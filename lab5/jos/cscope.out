cscope 15 $HOME/mit6.828/jos -q 0000001713 0000245340
	@boot/main.c

1 
	~<öc/x86.h
>

2 
	~<öc/ñf.h
>

32 
	#SECTSIZE
 512

	)

33 
	#ELFHDR
 ((
Elf
 *) 0x10000)

34 

	)

35 
ªad£˘
(*, 
uöt32_t
);

36 
ªad£g
(
uöt32_t
, uint32_t, uint32_t);

39 
	$boŸmaö
()

41 
Proghdr
 *
ph
, *
ïh
;

42 
i
;

45 
	`ªad£g
((
uöt32_t
Ë
ELFHDR
, 
SECTSIZE
*8, 0);

48 i‡(
ELFHDR
->
e_magic
 !
ELF_MAGIC
)

49 
bad
;

52 
ph
 = (
Proghdr
 *Ë((
uöt8_t
 *Ë
ELFHDR
 + ELFHDR->
e_phoff
);

53 
ïh
 = 
ph
 + 
ELFHDR
->
e_phnum
;

54 ; 
ph
 < 
ïh
;Öh++) {

57 
	`ªad£g
(
ph
->
p_∑
,Öh->
p_memsz
,Öh->
p_off£t
);

58 
i
 = 0; i < 
ph
->
p_memsz
 -Öh->
p_fûesz
; i++) {

59 *((*Ë
ph
->
p_∑
 +Öh->
p_fûesz
 + 
i
) = 0;

65 (((*)()Ë(
ELFHDR
->
e_íåy
))();

67 
bad
:

68 
	`outw
(0x8A00, 0x8A00);

69 
	`outw
(0x8A00, 0x8E00);

72 
	}
}

77 
	$ªad£g
(
uöt32_t
 
∑
, uöt32_à
cou¡
, uöt32_à
off£t
)

79 
uöt32_t
 
íd_∑
;

81 
íd_∑
 = 
∑
 + 
cou¡
;

84 
∑
 &~(
SECTSIZE
 - 1);

87 
off£t
 = (off£à/ 
SECTSIZE
) + 1;

92 
∑
 < 
íd_∑
) {

97 
	`ªad£˘
((
uöt8_t
*Ë
∑
, 
off£t
);

98 
∑
 +
SECTSIZE
;

99 
off£t
++;

101 
	}
}

104 
	$waôdisk
()

107 (
	`öb
(0x1F7) & 0xC0) != 0x40)

109 
	}
}

112 
	$ªad£˘
(*
d°
, 
uöt32_t
 
off£t
)

115 
	`waôdisk
();

117 
	`outb
(0x1F2, 1);

118 
	`outb
(0x1F3, 
off£t
);

119 
	`outb
(0x1F4, 
off£t
 >> 8);

120 
	`outb
(0x1F5, 
off£t
 >> 16);

121 
	`outb
(0x1F6, (
off£t
 >> 24) | 0xE0);

122 
	`outb
(0x1F7, 0x20);

125 
	`waôdisk
();

128 
	`ö¶
(0x1F0, 
d°
, 
SECTSIZE
/4);

129 
	}
}

	@fs/bc.c

2 
	~"fs.h
"

6 
	$diskaddr
(
uöt32_t
 
blockno
)

8 i‡(
blockno
 =0 || (
su≥r
 && blocknÿ>su≥r->
s_nblocks
))

9 
	`∑nic
("bad blockÇumbî %08x i¿diskaddr", 
blockno
);

10  (*Ë(
DISKMAP
 + 
blockno
 * 
BLKSIZE
);

11 
	}
}

14 
boﬁ


15 
	$va_is_m≠≥d
(*
va
)

17  (
uvpd
[
	`PDX
(
va
)] & 
PTE_P
Ë&& (
uv±
[
	`PGNUM
(va)] & PTE_P);

18 
	}
}

21 
boﬁ


22 
	$va_is_dúty
(*
va
)

24  (
uv±
[
	`PGNUM
(
va
)] & 
PTE_D
) != 0;

25 
	}
}

30 
	$bc_pgÁu…
(
UTøp‰ame
 *
utf
)

32 *
addr
 = (*Ë
utf
->
utf_Áu…_va
;

33 
uöt32_t
 
blockno
 = ((uöt32_t)
addr
 - 
DISKMAP
Ë/ 
BLKSIZE
;

34 
r
;

37 i‡(
addr
 < (*)
DISKMAP
 ||ádd∏>(*)(DISKMAP + 
DISKSIZE
))

38 
	`∑nic
("page fault in FS:Éip %08x, va %08x,Érr %04x",

39 
utf
->
utf_eù
, 
addr
, utf->
utf_îr
);

42 i‡(
su≥r
 && 
blockno
 >su≥r->
s_nblocks
)

43 
	`∑nic
("ªadögÇ⁄-exi°íàblock %08x\n", 
blockno
);

54 i‡((
r
 = 
	`sys_∑ge_m≠
(0, 
addr
, 0,áddr, 
uv±
[
	`PGNUM
◊ddr)] & 
PTE_SYSCALL
)) < 0)

55 
	`∑nic
("ö bc_pgÁu…, sys_∑ge_m≠: %e", 
r
);

60 i‡(
bôm≠
 && 
	`block_is_‰ì
(
blockno
))

61 
	`∑nic
("ªadög fªêblock %08x\n", 
blockno
);

62 
	}
}

72 
	$Êush_block
(*
addr
)

74 
uöt32_t
 
blockno
 = ((uöt32_t)
addr
 - 
DISKMAP
Ë/ 
BLKSIZE
;

76 i‡(
addr
 < (*)
DISKMAP
 ||ádd∏>(*)(DISKMAP + 
DISKSIZE
))

77 
	`∑nic
("Êush_block o‡bad v®%08x", 
addr
);

80 
	`∑nic
("flush_blockÇot implemented");

81 
	}
}

86 
	$check_bc
()

88 
Su≥r
 
backup
;

91 
	`memmove
(&
backup
, 
	`diskaddr
(1),  backup);

94 
	`°r˝y
(
	`diskaddr
(1), "OOPS!\n");

95 
	`Êush_block
(
	`diskaddr
(1));

96 
	`as£π
(
	`va_is_m≠≥d
(
	`diskaddr
(1)));

97 
	`as£π
(!
	`va_is_dúty
(
	`diskaddr
(1)));

100 
	`sys_∑ge_unm≠
(0, 
	`diskaddr
(1));

101 
	`as£π
(!
	`va_is_m≠≥d
(
	`diskaddr
(1)));

104 
	`as£π
(
	`°rcmp
(
	`diskaddr
(1), "OOPS!\n") == 0);

107 
	`memmove
(
	`diskaddr
(1), &
backup
,  backup);

108 
	`Êush_block
(
	`diskaddr
(1));

114 
	`memmove
(&
backup
, 
	`diskaddr
(1),  backup);

117 
	`°r˝y
(
	`diskaddr
(1), "OOPS!\n");

120 
	`Êush_block
(
	`diskaddr
(1) + 20);

121 
	`as£π
(
	`va_is_m≠≥d
(
	`diskaddr
(1)));

128 
	`sys_∑ge_unm≠
(0, 
	`diskaddr
(1));

129 
	`as£π
(!
	`va_is_m≠≥d
(
	`diskaddr
(1)));

132 
	`as£π
(
	`°rcmp
(
	`diskaddr
(1), "OOPS!\n") == 0);

135 
	`memmove
(
	`diskaddr
(1), &
backup
,  backup);

136 
	`Êush_block
(
	`diskaddr
(1));

138 
	`˝rötf
("block cache is good\n");

139 
	}
}

142 
	$bc_öô
()

144 
Su≥r
 
su≥r
;

145 
	`£t_pgÁu…_h™dÀr
(
bc_pgÁu…
);

146 
	`check_bc
();

149 
	`memmove
(&
su≥r
, 
	`diskaddr
(1),  super);

150 
	}
}

	@fs/fs.c

1 
	~<öc/°rög.h
>

2 
	~<öc/∑πôi⁄.h
>

4 
	~"fs.h
"

12 
	$check_su≥r
()

14 i‡(
su≥r
->
s_magic
 !
FS_MAGIC
)

15 
	`∑nic
("bad file system magicÇumber");

17 i‡(
su≥r
->
s_nblocks
 > 
DISKSIZE
/
BLKSIZE
)

18 
	`∑nic
("file system isÅooÜarge");

20 
	`˝rötf
("superblock is good\n");

21 
	}
}

29 
boﬁ


30 
	$block_is_‰ì
(
uöt32_t
 
blockno
)

32 i‡(
su≥r
 =0 || 
blockno
 >su≥r->
s_nblocks
)

34 i‡(
bôm≠
[
blockno
 / 32] & (1 << (blockno % 32)))

37 
	}
}

41 
	$‰ì_block
(
uöt32_t
 
blockno
)

44 i‡(
blockno
 == 0)

45 
	`∑nic
("attemptÅo free zero block");

46 
bôm≠
[
blockno
/32] |= 1<<(blockno%32);

47 
	}
}

58 
	$Æloc_block
()

65 
	`∑nic
("alloc_blockÇot implemented");

66  -
E_NO_DISK
;

67 
	}
}

74 
	$check_bôm≠
()

76 
uöt32_t
 
i
;

79 
i
 = 0; i * 
BLKBITSIZE
 < 
su≥r
->
s_nblocks
; i++)

80 
	`as£π
(!
	`block_is_‰ì
(2+
i
));

83 
	`as£π
(!
	`block_is_‰ì
(0));

84 
	`as£π
(!
	`block_is_‰ì
(1));

86 
	`˝rötf
("bitmap is good\n");

87 
	}
}

97 
	$fs_öô
()

99 
	`°©ic_as£π
((
Fûe
) == 256);

102 i‡(
	`ide_¥obe_disk1
())

103 
	`ide_£t_disk
(1);

105 
	`ide_£t_disk
(0);

106 
	`bc_öô
();

109 
su≥r
 = 
	`diskaddr
(1);

110 
	`check_su≥r
();

113 
bôm≠
 = 
	`diskaddr
(2);

114 
	`check_bôm≠
();

116 
	}
}

135 
	$fûe_block_wÆk
(
Fûe
 *
f
, 
uöt32_t
 
fûebno
, uöt32_à**
µdiskbno
, 
boﬁ
 
Æloc
)

138 
	`∑nic
("file_block_walkÇot implemented");

139 
	}
}

150 
	$fûe_gë_block
(
Fûe
 *
f
, 
uöt32_t
 
fûebno
, **
blk
)

153 
	`∑nic
("file_get_blockÇot implemented");

154 
	}
}

161 
	$dú_lookup
(
Fûe
 *
dú
, c⁄° *
«me
, Fûê**
fûe
)

163 
r
;

164 
uöt32_t
 
i
, 
j
, 
nblock
;

165 *
blk
;

166 
Fûe
 *
f
;

171 
	`as£π
((
dú
->
f_size
 % 
BLKSIZE
) == 0);

172 
nblock
 = 
dú
->
f_size
 / 
BLKSIZE
;

173 
i
 = 0; i < 
nblock
; i++) {

174 i‡((
r
 = 
	`fûe_gë_block
(
dú
, 
i
, &
blk
)) < 0)

175  
r
;

176 
f
 = (
Fûe
*Ë
blk
;

177 
j
 = 0; j < 
BLKFILES
; j++)

178 i‡(
	`°rcmp
(
f
[
j
].
f_«me
, 
«me
) == 0) {

179 *
fûe
 = &
f
[
j
];

183  -
E_NOT_FOUND
;

184 
	}
}

189 
	$dú_Æloc_fûe
(
Fûe
 *
dú
, Fûê**
fûe
)

191 
r
;

192 
uöt32_t
 
nblock
, 
i
, 
j
;

193 *
blk
;

194 
Fûe
 *
f
;

196 
	`as£π
((
dú
->
f_size
 % 
BLKSIZE
) == 0);

197 
nblock
 = 
dú
->
f_size
 / 
BLKSIZE
;

198 
i
 = 0; i < 
nblock
; i++) {

199 i‡((
r
 = 
	`fûe_gë_block
(
dú
, 
i
, &
blk
)) < 0)

200  
r
;

201 
f
 = (
Fûe
*Ë
blk
;

202 
j
 = 0; j < 
BLKFILES
; j++)

203 i‡(
f
[
j
].
f_«me
[0] == '\0') {

204 *
fûe
 = &
f
[
j
];

208 
dú
->
f_size
 +
BLKSIZE
;

209 i‡((
r
 = 
	`fûe_gë_block
(
dú
, 
i
, &
blk
)) < 0)

210  
r
;

211 
f
 = (
Fûe
*Ë
blk
;

212 *
fûe
 = &
f
[0];

214 
	}
}

218 
	$skù_¶ash
(c⁄° *
p
)

220 *
p
 == '/')

221 
p
++;

222  
p
;

223 
	}
}

232 
	$wÆk_∑th
(c⁄° *
∑th
, 
Fûe
 **
pdú
, Fûê**
pf
, *
œ°ñem
)

234 c⁄° *
p
;

235 
«me
[
MAXNAMELEN
];

236 
Fûe
 *
dú
, *
f
;

237 
r
;

241 
∑th
 = 
	`skù_¶ash
(path);

242 
f
 = &
su≥r
->
s_roŸ
;

243 
dú
 = 0;

244 
«me
[0] = 0;

246 i‡(
pdú
)

247 *
pdú
 = 0;

248 *
pf
 = 0;

249 *
∑th
 != '\0') {

250 
dú
 = 
f
;

251 
p
 = 
∑th
;

252 *
∑th
 != '/' && *path != '\0')

253 
∑th
++;

254 i‡(
∑th
 - 
p
 >
MAXNAMELEN
)

255  -
E_BAD_PATH
;

256 
	`memmove
(
«me
, 
p
, 
∑th
 -Ö);

257 
«me
[
∑th
 - 
p
] = '\0';

258 
∑th
 = 
	`skù_¶ash
(path);

260 i‡(
dú
->
f_ty≥
 !
FTYPE_DIR
)

261  -
E_NOT_FOUND
;

263 i‡((
r
 = 
	`dú_lookup
(
dú
, 
«me
, &
f
)) < 0) {

264 i‡(
r
 =-
E_NOT_FOUND
 && *
∑th
 == '\0') {

265 i‡(
pdú
)

266 *
pdú
 = 
dú
;

267 i‡(
œ°ñem
)

268 
	`°r˝y
(
œ°ñem
, 
«me
);

269 *
pf
 = 0;

271  
r
;

275 i‡(
pdú
)

276 *
pdú
 = 
dú
;

277 *
pf
 = 
f
;

279 
	}
}

288 
	$fûe_¸óã
(c⁄° *
∑th
, 
Fûe
 **
pf
)

290 
«me
[
MAXNAMELEN
];

291 
r
;

292 
Fûe
 *
dú
, *
f
;

294 i‡((
r
 = 
	`wÆk_∑th
(
∑th
, &
dú
, &
f
, 
«me
)) == 0)

295  -
E_FILE_EXISTS
;

296 i‡(
r
 !-
E_NOT_FOUND
 || 
dú
 == 0)

297  
r
;

298 i‡((
r
 = 
	`dú_Æloc_fûe
(
dú
, &
f
)) < 0)

299  
r
;

301 
	`°r˝y
(
f
->
f_«me
, 
«me
);

302 *
pf
 = 
f
;

303 
	`fûe_Êush
(
dú
);

305 
	}
}

310 
	$fûe_›í
(c⁄° *
∑th
, 
Fûe
 **
pf
)

312  
	`wÆk_∑th
(
∑th
, 0, 
pf
, 0);

313 
	}
}

318 
ssize_t


319 
	$fûe_ªad
(
Fûe
 *
f
, *
buf
, 
size_t
 
cou¡
, 
off_t
 
off£t
)

321 
r
, 
bn
;

322 
off_t
 
pos
;

323 *
blk
;

325 i‡(
off£t
 >
f
->
f_size
)

328 
cou¡
 = 
	`MIN
(cou¡, 
f
->
f_size
 - 
off£t
);

330 
pos
 = 
off£t
;Öo†< off£à+ 
cou¡
; ) {

331 i‡((
r
 = 
	`fûe_gë_block
(
f
, 
pos
 / 
BLKSIZE
, &
blk
)) < 0)

332  
r
;

333 
bn
 = 
	`MIN
(
BLKSIZE
 - 
pos
 % BLKSIZE, 
off£t
 + 
cou¡
 -Öos);

334 
	`memmove
(
buf
, 
blk
 + 
pos
 % 
BLKSIZE
, 
bn
);

335 
pos
 +
bn
;

336 
buf
 +
bn
;

339  
cou¡
;

340 
	}
}

348 
	$fûe_wrôe
(
Fûe
 *
f
, c⁄° *
buf
, 
size_t
 
cou¡
, 
off_t
 
off£t
)

350 
r
, 
bn
;

351 
off_t
 
pos
;

352 *
blk
;

355 i‡(
off£t
 + 
cou¡
 > 
f
->
f_size
)

356 i‡((
r
 = 
	`fûe_£t_size
(
f
, 
off£t
 + 
cou¡
)) < 0)

357  
r
;

359 
pos
 = 
off£t
;Öo†< off£à+ 
cou¡
; ) {

360 i‡((
r
 = 
	`fûe_gë_block
(
f
, 
pos
 / 
BLKSIZE
, &
blk
)) < 0)

361  
r
;

362 
bn
 = 
	`MIN
(
BLKSIZE
 - 
pos
 % BLKSIZE, 
off£t
 + 
cou¡
 -Öos);

363 
	`memmove
(
blk
 + 
pos
 % 
BLKSIZE
, 
buf
, 
bn
);

364 
pos
 +
bn
;

365 
buf
 +
bn
;

368  
cou¡
;

369 
	}
}

374 
	$fûe_‰ì_block
(
Fûe
 *
f
, 
uöt32_t
 
fûebno
)

376 
r
;

377 
uöt32_t
 *
±r
;

379 i‡((
r
 = 
	`fûe_block_wÆk
(
f
, 
fûebno
, &
±r
, 0)) < 0)

380  
r
;

381 i‡(*
±r
) {

382 
	`‰ì_block
(*
±r
);

383 *
±r
 = 0;

386 
	}
}

398 
	$fûe_åunˇã_blocks
(
Fûe
 *
f
, 
off_t
 
√wsize
)

400 
r
;

401 
uöt32_t
 
bno
, 
ﬁd_nblocks
, 
√w_nblocks
;

403 
ﬁd_nblocks
 = (
f
->
f_size
 + 
BLKSIZE
 - 1) / BLKSIZE;

404 
√w_nblocks
 = (
√wsize
 + 
BLKSIZE
 - 1) / BLKSIZE;

405 
bno
 = 
√w_nblocks
; bnÿ< 
ﬁd_nblocks
; bno++)

406 i‡((
r
 = 
	`fûe_‰ì_block
(
f
, 
bno
)) < 0)

407 
	`˝rötf
("w¨nög: fûe_‰ì_block: %e", 
r
);

409 i‡(
√w_nblocks
 <
NDIRECT
 && 
f
->
f_ödúe˘
) {

410 
	`‰ì_block
(
f
->
f_ödúe˘
);

411 
f
->
f_ödúe˘
 = 0;

413 
	}
}

417 
	$fûe_£t_size
(
Fûe
 *
f
, 
off_t
 
√wsize
)

419 i‡(
f
->
f_size
 > 
√wsize
)

420 
	`fûe_åunˇã_blocks
(
f
, 
√wsize
);

421 
f
->
f_size
 = 
√wsize
;

422 
	`Êush_block
(
f
);

424 
	}
}

431 
	$fûe_Êush
(
Fûe
 *
f
)

433 
i
;

434 
uöt32_t
 *
pdiskbno
;

436 
i
 = 0; i < (
f
->
f_size
 + 
BLKSIZE
 - 1) / BLKSIZE; i++) {

437 i‡(
	`fûe_block_wÆk
(
f
, 
i
, &
pdiskbno
, 0) < 0 ||

438 
pdiskbno
 =
NULL
 || *pdiskbno == 0)

440 
	`Êush_block
(
	`diskaddr
(*
pdiskbno
));

442 
	`Êush_block
(
f
);

443 i‡(
f
->
f_ödúe˘
)

444 
	`Êush_block
(
	`diskaddr
(
f
->
f_ödúe˘
));

445 
	}
}

450 
	$fs_sync
()

452 
i
;

453 
i
 = 1; i < 
su≥r
->
s_nblocks
; i++)

454 
	`Êush_block
(
	`diskaddr
(
i
));

455 
	}
}

	@fs/fs.h

1 
	~<öc/fs.h
>

2 
	~<öc/lib.h
>

4 
	#SECTSIZE
 512

5 
	#BLKSECTS
 (
BLKSIZE
 / 
SECTSIZE
)

6 

	)

9 
	#DISKMAP
 0x10000000

	)

12 
	#DISKSIZE
 0xC0000000

	)

14 
Su≥r
 *
	gsu≥r
;

15 
uöt32_t
 *
	gbôm≠
;

18 
boﬁ
 
ide_¥obe_disk1
();

19 
ide_£t_disk
(
diskno
);

20 
ide_£t_∑πôi⁄
(
uöt32_t
 
fú°_£˘
, uöt32_à
n£˘
);

21 
ide_ªad
(
uöt32_t
 
£˙o
, *
d°
, 
size_t
 
n£cs
);

22 
ide_wrôe
(
uöt32_t
 
£˙o
, c⁄° *
§c
, 
size_t
 
n£cs
);

25 * 
diskaddr
(
uöt32_t
 
blockno
);

26 
boﬁ
 
va_is_m≠≥d
(*
va
);

27 
boﬁ
 
va_is_dúty
(*
va
);

28 
Êush_block
(*
addr
);

29 
bc_öô
();

32 
fs_öô
();

33 
fûe_gë_block
(
Fûe
 *
f
, 
uöt32_t
 
fûe_blockno
, **
pblk
);

34 
fûe_¸óã
(c⁄° *
∑th
, 
Fûe
 **
f
);

35 
fûe_›í
(c⁄° *
∑th
, 
Fûe
 **
f
);

36 
ssize_t
 
fûe_ªad
(
Fûe
 *
f
, *
buf
, 
size_t
 
cou¡
, 
off_t
 
off£t
);

37 
fûe_wrôe
(
Fûe
 *
f
, c⁄° *
buf
, 
size_t
 
cou¡
, 
off_t
 
off£t
);

38 
fûe_£t_size
(
Fûe
 *
f
, 
off_t
 
√wsize
);

39 
fûe_Êush
(
Fûe
 *
f
);

40 
fûe_ªmove
(c⁄° *
∑th
);

41 
fs_sync
();

44 
boﬁ
 
block_is_‰ì
(
uöt32_t
 
blockno
);

45 
Æloc_block
();

48 
fs_ã°
();

	@fs/fsformat.c

6 
	#off_t
 
xxx_off_t


	)

7 
	#boﬁ
 
xxx_boﬁ


	)

8 
	~<as£π.h
>

9 
	~<î∫o.h
>

10 
	~<f˙é.h
>

11 
	~<öây≥s.h
>

12 
	~<°d¨g.h
>

13 
	~<°dio.h
>

14 
	~<°dlib.h
>

15 
	~<°rög.h
>

16 
	~<uni°d.h
>

17 
	~<sys/mm™.h
>

18 
	~<sys/°©.h
>

19 
	~<sys/ty≥s.h
>

20 #unde‡
off_t


21 #unde‡
boﬁ


25 
	#JOS_INC_TYPES_H


	)

27 
uöt32_t
 
	tphyßddr_t
;

28 
uöt32_t
 
	toff_t
;

29 
	tboﬁ
;

31 
	~<öc/mmu.h
>

32 
	~<öc/fs.h
>

34 
	#ROUNDUP
(
n
, 
v
Ë(“Ë- 1 + (vË- (“Ë- 1Ë% (v))

	)

35 
	#MAX_DIR_ENTS
 128

	)

37 
	sDú


39 
Fûe
 *
	mf
;

40 
Fûe
 *
	míts
;

41 
	mn
;

44 
uöt32_t
 
	gnblocks
;

45 *
	gdiskm≠
, *
	gdiskpos
;

46 
Su≥r
 *
	gsu≥r
;

47 
uöt32_t
 *
	gbôm≠
;

50 
	$∑nic
(c⁄° *
fmt
, ...)

52 
va_li°
 
≠
;

54 
	`va_°¨t
(
≠
, 
fmt
);

55 
	`vÂrötf
(
°dîr
, 
fmt
, 
≠
);

56 
	`va_íd
(
≠
);

57 
	`Âutc
('\n', 
°dîr
);

58 
	`ab‹t
();

59 
	}
}

62 
	$ªadn
(
f
, *
out
, 
size_t
 
n
)

64 
size_t
 
p
 = 0;

65 
p
 < 
n
) {

66 
ssize_t
 
m
 = 
	`ªad
(
f
, 
out
 + 
p
, 
n
 -Ö);

67 i‡(
m
 < 0)

68 
	`∑nic
("ªad: %s", 
	`°ªº‹
(
î∫o
));

69 i‡(
m
 == 0)

70 
	`∑nic
("read: Unexpected EOF");

71 
p
 +
m
;

73 
	}
}

75 
uöt32_t


76 
	$blockof
(*
pos
)

78  ((*)
pos
 - 
diskm≠
Ë/ 
BLKSIZE
;

79 
	}
}

82 
	$Æloc
(
uöt32_t
 
byãs
)

84 *
°¨t
 = 
diskpos
;

85 
diskpos
 +
	`ROUNDUP
(
byãs
, 
BLKSIZE
);

86 i‡(
	`blockof
(
diskpos
Ë>
nblocks
)

87 
	`∑nic
("out of disk blocks");

88  
°¨t
;

89 
	}
}

92 
	$›ídisk
(c⁄° *
«me
)

94 
r
, 
diskfd
, 
nbôblocks
;

96 i‡((
diskfd
 = 
	`›í
(
«me
, 
O_RDWR
 | 
O_CREAT
, 0666)) < 0)

97 
	`∑nic
("›í %s: %s", 
«me
, 
	`°ªº‹
(
î∫o
));

99 i‡((
r
 = 
	`·runˇã
(
diskfd
, 0)) < 0

100 || (
r
 = 
	`·runˇã
(
diskfd
, 
nblocks
 * 
BLKSIZE
)) < 0)

101 
	`∑nic
("åunˇã %s: %s", 
«me
, 
	`°ªº‹
(
î∫o
));

103 i‡((
diskm≠
 = 
	`mm≠
(
NULL
, 
nblocks
 * 
BLKSIZE
, 
PROT_READ
|
PROT_WRITE
,

104 
MAP_SHARED
, 
diskfd
, 0)Ë=
MAP_FAILED
)

105 
	`∑nic
("mm≠ %s: %s", 
«me
, 
	`°ªº‹
(
î∫o
));

107 
	`˛o£
(
diskfd
);

109 
diskpos
 = 
diskm≠
;

110 
	`Æloc
(
BLKSIZE
);

111 
su≥r
 = 
	`Æloc
(
BLKSIZE
);

112 
su≥r
->
s_magic
 = 
FS_MAGIC
;

113 
su≥r
->
s_nblocks
 = 
nblocks
;

114 
su≥r
->
s_roŸ
.
f_ty≥
 = 
FTYPE_DIR
;

115 
	`°r˝y
(
su≥r
->
s_roŸ
.
f_«me
, "/");

117 
nbôblocks
 = (
nblocks
 + 
BLKBITSIZE
 - 1) / BLKBITSIZE;

118 
bôm≠
 = 
	`Æloc
(
nbôblocks
 * 
BLKSIZE
);

119 
	`mem£t
(
bôm≠
, 0xFF, 
nbôblocks
 * 
BLKSIZE
);

120 
	}
}

123 
	$föishdisk
()

125 
r
, 
i
;

127 
i
 = 0; i < 
	`blockof
(
diskpos
); ++i)

128 
bôm≠
[
i
/32] &= ~(1<<(i%32));

130 i‡((
r
 = 
	`msync
(
diskm≠
, 
nblocks
 * 
BLKSIZE
, 
MS_SYNC
)) < 0)

131 
	`∑nic
("msync: %s", 
	`°ªº‹
(
î∫o
));

132 
	}
}

135 
	$föishfûe
(
Fûe
 *
f
, 
uöt32_t
 
°¨t
, uöt32_à
Àn
)

137 
i
;

138 
f
->
f_size
 = 
Àn
;

139 
Àn
 = 
	`ROUNDUP
÷í, 
BLKSIZE
);

140 
i
 = 0; i < 
Àn
 / 
BLKSIZE
 && i < 
NDIRECT
; ++i)

141 
f
->
f_dúe˘
[
i
] = 
°¨t
 + i;

142 i‡(
i
 =
NDIRECT
) {

143 
uöt32_t
 *
öd
 = 
	`Æloc
(
BLKSIZE
);

144 
f
->
f_ödúe˘
 = 
	`blockof
(
öd
);

145 ; 
i
 < 
Àn
 / 
BLKSIZE
; ++i)

146 
öd
[
i
 - 
NDIRECT
] = 
°¨t
 + i;

148 
	}
}

151 
	$°¨tdú
(
Fûe
 *
f
, 
Dú
 *
dout
)

153 
dout
->
f
 = f;

154 
dout
->
íts
 = 
	`mÆloc
(
MAX_DIR_ENTS
 *  *dout->ents);

155 
dout
->
n
 = 0;

156 
	}
}

158 
Fûe
 *

159 
	$dúadd
(
Dú
 *
d
, 
uöt32_t
 
ty≥
, c⁄° *
«me
)

161 
Fûe
 *
out
 = &
d
->
íts
[d->
n
++];

162 i‡(
d
->
n
 > 
MAX_DIR_ENTS
)

163 
	`∑nic
("too many directoryÉntries");

164 
	`°r˝y
(
out
->
f_«me
, 
«me
);

165 
out
->
f_ty≥
 = 
ty≥
;

166  
out
;

167 
	}
}

170 
	$föishdú
(
Dú
 *
d
)

172 
size
 = 
d
->
n
 * (
Fûe
);

173 
Fûe
 *
°¨t
 = 
	`Æloc
(
size
);

174 
	`memmove
(
°¨t
, 
d
->
íts
, 
size
);

175 
	`föishfûe
(
d
->
f
, 
	`blockof
(
°¨t
), 
	`ROUNDUP
(
size
, 
BLKSIZE
));

176 
	`‰ì
(
d
->
íts
);

177 
d
->
íts
 = 
NULL
;

178 
	}
}

181 
	$wrôefûe
(
Dú
 *
dú
, c⁄° *
«me
)

183 
r
, 
fd
;

184 
Fûe
 *
f
;

185 
°©
 
°
;

186 c⁄° *
œ°
;

187 *
°¨t
;

189 i‡((
fd
 = 
	`›í
(
«me
, 
O_RDONLY
)) < 0)

190 
	`∑nic
("›í %s: %s", 
«me
, 
	`°ªº‹
(
î∫o
));

191 i‡((
r
 = 
	`f°©
(
fd
, &
°
)) < 0)

192 
	`∑nic
("°© %s: %s", 
«me
, 
	`°ªº‹
(
î∫o
));

193 i‡(!
	`S_ISREG
(
°
.
°_mode
))

194 
	`∑nic
("%†i†nŸáÑeguœ∏fûe", 
«me
);

195 i‡(
°
.
°_size
 >
MAXFILESIZE
)

196 
	`∑nic
("%†toÿœrge", 
«me
);

198 
œ°
 = 
	`°ºchr
(
«me
, '/');

199 i‡(
œ°
)

200 
œ°
++;

202 
œ°
 = 
«me
;

204 
f
 = 
	`dúadd
(
dú
, 
FTYPE_REG
, 
œ°
);

205 
°¨t
 = 
	`Æloc
(
°
.
°_size
);

206 
	`ªadn
(
fd
, 
°¨t
, 
°
.
°_size
);

207 
	`föishfûe
(
f
, 
	`blockof
(
°¨t
), 
°
.
°_size
);

208 
	`˛o£
(
fd
);

209 
	}
}

212 
	$ußge
()

214 
	`Ârötf
(
°dîr
, "Usage: fsformat fs.img NBLOCKS files...\n");

215 
	`exô
(2);

216 
	}
}

219 
	$maö
(
¨gc
, **
¨gv
)

221 
i
;

222 *
s
;

223 
Dú
 
roŸ
;

225 
	`as£π
(
BLKSIZE
 % (
Fûe
) == 0);

227 i‡(
¨gc
 < 3)

228 
	`ußge
();

230 
nblocks
 = 
	`°πﬁ
(
¨gv
[2], &
s
, 0);

231 i‡(*
s
 || s =
¨gv
[2] || 
nblocks
 < 2 ||Çblocks > 1024)

232 
	`ußge
();

234 
	`›ídisk
(
¨gv
[1]);

236 
	`°¨tdú
(&
su≥r
->
s_roŸ
, &
roŸ
);

237 
i
 = 3; i < 
¨gc
; i++)

238 
	`wrôefûe
(&
roŸ
, 
¨gv
[
i
]);

239 
	`föishdú
(&
roŸ
);

241 
	`föishdisk
();

243 
	}
}

	@fs/ide.c

7 
	~"fs.h
"

8 
	~<öc/x86.h
>

10 
	#IDE_BSY
 0x80

	)

11 
	#IDE_DRDY
 0x40

	)

12 
	#IDE_DF
 0x20

	)

13 
	#IDE_ERR
 0x01

	)

15 
	gdiskno
 = 1;

18 
	$ide_waô_ªady
(
boﬁ
 
check_îr‹
)

20 
r
;

22 ((
r
 = 
	`öb
(0x1F7)Ë& (
IDE_BSY
|
IDE_DRDY
)) != IDE_DRDY)

25 i‡(
check_îr‹
 && (
r
 & (
IDE_DF
|
IDE_ERR
)) != 0)

28 
	}
}

30 
boﬁ


31 
	$ide_¥obe_disk1
()

33 
r
, 
x
;

36 
	`ide_waô_ªady
(0);

39 
	`outb
(0x1F6, 0xE0 | (1<<4));

42 
x
 = 0;

43 
x
 < 1000 && ((
r
 = 
	`öb
(0x1F7)Ë& (
IDE_BSY
|
IDE_DF
|
IDE_ERR
)) != 0;

44 
x
++)

48 
	`outb
(0x1F6, 0xE0 | (0<<4));

50 
	`˝rötf
("Devi˚ 1Öª£n˚: %d\n", (
x
 < 1000));

51  (
x
 < 1000);

52 
	}
}

55 
	$ide_£t_disk
(
d
)

57 i‡(
d
 != 0 && d != 1)

58 
	`∑nic
("bad diskÇumber");

59 
diskno
 = 
d
;

60 
	}
}

64 
	$ide_ªad
(
uöt32_t
 
£˙o
, *
d°
, 
size_t
 
n£cs
)

66 
r
;

68 
	`as£π
(
n£cs
 <= 256);

70 
	`ide_waô_ªady
(0);

72 
	`outb
(0x1F2, 
n£cs
);

73 
	`outb
(0x1F3, 
£˙o
 & 0xFF);

74 
	`outb
(0x1F4, (
£˙o
 >> 8) & 0xFF);

75 
	`outb
(0x1F5, (
£˙o
 >> 16) & 0xFF);

76 
	`outb
(0x1F6, 0xE0 | ((
diskno
&1)<<4Ë| ((
£˙o
>>24)&0x0F));

77 
	`outb
(0x1F7, 0x20);

79 ; 
n£cs
 > 0;Ç£cs--, 
d°
 +
SECTSIZE
) {

80 i‡((
r
 = 
	`ide_waô_ªady
(1)) < 0)

81  
r
;

82 
	`ö¶
(0x1F0, 
d°
, 
SECTSIZE
/4);

86 
	}
}

89 
	$ide_wrôe
(
uöt32_t
 
£˙o
, c⁄° *
§c
, 
size_t
 
n£cs
)

91 
r
;

93 
	`as£π
(
n£cs
 <= 256);

95 
	`ide_waô_ªady
(0);

97 
	`outb
(0x1F2, 
n£cs
);

98 
	`outb
(0x1F3, 
£˙o
 & 0xFF);

99 
	`outb
(0x1F4, (
£˙o
 >> 8) & 0xFF);

100 
	`outb
(0x1F5, (
£˙o
 >> 16) & 0xFF);

101 
	`outb
(0x1F6, 0xE0 | ((
diskno
&1)<<4Ë| ((
£˙o
>>24)&0x0F));

102 
	`outb
(0x1F7, 0x30);

104 ; 
n£cs
 > 0;Ç£cs--, 
§c
 +
SECTSIZE
) {

105 i‡((
r
 = 
	`ide_waô_ªady
(1)) < 0)

106  
r
;

107 
	`out¶
(0x1F0, 
§c
, 
SECTSIZE
/4);

111 
	}
}

	@fs/serv.c

6 
	~<öc/x86.h
>

7 
	~<öc/°rög.h
>

9 
	~"fs.h
"

12 
	#debug
 0

	)

32 
	sO≥nFûe
 {

33 
uöt32_t
 
	mo_fûeid
;

34 
Fûe
 *
	mo_fûe
;

35 
	mo_mode
;

36 
Fd
 *
	mo_fd
;

40 
	#MAXOPEN
 1024

	)

41 
	#FILEVA
 0xD0000000

	)

44 
O≥nFûe
 
	g›íèb
[
MAXOPEN
] = {

49 
Fsùc
 *
	gf§eq
 = (Fsipc *)0x0ffff000;

52 
	$£rve_öô
()

54 
i
;

55 
uöçå_t
 
va
 = 
FILEVA
;

56 
i
 = 0; i < 
MAXOPEN
; i++) {

57 
›íèb
[
i
].
o_fûeid
 = i;

58 
›íèb
[
i
].
o_fd
 = (
Fd
*Ë
va
;

59 
va
 +
PGSIZE
;

61 
	}
}

65 
	$›ífûe_Æloc
(
O≥nFûe
 **
o
)

67 
i
, 
r
;

70 
i
 = 0; i < 
MAXOPEN
; i++) {

71 
	`∑gîef
(
›íèb
[
i
].
o_fd
)) {

73 i‡((
r
 = 
	`sys_∑ge_Æloc
(0, 
›íèb
[
i
].
o_fd
, 
PTE_P
|
PTE_U
|
PTE_W
)) < 0)

74  
r
;

77 
›íèb
[
i
].
o_fûeid
 +
MAXOPEN
;

78 *
o
 = &
›íèb
[
i
];

79 
	`mem£t
(
›íèb
[
i
].
o_fd
, 0, 
PGSIZE
);

80  (*
o
)->
o_fûeid
;

83  -
E_MAX_OPEN
;

84 
	}
}

88 
	$›ífûe_lookup
(
ívid_t
 
ívid
, 
uöt32_t
 
fûeid
, 
O≥nFûe
 **
po
)

90 
O≥nFûe
 *
o
;

92 
o
 = &
›íèb
[
fûeid
 % 
MAXOPEN
];

93 i‡(
	`∑gîef
(
o
->
o_fd
Ë<1 || o->
o_fûeid
 !
fûeid
)

94  -
E_INVAL
;

95 *
po
 = 
o
;

97 
	}
}

103 
	$£rve_›í
(
ívid_t
 
ívid
, 
F§eq_›í
 *
ªq
,

104 **
pg_°‹e
, *
≥rm_°‹e
)

106 
∑th
[
MAXPATHLEN
];

107 
Fûe
 *
f
;

108 
fûeid
;

109 
r
;

110 
O≥nFûe
 *
o
;

112 i‡(
debug
)

113 
	`˝rötf
("£rve_›í %08x %†0x%x\n", 
ívid
, 
ªq
->
ªq_∑th
,Ñeq->
ªq_omode
);

116 
	`memmove
(
∑th
, 
ªq
->
ªq_∑th
, 
MAXPATHLEN
);

117 
∑th
[
MAXPATHLEN
-1] = 0;

120 i‡((
r
 = 
	`›ífûe_Æloc
(&
o
)) < 0) {

121 i‡(
debug
)

122 
	`˝rötf
("›ífûe_Ælo¯Áûed: %e", 
r
);

123  
r
;

125 
fûeid
 = 
r
;

128 i‡(
ªq
->
ªq_omode
 & 
O_CREAT
) {

129 i‡((
r
 = 
	`fûe_¸óã
(
∑th
, &
f
)) < 0) {

130 i‡(!(
ªq
->
ªq_omode
 & 
O_EXCL
Ë&& 
r
 =-
E_FILE_EXISTS
)

131 
åy_›í
;

132 i‡(
debug
)

133 
	`˝rötf
("fûe_¸óã faûed: %e", 
r
);

134  
r
;

137 
åy_›í
:

138 i‡((
r
 = 
	`fûe_›í
(
∑th
, &
f
)) < 0) {

139 i‡(
debug
)

140 
	`˝rötf
("fûe_›í faûed: %e", 
r
);

141  
r
;

146 i‡(
ªq
->
ªq_omode
 & 
O_TRUNC
) {

147 i‡((
r
 = 
	`fûe_£t_size
(
f
, 0)) < 0) {

148 i‡(
debug
)

149 
	`˝rötf
("fûe_£t_sizêÁûed: %e", 
r
);

150  
r
;

153 i‡((
r
 = 
	`fûe_›í
(
∑th
, &
f
)) < 0) {

154 i‡(
debug
)

155 
	`˝rötf
("fûe_›í faûed: %e", 
r
);

156  
r
;

160 
o
->
o_fûe
 = 
f
;

163 
o
->
o_fd
->
fd_fûe
.
id
 = o->
o_fûeid
;

164 
o
->
o_fd
->
fd_omode
 = 
ªq
->
ªq_omode
 & 
O_ACCMODE
;

165 
o
->
o_fd
->
fd_dev_id
 = 
devfûe
.
dev_id
;

166 
o
->
o_mode
 = 
ªq
->
ªq_omode
;

168 i‡(
debug
)

169 
	`˝rötf
("£ndög suc˚ss,Öagê%08x\n", (
uöçå_t
Ë
o
->
o_fd
);

173 *
pg_°‹e
 = 
o
->
o_fd
;

174 *
≥rm_°‹e
 = 
PTE_P
|
PTE_U
|
PTE_W
|
PTE_SHARE
;

177 
	}
}

182 
	$£rve_£t_size
(
ívid_t
 
ívid
, 
F§eq_£t_size
 *
ªq
)

184 
O≥nFûe
 *
o
;

185 
r
;

187 i‡(
debug
)

188 
	`˝rötf
("£rve_£t_sizê%08x %08x %08x\n", 
ívid
, 
ªq
->
ªq_fûeid
,Ñeq->
ªq_size
);

195 i‡((
r
 = 
	`›ífûe_lookup
(
ívid
, 
ªq
->
ªq_fûeid
, &
o
)) < 0)

196  
r
;

200  
	`fûe_£t_size
(
o
->
o_fûe
, 
ªq
->
ªq_size
);

201 
	}
}

208 
	$£rve_ªad
(
ívid_t
 
ívid
, 
Fsùc
 *
ùc
)

210 
F§eq_ªad
 *
ªq
 = &
ùc
->
ªad
;

211 
F§ë_ªad
 *
ªt
 = &
ùc
->
ªadRë
;

213 i‡(
debug
)

214 
	`˝rötf
("£rve_ªad %08x %08x %08x\n", 
ívid
, 
ªq
->
ªq_fûeid
,Ñeq->
ªq_n
);

218 
	}
}

226 
	$£rve_wrôe
(
ívid_t
 
ívid
, 
F§eq_wrôe
 *
ªq
)

228 i‡(
debug
)

229 
	`˝rötf
("£rve_wrôê%08x %08x %08x\n", 
ívid
, 
ªq
->
ªq_fûeid
,Ñeq->
ªq_n
);

232 
	`∑nic
("serve_writeÇot implemented");

233 
	}
}

238 
	$£rve_°©
(
ívid_t
 
ívid
, 
Fsùc
 *
ùc
)

240 
F§eq_°©
 *
ªq
 = &
ùc
->
°©
;

241 
F§ë_°©
 *
ªt
 = &
ùc
->
°©Rë
;

242 
O≥nFûe
 *
o
;

243 
r
;

245 i‡(
debug
)

246 
	`˝rötf
("£rve_°© %08x %08x\n", 
ívid
, 
ªq
->
ªq_fûeid
);

248 i‡((
r
 = 
	`›ífûe_lookup
(
ívid
, 
ªq
->
ªq_fûeid
, &
o
)) < 0)

249  
r
;

251 
	`°r˝y
(
ªt
->
ªt_«me
, 
o
->
o_fûe
->
f_«me
);

252 
ªt
->
ªt_size
 = 
o
->
o_fûe
->
f_size
;

253 
ªt
->
ªt_isdú
 = (
o
->
o_fûe
->
f_ty≥
 =
FTYPE_DIR
);

255 
	}
}

259 
	$£rve_Êush
(
ívid_t
 
ívid
, 
F§eq_Êush
 *
ªq
)

261 
O≥nFûe
 *
o
;

262 
r
;

264 i‡(
debug
)

265 
	`˝rötf
("£rve_Êush %08x %08x\n", 
ívid
, 
ªq
->
ªq_fûeid
);

267 i‡((
r
 = 
	`›ífûe_lookup
(
ívid
, 
ªq
->
ªq_fûeid
, &
o
)) < 0)

268  
r
;

269 
	`fûe_Êush
(
o
->
o_fûe
);

271 
	}
}

275 
	$£rve_sync
(
ívid_t
 
ívid
, 
Fsùc
 *
ªq
)

277 
	`fs_sync
();

279 
	}
}

281 (*
	tfsh™dÀr
)(
	tívid_t
 
	tívid
, 
	tFsùc
 *
	tªq
);

283 
fsh™dÀr
 
h™dÀrs
[] = {

286 [
FSREQ_READ
] = 
£rve_ªad
,

287 [
FSREQ_STAT
] = 
£rve_°©
,

288 [
FSREQ_FLUSH
] = (
fsh™dÀr
)
£rve_Êush
,

289 [
FSREQ_WRITE
] = (
fsh™dÀr
)
£rve_wrôe
,

290 [
FSREQ_SET_SIZE
] = (
fsh™dÀr
)
£rve_£t_size
,

291 [
FSREQ_SYNC
] = 
£rve_sync


292 
	}
};

295 
	$£rve
()

297 
uöt32_t
 
ªq
, 
whom
;

298 
≥rm
, 
r
;

299 *
pg
;

302 
≥rm
 = 0;

303 
ªq
 = 
	`ùc_ªcv
((
öt32_t
 *Ë&
whom
, 
f§eq
, &
≥rm
);

304 i‡(
debug
)

305 
	`˝rötf
("fsÑeq %d from %08x [page %08x: %s]\n",

306 
ªq
, 
whom
, 
uv±
[
	`PGNUM
(
f§eq
)], fsreq);

309 i‡(!(
≥rm
 & 
PTE_P
)) {

310 
	`˝rötf
("InvalidÑequest from %08x:ÇoárgumentÖage\n",

311 
whom
);

315 
pg
 = 
NULL
;

316 i‡(
ªq
 =
FSREQ_OPEN
) {

317 
r
 = 
	`£rve_›í
(
whom
, (
F§eq_›í
*)
f§eq
, &
pg
, &
≥rm
);

318 } i‡(
ªq
 < 
	`ARRAY_SIZE
(
h™dÀrs
) && handlers[req]) {

319 
r
 = 
h™dÀrs
[
ªq
](
whom
, 
f§eq
);

321 
	`˝rötf
("InvÆidÑeque° codê%d from %08x\n", 
ªq
, 
whom
);

322 
r
 = -
E_INVAL
;

324 
	`ùc_£nd
(
whom
, 
r
, 
pg
, 
≥rm
);

325 
	`sys_∑ge_unm≠
(0, 
f§eq
);

327 
	}
}

330 
	$umaö
(
¨gc
, **
¨gv
)

332 
	`°©ic_as£π
((
Fûe
) == 256);

333 
bö¨y«me
 = "fs";

334 
	`˝rötf
("FS isÑunning\n");

337 
	`outw
(0x8A00, 0x8A00);

338 
	`˝rötf
("FS can do I/O\n");

340 
	`£rve_öô
();

341 
	`fs_öô
();

342 
	`fs_ã°
();

343 
	`£rve
();

344 
	}
}

	@fs/test.c

1 
	~<öc/x86.h
>

2 
	~<öc/°rög.h
>

4 
	~"fs.h
"

6 *
	gmsg
 = "This isÅhe NEW message ofÅhe day!\n\n";

9 
	$fs_ã°
()

11 
Fûe
 *
f
;

12 
r
;

13 *
blk
;

14 
uöt32_t
 *
bôs
;

17 i‡((
r
 = 
	`sys_∑ge_Æloc
(0, (*Ë
PGSIZE
, 
PTE_P
|
PTE_U
|
PTE_W
)) < 0)

18 
	`∑nic
("sys_∑ge_Æloc: %e", 
r
);

19 
bôs
 = (
uöt32_t
*Ë
PGSIZE
;

20 
	`memmove
(
bôs
, 
bôm≠
, 
PGSIZE
);

22 i‡((
r
 = 
	`Æloc_block
()) < 0)

23 
	`∑nic
("Æloc_block: %e", 
r
);

25 
	`as£π
(
bôs
[
r
/32] & (1 << (r%32)));

27 
	`as£π
(!(
bôm≠
[
r
/32] & (1 << (r%32))));

28 
	`˝rötf
("alloc_block is good\n");

30 i‡((
r
 = 
	`fûe_›í
("/nŸ-found", &
f
)Ë< 0 &&Ñ !-
E_NOT_FOUND
)

31 
	`∑nic
("fûe_›í /nŸ-found: %e", 
r
);

32 i‡(
r
 == 0)

33 
	`∑nic
("file_open /not-found succeeded!");

34 i‡((
r
 = 
	`fûe_›í
("/√wmŸd", &
f
)) < 0)

35 
	`∑nic
("fûe_›í /√wmŸd: %e", 
r
);

36 
	`˝rötf
("file_open is good\n");

38 i‡((
r
 = 
	`fûe_gë_block
(
f
, 0, &
blk
)) < 0)

39 
	`∑nic
("fûe_gë_block: %e", 
r
);

40 i‡(
	`°rcmp
(
blk
, 
msg
) != 0)

41 
	`∑nic
("file_get_blockÑeturned wrong data");

42 
	`˝rötf
("file_get_block is good\n");

44 *(vﬁ©ûê*)
blk
 = *(volatile *)blk;

45 
	`as£π
((
uv±
[
	`PGNUM
(
blk
)] & 
PTE_D
));

46 
	`fûe_Êush
(
f
);

47 
	`as£π
(!(
uv±
[
	`PGNUM
(
blk
)] & 
PTE_D
));

48 
	`˝rötf
("file_flush is good\n");

50 i‡((
r
 = 
	`fûe_£t_size
(
f
, 0)) < 0)

51 
	`∑nic
("fûe_£t_size: %e", 
r
);

52 
	`as£π
(
f
->
f_dúe˘
[0] == 0);

53 
	`as£π
(!(
uv±
[
	`PGNUM
(
f
)] & 
PTE_D
));

54 
	`˝rötf
("file_truncate is good\n");

56 i‡((
r
 = 
	`fûe_£t_size
(
f
, 
	`°æí
(
msg
))) < 0)

57 
	`∑nic
("fûe_£t_sizê2: %e", 
r
);

58 
	`as£π
(!(
uv±
[
	`PGNUM
(
f
)] & 
PTE_D
));

59 i‡((
r
 = 
	`fûe_gë_block
(
f
, 0, &
blk
)) < 0)

60 
	`∑nic
("fûe_gë_block 2: %e", 
r
);

61 
	`°r˝y
(
blk
, 
msg
);

62 
	`as£π
((
uv±
[
	`PGNUM
(
blk
)] & 
PTE_D
));

63 
	`fûe_Êush
(
f
);

64 
	`as£π
(!(
uv±
[
	`PGNUM
(
blk
)] & 
PTE_D
));

65 
	`as£π
(!(
uv±
[
	`PGNUM
(
f
)] & 
PTE_D
));

66 
	`˝rötf
("fileÑewrite is good\n");

67 
	}
}

	@inc/args.h

1 #i‚de‡
JOS_INC_ARGS_H


2 
	#JOS_INC_ARGS_H


	)

4 
	gArg°©e
;

10 
¨g°¨t
(*
¨gc
, **
¨gv
, 
Arg°©e
 *
¨gs
);

24 
¨g√xt
(
Arg°©e
 *);

31 *
¨g√xtvÆue
(
Arg°©e
 *);

36 *
¨gvÆue
(
Arg°©e
 *);

75 
	sArg°©e
 {

76 *
	m¨gc
;

77 c⁄° **
	m¨gv
;

78 c⁄° *
	mcuørg
;

79 c⁄° *
	m¨gvÆue
;

	@inc/assert.h

3 #i‚de‡
JOS_INC_ASSERT_H


4 
	#JOS_INC_ASSERT_H


	)

6 
	~<öc/°dio.h
>

8 
_w¨n
(const *, , const *, ...);

9 
	$_∑nic
(c⁄° *, , c⁄° *, ...Ë
	`__©åibuã__
((
n‹ëu∫
));

11 
	#w¨n
(...Ë
	`_w¨n
(
__FILE__
, 
__LINE__
, 
__VA_ARGS__
)

	)

12 
	#∑nic
(...Ë
	`_∑nic
(
__FILE__
, 
__LINE__
, 
__VA_ARGS__
)

	)

14 
	#as£π
(
x
) \

15 dÿ{ i‡(!(
x
)Ë
	`∑nic
("as£πi⁄ faûed: %s", #x); 
	}
} 0)

	)

18 
	#°©ic_as£π
(
x
ËxË0: (x):

	)

	@inc/elf.h

1 #i‚de‡
JOS_INC_ELF_H


2 
	#JOS_INC_ELF_H


	)

4 
	#ELF_MAGIC
 0x464C457FU

	)

6 
	sElf
 {

7 
uöt32_t
 
	me_magic
;

8 
uöt8_t
 
	me_ñf
[12];

9 
uöt16_t
 
	me_ty≥
;

10 
uöt16_t
 
	me_machöe
;

11 
uöt32_t
 
	me_vîsi⁄
;

12 
uöt32_t
 
	me_íåy
;

13 
uöt32_t
 
	me_phoff
;

14 
uöt32_t
 
	me_shoff
;

15 
uöt32_t
 
	me_Êags
;

16 
uöt16_t
 
	me_ehsize
;

17 
uöt16_t
 
	me_phítsize
;

18 
uöt16_t
 
	me_phnum
;

19 
uöt16_t
 
	me_shítsize
;

20 
uöt16_t
 
	me_shnum
;

21 
uöt16_t
 
	me_sh°∫dx
;

24 
	sProghdr
 {

25 
uöt32_t
 
	mp_ty≥
;

26 
uöt32_t
 
	mp_off£t
;

27 
uöt32_t
 
	mp_va
;

28 
uöt32_t
 
	mp_∑
;

29 
uöt32_t
 
	mp_fûesz
;

30 
uöt32_t
 
	mp_memsz
;

31 
uöt32_t
 
	mp_Êags
;

32 
uöt32_t
 
	mp_Æign
;

35 
	sSe˘hdr
 {

36 
uöt32_t
 
	msh_«me
;

37 
uöt32_t
 
	msh_ty≥
;

38 
uöt32_t
 
	msh_Êags
;

39 
uöt32_t
 
	msh_addr
;

40 
uöt32_t
 
	msh_off£t
;

41 
uöt32_t
 
	msh_size
;

42 
uöt32_t
 
	msh_lök
;

43 
uöt32_t
 
	msh_öfo
;

44 
uöt32_t
 
	msh_addølign
;

45 
uöt32_t
 
	msh_ítsize
;

49 
	#ELF_PROG_LOAD
 1

	)

52 
	#ELF_PROG_FLAG_EXEC
 1

	)

53 
	#ELF_PROG_FLAG_WRITE
 2

	)

54 
	#ELF_PROG_FLAG_READ
 4

	)

57 
	#ELF_SHT_NULL
 0

	)

58 
	#ELF_SHT_PROGBITS
 1

	)

59 
	#ELF_SHT_SYMTAB
 2

	)

60 
	#ELF_SHT_STRTAB
 3

	)

63 
	#ELF_SHN_UNDEF
 0

	)

	@inc/env.h

3 #i‚de‡
JOS_INC_ENV_H


4 
	#JOS_INC_ENV_H


	)

6 
	~<öc/ty≥s.h
>

7 
	~<öc/å≠.h
>

8 
	~<öc/memœyout.h
>

10 
öt32_t
 
	tívid_t
;

28 
	#LOG2NENV
 10

	)

29 
	#NENV
 (1 << 
LOG2NENV
)

	)

30 
	#ENVX
(
ívid
Ë(”nvidË& (
NENV
 - 1))

	)

34 
	mENV_FREE
 = 0,

35 
	mENV_DYING
,

36 
	mENV_RUNNABLE
,

37 
	mENV_RUNNING
,

38 
	mENV_NOT_RUNNABLE


42 
	eEnvTy≥
 {

43 
	mENV_TYPE_USER
 = 0,

44 
	mENV_TYPE_FS
,

47 
	sEnv
 {

48 
Tøp‰ame
 
	mív_tf
;

49 
Env
 *
	mív_lök
;

50 
ívid_t
 
	mív_id
;

51 
ívid_t
 
	mív_∑ª¡_id
;

52 
EnvTy≥
 
	mív_ty≥
;

53 
	mív_°©us
;

54 
uöt32_t
 
	mív_runs
;

55 
	mív_˝unum
;

58 
pde_t
 *
	mív_pgdú
;

61 *
	mív_pgÁu…_upˇŒ
;

64 
boﬁ
 
	mív_ùc_ªcvög
;

65 *
	mív_ùc_d°va
;

66 
uöt32_t
 
	mív_ùc_vÆue
;

67 
ívid_t
 
	mív_ùc_‰om
;

68 
	mív_ùc_≥rm
;

	@inc/error.h

3 #i‚de‡
JOS_INC_ERROR_H


4 
	#JOS_INC_ERROR_H


	)

8 
	mE_UNSPECIFIED
 = 1,

9 
	mE_BAD_ENV
 ,

11 
	mE_INVAL
 ,

12 
	mE_NO_MEM
 ,

13 
	mE_NO_FREE_ENV
 ,

15 
	mE_FAULT
 ,

17 
	mE_IPC_NOT_RECV
 ,

18 
	mE_EOF
 ,

21 
	mE_NO_DISK
 ,

22 
	mE_MAX_OPEN
 ,

23 
	mE_NOT_FOUND
 ,

24 
	mE_BAD_PATH
 ,

25 
	mE_FILE_EXISTS
 ,

26 
	mE_NOT_EXEC
 ,

27 
	mE_NOT_SUPP
 ,

29 
	mMAXERROR


	@inc/fd.h

5 #i‚de‡
JOS_INC_FD_H


6 
	#JOS_INC_FD_H


	)

8 
	~<öc/ty≥s.h
>

9 
	~<öc/fs.h
>

11 
	gFd
;

12 
	gSèt
;

13 
	gDev
;

16 
	sDev
 {

17 
	mdev_id
;

18 c⁄° *
	mdev_«me
;

19 
ssize_t
 (*
dev_ªad
)(
Fd
 *
	mfd
, *
	mbuf
, 
size_t
 
	mÀn
);

20 
ssize_t
 (*
dev_wrôe
)(
Fd
 *
	mfd
, c⁄° *
	mbuf
, 
size_t
 
	mÀn
);

21 (*
	mdev_˛o£
)(
Fd
 *
	mfd
);

22 (*
	mdev_°©
)(
Fd
 *
	mfd
, 
Sèt
 *
	m°©
);

23 (*
	mdev_åunc
)(
Fd
 *
	mfd
, 
off_t
 
	mÀngth
);

26 
	sFdFûe
 {

27 
	mid
;

30 
	sFd
 {

31 
	mfd_dev_id
;

32 
off_t
 
	mfd_off£t
;

33 
	mfd_omode
;

36 
FdFûe
 
	mfd_fûe
;

40 
	sSèt
 {

41 
	m°_«me
[
MAXNAMELEN
];

42 
off_t
 
	m°_size
;

43 
	m°_isdú
;

44 
Dev
 *
	m°_dev
;

47 * 
fd2d©a
(
Fd
 *
fd
);

48 
fd2num
(
Fd
 *
fd
);

49 
fd_Æloc
(
Fd
 **
fd_°‹e
);

50 
fd_˛o£
(
Fd
 *
fd
, 
boﬁ
 
mu°_exi°
);

51 
fd_lookup
(
fdnum
, 
Fd
 **
fd_°‹e
);

52 
dev_lookup
(
devid
, 
Dev
 **
dev_°‹e
);

54 
Dev
 
devfûe
;

55 
Dev
 
devc⁄s
;

56 
Dev
 
devpùe
;

	@inc/fs.h

3 #i‚de‡
JOS_INC_FS_H


4 
	#JOS_INC_FS_H


	)

6 
	~<öc/ty≥s.h
>

7 
	~<öc/mmu.h
>

12 
	#BLKSIZE
 
PGSIZE


	)

13 
	#BLKBITSIZE
 (
BLKSIZE
 * 8)

	)

17 
	#MAXNAMELEN
 128

	)

20 
	#MAXPATHLEN
 1024

	)

23 
	#NDIRECT
 10

	)

25 
	#NINDIRECT
 (
BLKSIZE
 / 4)

	)

27 
	#MAXFILESIZE
 ((
NDIRECT
 + 
NINDIRECT
Ë* 
BLKSIZE
)

	)

29 
	sFûe
 {

30 
	mf_«me
[
MAXNAMELEN
];

31 
off_t
 
	mf_size
;

32 
uöt32_t
 
	mf_ty≥
;

36 
uöt32_t
 
	mf_dúe˘
[
NDIRECT
];

37 
uöt32_t
 
	mf_ödúe˘
;

41 
uöt8_t
 
	mf_∑d
[256 - 
MAXNAMELEN
 - 8 - 4*
NDIRECT
 - 4];

42 } 
__©åibuã__
((
∑cked
));

45 
	#BLKFILES
 (
BLKSIZE
 / (
Fûe
))

	)

48 
	#FTYPE_REG
 0

49 
	#FTYPE_DIR
 1

50 

	)

54 
	#FS_MAGIC
 0x4A0530AE

55 

	)

56 
	sSu≥r
 {

57 
uöt32_t
 
	ms_magic
;

58 
uöt32_t
 
	ms_nblocks
;

59 
Fûe
 
	ms_roŸ
;

64 
	mFSREQ_OPEN
 = 1,

65 
	mFSREQ_SET_SIZE
,

67 
	mFSREQ_READ
,

68 
	mFSREQ_WRITE
,

70 
	mFSREQ_STAT
,

71 
	mFSREQ_FLUSH
,

72 
	mFSREQ_REMOVE
,

73 
	mFSREQ_SYNC


76 
	uFsùc
 {

77 
	sF§eq_›í
 {

78 
	mªq_∑th
[
MAXPATHLEN
];

79 
	mªq_omode
;

80 } 
	m›í
;

81 
	sF§eq_£t_size
 {

82 
	mªq_fûeid
;

83 
off_t
 
	mªq_size
;

84 } 
	m£t_size
;

85 
	sF§eq_ªad
 {

86 
	mªq_fûeid
;

87 
size_t
 
	mªq_n
;

88 } 
	mªad
;

89 
	sF§ë_ªad
 {

90 
	mªt_buf
[
PGSIZE
];

91 } 
	mªadRë
;

92 
	sF§eq_wrôe
 {

93 
	mªq_fûeid
;

94 
size_t
 
	mªq_n
;

95 
	mªq_buf
[
PGSIZE
 - ((Ë+ (
size_t
))];

96 } 
	mwrôe
;

97 
	sF§eq_°©
 {

98 
	mªq_fûeid
;

99 } 
	m°©
;

100 
	sF§ë_°©
 {

101 
	mªt_«me
[
MAXNAMELEN
];

102 
off_t
 
	mªt_size
;

103 
	mªt_isdú
;

104 } 
	m°©Rë
;

105 
	sF§eq_Êush
 {

106 
	mªq_fûeid
;

107 } 
	mÊush
;

108 
	sF§eq_ªmove
 {

109 
	mªq_∑th
[
MAXPATHLEN
];

110 } 
	mªmove
;

113 
	m_∑d
[
PGSIZE
];

	@inc/kbdreg.h

1 #i‚de‡
JOS_KBDREG_H


2 
	#JOS_KBDREG_H


	)

5 
	#KEY_HOME
 0xE0

	)

6 
	#KEY_END
 0xE1

	)

7 
	#KEY_UP
 0xE2

	)

8 
	#KEY_DN
 0xE3

	)

9 
	#KEY_LF
 0xE4

	)

10 
	#KEY_RT
 0xE5

	)

11 
	#KEY_PGUP
 0xE6

	)

12 
	#KEY_PGDN
 0xE7

	)

13 
	#KEY_INS
 0xE8

	)

14 
	#KEY_DEL
 0xE9

	)

19 
	#KBSTATP
 0x64

	)

20 
	#KBS_DIB
 0x01

	)

21 
	#KBS_IBF
 0x02

	)

22 
	#KBS_WARM
 0x04

	)

23 
	#KBS_OCMD
 0x08

	)

24 
	#KBS_NOSEC
 0x10

	)

25 
	#KBS_TERR
 0x20

	)

26 
	#KBS_RERR
 0x40

	)

27 
	#KBS_PERR
 0x80

	)

29 
	#KBCMDP
 0x64

	)

30 
	#KBC_RAMREAD
 0x20

	)

31 
	#KBC_RAMWRITE
 0x60

	)

32 
	#KBC_AUXDISABLE
 0xa7

	)

33 
	#KBC_AUXENABLE
 0xa8

	)

34 
	#KBC_AUXTEST
 0xa9

	)

35 
	#KBC_KBDECHO
 0xd2

	)

36 
	#KBC_AUXECHO
 0xd3

	)

37 
	#KBC_AUXWRITE
 0xd4

	)

38 
	#KBC_SELFTEST
 0xØ

	)

39 
	#KBC_KBDTEST
 0xab

	)

40 
	#KBC_KBDDISABLE
 0xad

	)

41 
	#KBC_KBDENABLE
 0x´

	)

42 
	#KBC_PULSE0
 0x„

	)

43 
	#KBC_PULSE1
 0xfd

	)

44 
	#KBC_PULSE2
 0xfb

	)

45 
	#KBC_PULSE3
 0xf7

	)

47 
	#KBDATAP
 0x60

	)

48 
	#KBOUTP
 0x60

	)

50 
	#K_RDCMDBYTE
 0x20

	)

51 
	#K_LDCMDBYTE
 0x60

	)

53 
	#KC8_TRANS
 0x40

	)

54 
	#KC8_MDISABLE
 0x20

	)

55 
	#KC8_KDISABLE
 0x10

	)

56 
	#KC8_IGNSEC
 0x08

	)

57 
	#KC8_CPU
 0x04

	)

58 
	#KC8_MENABLE
 0x02

	)

59 
	#KC8_KENABLE
 0x01

	)

60 
	#CMDBYTE
 (
KC8_TRANS
|
KC8_CPU
|
KC8_MENABLE
|
KC8_KENABLE
)

	)

63 
	#KBC_RESET
 0xFF

	)

64 
	#KBC_RESEND
 0xFE

	)

65 
	#KBC_SETDEFAULT
 0xF6

	)

66 
	#KBC_DISABLE
 0xF5

	)

67 
	#KBC_ENABLE
 0xF4

	)

68 
	#KBC_TYPEMATIC
 0xF3

	)

69 
	#KBC_SETTABLE
 0xF0

	)

70 
	#KBC_MODEIND
 0xED

	)

71 
	#KBC_ECHO
 0xEE

	)

74 
	#KBR_EXTENDED
 0xE0

	)

75 
	#KBR_RESEND
 0xFE

	)

76 
	#KBR_ACK
 0xFA

	)

77 
	#KBR_OVERRUN
 0x00

	)

78 
	#KBR_FAILURE
 0xFD

	)

79 
	#KBR_BREAK
 0xF0

	)

80 
	#KBR_RSTDONE
 0xAA

	)

81 
	#KBR_ECHO
 0xEE

	)

	@inc/lib.h

7 #i‚de‡
JOS_INC_LIB_H


8 
	#JOS_INC_LIB_H
 1

	)

10 
	~<öc/ty≥s.h
>

11 
	~<öc/°dio.h
>

12 
	~<öc/°d¨g.h
>

13 
	~<öc/°rög.h
>

14 
	~<öc/îr‹.h
>

15 
	~<öc/as£π.h
>

16 
	~<öc/ív.h
>

17 
	~<öc/memœyout.h
>

18 
	~<öc/sysˇŒ.h
>

19 
	~<öc/å≠.h
>

20 
	~<öc/fs.h
>

21 
	~<öc/fd.h
>

22 
	~<öc/¨gs.h
>

24 
	#USED
(
x
Ë()(x)

	)

27 
umaö
(
¨gc
, **
¨gv
);

30 c⁄° *
bö¨y«me
;

31 c⁄° vﬁ©ûê
Env
 *
thi£nv
;

32 c⁄° vﬁ©ûê
Env
 
ívs
[
NENV
];

33 c⁄° vﬁ©ûê
PageInfo
 
∑ges
[];

36 
exô
();

39 
£t_pgÁu…_h™dÀr
((*
h™dÀr
)(
UTøp‰ame
 *
utf
));

42 * 
	`ªadlöe
(c⁄° *
buf
);

45 
	`sys_˝uts
(c⁄° *
°rög
, 
size_t
 
Àn
);

46 
	`sys_cgëc
();

47 
ívid_t
 
	`sys_gëívid
();

48 
	`sys_ív_de°roy
(
ívid_t
);

49 
	`sys_yõld
();

50 
ívid_t
 
	`sys_exof‹k
();

51 
	`sys_ív_£t_°©us
(
ívid_t
 
ív
, 
°©us
);

52 
	`sys_ív_£t_å≠‰ame
(
ívid_t
 
ív
, 
Tøp‰ame
 *
tf
);

53 
	`sys_ív_£t_pgÁu…_upˇŒ
(
ívid_t
 
ív
, *
upˇŒ
);

54 
	`sys_∑ge_Æloc
(
ívid_t
 
ív
, *
pg
, 
≥rm
);

55 
	`sys_∑ge_m≠
(
ívid_t
 
§c_ív
, *
§c_pg
,

56 
ívid_t
 
d°_ív
, *
d°_pg
, 
≥rm
);

57 
	`sys_∑ge_unm≠
(
ívid_t
 
ív
, *
pg
);

58 
	`sys_ùc_åy_£nd
(
ívid_t
 
to_ív
, 
uöt32_t
 
vÆue
, *
pg
, 
≥rm
);

59 
	`sys_ùc_ªcv
(*
rcv_pg
);

62 
ölöe
 
ívid_t
 
	`__©åibuã__
((
Æways_ölöe
))

63 
	$sys_exof‹k
()

65 
ívid_t
 
ªt
;

66 
asm
 volatile("int %2"

67 : "˜" (
ªt
)

68 : "a" (
SYS_exof‹k
), "i" (
T_SYSCALL
));

69  
ªt
;

70 
	}
}

73 
ùc_£nd
(
ívid_t
 
to_ív
, 
uöt32_t
 
vÆue
, *
pg
, 
≥rm
);

74 
öt32_t
 
ùc_ªcv
(
ívid_t
 *
‰om_ív_°‹e
, *
pg
, *
≥rm_°‹e
);

75 
ívid_t
 
ùc_föd_ív
(
EnvTy≥
 
ty≥
);

78 
	#PTE_SHARE
 0x400

	)

79 
ívid_t
 
f‹k
();

80 
ívid_t
 
sf‹k
();

83 
˛o£
(
fd
);

84 
ssize_t
 
ªad
(
fd
, *
buf
, 
size_t
 
nbyãs
);

85 
ssize_t
 
wrôe
(
fd
, c⁄° *
buf
, 
size_t
 
nbyãs
);

86 
£ek
(
fd
, 
off_t
 
off£t
);

87 
˛o£_Æl
();

88 
ssize_t
 
ªadn
(
fd
, *
buf
, 
size_t
 
nbyãs
);

89 
dup
(
ﬁdfd
, 
√wfd
);

90 
f°©
(
fd
, 
Sèt
 *
°©buf
);

91 
°©
(c⁄° *
∑th
, 
Sèt
 *
°©buf
);

94 
›í
(c⁄° *
∑th
, 
mode
);

95 
·runˇã
(
fd
, 
off_t
 
size
);

96 
ªmove
(c⁄° *
∑th
);

97 
sync
();

100 
∑gîef
(*
addr
);

104 
ívid_t
 
•awn
(c⁄° *
¥ogøm
, c⁄° **
¨gv
);

105 
ívid_t
 
•aw∆
(c⁄° *
¥ogøm
, c⁄° *
¨g0
, ...);

108 
˝utch¨
(
c
);

109 
gëch¨
();

110 
isc⁄s
(
fd
);

111 
›íc⁄s
();

114 
pùe
(
pùefds
[2]);

115 
pùeis˛o£d
(
pùefd
);

118 
waô
(
ívid_t
 
ív
);

121 
	#O_RDONLY
 0x0000

	)

122 
	#O_WRONLY
 0x0001

	)

123 
	#O_RDWR
 0x0002

	)

124 
	#O_ACCMODE
 0x0003

	)

126 
	#O_CREAT
 0x0100

	)

127 
	#O_TRUNC
 0x0200

	)

128 
	#O_EXCL
 0x0400

	)

129 
	#O_MKDIR
 0x0800

	)

	@inc/memlayout.h

1 #i‚de‡
JOS_INC_MEMLAYOUT_H


2 
	#JOS_INC_MEMLAYOUT_H


	)

4 #i‚de‡
__ASSEMBLER__


5 
	~<öc/ty≥s.h
>

6 
	~<öc/mmu.h
>

15 
	#GD_KT
 0x08

16 
	#GD_KD
 0x10

17 
	#GD_UT
 0x18

18 
	#GD_UD
 0x20

19 
	#GD_TSS0
 0x28

20 

	)

87 
	#KERNBASE
 0xF0000000

	)

92 
	#IOPHYSMEM
 0x0A0000

	)

93 
	#EXTPHYSMEM
 0x100000

	)

96 
	#KSTACKTOP
 
KERNBASE


	)

97 
	#KSTKSIZE
 (8*
PGSIZE
)

98 
	#KSTKGAP
 (8*
PGSIZE
)

99 

	)

101 
	#MMIOLIM
 (
KSTACKTOP
 - 
PTSIZE
)

	)

102 
	#MMIOBASE
 (
MMIOLIM
 - 
PTSIZE
)

	)

104 
	#ULIM
 (
MMIOBASE
)

	)

112 
	#UVPT
 (
ULIM
 - 
PTSIZE
)

	)

114 
	#UPAGES
 (
UVPT
 - 
PTSIZE
)

	)

116 
	#UENVS
 (
UPAGES
 - 
PTSIZE
)

	)

123 
	#UTOP
 
UENVS


	)

125 
	#UXSTACKTOP
 
UTOP


	)

128 
	#USTACKTOP
 (
UTOP
 - 2*
PGSIZE
)

	)

131 
	#UTEXT
 (2*
PTSIZE
)

	)

134 
	#UTEMP
 ((*Ë
PTSIZE
)

	)

137 
	#PFTEMP
 (
UTEMP
 + 
PTSIZE
 - 
PGSIZE
)

	)

139 
	#USTABDATA
 (
PTSIZE
 / 2)

	)

142 
	#MPENTRY_PADDR
 0x7000

	)

144 #i‚de‡
__ASSEMBLER__


146 
uöt32_t
 
	t±e_t
;

147 
uöt32_t
 
	tpde_t
;

149 #i‡
JOS_USER


164 vﬁ©ûê
±e_t
 
uv±
[];

165 vﬁ©ûê
pde_t
 
uvpd
[];

178 
	sPageInfo
 {

180 
PageInfo
 *
	mµ_lök
;

187 
uöt16_t
 
	mµ_ªf
;

	@inc/mmu.h

1 #i‚de‡
JOS_INC_MMU_H


2 
	#JOS_INC_MMU_H


	)

30 
	#PGNUM
(
œ
Ë(((
uöçå_t
Ë÷a)Ë>> 
PTXSHIFT
)

	)

33 
	#PDX
(
œ
Ë((((
uöçå_t
Ë÷a)Ë>> 
PDXSHIFT
Ë& 0x3FF)

	)

36 
	#PTX
(
œ
Ë((((
uöçå_t
Ë÷a)Ë>> 
PTXSHIFT
Ë& 0x3FF)

	)

39 
	#PGOFF
(
œ
Ë(((
uöçå_t
Ë÷a)Ë& 0xFFF)

	)

42 
	#PGADDR
(
d
, 
t
, 
o
Ë((*Ë((dË<< 
PDXSHIFT
 | (tË<< 
PTXSHIFT
 | (o)))

	)

45 
	#NPDENTRIES
 1024

46 
	#NPTENTRIES
 1024

47 

	)

48 
	#PGSIZE
 4096

49 
	#PGSHIFT
 12

50 

	)

51 
	#PTSIZE
 (
PGSIZE
*
NPTENTRIES
)

52 
	#PTSHIFT
 22

53 

	)

54 
	#PTXSHIFT
 12

55 
	#PDXSHIFT
 22

56 

	)

58 
	#PTE_P
 0x001

59 
	#PTE_W
 0x002

60 
	#PTE_U
 0x004

61 
	#PTE_PWT
 0x008

62 
	#PTE_PCD
 0x010

63 
	#PTE_A
 0x020

64 
	#PTE_D
 0x040

65 
	#PTE_PS
 0x080

66 
	#PTE_G
 0x100

67 

	)

70 
	#PTE_AVAIL
 0xE00

71 

	)

73 
	#PTE_SYSCALL
 (
PTE_AVAIL
 | 
PTE_P
 | 
PTE_W
 | 
PTE_U
)

	)

76 
	#PTE_ADDR
(
±e
Ë((
phyßddr_t
Ë’ãË& ~0xFFF)

	)

79 
	#CR0_PE
 0x00000001

80 
	#CR0_MP
 0x00000002

81 
	#CR0_EM
 0x00000004

82 
	#CR0_TS
 0x00000008

83 
	#CR0_ET
 0x00000010

84 
	#CR0_NE
 0x00000020

85 
	#CR0_WP
 0x00010000

86 
	#CR0_AM
 0x00040000

87 
	#CR0_NW
 0x20000000

88 
	#CR0_CD
 0x40000000

89 
	#CR0_PG
 0x80000000

90 

	)

91 
	#CR4_PCE
 0x00000100

92 
	#CR4_MCE
 0x00000040

93 
	#CR4_PSE
 0x00000010

94 
	#CR4_DE
 0x00000008

95 
	#CR4_TSD
 0x00000004

96 
	#CR4_PVI
 0x00000002

97 
	#CR4_VME
 0x00000001

98 

	)

100 
	#FL_CF
 0x00000001

101 
	#FL_PF
 0x00000004

102 
	#FL_AF
 0x00000010

103 
	#FL_ZF
 0x00000040

104 
	#FL_SF
 0x00000080

105 
	#FL_TF
 0x00000100

106 
	#FL_IF
 0x00000200

107 
	#FL_DF
 0x00000400

108 
	#FL_OF
 0x00000800

109 
	#FL_IOPL_MASK
 0x00003000

110 
	#FL_IOPL_0
 0x00000000

111 
	#FL_IOPL_1
 0x00001000

112 
	#FL_IOPL_2
 0x00002000

113 
	#FL_IOPL_3
 0x00003000

114 
	#FL_NT
 0x00004000

115 
	#FL_RF
 0x00010000

116 
	#FL_VM
 0x00020000

117 
	#FL_AC
 0x00040000

118 
	#FL_VIF
 0x00080000

119 
	#FL_VIP
 0x00100000

120 
	#FL_ID
 0x00200000

121 

	)

123 
	#FEC_PR
 0x1

124 
	#FEC_WR
 0x2

125 
	#FEC_U
 0x4

126 

	)

134 #ifde‡
__ASSEMBLER__


139 
	#SEG_NULL
 \

140 .
w‹d
 0, 0; \

141 .
byã
 0, 0, 0, 0

	)

142 
	#SEG
(
ty≥
,
ba£
,
lim
) \

143 .
	`w‹d
 (((
lim
Ë>> 12Ë& 0xffff), ((
ba£
) & 0xffff); \

144 .
	`byã
 (((
ba£
Ë>> 16Ë& 0xff), (0x90 | (
ty≥
)), \

145 (0xC0 | (((
lim
Ë>> 28Ë& 0xf)), (((
ba£
Ë>> 24Ë& 0xff)

	)

149 
	~<öc/ty≥s.h
>

152 
	sSegdesc
 {

153 
	msd_lim_15_0
 : 16;

154 
	msd_ba£_15_0
 : 16;

155 
	msd_ba£_23_16
 : 8;

156 
	msd_ty≥
 : 4;

157 
	msd_s
 : 1;

158 
	msd_d∂
 : 2;

159 
	msd_p
 : 1;

160 
	msd_lim_19_16
 : 4;

161 
	msd_avl
 : 1;

162 
	msd_rsv1
 : 1;

163 
	msd_db
 : 1;

164 
	msd_g
 : 1;

165 
	msd_ba£_31_24
 : 8;

168 
	#SEG_NULL
 { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 }

	)

170 
	#SEG_FAULT
 { 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0 }

	)

172 
	#SEG
(
ty≥
, 
ba£
, 
lim
, 
d∂
) \

173 { ((
lim
Ë>> 12Ë& 0xffff, (
ba£
) & 0xffff, ((base) >> 16) & 0xff, \

174 
ty≥
, 1, 
d∂
, 1, (Ë(
lim
) >> 28, 0, 0, 1, 1, \

175 (Ë(
ba£
Ë>> 24 }

	)

176 
	#SEG16
(
ty≥
, 
ba£
, 
lim
, 
d∂
Ë(
Segdesc
) \

177 { (
lim
Ë& 0xffff, (
ba£
) & 0xffff, ((base) >> 16) & 0xff, \

178 
ty≥
, 1, 
d∂
, 1, (Ë(
lim
) >> 16, 0, 0, 1, 0, \

179 (Ë(
ba£
Ë>> 24 }

	)

184 
	#STA_X
 0x8

185 
	#STA_E
 0x4

186 
	#STA_C
 0x4

187 
	#STA_W
 0x2

188 
	#STA_R
 0x2

189 
	#STA_A
 0x1

190 

	)

192 
	#STS_T16A
 0x1

193 
	#STS_LDT
 0x2

194 
	#STS_T16B
 0x3

195 
	#STS_CG16
 0x4

196 
	#STS_TG
 0x5

197 
	#STS_IG16
 0x6

198 
	#STS_TG16
 0x7

199 
	#STS_T32A
 0x9

200 
	#STS_T32B
 0xB

201 
	#STS_CG32
 0xC

202 
	#STS_IG32
 0xE

203 
	#STS_TG32
 0xF

204 

	)

212 #i‚de‡
__ASSEMBLER__


215 
	sTask°©e
 {

216 
uöt32_t
 
	mts_lök
;

217 
uöçå_t
 
	mts_e•0
;

218 
uöt16_t
 
	mts_ss0
;

219 
uöt16_t
 
	mts_∑ddög1
;

220 
uöçå_t
 
	mts_e•1
;

221 
uöt16_t
 
	mts_ss1
;

222 
uöt16_t
 
	mts_∑ddög2
;

223 
uöçå_t
 
	mts_e•2
;

224 
uöt16_t
 
	mts_ss2
;

225 
uöt16_t
 
	mts_∑ddög3
;

226 
phyßddr_t
 
	mts_¸3
;

227 
uöçå_t
 
	mts_eù
;

228 
uöt32_t
 
	mts_eÊags
;

229 
uöt32_t
 
	mts_óx
;

230 
uöt32_t
 
	mts_ecx
;

231 
uöt32_t
 
	mts_edx
;

232 
uöt32_t
 
	mts_ebx
;

233 
uöçå_t
 
	mts_e•
;

234 
uöçå_t
 
	mts_ebp
;

235 
uöt32_t
 
	mts_esi
;

236 
uöt32_t
 
	mts_edi
;

237 
uöt16_t
 
	mts_es
;

238 
uöt16_t
 
	mts_∑ddög4
;

239 
uöt16_t
 
	mts_cs
;

240 
uöt16_t
 
	mts_∑ddög5
;

241 
uöt16_t
 
	mts_ss
;

242 
uöt16_t
 
	mts_∑ddög6
;

243 
uöt16_t
 
	mts_ds
;

244 
uöt16_t
 
	mts_∑ddög7
;

245 
uöt16_t
 
	mts_fs
;

246 
uöt16_t
 
	mts_∑ddög8
;

247 
uöt16_t
 
	mts_gs
;

248 
uöt16_t
 
	mts_∑ddög9
;

249 
uöt16_t
 
	mts_ldt
;

250 
uöt16_t
 
	mts_∑ddög10
;

251 
uöt16_t
 
	mts_t
;

252 
uöt16_t
 
	mts_iomb
;

256 
	sG©edesc
 {

257 
	mgd_off_15_0
 : 16;

258 
	mgd_£l
 : 16;

259 
	mgd_¨gs
 : 5;

260 
	mgd_rsv1
 : 3;

261 
	mgd_ty≥
 : 4;

262 
	mgd_s
 : 1;

263 
	mgd_d∂
 : 2;

264 
	mgd_p
 : 1;

265 
	mgd_off_31_16
 : 16;

282 
	#SETGATE
(
g©e
, 
i°øp
, 
£l
, 
off
, 
d∂
) \

284 (
g©e
).
gd_off_15_0
 = (
uöt32_t
Ë(
off
) & 0xffff; \

285 (
g©e
).
gd_£l
 = (
£l
); \

286 (
g©e
).
gd_¨gs
 = 0; \

287 (
g©e
).
gd_rsv1
 = 0; \

288 (
g©e
).
gd_ty≥
 = (
i°øp
Ë? 
STS_TG32
 : 
STS_IG32
; \

289 (
g©e
).
gd_s
 = 0; \

290 (
g©e
).
gd_d∂
 = (
d∂
); \

291 (
g©e
).
gd_p
 = 1; \

292 (
g©e
).
gd_off_31_16
 = (
uöt32_t
Ë(
off
) >> 16; \

293 }

	)

296 
	#SETCALLGATE
(
g©e
, 
£l
, 
off
, 
d∂
) \

298 (
g©e
).
gd_off_15_0
 = (
uöt32_t
Ë(
off
) & 0xffff; \

299 (
g©e
).
gd_£l
 = (
£l
); \

300 (
g©e
).
gd_¨gs
 = 0; \

301 (
g©e
).
gd_rsv1
 = 0; \

302 (
g©e
).
gd_ty≥
 = 
STS_CG32
; \

303 (
g©e
).
gd_s
 = 0; \

304 (
g©e
).
gd_d∂
 = (
d∂
); \

305 (
g©e
).
gd_p
 = 1; \

306 (
g©e
).
gd_off_31_16
 = (
uöt32_t
Ë(
off
) >> 16; \

307 }

	)

310 
	sP£udodesc
 {

311 
uöt16_t
 
	mpd_lim
;

312 
uöt32_t
 
	mpd_ba£
;

313 } 
__©åibuã__
 ((
∑cked
));

	@inc/partition.h

1 #i‚de‡
JOS_INC_PARTITION_H


2 
	#JOS_INC_PARTITION_H


	)

3 
	~<öc/ty≥s.h
>

11 
	#PTABLE_OFFSET
 446

	)

13 
	#PTABLE_MAGIC_OFFSET
 510

	)

14 
	#PTABLE_MAGIC
 "\x55\xAA"

	)

17 
	#PTYPE_JOS_KERN
 0x27

18 
	#PTYPE_JOSFS
 0x28

20 
	#PTYPE_DOS_EXTENDED
 0x05

	)

21 
	#PTYPE_W95_EXTENDED
 0x0F

	)

22 
	#PTYPE_LINUX_EXTENDED
 0x85

	)

24 
	sP¨tôi⁄desc
 {

25 
uöt8_t
 
	mboŸ
;

26 
uöt8_t
 
	mchs_begö
[3];

27 
uöt8_t
 
	mty≥
;

28 
uöt8_t
 
	mchs_íd
[3];

29 
uöt32_t
 
	mlba_°¨t
;

30 
uöt32_t
 
	mlba_Àngth
;

	@inc/stab.h

1 #i‚de‡
JOS_STAB_H


2 
	#JOS_STAB_H


	)

3 
	~<öc/ty≥s.h
>

15 
	#N_GSYM
 0x20

16 
	#N_FNAME
 0x22

17 
	#N_FUN
 0x24

18 
	#N_STSYM
 0x26

19 
	#N_LCSYM
 0x28

20 
	#N_MAIN
 0x2a

21 
	#N_PC
 0x30

22 
	#N_RSYM
 0x40

23 
	#N_SLINE
 0x44

24 
	#N_DSLINE
 0x46

25 
	#N_BSLINE
 0x48

26 
	#N_SSYM
 0x60

27 
	#N_SO
 0x64

28 
	#N_LSYM
 0x80

29 
	#N_BINCL
 0x82

30 
	#N_SOL
 0x84

31 
	#N_PSYM
 0xa0

32 
	#N_EINCL
 0xa2

33 
	#N_ENTRY
 0xa4

34 
	#N_LBRAC
 0xc0

35 
	#N_EXCL
 0xc2

36 
	#N_RBRAC
 0xe0

37 
	#N_BCOMM
 0xe2

38 
	#N_ECOMM
 0xe4

39 
	#N_ECOML
 0xe8

40 
	#N_LENG
 0xfe

41 

	)

43 
	sSèb
 {

44 
uöt32_t
 
	mn_°rx
;

45 
uöt8_t
 
	mn_ty≥
;

46 
uöt8_t
 
	mn_Ÿhî
;

47 
uöt16_t
 
	mn_desc
;

48 
uöçå_t
 
	mn_vÆue
;

	@inc/stdarg.h

3 #i‚de‡
JOS_INC_STDARG_H


4 
	#JOS_INC_STDARG_H


	)

6 
__buûtö_va_li°
 
	tva_li°
;

8 
	#va_°¨t
(
≠
, 
œ°
Ë
	`__buûtö_va_°¨t
◊p,Üa°)

	)

10 
	#va_¨g
(
≠
, 
ty≥
Ë
	`__buûtö_va_¨g
◊p,Åy≥)

	)

12 
	#va_íd
(
≠
Ë
	`__buûtö_va_íd
◊p)

	)

	@inc/stdio.h

1 #i‚de‡
JOS_INC_STDIO_H


2 
	#JOS_INC_STDIO_H


	)

4 
	~<öc/°d¨g.h
>

6 #i‚de‡
NULL


7 
	#NULL
 ((*Ë0)

	)

11 
˝utch¨
(
c
);

12 
gëch¨
();

13 
isc⁄s
(
fd
);

16 
¥ötfmt
((*
putch
)(, *), *
putd©
, c⁄° *
fmt
, ...);

17 
	`v¥ötfmt
((*
putch
)(, *), *
putd©
, c⁄° *
fmt
, 
va_li°
);

18 
	`¢¥ötf
(*
°r
, 
size
, c⁄° *
fmt
, ...);

19 
	`v¢¥ötf
(*
°r
, 
size
, c⁄° *
fmt
, 
va_li°
);

22 
	`˝rötf
(c⁄° *
fmt
, ...);

23 
	`v˝rötf
(c⁄° *
fmt
, 
va_li°
);

26 
	`¥ötf
(c⁄° *
fmt
, ...);

27 
	`Ârötf
(
fd
, c⁄° *
fmt
, ...);

28 
	`vÂrötf
(
fd
, c⁄° *
fmt
, 
va_li°
);

31 * 
	`ªadlöe
(c⁄° *
¥om±
);

	@inc/string.h

1 #i‚de‡
JOS_INC_STRING_H


2 
	#JOS_INC_STRING_H


	)

4 
	~<öc/ty≥s.h
>

6 
°æí
(c⁄° *
s
);

7 
°∫Àn
(c⁄° *
s
, 
size_t
 
size
);

8 * 
°r˝y
(*
d°
, c⁄° *
§c
);

9 * 
°∫˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
size
);

10 * 
°rˇt
(*
d°
, c⁄° *
§c
);

11 
size_t
 
°æ˝y
(*
d°
, c⁄° *
§c
, size_à
size
);

12 
°rcmp
(c⁄° *
s1
, c⁄° *
s2
);

13 
°∫cmp
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
size
);

14 * 
°rchr
(c⁄° *
s
, 
c
);

15 * 
°rföd
(c⁄° *
s
, 
c
);

17 * 
mem£t
(*
d°
, 
c
, 
size_t
 
Àn
);

18 * 
mem˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
Àn
);

19 * 
memmove
(*
d°
, c⁄° *
§c
, 
size_t
 
Àn
);

20 
memcmp
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
Àn
);

21 * 
memföd
(c⁄° *
s
, 
c
, 
size_t
 
Àn
);

23 
°πﬁ
(c⁄° *
s
, **
íd±r
, 
ba£
);

	@inc/syscall.h

1 #i‚de‡
JOS_INC_SYSCALL_H


2 
	#JOS_INC_SYSCALL_H


	)

6 
	mSYS_˝uts
 = 0,

7 
	mSYS_cgëc
,

8 
	mSYS_gëívid
,

9 
	mSYS_ív_de°roy
,

10 
	mSYS_∑ge_Æloc
,

11 
	mSYS_∑ge_m≠
,

12 
	mSYS_∑ge_unm≠
,

13 
	mSYS_exof‹k
,

14 
	mSYS_ív_£t_°©us
,

15 
	mSYS_ív_£t_å≠‰ame
,

16 
	mSYS_ív_£t_pgÁu…_upˇŒ
,

17 
	mSYS_yõld
,

18 
	mSYS_ùc_åy_£nd
,

19 
	mSYS_ùc_ªcv
,

20 
	mNSYSCALLS


	@inc/trap.h

1 #i‚de‡
JOS_INC_TRAP_H


2 
	#JOS_INC_TRAP_H


	)

6 
	#T_DIVIDE
 0

7 
	#T_DEBUG
 1

8 
	#T_NMI
 2

9 
	#T_BRKPT
 3

10 
	#T_OFLOW
 4

11 
	#T_BOUND
 5

12 
	#T_ILLOP
 6

13 
	#T_DEVICE
 7

14 
	#T_DBLFLT
 8

16 
	#T_TSS
 10

17 
	#T_SEGNP
 11

18 
	#T_STACK
 12

19 
	#T_GPFLT
 13

20 
	#T_PGFLT
 14

22 
	#T_FPERR
 16

23 
	#T_ALIGN
 17

24 
	#T_MCHK
 18

25 
	#T_SIMDERR
 19

26 

	)

29 
	#T_SYSCALL
 48

30 
	#T_DEFAULT
 500

31 

	)

32 
	#IRQ_OFFSET
 32

33 

	)

35 
	#IRQ_TIMER
 0

	)

36 
	#IRQ_KBD
 1

	)

37 
	#IRQ_SERIAL
 4

	)

38 
	#IRQ_SPURIOUS
 7

	)

39 
	#IRQ_IDE
 14

	)

40 
	#IRQ_ERROR
 19

	)

42 #i‚de‡
__ASSEMBLER__


44 
	~<öc/ty≥s.h
>

46 
	sPushRegs
 {

48 
uöt32_t
 
	mªg_edi
;

49 
uöt32_t
 
	mªg_esi
;

50 
uöt32_t
 
	mªg_ebp
;

51 
uöt32_t
 
	mªg_€•
;

52 
uöt32_t
 
	mªg_ebx
;

53 
uöt32_t
 
	mªg_edx
;

54 
uöt32_t
 
	mªg_ecx
;

55 
uöt32_t
 
	mªg_óx
;

56 } 
__©åibuã__
((
∑cked
));

58 
	sTøp‰ame
 {

59 
PushRegs
 
	mtf_ªgs
;

60 
uöt16_t
 
	mtf_es
;

61 
uöt16_t
 
	mtf_∑ddög1
;

62 
uöt16_t
 
	mtf_ds
;

63 
uöt16_t
 
	mtf_∑ddög2
;

64 
uöt32_t
 
	mtf_å≠no
;

66 
uöt32_t
 
	mtf_îr
;

67 
uöçå_t
 
	mtf_eù
;

68 
uöt16_t
 
	mtf_cs
;

69 
uöt16_t
 
	mtf_∑ddög3
;

70 
uöt32_t
 
	mtf_eÊags
;

72 
uöçå_t
 
	mtf_e•
;

73 
uöt16_t
 
	mtf_ss
;

74 
uöt16_t
 
	mtf_∑ddög4
;

75 } 
__©åibuã__
((
∑cked
));

77 
	sUTøp‰ame
 {

79 
uöt32_t
 
	mutf_Áu…_va
;

80 
uöt32_t
 
	mutf_îr
;

82 
PushRegs
 
	mutf_ªgs
;

83 
uöçå_t
 
	mutf_eù
;

84 
uöt32_t
 
	mutf_eÊags
;

86 
uöçå_t
 
	mutf_e•
;

87 } 
__©åibuã__
((
∑cked
));

	@inc/types.h

1 #i‚de‡
JOS_INC_TYPES_H


2 
	#JOS_INC_TYPES_H


	)

4 #i‚de‡
NULL


5 
	#NULL
 ((*Ë0)

	)

9 
_Boﬁ
 
	tboﬁ
;

10 íum { 
	mÁl£
, 
	måue
 };

13 
__sig√d
 
	töt8_t
;

14 
	tuöt8_t
;

15 
	töt16_t
;

16 
	tuöt16_t
;

17 
	töt32_t
;

18 
	tuöt32_t
;

19 
	töt64_t
;

20 
	tuöt64_t
;

26 
öt32_t
 
	töçå_t
;

27 
uöt32_t
 
	tuöçå_t
;

28 
uöt32_t
 
	tphyßddr_t
;

31 
uöt32_t
 
	tµn_t
;

34 
uöt32_t
 
	tsize_t
;

37 
öt32_t
 
	tssize_t
;

40 
öt32_t
 
	toff_t
;

43 
	#MIN
(
_a
, 
_b
) \

45 
	`ty≥of
(
_a
Ë
__a
 = (_a); \

46 
	`ty≥of
(
_b
Ë
__b
 = (_b); \

47 
__a
 <
__b
 ? __a : __b; \

48 })

	)

49 
	#MAX
(
_a
, 
_b
) \

51 
	`ty≥of
(
_a
Ë
__a
 = (_a); \

52 
	`ty≥of
(
_b
Ë
__b
 = (_b); \

53 
__a
 >
__b
 ? __a : __b; \

54 })

	)

58 
	#ROUNDDOWN
(
a
, 
n
) \

60 
uöt32_t
 
__a
 = (uöt32_tË(
a
); \

61 (
	`ty≥of
(
a
)Ë(
__a
 - __®% (
n
)); \

62 })

	)

64 
	#ROUNDUP
(
a
, 
n
) \

66 
uöt32_t
 
__n
 = (uöt32_tË(
n
); \

67 (
	`ty≥of
(
a
)Ë(
	`ROUNDDOWN
((
uöt32_t
Ë◊Ë+ 
__n
 - 1, __n)); \

68 })

	)

70 
	#ARRAY_SIZE
(
a
Ë(◊Ë/ ◊[0]))

	)

73 
	#off£tof
(
ty≥
, 
membî
Ë((
size_t
Ë(&(—y≥*)0)->membî))

	)

	@inc/x86.h

1 #i‚de‡
JOS_INC_X86_H


2 
	#JOS_INC_X86_H


	)

4 
	~<öc/ty≥s.h
>

6 
ölöe
 

7 
	$bªakpoöt
()

9 
asm
 volatile("int3");

10 
	}
}

12 
ölöe
 
uöt8_t


13 
	$öb
(
p‹t
)

15 
uöt8_t
 
d©a
;

16 
asm
 vﬁ©ûe("öb %w1,%0" : "˜" (
d©a
Ë: "d" (
p‹t
));

17  
d©a
;

18 
	}
}

20 
ölöe
 

21 
	$ösb
(
p‹t
, *
addr
, 
˙t
)

23 
asm
 volatile("cld\n\trepne\n\tinsb"

24 : "=D" (
addr
), "=c" (
˙t
)

25 : "d" (
p‹t
), "0" (
addr
), "1" (
˙t
)

27 
	}
}

29 
ölöe
 
uöt16_t


30 
	$öw
(
p‹t
)

32 
uöt16_t
 
d©a
;

33 
asm
 vﬁ©ûe("öw %w1,%0" : "˜" (
d©a
Ë: "d" (
p‹t
));

34  
d©a
;

35 
	}
}

37 
ölöe
 

38 
	$ösw
(
p‹t
, *
addr
, 
˙t
)

40 
asm
 volatile("cld\n\trepne\n\tinsw"

41 : "=D" (
addr
), "=c" (
˙t
)

42 : "d" (
p‹t
), "0" (
addr
), "1" (
˙t
)

44 
	}
}

46 
ölöe
 
uöt32_t


47 
	$öl
(
p‹t
)

49 
uöt32_t
 
d©a
;

50 
asm
 vﬁ©ûe("ö»%w1,%0" : "˜" (
d©a
Ë: "d" (
p‹t
));

51  
d©a
;

52 
	}
}

54 
ölöe
 

55 
	$ö¶
(
p‹t
, *
addr
, 
˙t
)

57 
asm
 volatile("cld\n\trepne\n\tinsl"

58 : "=D" (
addr
), "=c" (
˙t
)

59 : "d" (
p‹t
), "0" (
addr
), "1" (
˙t
)

61 
	}
}

63 
ölöe
 

64 
	$outb
(
p‹t
, 
uöt8_t
 
d©a
)

66 
asm
 vﬁ©ûe("outb %0,%w1" : : "a" (
d©a
), "d" (
p‹t
));

67 
	}
}

69 
ölöe
 

70 
	$outsb
(
p‹t
, c⁄° *
addr
, 
˙t
)

72 
asm
 volatile("cld\n\trepne\n\toutsb"

73 : "=S" (
addr
), "=c" (
˙t
)

74 : "d" (
p‹t
), "0" (
addr
), "1" (
˙t
)

76 
	}
}

78 
ölöe
 

79 
	$outw
(
p‹t
, 
uöt16_t
 
d©a
)

81 
asm
 vﬁ©ûe("outw %0,%w1" : : "a" (
d©a
), "d" (
p‹t
));

82 
	}
}

84 
ölöe
 

85 
	$outsw
(
p‹t
, c⁄° *
addr
, 
˙t
)

87 
asm
 volatile("cld\n\trepne\n\toutsw"

88 : "=S" (
addr
), "=c" (
˙t
)

89 : "d" (
p‹t
), "0" (
addr
), "1" (
˙t
)

91 
	}
}

93 
ölöe
 

94 
	$out¶
(
p‹t
, c⁄° *
addr
, 
˙t
)

96 
asm
 volatile("cld\n\trepne\n\toutsl"

97 : "=S" (
addr
), "=c" (
˙t
)

98 : "d" (
p‹t
), "0" (
addr
), "1" (
˙t
)

100 
	}
}

102 
ölöe
 

103 
	$oué
(
p‹t
, 
uöt32_t
 
d©a
)

105 
asm
 vﬁ©ûe("oué %0,%w1" : : "a" (
d©a
), "d" (
p‹t
));

106 
	}
}

108 
ölöe
 

109 
	$övÕg
(*
addr
)

111 
asm
 vﬁ©ûe("övÕg (%0)" : : "r" (
addr
) : "memory");

112 
	}
}

114 
ölöe
 

115 
	$lidt
(*
p
)

117 
asm
 vﬁ©ûe("lidà(%0)" : : "r" (
p
));

118 
	}
}

120 
ölöe
 

121 
	$lgdt
(*
p
)

123 
asm
 vﬁ©ûe("lgdà(%0)" : : "r" (
p
));

124 
	}
}

126 
ölöe
 

127 
	$Œdt
(
uöt16_t
 
£l
)

129 
asm
 vﬁ©ûe("Œdà%0" : : "r" (
£l
));

130 
	}
}

132 
ölöe
 

133 
	$…r
(
uöt16_t
 
£l
)

135 
asm
 vﬁ©ûe("…∏%0" : : "r" (
£l
));

136 
	}
}

138 
ölöe
 

139 
	$l¸0
(
uöt32_t
 
vÆ
)

141 
asm
 vﬁ©ûe("mov»%0,%%¸0" : : "r" (
vÆ
));

142 
	}
}

144 
ölöe
 
uöt32_t


145 
	$r¸0
()

147 
uöt32_t
 
vÆ
;

148 
asm
 vﬁ©ûe("mov»%%¸0,%0" : "Ù" (
vÆ
));

149  
vÆ
;

150 
	}
}

152 
ölöe
 
uöt32_t


153 
	$r¸2
()

155 
uöt32_t
 
vÆ
;

156 
asm
 vﬁ©ûe("mov»%%¸2,%0" : "Ù" (
vÆ
));

157  
vÆ
;

158 
	}
}

160 
ölöe
 

161 
	$l¸3
(
uöt32_t
 
vÆ
)

163 
asm
 vﬁ©ûe("mov»%0,%%¸3" : : "r" (
vÆ
));

164 
	}
}

166 
ölöe
 
uöt32_t


167 
	$r¸3
()

169 
uöt32_t
 
vÆ
;

170 
asm
 vﬁ©ûe("mov»%%¸3,%0" : "Ù" (
vÆ
));

171  
vÆ
;

172 
	}
}

174 
ölöe
 

175 
	$l¸4
(
uöt32_t
 
vÆ
)

177 
asm
 vﬁ©ûe("mov»%0,%%¸4" : : "r" (
vÆ
));

178 
	}
}

180 
ölöe
 
uöt32_t


181 
	$r¸4
()

183 
uöt32_t
 
¸4
;

184 
asm
 vﬁ©ûe("mov»%%¸4,%0" : "Ù" (
¸4
));

185  
¸4
;

186 
	}
}

188 
ölöe
 

189 
	$ébÊush
()

191 
uöt32_t
 
¸3
;

192 
asm
 vﬁ©ûe("mov»%%¸3,%0" : "Ù" (
¸3
));

193 
asm
 vﬁ©ûe("mov»%0,%%¸3" : : "r" (
¸3
));

194 
	}
}

196 
ölöe
 
uöt32_t


197 
	$ªad_eÊags
()

199 
uöt32_t
 
eÊags
;

200 
asm
 vﬁ©ûe("pushÊ;Ö›»%0" : "Ù" (
eÊags
));

201  
eÊags
;

202 
	}
}

204 
ölöe
 

205 
	$wrôe_eÊags
(
uöt32_t
 
eÊags
)

207 
asm
 vﬁ©ûe("push»%0;Ö›Ê" : : "r" (
eÊags
));

208 
	}
}

210 
ölöe
 
uöt32_t


211 
	$ªad_ebp
()

213 
uöt32_t
 
ebp
;

214 
asm
 vﬁ©ûe("mov»%%ebp,%0" : "Ù" (
ebp
));

215  
ebp
;

216 
	}
}

218 
ölöe
 
uöt32_t


219 
	$ªad_e•
()

221 
uöt32_t
 
e•
;

222 
asm
 vﬁ©ûe("mov»%%e•,%0" : "Ù" (
e•
));

223  
e•
;

224 
	}
}

226 
ölöe
 

227 
	$˝uid
(
uöt32_t
 
öfo
, uöt32_à*
óxp
, uöt32_à*
ebxp
, uöt32_à*
ecxp
, uöt32_à*
edxp
)

229 
uöt32_t
 
óx
, 
ebx
, 
ecx
, 
edx
;

230 
asm
 volatile("cpuid"

231 : "˜" (
óx
), "=b" (
ebx
), "=c" (
ecx
), "=d" (
edx
)

232 : "a" (
öfo
));

233 i‡(
óxp
)

234 *
óxp
 = 
óx
;

235 i‡(
ebxp
)

236 *
ebxp
 = 
ebx
;

237 i‡(
ecxp
)

238 *
ecxp
 = 
ecx
;

239 i‡(
edxp
)

240 *
edxp
 = 
edx
;

241 
	}
}

243 
ölöe
 
uöt64_t


244 
	$ªad_tsc
()

246 
uöt64_t
 
tsc
;

247 
asm
 vﬁ©ûe("rdtsc" : "=A" (
tsc
));

248  
tsc
;

249 
	}
}

251 
ölöe
 
uöt32_t


252 
	$xchg
(vﬁ©ûê
uöt32_t
 *
addr
, uöt32_à
√wvÆ
)

254 
uöt32_t
 
ªsu…
;

257 
asm
 volatile("lock; xchgl %0, %1"

258 : "+m" (*
addr
), "˜" (
ªsu…
)

259 : "1" (
√wvÆ
)

261  
ªsu…
;

262 
	}
}

	@kern/console.c

3 
	~<öc/x86.h
>

4 
	~<öc/memœyout.h
>

5 
	~<öc/kbdªg.h
>

6 
	~<öc/°rög.h
>

7 
	~<öc/as£π.h
>

9 
	~<kîn/c⁄sﬁe.h
>

10 
	~<kîn/å≠.h
>

11 
	~<kîn/picúq.h
>

13 
c⁄s_öå
((*
¥oc
)());

14 
	`c⁄s_putc
(
c
);

18 
	$dñay
()

20 
	`öb
(0x84);

21 
	`öb
(0x84);

22 
	`öb
(0x84);

23 
	`öb
(0x84);

24 
	}
}

28 
	#COM1
 0x3F8

	)

30 
	#COM_RX
 0

31 
	#COM_TX
 0

32 
	#COM_DLL
 0

33 
	#COM_DLM
 1

34 
	#COM_IER
 1

35 
	#COM_IER_RDI
 0x01

36 
	#COM_IIR
 2

37 
	#COM_FCR
 2

38 
	#COM_LCR
 3

39 
	#COM_LCR_DLAB
 0x80

40 
	#COM_LCR_WLEN8
 0x03

41 
	#COM_MCR
 4

42 
	#COM_MCR_RTS
 0x02

43 
	#COM_MCR_DTR
 0x01

44 
	#COM_MCR_OUT2
 0x08

45 
	#COM_LSR
 5

46 
	#COM_LSR_DATA
 0x01

47 
	#COM_LSR_TXRDY
 0x20

48 
	#COM_LSR_TSRE
 0x40

49 

	)

50 
boﬁ
 
	g£rül_exi°s
;

53 
	$£rül_¥oc_d©a
()

55 i‡(!(
	`öb
(
COM1
+
COM_LSR
Ë& 
COM_LSR_DATA
))

57  
	`öb
(
COM1
+
COM_RX
);

58 
	}
}

61 
	$£rül_öå
()

63 i‡(
£rül_exi°s
)

64 
	`c⁄s_öå
(
£rül_¥oc_d©a
);

65 
	}
}

68 
	$£rül_putc
(
c
)

70 
i
;

72 
i
 = 0;

73 !(
	`öb
(
COM1
 + 
COM_LSR
Ë& 
COM_LSR_TXRDY
Ë&& 
i
 < 12800;

74 
i
++)

75 
	`dñay
();

77 
	`outb
(
COM1
 + 
COM_TX
, 
c
);

78 
	}
}

81 
	$£rül_öô
()

84 
	`outb
(
COM1
+
COM_FCR
, 0);

87 
	`outb
(
COM1
+
COM_LCR
, 
COM_LCR_DLAB
);

88 
	`outb
(
COM1
+
COM_DLL
, (
uöt8_t
) (115200 / 9600));

89 
	`outb
(
COM1
+
COM_DLM
, 0);

92 
	`outb
(
COM1
+
COM_LCR
, 
COM_LCR_WLEN8
 & ~
COM_LCR_DLAB
);

95 
	`outb
(
COM1
+
COM_MCR
, 0);

97 
	`outb
(
COM1
+
COM_IER
, 
COM_IER_RDI
);

101 
£rül_exi°s
 = (
	`öb
(
COM1
+
COM_LSR
) != 0xFF);

102 (Ë
	`öb
(
COM1
+
COM_IIR
);

103 (Ë
	`öb
(
COM1
+
COM_RX
);

106 i‡(
£rül_exi°s
)

107 
	`úq_£tmask_8259A
(
úq_mask_8259A
 & ~(1<<
IRQ_SERIAL
));

108 
	}
}

117 
	$Õt_putc
(
c
)

119 
i
;

121 
i
 = 0; !(
	`öb
(0x378+1) & 0x80) && i < 12800; i++)

122 
	`dñay
();

123 
	`outb
(0x378+0, 
c
);

124 
	`outb
(0x378+2, 0x08|0x04|0x01);

125 
	`outb
(0x378+2, 0x08);

126 
	}
}

133 
	gaddr_6845
;

134 
uöt16_t
 *
	g¸t_buf
;

135 
uöt16_t
 
	g¸t_pos
;

138 
	$cga_öô
()

140 vﬁ©ûê
uöt16_t
 *
˝
;

141 
uöt16_t
 
was
;

142 
pos
;

144 
˝
 = (
uöt16_t
*Ë(
KERNBASE
 + 
CGA_BUF
);

145 
was
 = *
˝
;

146 *
˝
 = (
uöt16_t
) 0xA55A;

147 i‡(*
˝
 != 0xA55A) {

148 
˝
 = (
uöt16_t
*Ë(
KERNBASE
 + 
MONO_BUF
);

149 
addr_6845
 = 
MONO_BASE
;

151 *
˝
 = 
was
;

152 
addr_6845
 = 
CGA_BASE
;

156 
	`outb
(
addr_6845
, 14);

157 
pos
 = 
	`öb
(
addr_6845
 + 1) << 8;

158 
	`outb
(
addr_6845
, 15);

159 
pos
 |
	`öb
(
addr_6845
 + 1);

161 
¸t_buf
 = (
uöt16_t
*Ë
˝
;

162 
¸t_pos
 = 
pos
;

163 
	}
}

168 
	$cga_putc
(
c
)

171 i‡(!(
c
 & ~0xFF))

172 
c
 |= 0x0700;

174 
c
 & 0xff) {

176 i‡(
¸t_pos
 > 0) {

177 
¸t_pos
--;

178 
¸t_buf
[
¸t_pos
] = (
c
 & ~0xff) | ' ';

182 
¸t_pos
 +
CRT_COLS
;

185 
¸t_pos
 -(¸t_po†% 
CRT_COLS
);

188 
	`c⁄s_putc
(' ');

189 
	`c⁄s_putc
(' ');

190 
	`c⁄s_putc
(' ');

191 
	`c⁄s_putc
(' ');

192 
	`c⁄s_putc
(' ');

195 
¸t_buf
[
¸t_pos
++] = 
c
;

200 i‡(
¸t_pos
 >
CRT_SIZE
) {

201 
i
;

203 
	`memmove
(
¸t_buf
, cπ_bu‡+ 
CRT_COLS
, (
CRT_SIZE
 - CRT_COLSË* (
uöt16_t
));

204 
i
 = 
CRT_SIZE
 - 
CRT_COLS
; i < CRT_SIZE; i++)

205 
¸t_buf
[
i
] = 0x0700 | ' ';

206 
¸t_pos
 -
CRT_COLS
;

210 
	`outb
(
addr_6845
, 14);

211 
	`outb
(
addr_6845
 + 1, 
¸t_pos
 >> 8);

212 
	`outb
(
addr_6845
, 15);

213 
	`outb
(
addr_6845
 + 1, 
¸t_pos
);

214 
	}
}

219 
	#NO
 0

	)

221 
	#SHIFT
 (1<<0)

	)

222 
	#CTL
 (1<<1)

	)

223 
	#ALT
 (1<<2)

	)

225 
	#CAPSLOCK
 (1<<3)

	)

226 
	#NUMLOCK
 (1<<4)

	)

227 
	#SCROLLLOCK
 (1<<5)

	)

229 
	#E0ESC
 (1<<6)

	)

231 
uöt8_t
 
	gshi·code
[256] =

233 [0x1D] = 
CTL
,

234 [0x2A] = 
SHIFT
,

235 [0x36] = 
SHIFT
,

236 [0x38] = 
ALT
,

237 [0x9D] = 
CTL
,

238 [0xB8] = 
ALT


241 
uöt8_t
 
	gtoggÀcode
[256] =

243 [0x3A] = 
CAPSLOCK
,

244 [0x45] = 
NUMLOCK
,

245 [0x46] = 
SCROLLLOCK


248 
uöt8_t
 
	gn‹mÆm≠
[256] =

250 
NO
, 0x1B, '1', '2', '3', '4', '5', '6',

253 'o', 'p', '[', ']', '\n', 
NO
, 'a', 's',

255 '\'', '`', 
NO
, '\\', 'z', 'x', 'c', 'v',

256 'b', 'n', 'm', ',', '.', '/', 
NO
, '*',

257 
NO
, ' ', NO, NO, NO, NO, NO, NO,

258 
NO
, NO, NO, NO, NO, NO, NO, '7',

260 '2', '3', '0', '.', 
NO
, NO, NO, NO,

261 [0xC7] = 
KEY_HOME
, [0x9C] = '\n' ,

262 [0xB5] = '/' , [0xC8] = 
KEY_UP
,

263 [0xC9] = 
KEY_PGUP
, [0xCB] = 
KEY_LF
,

264 [0xCD] = 
KEY_RT
, [0xCF] = 
KEY_END
,

265 [0xD0] = 
KEY_DN
, [0xD1] = 
KEY_PGDN
,

266 [0xD2] = 
KEY_INS
, [0xD3] = 
KEY_DEL


269 
uöt8_t
 
	gshi·m≠
[256] =

271 
NO
, 033, '!', '@', '#', '$', '%', '^',

274 'O', 'P', '{', '}', '\n', 
NO
, 'A', 'S',

276 '"', '~', 
NO
, '|', 'Z', 'X', 'C', 'V',

277 'B', 'N', 'M', '<', '>', '?', 
NO
, '*',

278 
NO
, ' ', NO, NO, NO, NO, NO, NO,

279 
NO
, NO, NO, NO, NO, NO, NO, '7',

281 '2', '3', '0', '.', 
NO
, NO, NO, NO,

282 [0xC7] = 
KEY_HOME
, [0x9C] = '\n' ,

283 [0xB5] = '/' , [0xC8] = 
KEY_UP
,

284 [0xC9] = 
KEY_PGUP
, [0xCB] = 
KEY_LF
,

285 [0xCD] = 
KEY_RT
, [0xCF] = 
KEY_END
,

286 [0xD0] = 
KEY_DN
, [0xD1] = 
KEY_PGDN
,

287 [0xD2] = 
KEY_INS
, [0xD3] = 
KEY_DEL


290 
	#C
(
x
Ë(x - '@')

	)

292 
uöt8_t
 
	g˘lm≠
[256] =

294 
NO
, NO, NO, NO, NO, NO, NO, NO,

295 
NO
, NO, NO, NO, NO, NO, NO, NO,

296 
C
('Q'), C('W'), C('E'), C('R'), C('T'), C('Y'), C('U'), C('I'),

297 
C
('O'), C('P'), 
NO
, NO, '\r', NO, C('A'), C('S'),

298 
C
('D'), C('F'), C('G'), C('H'), C('J'), C('K'), C('L'), 
NO
,

299 
NO
, NO, NO, 
C
('\\'), C('Z'), C('X'), C('C'), C('V'),

300 
C
('B'), C('N'), C('M'), 
NO
, NO, C('/'), NO, NO,

301 [0x97] = 
KEY_HOME
,

302 [0xB5] = 
C
('/'), [0xC8] = 
KEY_UP
,

303 [0xC9] = 
KEY_PGUP
, [0xCB] = 
KEY_LF
,

304 [0xCD] = 
KEY_RT
, [0xCF] = 
KEY_END
,

305 [0xD0] = 
KEY_DN
, [0xD1] = 
KEY_PGDN
,

306 [0xD2] = 
KEY_INS
, [0xD3] = 
KEY_DEL


309 
uöt8_t
 *
	gch¨code
[4] = {

310 
n‹mÆm≠
,

311 
shi·m≠
,

312 
˘lm≠
,

313 
˘lm≠


321 
	$kbd_¥oc_d©a
()

323 
c
;

324 
uöt8_t
 
°©
, 
d©a
;

325 
uöt32_t
 
shi·
;

327 
°©
 = 
	`öb
(
KBSTATP
);

328 i‡((
°©
 & 
KBS_DIB
) == 0)

331 i‡(
°©
 & 
KBS_TERR
)

334 
d©a
 = 
	`öb
(
KBDATAP
);

336 i‡(
d©a
 == 0xE0) {

338 
shi·
 |
E0ESC
;

340 } i‡(
d©a
 & 0x80) {

342 
d©a
 = (
shi·
 & 
E0ESC
 ? data : data & 0x7F);

343 
shi·
 &~(
shi·code
[
d©a
] | 
E0ESC
);

345 } i‡(
shi·
 & 
E0ESC
) {

347 
d©a
 |= 0x80;

348 
shi·
 &~
E0ESC
;

351 
shi·
 |
shi·code
[
d©a
];

352 
shi·
 ^
toggÀcode
[
d©a
];

354 
c
 = 
ch¨code
[
shi·
 & (
CTL
 | 
SHIFT
)][
d©a
];

355 i‡(
shi·
 & 
CAPSLOCK
) {

356 i‡('a' <
c
 && c <= 'z')

357 
c
 += 'A' - 'a';

358 i‡('A' <
c
 && c <= 'Z')

359 
c
 += 'a' - 'A';

364 i‡(!(~
shi·
 & (
CTL
 | 
ALT
)Ë&& 
c
 =
KEY_DEL
) {

365 
	`˝rötf
("Rebooting!\n");

366 
	`outb
(0x92, 0x3);

369  
c
;

370 
	}
}

373 
	$kbd_öå
()

375 
	`c⁄s_öå
(
kbd_¥oc_d©a
);

376 
	}
}

379 
	$kbd_öô
()

382 
	`kbd_öå
();

383 
	`úq_£tmask_8259A
(
úq_mask_8259A
 & ~(1<<
IRQ_KBD
));

384 
	}
}

393 
	#CONSBUFSIZE
 512

	)

396 
uöt8_t
 
	mbuf
[
CONSBUFSIZE
];

397 
uöt32_t
 
	mΩos
;

398 
uöt32_t
 
	mwpos
;

399 } 
	gc⁄s
;

404 
	$c⁄s_öå
((*
¥oc
)())

406 
c
;

408 (
c
 = (*
¥oc
)()) != -1) {

409 i‡(
c
 == 0)

411 
c⁄s
.
buf
[c⁄s.
wpos
++] = 
c
;

412 i‡(
c⁄s
.
wpos
 =
CONSBUFSIZE
)

413 
c⁄s
.
wpos
 = 0;

415 
	}
}

419 
	$c⁄s_gëc
()

421 
c
;

426 
	`£rül_öå
();

427 
	`kbd_öå
();

430 i‡(
c⁄s
.
Ωos
 !c⁄s.
wpos
) {

431 
c
 = 
c⁄s
.
buf
[c⁄s.
Ωos
++];

432 i‡(
c⁄s
.
Ωos
 =
CONSBUFSIZE
)

433 
c⁄s
.
Ωos
 = 0;

434  
c
;

437 
	}
}

441 
	$c⁄s_putc
(
c
)

443 
	`£rül_putc
(
c
);

444 
	`Õt_putc
(
c
);

445 
	`cga_putc
(
c
);

446 
	}
}

450 
	$c⁄s_öô
()

452 
	`cga_öô
();

453 
	`kbd_öô
();

454 
	`£rül_öô
();

456 i‡(!
£rül_exi°s
)

457 
	`˝rötf
("SerialÖort doesÇotÉxist!\n");

458 
	}
}

464 
	$˝utch¨
(
c
)

466 
	`c⁄s_putc
(
c
);

467 
	}
}

470 
	$gëch¨
()

472 
c
;

474 (
c
 = 
	`c⁄s_gëc
()) == 0)

476  
c
;

477 
	}
}

480 
	$isc⁄s
(
fdnum
)

484 
	}
}

	@kern/console.h

3 #i‚de‡
_CONSOLE_H_


4 
	#_CONSOLE_H_


	)

5 #i‚de‡
JOS_KERNEL


9 
	~<öc/ty≥s.h
>

11 
	#MONO_BASE
 0x3B4

	)

12 
	#MONO_BUF
 0xB0000

	)

13 
	#CGA_BASE
 0x3D4

	)

14 
	#CGA_BUF
 0xB8000

	)

16 
	#CRT_ROWS
 25

	)

17 
	#CRT_COLS
 80

	)

18 
	#CRT_SIZE
 (
CRT_ROWS
 * 
CRT_COLS
)

	)

20 
c⁄s_öô
();

21 
c⁄s_gëc
();

23 
kbd_öå
();

24 
£rül_öå
();

	@kern/cpu.h

2 #i‚de‡
JOS_INC_CPU_H


3 
	#JOS_INC_CPU_H


	)

5 
	~<öc/ty≥s.h
>

6 
	~<öc/memœyout.h
>

7 
	~<öc/mmu.h
>

8 
	~<öc/ív.h
>

11 
	#NCPU
 8

	)

15 
	mCPU_UNUSED
 = 0,

16 
	mCPU_STARTED
,

17 
	mCPU_HALTED
,

21 
	sCpuInfo
 {

22 
uöt8_t
 
	m˝u_id
;

23 vﬁ©ûê
	m˝u_°©us
;

24 
Env
 *
	m˝u_ív
;

25 
Task°©e
 
	m˝u_ts
;

29 
CpuInfo
 
˝us
[
NCPU
];

30 
n˝u
;

31 
CpuInfo
 *
boŸ˝u
;

32 
phyßddr_t
 
œpiˇddr
;

35 
≥r˝u_k°acks
[
NCPU
][
KSTKSIZE
];

37 
˝unum
();

38 
	#this˝u
 (&
˝us
[
	`˝unum
()])

	)

40 
mp_öô
();

41 
œpic_öô
();

42 
œpic_°¨èp
(
uöt8_t
 
≠icid
, 
uöt32_t
 
addr
);

43 
œpic_eoi
();

44 
œpic_ùi
(
ve˘‹
);

	@kern/entrypgdir.c

1 
	~<öc/mmu.h
>

2 
	~<öc/memœyout.h
>

4 
±e_t
 
	gíåy_pgèbÀ
[
NPTENTRIES
];

20 
__©åibuã__
((
	$__Æig√d__
(
PGSIZE
)))

21 
pde_t
 
íåy_pgdú
[
NPDENTRIES
] = {

24 ((
uöçå_t
)
íåy_pgèbÀ
 - 
KERNBASE
Ë+ 
PTE_P
,

26 [
KERNBASE
>>
PDXSHIFT
]

27 ((
uöçå_t
)
íåy_pgèbÀ
 - 
KERNBASE
Ë+ 
PTE_P
 + 
PTE_W


28 
	}
};

32 
__©åibuã__
((
	$__Æig√d__
(
PGSIZE
)))

33 
±e_t
 
íåy_pgèbÀ
[
NPTENTRIES
] = {

34 0x000000 | 
PTE_P
 | 
PTE_W
,

35 0x001000 | 
PTE_P
 | 
PTE_W
,

36 0x002000 | 
PTE_P
 | 
PTE_W
,

37 0x003000 | 
PTE_P
 | 
PTE_W
,

38 0x004000 | 
PTE_P
 | 
PTE_W
,

39 0x005000 | 
PTE_P
 | 
PTE_W
,

40 0x006000 | 
PTE_P
 | 
PTE_W
,

41 0x007000 | 
PTE_P
 | 
PTE_W
,

42 0x008000 | 
PTE_P
 | 
PTE_W
,

43 0x009000 | 
PTE_P
 | 
PTE_W
,

44 0x00a000 | 
PTE_P
 | 
PTE_W
,

45 0x00b000 | 
PTE_P
 | 
PTE_W
,

46 0x00c000 | 
PTE_P
 | 
PTE_W
,

47 0x00d000 | 
PTE_P
 | 
PTE_W
,

48 0x00e000 | 
PTE_P
 | 
PTE_W
,

49 0x00f000 | 
PTE_P
 | 
PTE_W
,

50 0x010000 | 
PTE_P
 | 
PTE_W
,

51 0x011000 | 
PTE_P
 | 
PTE_W
,

52 0x012000 | 
PTE_P
 | 
PTE_W
,

53 0x013000 | 
PTE_P
 | 
PTE_W
,

54 0x014000 | 
PTE_P
 | 
PTE_W
,

55 0x015000 | 
PTE_P
 | 
PTE_W
,

56 0x016000 | 
PTE_P
 | 
PTE_W
,

57 0x017000 | 
PTE_P
 | 
PTE_W
,

58 0x018000 | 
PTE_P
 | 
PTE_W
,

59 0x019000 | 
PTE_P
 | 
PTE_W
,

60 0x01a000 | 
PTE_P
 | 
PTE_W
,

61 0x01b000 | 
PTE_P
 | 
PTE_W
,

62 0x01c000 | 
PTE_P
 | 
PTE_W
,

63 0x01d000 | 
PTE_P
 | 
PTE_W
,

64 0x01e000 | 
PTE_P
 | 
PTE_W
,

65 0x01f000 | 
PTE_P
 | 
PTE_W
,

66 0x020000 | 
PTE_P
 | 
PTE_W
,

67 0x021000 | 
PTE_P
 | 
PTE_W
,

68 0x022000 | 
PTE_P
 | 
PTE_W
,

69 0x023000 | 
PTE_P
 | 
PTE_W
,

70 0x024000 | 
PTE_P
 | 
PTE_W
,

71 0x025000 | 
PTE_P
 | 
PTE_W
,

72 0x026000 | 
PTE_P
 | 
PTE_W
,

73 0x027000 | 
PTE_P
 | 
PTE_W
,

74 0x028000 | 
PTE_P
 | 
PTE_W
,

75 0x029000 | 
PTE_P
 | 
PTE_W
,

76 0x02a000 | 
PTE_P
 | 
PTE_W
,

77 0x02b000 | 
PTE_P
 | 
PTE_W
,

78 0x02c000 | 
PTE_P
 | 
PTE_W
,

79 0x02d000 | 
PTE_P
 | 
PTE_W
,

80 0x02e000 | 
PTE_P
 | 
PTE_W
,

81 0x02f000 | 
PTE_P
 | 
PTE_W
,

82 0x030000 | 
PTE_P
 | 
PTE_W
,

83 0x031000 | 
PTE_P
 | 
PTE_W
,

84 0x032000 | 
PTE_P
 | 
PTE_W
,

85 0x033000 | 
PTE_P
 | 
PTE_W
,

86 0x034000 | 
PTE_P
 | 
PTE_W
,

87 0x035000 | 
PTE_P
 | 
PTE_W
,

88 0x036000 | 
PTE_P
 | 
PTE_W
,

89 0x037000 | 
PTE_P
 | 
PTE_W
,

90 0x038000 | 
PTE_P
 | 
PTE_W
,

91 0x039000 | 
PTE_P
 | 
PTE_W
,

92 0x03a000 | 
PTE_P
 | 
PTE_W
,

93 0x03b000 | 
PTE_P
 | 
PTE_W
,

94 0x03c000 | 
PTE_P
 | 
PTE_W
,

95 0x03d000 | 
PTE_P
 | 
PTE_W
,

96 0x03e000 | 
PTE_P
 | 
PTE_W
,

97 0x03f000 | 
PTE_P
 | 
PTE_W
,

98 0x040000 | 
PTE_P
 | 
PTE_W
,

99 0x041000 | 
PTE_P
 | 
PTE_W
,

100 0x042000 | 
PTE_P
 | 
PTE_W
,

101 0x043000 | 
PTE_P
 | 
PTE_W
,

102 0x044000 | 
PTE_P
 | 
PTE_W
,

103 0x045000 | 
PTE_P
 | 
PTE_W
,

104 0x046000 | 
PTE_P
 | 
PTE_W
,

105 0x047000 | 
PTE_P
 | 
PTE_W
,

106 0x048000 | 
PTE_P
 | 
PTE_W
,

107 0x049000 | 
PTE_P
 | 
PTE_W
,

108 0x04a000 | 
PTE_P
 | 
PTE_W
,

109 0x04b000 | 
PTE_P
 | 
PTE_W
,

110 0x04c000 | 
PTE_P
 | 
PTE_W
,

111 0x04d000 | 
PTE_P
 | 
PTE_W
,

112 0x04e000 | 
PTE_P
 | 
PTE_W
,

113 0x04f000 | 
PTE_P
 | 
PTE_W
,

114 0x050000 | 
PTE_P
 | 
PTE_W
,

115 0x051000 | 
PTE_P
 | 
PTE_W
,

116 0x052000 | 
PTE_P
 | 
PTE_W
,

117 0x053000 | 
PTE_P
 | 
PTE_W
,

118 0x054000 | 
PTE_P
 | 
PTE_W
,

119 0x055000 | 
PTE_P
 | 
PTE_W
,

120 0x056000 | 
PTE_P
 | 
PTE_W
,

121 0x057000 | 
PTE_P
 | 
PTE_W
,

122 0x058000 | 
PTE_P
 | 
PTE_W
,

123 0x059000 | 
PTE_P
 | 
PTE_W
,

124 0x05a000 | 
PTE_P
 | 
PTE_W
,

125 0x05b000 | 
PTE_P
 | 
PTE_W
,

126 0x05c000 | 
PTE_P
 | 
PTE_W
,

127 0x05d000 | 
PTE_P
 | 
PTE_W
,

128 0x05e000 | 
PTE_P
 | 
PTE_W
,

129 0x05f000 | 
PTE_P
 | 
PTE_W
,

130 0x060000 | 
PTE_P
 | 
PTE_W
,

131 0x061000 | 
PTE_P
 | 
PTE_W
,

132 0x062000 | 
PTE_P
 | 
PTE_W
,

133 0x063000 | 
PTE_P
 | 
PTE_W
,

134 0x064000 | 
PTE_P
 | 
PTE_W
,

135 0x065000 | 
PTE_P
 | 
PTE_W
,

136 0x066000 | 
PTE_P
 | 
PTE_W
,

137 0x067000 | 
PTE_P
 | 
PTE_W
,

138 0x068000 | 
PTE_P
 | 
PTE_W
,

139 0x069000 | 
PTE_P
 | 
PTE_W
,

140 0x06a000 | 
PTE_P
 | 
PTE_W
,

141 0x06b000 | 
PTE_P
 | 
PTE_W
,

142 0x06c000 | 
PTE_P
 | 
PTE_W
,

143 0x06d000 | 
PTE_P
 | 
PTE_W
,

144 0x06e000 | 
PTE_P
 | 
PTE_W
,

145 0x06f000 | 
PTE_P
 | 
PTE_W
,

146 0x070000 | 
PTE_P
 | 
PTE_W
,

147 0x071000 | 
PTE_P
 | 
PTE_W
,

148 0x072000 | 
PTE_P
 | 
PTE_W
,

149 0x073000 | 
PTE_P
 | 
PTE_W
,

150 0x074000 | 
PTE_P
 | 
PTE_W
,

151 0x075000 | 
PTE_P
 | 
PTE_W
,

152 0x076000 | 
PTE_P
 | 
PTE_W
,

153 0x077000 | 
PTE_P
 | 
PTE_W
,

154 0x078000 | 
PTE_P
 | 
PTE_W
,

155 0x079000 | 
PTE_P
 | 
PTE_W
,

156 0x07a000 | 
PTE_P
 | 
PTE_W
,

157 0x07b000 | 
PTE_P
 | 
PTE_W
,

158 0x07c000 | 
PTE_P
 | 
PTE_W
,

159 0x07d000 | 
PTE_P
 | 
PTE_W
,

160 0x07e000 | 
PTE_P
 | 
PTE_W
,

161 0x07f000 | 
PTE_P
 | 
PTE_W
,

162 0x080000 | 
PTE_P
 | 
PTE_W
,

163 0x081000 | 
PTE_P
 | 
PTE_W
,

164 0x082000 | 
PTE_P
 | 
PTE_W
,

165 0x083000 | 
PTE_P
 | 
PTE_W
,

166 0x084000 | 
PTE_P
 | 
PTE_W
,

167 0x085000 | 
PTE_P
 | 
PTE_W
,

168 0x086000 | 
PTE_P
 | 
PTE_W
,

169 0x087000 | 
PTE_P
 | 
PTE_W
,

170 0x088000 | 
PTE_P
 | 
PTE_W
,

171 0x089000 | 
PTE_P
 | 
PTE_W
,

172 0x08a000 | 
PTE_P
 | 
PTE_W
,

173 0x08b000 | 
PTE_P
 | 
PTE_W
,

174 0x08c000 | 
PTE_P
 | 
PTE_W
,

175 0x08d000 | 
PTE_P
 | 
PTE_W
,

176 0x08e000 | 
PTE_P
 | 
PTE_W
,

177 0x08f000 | 
PTE_P
 | 
PTE_W
,

178 0x090000 | 
PTE_P
 | 
PTE_W
,

179 0x091000 | 
PTE_P
 | 
PTE_W
,

180 0x092000 | 
PTE_P
 | 
PTE_W
,

181 0x093000 | 
PTE_P
 | 
PTE_W
,

182 0x094000 | 
PTE_P
 | 
PTE_W
,

183 0x095000 | 
PTE_P
 | 
PTE_W
,

184 0x096000 | 
PTE_P
 | 
PTE_W
,

185 0x097000 | 
PTE_P
 | 
PTE_W
,

186 0x098000 | 
PTE_P
 | 
PTE_W
,

187 0x099000 | 
PTE_P
 | 
PTE_W
,

188 0x09a000 | 
PTE_P
 | 
PTE_W
,

189 0x09b000 | 
PTE_P
 | 
PTE_W
,

190 0x09c000 | 
PTE_P
 | 
PTE_W
,

191 0x09d000 | 
PTE_P
 | 
PTE_W
,

192 0x09e000 | 
PTE_P
 | 
PTE_W
,

193 0x09f000 | 
PTE_P
 | 
PTE_W
,

194 0x0a0000 | 
PTE_P
 | 
PTE_W
,

195 0x0a1000 | 
PTE_P
 | 
PTE_W
,

196 0x0a2000 | 
PTE_P
 | 
PTE_W
,

197 0x0a3000 | 
PTE_P
 | 
PTE_W
,

198 0x0a4000 | 
PTE_P
 | 
PTE_W
,

199 0x0a5000 | 
PTE_P
 | 
PTE_W
,

200 0x0a6000 | 
PTE_P
 | 
PTE_W
,

201 0x0a7000 | 
PTE_P
 | 
PTE_W
,

202 0x0a8000 | 
PTE_P
 | 
PTE_W
,

203 0x0a9000 | 
PTE_P
 | 
PTE_W
,

204 0x0Ø000 | 
PTE_P
 | 
PTE_W
,

205 0x0ab000 | 
PTE_P
 | 
PTE_W
,

206 0x0ac000 | 
PTE_P
 | 
PTE_W
,

207 0x0ad000 | 
PTE_P
 | 
PTE_W
,

208 0x0´000 | 
PTE_P
 | 
PTE_W
,

209 0x0af000 | 
PTE_P
 | 
PTE_W
,

210 0x0b0000 | 
PTE_P
 | 
PTE_W
,

211 0x0b1000 | 
PTE_P
 | 
PTE_W
,

212 0x0b2000 | 
PTE_P
 | 
PTE_W
,

213 0x0b3000 | 
PTE_P
 | 
PTE_W
,

214 0x0b4000 | 
PTE_P
 | 
PTE_W
,

215 0x0b5000 | 
PTE_P
 | 
PTE_W
,

216 0x0b6000 | 
PTE_P
 | 
PTE_W
,

217 0x0b7000 | 
PTE_P
 | 
PTE_W
,

218 0x0b8000 | 
PTE_P
 | 
PTE_W
,

219 0x0b9000 | 
PTE_P
 | 
PTE_W
,

220 0x0ba000 | 
PTE_P
 | 
PTE_W
,

221 0x0bb000 | 
PTE_P
 | 
PTE_W
,

222 0x0bc000 | 
PTE_P
 | 
PTE_W
,

223 0x0bd000 | 
PTE_P
 | 
PTE_W
,

224 0x0be000 | 
PTE_P
 | 
PTE_W
,

225 0x0bf000 | 
PTE_P
 | 
PTE_W
,

226 0x0c0000 | 
PTE_P
 | 
PTE_W
,

227 0x0c1000 | 
PTE_P
 | 
PTE_W
,

228 0x0c2000 | 
PTE_P
 | 
PTE_W
,

229 0x0c3000 | 
PTE_P
 | 
PTE_W
,

230 0x0c4000 | 
PTE_P
 | 
PTE_W
,

231 0x0c5000 | 
PTE_P
 | 
PTE_W
,

232 0x0c6000 | 
PTE_P
 | 
PTE_W
,

233 0x0c7000 | 
PTE_P
 | 
PTE_W
,

234 0x0c8000 | 
PTE_P
 | 
PTE_W
,

235 0x0c9000 | 
PTE_P
 | 
PTE_W
,

236 0x0ˇ000 | 
PTE_P
 | 
PTE_W
,

237 0x0cb000 | 
PTE_P
 | 
PTE_W
,

238 0x0cc000 | 
PTE_P
 | 
PTE_W
,

239 0x0cd000 | 
PTE_P
 | 
PTE_W
,

240 0x0˚000 | 
PTE_P
 | 
PTE_W
,

241 0x0cf000 | 
PTE_P
 | 
PTE_W
,

242 0x0d0000 | 
PTE_P
 | 
PTE_W
,

243 0x0d1000 | 
PTE_P
 | 
PTE_W
,

244 0x0d2000 | 
PTE_P
 | 
PTE_W
,

245 0x0d3000 | 
PTE_P
 | 
PTE_W
,

246 0x0d4000 | 
PTE_P
 | 
PTE_W
,

247 0x0d5000 | 
PTE_P
 | 
PTE_W
,

248 0x0d6000 | 
PTE_P
 | 
PTE_W
,

249 0x0d7000 | 
PTE_P
 | 
PTE_W
,

250 0x0d8000 | 
PTE_P
 | 
PTE_W
,

251 0x0d9000 | 
PTE_P
 | 
PTE_W
,

252 0x0da000 | 
PTE_P
 | 
PTE_W
,

253 0x0db000 | 
PTE_P
 | 
PTE_W
,

254 0x0dc000 | 
PTE_P
 | 
PTE_W
,

255 0x0dd000 | 
PTE_P
 | 
PTE_W
,

256 0x0de000 | 
PTE_P
 | 
PTE_W
,

257 0x0df000 | 
PTE_P
 | 
PTE_W
,

258 0x0e0000 | 
PTE_P
 | 
PTE_W
,

259 0x0e1000 | 
PTE_P
 | 
PTE_W
,

260 0x0e2000 | 
PTE_P
 | 
PTE_W
,

261 0x0e3000 | 
PTE_P
 | 
PTE_W
,

262 0x0e4000 | 
PTE_P
 | 
PTE_W
,

263 0x0e5000 | 
PTE_P
 | 
PTE_W
,

264 0x0e6000 | 
PTE_P
 | 
PTE_W
,

265 0x0e7000 | 
PTE_P
 | 
PTE_W
,

266 0x0e8000 | 
PTE_P
 | 
PTE_W
,

267 0x0e9000 | 
PTE_P
 | 
PTE_W
,

268 0x0ó000 | 
PTE_P
 | 
PTE_W
,

269 0x0eb000 | 
PTE_P
 | 
PTE_W
,

270 0x0ec000 | 
PTE_P
 | 
PTE_W
,

271 0x0ed000 | 
PTE_P
 | 
PTE_W
,

272 0x0ì000 | 
PTE_P
 | 
PTE_W
,

273 0x0ef000 | 
PTE_P
 | 
PTE_W
,

274 0x0f0000 | 
PTE_P
 | 
PTE_W
,

275 0x0f1000 | 
PTE_P
 | 
PTE_W
,

276 0x0f2000 | 
PTE_P
 | 
PTE_W
,

277 0x0f3000 | 
PTE_P
 | 
PTE_W
,

278 0x0f4000 | 
PTE_P
 | 
PTE_W
,

279 0x0f5000 | 
PTE_P
 | 
PTE_W
,

280 0x0f6000 | 
PTE_P
 | 
PTE_W
,

281 0x0f7000 | 
PTE_P
 | 
PTE_W
,

282 0x0f8000 | 
PTE_P
 | 
PTE_W
,

283 0x0f9000 | 
PTE_P
 | 
PTE_W
,

284 0x0Á000 | 
PTE_P
 | 
PTE_W
,

285 0x0fb000 | 
PTE_P
 | 
PTE_W
,

286 0x0fc000 | 
PTE_P
 | 
PTE_W
,

287 0x0fd000 | 
PTE_P
 | 
PTE_W
,

288 0x0„000 | 
PTE_P
 | 
PTE_W
,

289 0x0ff000 | 
PTE_P
 | 
PTE_W
,

290 0x100000 | 
PTE_P
 | 
PTE_W
,

291 0x101000 | 
PTE_P
 | 
PTE_W
,

292 0x102000 | 
PTE_P
 | 
PTE_W
,

293 0x103000 | 
PTE_P
 | 
PTE_W
,

294 0x104000 | 
PTE_P
 | 
PTE_W
,

295 0x105000 | 
PTE_P
 | 
PTE_W
,

296 0x106000 | 
PTE_P
 | 
PTE_W
,

297 0x107000 | 
PTE_P
 | 
PTE_W
,

298 0x108000 | 
PTE_P
 | 
PTE_W
,

299 0x109000 | 
PTE_P
 | 
PTE_W
,

300 0x10a000 | 
PTE_P
 | 
PTE_W
,

301 0x10b000 | 
PTE_P
 | 
PTE_W
,

302 0x10c000 | 
PTE_P
 | 
PTE_W
,

303 0x10d000 | 
PTE_P
 | 
PTE_W
,

304 0x10e000 | 
PTE_P
 | 
PTE_W
,

305 0x10f000 | 
PTE_P
 | 
PTE_W
,

306 0x110000 | 
PTE_P
 | 
PTE_W
,

307 0x111000 | 
PTE_P
 | 
PTE_W
,

308 0x112000 | 
PTE_P
 | 
PTE_W
,

309 0x113000 | 
PTE_P
 | 
PTE_W
,

310 0x114000 | 
PTE_P
 | 
PTE_W
,

311 0x115000 | 
PTE_P
 | 
PTE_W
,

312 0x116000 | 
PTE_P
 | 
PTE_W
,

313 0x117000 | 
PTE_P
 | 
PTE_W
,

314 0x118000 | 
PTE_P
 | 
PTE_W
,

315 0x119000 | 
PTE_P
 | 
PTE_W
,

316 0x11a000 | 
PTE_P
 | 
PTE_W
,

317 0x11b000 | 
PTE_P
 | 
PTE_W
,

318 0x11c000 | 
PTE_P
 | 
PTE_W
,

319 0x11d000 | 
PTE_P
 | 
PTE_W
,

320 0x11e000 | 
PTE_P
 | 
PTE_W
,

321 0x11f000 | 
PTE_P
 | 
PTE_W
,

322 0x120000 | 
PTE_P
 | 
PTE_W
,

323 0x121000 | 
PTE_P
 | 
PTE_W
,

324 0x122000 | 
PTE_P
 | 
PTE_W
,

325 0x123000 | 
PTE_P
 | 
PTE_W
,

326 0x124000 | 
PTE_P
 | 
PTE_W
,

327 0x125000 | 
PTE_P
 | 
PTE_W
,

328 0x126000 | 
PTE_P
 | 
PTE_W
,

329 0x127000 | 
PTE_P
 | 
PTE_W
,

330 0x128000 | 
PTE_P
 | 
PTE_W
,

331 0x129000 | 
PTE_P
 | 
PTE_W
,

332 0x12a000 | 
PTE_P
 | 
PTE_W
,

333 0x12b000 | 
PTE_P
 | 
PTE_W
,

334 0x12c000 | 
PTE_P
 | 
PTE_W
,

335 0x12d000 | 
PTE_P
 | 
PTE_W
,

336 0x12e000 | 
PTE_P
 | 
PTE_W
,

337 0x12f000 | 
PTE_P
 | 
PTE_W
,

338 0x130000 | 
PTE_P
 | 
PTE_W
,

339 0x131000 | 
PTE_P
 | 
PTE_W
,

340 0x132000 | 
PTE_P
 | 
PTE_W
,

341 0x133000 | 
PTE_P
 | 
PTE_W
,

342 0x134000 | 
PTE_P
 | 
PTE_W
,

343 0x135000 | 
PTE_P
 | 
PTE_W
,

344 0x136000 | 
PTE_P
 | 
PTE_W
,

345 0x137000 | 
PTE_P
 | 
PTE_W
,

346 0x138000 | 
PTE_P
 | 
PTE_W
,

347 0x139000 | 
PTE_P
 | 
PTE_W
,

348 0x13a000 | 
PTE_P
 | 
PTE_W
,

349 0x13b000 | 
PTE_P
 | 
PTE_W
,

350 0x13c000 | 
PTE_P
 | 
PTE_W
,

351 0x13d000 | 
PTE_P
 | 
PTE_W
,

352 0x13e000 | 
PTE_P
 | 
PTE_W
,

353 0x13f000 | 
PTE_P
 | 
PTE_W
,

354 0x140000 | 
PTE_P
 | 
PTE_W
,

355 0x141000 | 
PTE_P
 | 
PTE_W
,

356 0x142000 | 
PTE_P
 | 
PTE_W
,

357 0x143000 | 
PTE_P
 | 
PTE_W
,

358 0x144000 | 
PTE_P
 | 
PTE_W
,

359 0x145000 | 
PTE_P
 | 
PTE_W
,

360 0x146000 | 
PTE_P
 | 
PTE_W
,

361 0x147000 | 
PTE_P
 | 
PTE_W
,

362 0x148000 | 
PTE_P
 | 
PTE_W
,

363 0x149000 | 
PTE_P
 | 
PTE_W
,

364 0x14a000 | 
PTE_P
 | 
PTE_W
,

365 0x14b000 | 
PTE_P
 | 
PTE_W
,

366 0x14c000 | 
PTE_P
 | 
PTE_W
,

367 0x14d000 | 
PTE_P
 | 
PTE_W
,

368 0x14e000 | 
PTE_P
 | 
PTE_W
,

369 0x14f000 | 
PTE_P
 | 
PTE_W
,

370 0x150000 | 
PTE_P
 | 
PTE_W
,

371 0x151000 | 
PTE_P
 | 
PTE_W
,

372 0x152000 | 
PTE_P
 | 
PTE_W
,

373 0x153000 | 
PTE_P
 | 
PTE_W
,

374 0x154000 | 
PTE_P
 | 
PTE_W
,

375 0x155000 | 
PTE_P
 | 
PTE_W
,

376 0x156000 | 
PTE_P
 | 
PTE_W
,

377 0x157000 | 
PTE_P
 | 
PTE_W
,

378 0x158000 | 
PTE_P
 | 
PTE_W
,

379 0x159000 | 
PTE_P
 | 
PTE_W
,

380 0x15a000 | 
PTE_P
 | 
PTE_W
,

381 0x15b000 | 
PTE_P
 | 
PTE_W
,

382 0x15c000 | 
PTE_P
 | 
PTE_W
,

383 0x15d000 | 
PTE_P
 | 
PTE_W
,

384 0x15e000 | 
PTE_P
 | 
PTE_W
,

385 0x15f000 | 
PTE_P
 | 
PTE_W
,

386 0x160000 | 
PTE_P
 | 
PTE_W
,

387 0x161000 | 
PTE_P
 | 
PTE_W
,

388 0x162000 | 
PTE_P
 | 
PTE_W
,

389 0x163000 | 
PTE_P
 | 
PTE_W
,

390 0x164000 | 
PTE_P
 | 
PTE_W
,

391 0x165000 | 
PTE_P
 | 
PTE_W
,

392 0x166000 | 
PTE_P
 | 
PTE_W
,

393 0x167000 | 
PTE_P
 | 
PTE_W
,

394 0x168000 | 
PTE_P
 | 
PTE_W
,

395 0x169000 | 
PTE_P
 | 
PTE_W
,

396 0x16a000 | 
PTE_P
 | 
PTE_W
,

397 0x16b000 | 
PTE_P
 | 
PTE_W
,

398 0x16c000 | 
PTE_P
 | 
PTE_W
,

399 0x16d000 | 
PTE_P
 | 
PTE_W
,

400 0x16e000 | 
PTE_P
 | 
PTE_W
,

401 0x16f000 | 
PTE_P
 | 
PTE_W
,

402 0x170000 | 
PTE_P
 | 
PTE_W
,

403 0x171000 | 
PTE_P
 | 
PTE_W
,

404 0x172000 | 
PTE_P
 | 
PTE_W
,

405 0x173000 | 
PTE_P
 | 
PTE_W
,

406 0x174000 | 
PTE_P
 | 
PTE_W
,

407 0x175000 | 
PTE_P
 | 
PTE_W
,

408 0x176000 | 
PTE_P
 | 
PTE_W
,

409 0x177000 | 
PTE_P
 | 
PTE_W
,

410 0x178000 | 
PTE_P
 | 
PTE_W
,

411 0x179000 | 
PTE_P
 | 
PTE_W
,

412 0x17a000 | 
PTE_P
 | 
PTE_W
,

413 0x17b000 | 
PTE_P
 | 
PTE_W
,

414 0x17c000 | 
PTE_P
 | 
PTE_W
,

415 0x17d000 | 
PTE_P
 | 
PTE_W
,

416 0x17e000 | 
PTE_P
 | 
PTE_W
,

417 0x17f000 | 
PTE_P
 | 
PTE_W
,

418 0x180000 | 
PTE_P
 | 
PTE_W
,

419 0x181000 | 
PTE_P
 | 
PTE_W
,

420 0x182000 | 
PTE_P
 | 
PTE_W
,

421 0x183000 | 
PTE_P
 | 
PTE_W
,

422 0x184000 | 
PTE_P
 | 
PTE_W
,

423 0x185000 | 
PTE_P
 | 
PTE_W
,

424 0x186000 | 
PTE_P
 | 
PTE_W
,

425 0x187000 | 
PTE_P
 | 
PTE_W
,

426 0x188000 | 
PTE_P
 | 
PTE_W
,

427 0x189000 | 
PTE_P
 | 
PTE_W
,

428 0x18a000 | 
PTE_P
 | 
PTE_W
,

429 0x18b000 | 
PTE_P
 | 
PTE_W
,

430 0x18c000 | 
PTE_P
 | 
PTE_W
,

431 0x18d000 | 
PTE_P
 | 
PTE_W
,

432 0x18e000 | 
PTE_P
 | 
PTE_W
,

433 0x18f000 | 
PTE_P
 | 
PTE_W
,

434 0x190000 | 
PTE_P
 | 
PTE_W
,

435 0x191000 | 
PTE_P
 | 
PTE_W
,

436 0x192000 | 
PTE_P
 | 
PTE_W
,

437 0x193000 | 
PTE_P
 | 
PTE_W
,

438 0x194000 | 
PTE_P
 | 
PTE_W
,

439 0x195000 | 
PTE_P
 | 
PTE_W
,

440 0x196000 | 
PTE_P
 | 
PTE_W
,

441 0x197000 | 
PTE_P
 | 
PTE_W
,

442 0x198000 | 
PTE_P
 | 
PTE_W
,

443 0x199000 | 
PTE_P
 | 
PTE_W
,

444 0x19a000 | 
PTE_P
 | 
PTE_W
,

445 0x19b000 | 
PTE_P
 | 
PTE_W
,

446 0x19c000 | 
PTE_P
 | 
PTE_W
,

447 0x19d000 | 
PTE_P
 | 
PTE_W
,

448 0x19e000 | 
PTE_P
 | 
PTE_W
,

449 0x19f000 | 
PTE_P
 | 
PTE_W
,

450 0x1a0000 | 
PTE_P
 | 
PTE_W
,

451 0x1a1000 | 
PTE_P
 | 
PTE_W
,

452 0x1a2000 | 
PTE_P
 | 
PTE_W
,

453 0x1a3000 | 
PTE_P
 | 
PTE_W
,

454 0x1a4000 | 
PTE_P
 | 
PTE_W
,

455 0x1a5000 | 
PTE_P
 | 
PTE_W
,

456 0x1a6000 | 
PTE_P
 | 
PTE_W
,

457 0x1a7000 | 
PTE_P
 | 
PTE_W
,

458 0x1a8000 | 
PTE_P
 | 
PTE_W
,

459 0x1a9000 | 
PTE_P
 | 
PTE_W
,

460 0x1Ø000 | 
PTE_P
 | 
PTE_W
,

461 0x1ab000 | 
PTE_P
 | 
PTE_W
,

462 0x1ac000 | 
PTE_P
 | 
PTE_W
,

463 0x1ad000 | 
PTE_P
 | 
PTE_W
,

464 0x1´000 | 
PTE_P
 | 
PTE_W
,

465 0x1af000 | 
PTE_P
 | 
PTE_W
,

466 0x1b0000 | 
PTE_P
 | 
PTE_W
,

467 0x1b1000 | 
PTE_P
 | 
PTE_W
,

468 0x1b2000 | 
PTE_P
 | 
PTE_W
,

469 0x1b3000 | 
PTE_P
 | 
PTE_W
,

470 0x1b4000 | 
PTE_P
 | 
PTE_W
,

471 0x1b5000 | 
PTE_P
 | 
PTE_W
,

472 0x1b6000 | 
PTE_P
 | 
PTE_W
,

473 0x1b7000 | 
PTE_P
 | 
PTE_W
,

474 0x1b8000 | 
PTE_P
 | 
PTE_W
,

475 0x1b9000 | 
PTE_P
 | 
PTE_W
,

476 0x1ba000 | 
PTE_P
 | 
PTE_W
,

477 0x1bb000 | 
PTE_P
 | 
PTE_W
,

478 0x1bc000 | 
PTE_P
 | 
PTE_W
,

479 0x1bd000 | 
PTE_P
 | 
PTE_W
,

480 0x1be000 | 
PTE_P
 | 
PTE_W
,

481 0x1bf000 | 
PTE_P
 | 
PTE_W
,

482 0x1c0000 | 
PTE_P
 | 
PTE_W
,

483 0x1c1000 | 
PTE_P
 | 
PTE_W
,

484 0x1c2000 | 
PTE_P
 | 
PTE_W
,

485 0x1c3000 | 
PTE_P
 | 
PTE_W
,

486 0x1c4000 | 
PTE_P
 | 
PTE_W
,

487 0x1c5000 | 
PTE_P
 | 
PTE_W
,

488 0x1c6000 | 
PTE_P
 | 
PTE_W
,

489 0x1c7000 | 
PTE_P
 | 
PTE_W
,

490 0x1c8000 | 
PTE_P
 | 
PTE_W
,

491 0x1c9000 | 
PTE_P
 | 
PTE_W
,

492 0x1ˇ000 | 
PTE_P
 | 
PTE_W
,

493 0x1cb000 | 
PTE_P
 | 
PTE_W
,

494 0x1cc000 | 
PTE_P
 | 
PTE_W
,

495 0x1cd000 | 
PTE_P
 | 
PTE_W
,

496 0x1˚000 | 
PTE_P
 | 
PTE_W
,

497 0x1cf000 | 
PTE_P
 | 
PTE_W
,

498 0x1d0000 | 
PTE_P
 | 
PTE_W
,

499 0x1d1000 | 
PTE_P
 | 
PTE_W
,

500 0x1d2000 | 
PTE_P
 | 
PTE_W
,

501 0x1d3000 | 
PTE_P
 | 
PTE_W
,

502 0x1d4000 | 
PTE_P
 | 
PTE_W
,

503 0x1d5000 | 
PTE_P
 | 
PTE_W
,

504 0x1d6000 | 
PTE_P
 | 
PTE_W
,

505 0x1d7000 | 
PTE_P
 | 
PTE_W
,

506 0x1d8000 | 
PTE_P
 | 
PTE_W
,

507 0x1d9000 | 
PTE_P
 | 
PTE_W
,

508 0x1da000 | 
PTE_P
 | 
PTE_W
,

509 0x1db000 | 
PTE_P
 | 
PTE_W
,

510 0x1dc000 | 
PTE_P
 | 
PTE_W
,

511 0x1dd000 | 
PTE_P
 | 
PTE_W
,

512 0x1de000 | 
PTE_P
 | 
PTE_W
,

513 0x1df000 | 
PTE_P
 | 
PTE_W
,

514 0x1e0000 | 
PTE_P
 | 
PTE_W
,

515 0x1e1000 | 
PTE_P
 | 
PTE_W
,

516 0x1e2000 | 
PTE_P
 | 
PTE_W
,

517 0x1e3000 | 
PTE_P
 | 
PTE_W
,

518 0x1e4000 | 
PTE_P
 | 
PTE_W
,

519 0x1e5000 | 
PTE_P
 | 
PTE_W
,

520 0x1e6000 | 
PTE_P
 | 
PTE_W
,

521 0x1e7000 | 
PTE_P
 | 
PTE_W
,

522 0x1e8000 | 
PTE_P
 | 
PTE_W
,

523 0x1e9000 | 
PTE_P
 | 
PTE_W
,

524 0x1ó000 | 
PTE_P
 | 
PTE_W
,

525 0x1eb000 | 
PTE_P
 | 
PTE_W
,

526 0x1ec000 | 
PTE_P
 | 
PTE_W
,

527 0x1ed000 | 
PTE_P
 | 
PTE_W
,

528 0x1ì000 | 
PTE_P
 | 
PTE_W
,

529 0x1ef000 | 
PTE_P
 | 
PTE_W
,

530 0x1f0000 | 
PTE_P
 | 
PTE_W
,

531 0x1f1000 | 
PTE_P
 | 
PTE_W
,

532 0x1f2000 | 
PTE_P
 | 
PTE_W
,

533 0x1f3000 | 
PTE_P
 | 
PTE_W
,

534 0x1f4000 | 
PTE_P
 | 
PTE_W
,

535 0x1f5000 | 
PTE_P
 | 
PTE_W
,

536 0x1f6000 | 
PTE_P
 | 
PTE_W
,

537 0x1f7000 | 
PTE_P
 | 
PTE_W
,

538 0x1f8000 | 
PTE_P
 | 
PTE_W
,

539 0x1f9000 | 
PTE_P
 | 
PTE_W
,

540 0x1Á000 | 
PTE_P
 | 
PTE_W
,

541 0x1fb000 | 
PTE_P
 | 
PTE_W
,

542 0x1fc000 | 
PTE_P
 | 
PTE_W
,

543 0x1fd000 | 
PTE_P
 | 
PTE_W
,

544 0x1„000 | 
PTE_P
 | 
PTE_W
,

545 0x1ff000 | 
PTE_P
 | 
PTE_W
,

546 0x200000 | 
PTE_P
 | 
PTE_W
,

547 0x201000 | 
PTE_P
 | 
PTE_W
,

548 0x202000 | 
PTE_P
 | 
PTE_W
,

549 0x203000 | 
PTE_P
 | 
PTE_W
,

550 0x204000 | 
PTE_P
 | 
PTE_W
,

551 0x205000 | 
PTE_P
 | 
PTE_W
,

552 0x206000 | 
PTE_P
 | 
PTE_W
,

553 0x207000 | 
PTE_P
 | 
PTE_W
,

554 0x208000 | 
PTE_P
 | 
PTE_W
,

555 0x209000 | 
PTE_P
 | 
PTE_W
,

556 0x20a000 | 
PTE_P
 | 
PTE_W
,

557 0x20b000 | 
PTE_P
 | 
PTE_W
,

558 0x20c000 | 
PTE_P
 | 
PTE_W
,

559 0x20d000 | 
PTE_P
 | 
PTE_W
,

560 0x20e000 | 
PTE_P
 | 
PTE_W
,

561 0x20f000 | 
PTE_P
 | 
PTE_W
,

562 0x210000 | 
PTE_P
 | 
PTE_W
,

563 0x211000 | 
PTE_P
 | 
PTE_W
,

564 0x212000 | 
PTE_P
 | 
PTE_W
,

565 0x213000 | 
PTE_P
 | 
PTE_W
,

566 0x214000 | 
PTE_P
 | 
PTE_W
,

567 0x215000 | 
PTE_P
 | 
PTE_W
,

568 0x216000 | 
PTE_P
 | 
PTE_W
,

569 0x217000 | 
PTE_P
 | 
PTE_W
,

570 0x218000 | 
PTE_P
 | 
PTE_W
,

571 0x219000 | 
PTE_P
 | 
PTE_W
,

572 0x21a000 | 
PTE_P
 | 
PTE_W
,

573 0x21b000 | 
PTE_P
 | 
PTE_W
,

574 0x21c000 | 
PTE_P
 | 
PTE_W
,

575 0x21d000 | 
PTE_P
 | 
PTE_W
,

576 0x21e000 | 
PTE_P
 | 
PTE_W
,

577 0x21f000 | 
PTE_P
 | 
PTE_W
,

578 0x220000 | 
PTE_P
 | 
PTE_W
,

579 0x221000 | 
PTE_P
 | 
PTE_W
,

580 0x222000 | 
PTE_P
 | 
PTE_W
,

581 0x223000 | 
PTE_P
 | 
PTE_W
,

582 0x224000 | 
PTE_P
 | 
PTE_W
,

583 0x225000 | 
PTE_P
 | 
PTE_W
,

584 0x226000 | 
PTE_P
 | 
PTE_W
,

585 0x227000 | 
PTE_P
 | 
PTE_W
,

586 0x228000 | 
PTE_P
 | 
PTE_W
,

587 0x229000 | 
PTE_P
 | 
PTE_W
,

588 0x22a000 | 
PTE_P
 | 
PTE_W
,

589 0x22b000 | 
PTE_P
 | 
PTE_W
,

590 0x22c000 | 
PTE_P
 | 
PTE_W
,

591 0x22d000 | 
PTE_P
 | 
PTE_W
,

592 0x22e000 | 
PTE_P
 | 
PTE_W
,

593 0x22f000 | 
PTE_P
 | 
PTE_W
,

594 0x230000 | 
PTE_P
 | 
PTE_W
,

595 0x231000 | 
PTE_P
 | 
PTE_W
,

596 0x232000 | 
PTE_P
 | 
PTE_W
,

597 0x233000 | 
PTE_P
 | 
PTE_W
,

598 0x234000 | 
PTE_P
 | 
PTE_W
,

599 0x235000 | 
PTE_P
 | 
PTE_W
,

600 0x236000 | 
PTE_P
 | 
PTE_W
,

601 0x237000 | 
PTE_P
 | 
PTE_W
,

602 0x238000 | 
PTE_P
 | 
PTE_W
,

603 0x239000 | 
PTE_P
 | 
PTE_W
,

604 0x23a000 | 
PTE_P
 | 
PTE_W
,

605 0x23b000 | 
PTE_P
 | 
PTE_W
,

606 0x23c000 | 
PTE_P
 | 
PTE_W
,

607 0x23d000 | 
PTE_P
 | 
PTE_W
,

608 0x23e000 | 
PTE_P
 | 
PTE_W
,

609 0x23f000 | 
PTE_P
 | 
PTE_W
,

610 0x240000 | 
PTE_P
 | 
PTE_W
,

611 0x241000 | 
PTE_P
 | 
PTE_W
,

612 0x242000 | 
PTE_P
 | 
PTE_W
,

613 0x243000 | 
PTE_P
 | 
PTE_W
,

614 0x244000 | 
PTE_P
 | 
PTE_W
,

615 0x245000 | 
PTE_P
 | 
PTE_W
,

616 0x246000 | 
PTE_P
 | 
PTE_W
,

617 0x247000 | 
PTE_P
 | 
PTE_W
,

618 0x248000 | 
PTE_P
 | 
PTE_W
,

619 0x249000 | 
PTE_P
 | 
PTE_W
,

620 0x24a000 | 
PTE_P
 | 
PTE_W
,

621 0x24b000 | 
PTE_P
 | 
PTE_W
,

622 0x24c000 | 
PTE_P
 | 
PTE_W
,

623 0x24d000 | 
PTE_P
 | 
PTE_W
,

624 0x24e000 | 
PTE_P
 | 
PTE_W
,

625 0x24f000 | 
PTE_P
 | 
PTE_W
,

626 0x250000 | 
PTE_P
 | 
PTE_W
,

627 0x251000 | 
PTE_P
 | 
PTE_W
,

628 0x252000 | 
PTE_P
 | 
PTE_W
,

629 0x253000 | 
PTE_P
 | 
PTE_W
,

630 0x254000 | 
PTE_P
 | 
PTE_W
,

631 0x255000 | 
PTE_P
 | 
PTE_W
,

632 0x256000 | 
PTE_P
 | 
PTE_W
,

633 0x257000 | 
PTE_P
 | 
PTE_W
,

634 0x258000 | 
PTE_P
 | 
PTE_W
,

635 0x259000 | 
PTE_P
 | 
PTE_W
,

636 0x25a000 | 
PTE_P
 | 
PTE_W
,

637 0x25b000 | 
PTE_P
 | 
PTE_W
,

638 0x25c000 | 
PTE_P
 | 
PTE_W
,

639 0x25d000 | 
PTE_P
 | 
PTE_W
,

640 0x25e000 | 
PTE_P
 | 
PTE_W
,

641 0x25f000 | 
PTE_P
 | 
PTE_W
,

642 0x260000 | 
PTE_P
 | 
PTE_W
,

643 0x261000 | 
PTE_P
 | 
PTE_W
,

644 0x262000 | 
PTE_P
 | 
PTE_W
,

645 0x263000 | 
PTE_P
 | 
PTE_W
,

646 0x264000 | 
PTE_P
 | 
PTE_W
,

647 0x265000 | 
PTE_P
 | 
PTE_W
,

648 0x266000 | 
PTE_P
 | 
PTE_W
,

649 0x267000 | 
PTE_P
 | 
PTE_W
,

650 0x268000 | 
PTE_P
 | 
PTE_W
,

651 0x269000 | 
PTE_P
 | 
PTE_W
,

652 0x26a000 | 
PTE_P
 | 
PTE_W
,

653 0x26b000 | 
PTE_P
 | 
PTE_W
,

654 0x26c000 | 
PTE_P
 | 
PTE_W
,

655 0x26d000 | 
PTE_P
 | 
PTE_W
,

656 0x26e000 | 
PTE_P
 | 
PTE_W
,

657 0x26f000 | 
PTE_P
 | 
PTE_W
,

658 0x270000 | 
PTE_P
 | 
PTE_W
,

659 0x271000 | 
PTE_P
 | 
PTE_W
,

660 0x272000 | 
PTE_P
 | 
PTE_W
,

661 0x273000 | 
PTE_P
 | 
PTE_W
,

662 0x274000 | 
PTE_P
 | 
PTE_W
,

663 0x275000 | 
PTE_P
 | 
PTE_W
,

664 0x276000 | 
PTE_P
 | 
PTE_W
,

665 0x277000 | 
PTE_P
 | 
PTE_W
,

666 0x278000 | 
PTE_P
 | 
PTE_W
,

667 0x279000 | 
PTE_P
 | 
PTE_W
,

668 0x27a000 | 
PTE_P
 | 
PTE_W
,

669 0x27b000 | 
PTE_P
 | 
PTE_W
,

670 0x27c000 | 
PTE_P
 | 
PTE_W
,

671 0x27d000 | 
PTE_P
 | 
PTE_W
,

672 0x27e000 | 
PTE_P
 | 
PTE_W
,

673 0x27f000 | 
PTE_P
 | 
PTE_W
,

674 0x280000 | 
PTE_P
 | 
PTE_W
,

675 0x281000 | 
PTE_P
 | 
PTE_W
,

676 0x282000 | 
PTE_P
 | 
PTE_W
,

677 0x283000 | 
PTE_P
 | 
PTE_W
,

678 0x284000 | 
PTE_P
 | 
PTE_W
,

679 0x285000 | 
PTE_P
 | 
PTE_W
,

680 0x286000 | 
PTE_P
 | 
PTE_W
,

681 0x287000 | 
PTE_P
 | 
PTE_W
,

682 0x288000 | 
PTE_P
 | 
PTE_W
,

683 0x289000 | 
PTE_P
 | 
PTE_W
,

684 0x28a000 | 
PTE_P
 | 
PTE_W
,

685 0x28b000 | 
PTE_P
 | 
PTE_W
,

686 0x28c000 | 
PTE_P
 | 
PTE_W
,

687 0x28d000 | 
PTE_P
 | 
PTE_W
,

688 0x28e000 | 
PTE_P
 | 
PTE_W
,

689 0x28f000 | 
PTE_P
 | 
PTE_W
,

690 0x290000 | 
PTE_P
 | 
PTE_W
,

691 0x291000 | 
PTE_P
 | 
PTE_W
,

692 0x292000 | 
PTE_P
 | 
PTE_W
,

693 0x293000 | 
PTE_P
 | 
PTE_W
,

694 0x294000 | 
PTE_P
 | 
PTE_W
,

695 0x295000 | 
PTE_P
 | 
PTE_W
,

696 0x296000 | 
PTE_P
 | 
PTE_W
,

697 0x297000 | 
PTE_P
 | 
PTE_W
,

698 0x298000 | 
PTE_P
 | 
PTE_W
,

699 0x299000 | 
PTE_P
 | 
PTE_W
,

700 0x29a000 | 
PTE_P
 | 
PTE_W
,

701 0x29b000 | 
PTE_P
 | 
PTE_W
,

702 0x29c000 | 
PTE_P
 | 
PTE_W
,

703 0x29d000 | 
PTE_P
 | 
PTE_W
,

704 0x29e000 | 
PTE_P
 | 
PTE_W
,

705 0x29f000 | 
PTE_P
 | 
PTE_W
,

706 0x2a0000 | 
PTE_P
 | 
PTE_W
,

707 0x2a1000 | 
PTE_P
 | 
PTE_W
,

708 0x2a2000 | 
PTE_P
 | 
PTE_W
,

709 0x2a3000 | 
PTE_P
 | 
PTE_W
,

710 0x2a4000 | 
PTE_P
 | 
PTE_W
,

711 0x2a5000 | 
PTE_P
 | 
PTE_W
,

712 0x2a6000 | 
PTE_P
 | 
PTE_W
,

713 0x2a7000 | 
PTE_P
 | 
PTE_W
,

714 0x2a8000 | 
PTE_P
 | 
PTE_W
,

715 0x2a9000 | 
PTE_P
 | 
PTE_W
,

716 0x2Ø000 | 
PTE_P
 | 
PTE_W
,

717 0x2ab000 | 
PTE_P
 | 
PTE_W
,

718 0x2ac000 | 
PTE_P
 | 
PTE_W
,

719 0x2ad000 | 
PTE_P
 | 
PTE_W
,

720 0x2´000 | 
PTE_P
 | 
PTE_W
,

721 0x2af000 | 
PTE_P
 | 
PTE_W
,

722 0x2b0000 | 
PTE_P
 | 
PTE_W
,

723 0x2b1000 | 
PTE_P
 | 
PTE_W
,

724 0x2b2000 | 
PTE_P
 | 
PTE_W
,

725 0x2b3000 | 
PTE_P
 | 
PTE_W
,

726 0x2b4000 | 
PTE_P
 | 
PTE_W
,

727 0x2b5000 | 
PTE_P
 | 
PTE_W
,

728 0x2b6000 | 
PTE_P
 | 
PTE_W
,

729 0x2b7000 | 
PTE_P
 | 
PTE_W
,

730 0x2b8000 | 
PTE_P
 | 
PTE_W
,

731 0x2b9000 | 
PTE_P
 | 
PTE_W
,

732 0x2ba000 | 
PTE_P
 | 
PTE_W
,

733 0x2bb000 | 
PTE_P
 | 
PTE_W
,

734 0x2bc000 | 
PTE_P
 | 
PTE_W
,

735 0x2bd000 | 
PTE_P
 | 
PTE_W
,

736 0x2be000 | 
PTE_P
 | 
PTE_W
,

737 0x2bf000 | 
PTE_P
 | 
PTE_W
,

738 0x2c0000 | 
PTE_P
 | 
PTE_W
,

739 0x2c1000 | 
PTE_P
 | 
PTE_W
,

740 0x2c2000 | 
PTE_P
 | 
PTE_W
,

741 0x2c3000 | 
PTE_P
 | 
PTE_W
,

742 0x2c4000 | 
PTE_P
 | 
PTE_W
,

743 0x2c5000 | 
PTE_P
 | 
PTE_W
,

744 0x2c6000 | 
PTE_P
 | 
PTE_W
,

745 0x2c7000 | 
PTE_P
 | 
PTE_W
,

746 0x2c8000 | 
PTE_P
 | 
PTE_W
,

747 0x2c9000 | 
PTE_P
 | 
PTE_W
,

748 0x2ˇ000 | 
PTE_P
 | 
PTE_W
,

749 0x2cb000 | 
PTE_P
 | 
PTE_W
,

750 0x2cc000 | 
PTE_P
 | 
PTE_W
,

751 0x2cd000 | 
PTE_P
 | 
PTE_W
,

752 0x2˚000 | 
PTE_P
 | 
PTE_W
,

753 0x2cf000 | 
PTE_P
 | 
PTE_W
,

754 0x2d0000 | 
PTE_P
 | 
PTE_W
,

755 0x2d1000 | 
PTE_P
 | 
PTE_W
,

756 0x2d2000 | 
PTE_P
 | 
PTE_W
,

757 0x2d3000 | 
PTE_P
 | 
PTE_W
,

758 0x2d4000 | 
PTE_P
 | 
PTE_W
,

759 0x2d5000 | 
PTE_P
 | 
PTE_W
,

760 0x2d6000 | 
PTE_P
 | 
PTE_W
,

761 0x2d7000 | 
PTE_P
 | 
PTE_W
,

762 0x2d8000 | 
PTE_P
 | 
PTE_W
,

763 0x2d9000 | 
PTE_P
 | 
PTE_W
,

764 0x2da000 | 
PTE_P
 | 
PTE_W
,

765 0x2db000 | 
PTE_P
 | 
PTE_W
,

766 0x2dc000 | 
PTE_P
 | 
PTE_W
,

767 0x2dd000 | 
PTE_P
 | 
PTE_W
,

768 0x2de000 | 
PTE_P
 | 
PTE_W
,

769 0x2df000 | 
PTE_P
 | 
PTE_W
,

770 0x2e0000 | 
PTE_P
 | 
PTE_W
,

771 0x2e1000 | 
PTE_P
 | 
PTE_W
,

772 0x2e2000 | 
PTE_P
 | 
PTE_W
,

773 0x2e3000 | 
PTE_P
 | 
PTE_W
,

774 0x2e4000 | 
PTE_P
 | 
PTE_W
,

775 0x2e5000 | 
PTE_P
 | 
PTE_W
,

776 0x2e6000 | 
PTE_P
 | 
PTE_W
,

777 0x2e7000 | 
PTE_P
 | 
PTE_W
,

778 0x2e8000 | 
PTE_P
 | 
PTE_W
,

779 0x2e9000 | 
PTE_P
 | 
PTE_W
,

780 0x2ó000 | 
PTE_P
 | 
PTE_W
,

781 0x2eb000 | 
PTE_P
 | 
PTE_W
,

782 0x2ec000 | 
PTE_P
 | 
PTE_W
,

783 0x2ed000 | 
PTE_P
 | 
PTE_W
,

784 0x2ì000 | 
PTE_P
 | 
PTE_W
,

785 0x2ef000 | 
PTE_P
 | 
PTE_W
,

786 0x2f0000 | 
PTE_P
 | 
PTE_W
,

787 0x2f1000 | 
PTE_P
 | 
PTE_W
,

788 0x2f2000 | 
PTE_P
 | 
PTE_W
,

789 0x2f3000 | 
PTE_P
 | 
PTE_W
,

790 0x2f4000 | 
PTE_P
 | 
PTE_W
,

791 0x2f5000 | 
PTE_P
 | 
PTE_W
,

792 0x2f6000 | 
PTE_P
 | 
PTE_W
,

793 0x2f7000 | 
PTE_P
 | 
PTE_W
,

794 0x2f8000 | 
PTE_P
 | 
PTE_W
,

795 0x2f9000 | 
PTE_P
 | 
PTE_W
,

796 0x2Á000 | 
PTE_P
 | 
PTE_W
,

797 0x2fb000 | 
PTE_P
 | 
PTE_W
,

798 0x2fc000 | 
PTE_P
 | 
PTE_W
,

799 0x2fd000 | 
PTE_P
 | 
PTE_W
,

800 0x2„000 | 
PTE_P
 | 
PTE_W
,

801 0x2ff000 | 
PTE_P
 | 
PTE_W
,

802 0x300000 | 
PTE_P
 | 
PTE_W
,

803 0x301000 | 
PTE_P
 | 
PTE_W
,

804 0x302000 | 
PTE_P
 | 
PTE_W
,

805 0x303000 | 
PTE_P
 | 
PTE_W
,

806 0x304000 | 
PTE_P
 | 
PTE_W
,

807 0x305000 | 
PTE_P
 | 
PTE_W
,

808 0x306000 | 
PTE_P
 | 
PTE_W
,

809 0x307000 | 
PTE_P
 | 
PTE_W
,

810 0x308000 | 
PTE_P
 | 
PTE_W
,

811 0x309000 | 
PTE_P
 | 
PTE_W
,

812 0x30a000 | 
PTE_P
 | 
PTE_W
,

813 0x30b000 | 
PTE_P
 | 
PTE_W
,

814 0x30c000 | 
PTE_P
 | 
PTE_W
,

815 0x30d000 | 
PTE_P
 | 
PTE_W
,

816 0x30e000 | 
PTE_P
 | 
PTE_W
,

817 0x30f000 | 
PTE_P
 | 
PTE_W
,

818 0x310000 | 
PTE_P
 | 
PTE_W
,

819 0x311000 | 
PTE_P
 | 
PTE_W
,

820 0x312000 | 
PTE_P
 | 
PTE_W
,

821 0x313000 | 
PTE_P
 | 
PTE_W
,

822 0x314000 | 
PTE_P
 | 
PTE_W
,

823 0x315000 | 
PTE_P
 | 
PTE_W
,

824 0x316000 | 
PTE_P
 | 
PTE_W
,

825 0x317000 | 
PTE_P
 | 
PTE_W
,

826 0x318000 | 
PTE_P
 | 
PTE_W
,

827 0x319000 | 
PTE_P
 | 
PTE_W
,

828 0x31a000 | 
PTE_P
 | 
PTE_W
,

829 0x31b000 | 
PTE_P
 | 
PTE_W
,

830 0x31c000 | 
PTE_P
 | 
PTE_W
,

831 0x31d000 | 
PTE_P
 | 
PTE_W
,

832 0x31e000 | 
PTE_P
 | 
PTE_W
,

833 0x31f000 | 
PTE_P
 | 
PTE_W
,

834 0x320000 | 
PTE_P
 | 
PTE_W
,

835 0x321000 | 
PTE_P
 | 
PTE_W
,

836 0x322000 | 
PTE_P
 | 
PTE_W
,

837 0x323000 | 
PTE_P
 | 
PTE_W
,

838 0x324000 | 
PTE_P
 | 
PTE_W
,

839 0x325000 | 
PTE_P
 | 
PTE_W
,

840 0x326000 | 
PTE_P
 | 
PTE_W
,

841 0x327000 | 
PTE_P
 | 
PTE_W
,

842 0x328000 | 
PTE_P
 | 
PTE_W
,

843 0x329000 | 
PTE_P
 | 
PTE_W
,

844 0x32a000 | 
PTE_P
 | 
PTE_W
,

845 0x32b000 | 
PTE_P
 | 
PTE_W
,

846 0x32c000 | 
PTE_P
 | 
PTE_W
,

847 0x32d000 | 
PTE_P
 | 
PTE_W
,

848 0x32e000 | 
PTE_P
 | 
PTE_W
,

849 0x32f000 | 
PTE_P
 | 
PTE_W
,

850 0x330000 | 
PTE_P
 | 
PTE_W
,

851 0x331000 | 
PTE_P
 | 
PTE_W
,

852 0x332000 | 
PTE_P
 | 
PTE_W
,

853 0x333000 | 
PTE_P
 | 
PTE_W
,

854 0x334000 | 
PTE_P
 | 
PTE_W
,

855 0x335000 | 
PTE_P
 | 
PTE_W
,

856 0x336000 | 
PTE_P
 | 
PTE_W
,

857 0x337000 | 
PTE_P
 | 
PTE_W
,

858 0x338000 | 
PTE_P
 | 
PTE_W
,

859 0x339000 | 
PTE_P
 | 
PTE_W
,

860 0x33a000 | 
PTE_P
 | 
PTE_W
,

861 0x33b000 | 
PTE_P
 | 
PTE_W
,

862 0x33c000 | 
PTE_P
 | 
PTE_W
,

863 0x33d000 | 
PTE_P
 | 
PTE_W
,

864 0x33e000 | 
PTE_P
 | 
PTE_W
,

865 0x33f000 | 
PTE_P
 | 
PTE_W
,

866 0x340000 | 
PTE_P
 | 
PTE_W
,

867 0x341000 | 
PTE_P
 | 
PTE_W
,

868 0x342000 | 
PTE_P
 | 
PTE_W
,

869 0x343000 | 
PTE_P
 | 
PTE_W
,

870 0x344000 | 
PTE_P
 | 
PTE_W
,

871 0x345000 | 
PTE_P
 | 
PTE_W
,

872 0x346000 | 
PTE_P
 | 
PTE_W
,

873 0x347000 | 
PTE_P
 | 
PTE_W
,

874 0x348000 | 
PTE_P
 | 
PTE_W
,

875 0x349000 | 
PTE_P
 | 
PTE_W
,

876 0x34a000 | 
PTE_P
 | 
PTE_W
,

877 0x34b000 | 
PTE_P
 | 
PTE_W
,

878 0x34c000 | 
PTE_P
 | 
PTE_W
,

879 0x34d000 | 
PTE_P
 | 
PTE_W
,

880 0x34e000 | 
PTE_P
 | 
PTE_W
,

881 0x34f000 | 
PTE_P
 | 
PTE_W
,

882 0x350000 | 
PTE_P
 | 
PTE_W
,

883 0x351000 | 
PTE_P
 | 
PTE_W
,

884 0x352000 | 
PTE_P
 | 
PTE_W
,

885 0x353000 | 
PTE_P
 | 
PTE_W
,

886 0x354000 | 
PTE_P
 | 
PTE_W
,

887 0x355000 | 
PTE_P
 | 
PTE_W
,

888 0x356000 | 
PTE_P
 | 
PTE_W
,

889 0x357000 | 
PTE_P
 | 
PTE_W
,

890 0x358000 | 
PTE_P
 | 
PTE_W
,

891 0x359000 | 
PTE_P
 | 
PTE_W
,

892 0x35a000 | 
PTE_P
 | 
PTE_W
,

893 0x35b000 | 
PTE_P
 | 
PTE_W
,

894 0x35c000 | 
PTE_P
 | 
PTE_W
,

895 0x35d000 | 
PTE_P
 | 
PTE_W
,

896 0x35e000 | 
PTE_P
 | 
PTE_W
,

897 0x35f000 | 
PTE_P
 | 
PTE_W
,

898 0x360000 | 
PTE_P
 | 
PTE_W
,

899 0x361000 | 
PTE_P
 | 
PTE_W
,

900 0x362000 | 
PTE_P
 | 
PTE_W
,

901 0x363000 | 
PTE_P
 | 
PTE_W
,

902 0x364000 | 
PTE_P
 | 
PTE_W
,

903 0x365000 | 
PTE_P
 | 
PTE_W
,

904 0x366000 | 
PTE_P
 | 
PTE_W
,

905 0x367000 | 
PTE_P
 | 
PTE_W
,

906 0x368000 | 
PTE_P
 | 
PTE_W
,

907 0x369000 | 
PTE_P
 | 
PTE_W
,

908 0x36a000 | 
PTE_P
 | 
PTE_W
,

909 0x36b000 | 
PTE_P
 | 
PTE_W
,

910 0x36c000 | 
PTE_P
 | 
PTE_W
,

911 0x36d000 | 
PTE_P
 | 
PTE_W
,

912 0x36e000 | 
PTE_P
 | 
PTE_W
,

913 0x36f000 | 
PTE_P
 | 
PTE_W
,

914 0x370000 | 
PTE_P
 | 
PTE_W
,

915 0x371000 | 
PTE_P
 | 
PTE_W
,

916 0x372000 | 
PTE_P
 | 
PTE_W
,

917 0x373000 | 
PTE_P
 | 
PTE_W
,

918 0x374000 | 
PTE_P
 | 
PTE_W
,

919 0x375000 | 
PTE_P
 | 
PTE_W
,

920 0x376000 | 
PTE_P
 | 
PTE_W
,

921 0x377000 | 
PTE_P
 | 
PTE_W
,

922 0x378000 | 
PTE_P
 | 
PTE_W
,

923 0x379000 | 
PTE_P
 | 
PTE_W
,

924 0x37a000 | 
PTE_P
 | 
PTE_W
,

925 0x37b000 | 
PTE_P
 | 
PTE_W
,

926 0x37c000 | 
PTE_P
 | 
PTE_W
,

927 0x37d000 | 
PTE_P
 | 
PTE_W
,

928 0x37e000 | 
PTE_P
 | 
PTE_W
,

929 0x37f000 | 
PTE_P
 | 
PTE_W
,

930 0x380000 | 
PTE_P
 | 
PTE_W
,

931 0x381000 | 
PTE_P
 | 
PTE_W
,

932 0x382000 | 
PTE_P
 | 
PTE_W
,

933 0x383000 | 
PTE_P
 | 
PTE_W
,

934 0x384000 | 
PTE_P
 | 
PTE_W
,

935 0x385000 | 
PTE_P
 | 
PTE_W
,

936 0x386000 | 
PTE_P
 | 
PTE_W
,

937 0x387000 | 
PTE_P
 | 
PTE_W
,

938 0x388000 | 
PTE_P
 | 
PTE_W
,

939 0x389000 | 
PTE_P
 | 
PTE_W
,

940 0x38a000 | 
PTE_P
 | 
PTE_W
,

941 0x38b000 | 
PTE_P
 | 
PTE_W
,

942 0x38c000 | 
PTE_P
 | 
PTE_W
,

943 0x38d000 | 
PTE_P
 | 
PTE_W
,

944 0x38e000 | 
PTE_P
 | 
PTE_W
,

945 0x38f000 | 
PTE_P
 | 
PTE_W
,

946 0x390000 | 
PTE_P
 | 
PTE_W
,

947 0x391000 | 
PTE_P
 | 
PTE_W
,

948 0x392000 | 
PTE_P
 | 
PTE_W
,

949 0x393000 | 
PTE_P
 | 
PTE_W
,

950 0x394000 | 
PTE_P
 | 
PTE_W
,

951 0x395000 | 
PTE_P
 | 
PTE_W
,

952 0x396000 | 
PTE_P
 | 
PTE_W
,

953 0x397000 | 
PTE_P
 | 
PTE_W
,

954 0x398000 | 
PTE_P
 | 
PTE_W
,

955 0x399000 | 
PTE_P
 | 
PTE_W
,

956 0x39a000 | 
PTE_P
 | 
PTE_W
,

957 0x39b000 | 
PTE_P
 | 
PTE_W
,

958 0x39c000 | 
PTE_P
 | 
PTE_W
,

959 0x39d000 | 
PTE_P
 | 
PTE_W
,

960 0x39e000 | 
PTE_P
 | 
PTE_W
,

961 0x39f000 | 
PTE_P
 | 
PTE_W
,

962 0x3a0000 | 
PTE_P
 | 
PTE_W
,

963 0x3a1000 | 
PTE_P
 | 
PTE_W
,

964 0x3a2000 | 
PTE_P
 | 
PTE_W
,

965 0x3a3000 | 
PTE_P
 | 
PTE_W
,

966 0x3a4000 | 
PTE_P
 | 
PTE_W
,

967 0x3a5000 | 
PTE_P
 | 
PTE_W
,

968 0x3a6000 | 
PTE_P
 | 
PTE_W
,

969 0x3a7000 | 
PTE_P
 | 
PTE_W
,

970 0x3a8000 | 
PTE_P
 | 
PTE_W
,

971 0x3a9000 | 
PTE_P
 | 
PTE_W
,

972 0x3Ø000 | 
PTE_P
 | 
PTE_W
,

973 0x3ab000 | 
PTE_P
 | 
PTE_W
,

974 0x3ac000 | 
PTE_P
 | 
PTE_W
,

975 0x3ad000 | 
PTE_P
 | 
PTE_W
,

976 0x3´000 | 
PTE_P
 | 
PTE_W
,

977 0x3af000 | 
PTE_P
 | 
PTE_W
,

978 0x3b0000 | 
PTE_P
 | 
PTE_W
,

979 0x3b1000 | 
PTE_P
 | 
PTE_W
,

980 0x3b2000 | 
PTE_P
 | 
PTE_W
,

981 0x3b3000 | 
PTE_P
 | 
PTE_W
,

982 0x3b4000 | 
PTE_P
 | 
PTE_W
,

983 0x3b5000 | 
PTE_P
 | 
PTE_W
,

984 0x3b6000 | 
PTE_P
 | 
PTE_W
,

985 0x3b7000 | 
PTE_P
 | 
PTE_W
,

986 0x3b8000 | 
PTE_P
 | 
PTE_W
,

987 0x3b9000 | 
PTE_P
 | 
PTE_W
,

988 0x3ba000 | 
PTE_P
 | 
PTE_W
,

989 0x3bb000 | 
PTE_P
 | 
PTE_W
,

990 0x3bc000 | 
PTE_P
 | 
PTE_W
,

991 0x3bd000 | 
PTE_P
 | 
PTE_W
,

992 0x3be000 | 
PTE_P
 | 
PTE_W
,

993 0x3bf000 | 
PTE_P
 | 
PTE_W
,

994 0x3c0000 | 
PTE_P
 | 
PTE_W
,

995 0x3c1000 | 
PTE_P
 | 
PTE_W
,

996 0x3c2000 | 
PTE_P
 | 
PTE_W
,

997 0x3c3000 | 
PTE_P
 | 
PTE_W
,

998 0x3c4000 | 
PTE_P
 | 
PTE_W
,

999 0x3c5000 | 
PTE_P
 | 
PTE_W
,

1000 0x3c6000 | 
PTE_P
 | 
PTE_W
,

1001 0x3c7000 | 
PTE_P
 | 
PTE_W
,

1002 0x3c8000 | 
PTE_P
 | 
PTE_W
,

1003 0x3c9000 | 
PTE_P
 | 
PTE_W
,

1004 0x3ˇ000 | 
PTE_P
 | 
PTE_W
,

1005 0x3cb000 | 
PTE_P
 | 
PTE_W
,

1006 0x3cc000 | 
PTE_P
 | 
PTE_W
,

1007 0x3cd000 | 
PTE_P
 | 
PTE_W
,

1008 0x3˚000 | 
PTE_P
 | 
PTE_W
,

1009 0x3cf000 | 
PTE_P
 | 
PTE_W
,

1010 0x3d0000 | 
PTE_P
 | 
PTE_W
,

1011 0x3d1000 | 
PTE_P
 | 
PTE_W
,

1012 0x3d2000 | 
PTE_P
 | 
PTE_W
,

1013 0x3d3000 | 
PTE_P
 | 
PTE_W
,

1014 0x3d4000 | 
PTE_P
 | 
PTE_W
,

1015 0x3d5000 | 
PTE_P
 | 
PTE_W
,

1016 0x3d6000 | 
PTE_P
 | 
PTE_W
,

1017 0x3d7000 | 
PTE_P
 | 
PTE_W
,

1018 0x3d8000 | 
PTE_P
 | 
PTE_W
,

1019 0x3d9000 | 
PTE_P
 | 
PTE_W
,

1020 0x3da000 | 
PTE_P
 | 
PTE_W
,

1021 0x3db000 | 
PTE_P
 | 
PTE_W
,

1022 0x3dc000 | 
PTE_P
 | 
PTE_W
,

1023 0x3dd000 | 
PTE_P
 | 
PTE_W
,

1024 0x3de000 | 
PTE_P
 | 
PTE_W
,

1025 0x3df000 | 
PTE_P
 | 
PTE_W
,

1026 0x3e0000 | 
PTE_P
 | 
PTE_W
,

1027 0x3e1000 | 
PTE_P
 | 
PTE_W
,

1028 0x3e2000 | 
PTE_P
 | 
PTE_W
,

1029 0x3e3000 | 
PTE_P
 | 
PTE_W
,

1030 0x3e4000 | 
PTE_P
 | 
PTE_W
,

1031 0x3e5000 | 
PTE_P
 | 
PTE_W
,

1032 0x3e6000 | 
PTE_P
 | 
PTE_W
,

1033 0x3e7000 | 
PTE_P
 | 
PTE_W
,

1034 0x3e8000 | 
PTE_P
 | 
PTE_W
,

1035 0x3e9000 | 
PTE_P
 | 
PTE_W
,

1036 0x3ó000 | 
PTE_P
 | 
PTE_W
,

1037 0x3eb000 | 
PTE_P
 | 
PTE_W
,

1038 0x3ec000 | 
PTE_P
 | 
PTE_W
,

1039 0x3ed000 | 
PTE_P
 | 
PTE_W
,

1040 0x3ì000 | 
PTE_P
 | 
PTE_W
,

1041 0x3ef000 | 
PTE_P
 | 
PTE_W
,

1042 0x3f0000 | 
PTE_P
 | 
PTE_W
,

1043 0x3f1000 | 
PTE_P
 | 
PTE_W
,

1044 0x3f2000 | 
PTE_P
 | 
PTE_W
,

1045 0x3f3000 | 
PTE_P
 | 
PTE_W
,

1046 0x3f4000 | 
PTE_P
 | 
PTE_W
,

1047 0x3f5000 | 
PTE_P
 | 
PTE_W
,

1048 0x3f6000 | 
PTE_P
 | 
PTE_W
,

1049 0x3f7000 | 
PTE_P
 | 
PTE_W
,

1050 0x3f8000 | 
PTE_P
 | 
PTE_W
,

1051 0x3f9000 | 
PTE_P
 | 
PTE_W
,

1052 0x3Á000 | 
PTE_P
 | 
PTE_W
,

1053 0x3fb000 | 
PTE_P
 | 
PTE_W
,

1054 0x3fc000 | 
PTE_P
 | 
PTE_W
,

1055 0x3fd000 | 
PTE_P
 | 
PTE_W
,

1056 0x3„000 | 
PTE_P
 | 
PTE_W
,

1057 0x3ff000 | 
PTE_P
 | 
PTE_W
,

1058 
	}
};

	@kern/env.c

3 
	~<öc/x86.h
>

4 
	~<öc/mmu.h
>

5 
	~<öc/îr‹.h
>

6 
	~<öc/°rög.h
>

7 
	~<öc/as£π.h
>

8 
	~<öc/ñf.h
>

10 
	~<kîn/ív.h
>

11 
	~<kîn/pm≠.h
>

12 
	~<kîn/å≠.h
>

13 
	~<kîn/m⁄ô‹.h
>

14 
	~<kîn/sched.h
>

15 
	~<kîn/˝u.h
>

16 
	~<kîn/•ölock.h
>

18 
Env
 *
	gívs
 = 
NULL
;

19 
Env
 *
	gív_‰ì_li°
;

22 
	#ENVGENSHIFT
 12

23 

	)

39 
Segdesc
 
	ggdt
[
NCPU
 + 5] =

42 
SEG_NULL
,

45 [
GD_KT
 >> 3] = 
SEG
(
STA_X
 | 
STA_R
, 0x0, 0xffffffff, 0),

48 [
GD_KD
 >> 3] = 
SEG
(
STA_W
, 0x0, 0xffffffff, 0),

51 [
GD_UT
 >> 3] = 
SEG
(
STA_X
 | 
STA_R
, 0x0, 0xffffffff, 3),

54 [
GD_UD
 >> 3] = 
SEG
(
STA_W
, 0x0, 0xffffffff, 3),

58 [
GD_TSS0
 >> 3] = 
SEG_NULL


61 
P£udodesc
 
	ggdt_pd
 = {

62 (
gdt
) - 1, () gdt

76 
	$ívid2ív
(
ívid_t
 
ívid
, 
Env
 **
ív_°‹e
, 
boﬁ
 
check≥rm
)

78 
Env
 *
e
;

81 i‡(
ívid
 == 0) {

82 *
ív_°‹e
 = 
cuªnv
;

91 
e
 = &
ívs
[
	`ENVX
(
ívid
)];

92 i‡(
e
->
ív_°©us
 =
ENV_FREE
 ||É->
ív_id
 !
ívid
) {

93 *
ív_°‹e
 = 0;

94  -
E_BAD_ENV
;

102 i‡(
check≥rm
 && 
e
 !
cuªnv
 &&É->
ív_∑ª¡_id
 !cuªnv->
ív_id
) {

103 *
ív_°‹e
 = 0;

104  -
E_BAD_ENV
;

107 *
ív_°‹e
 = 
e
;

109 
	}
}

118 
	$ív_öô
()

122 
i
;

123 
i
 = 0; i < 
NENV
; i++){

124 if(
i
 =
NENV
 - 1){

125 
ívs
[
i
].
ív_lök
 = 
NULL
;

127 
ívs
[
i
].
ív_lök
 = &envs[i+1];

129 
ívs
[
i
].
ív_id
 = 0;

130 
ívs
[
i
].
ív_∑ª¡_id
 = 0;

131 
ívs
[
i
].
ív_ty≥
 = 
ENV_TYPE_USER
;

132 
ívs
[
i
].
ív_°©us
 = 
ENV_FREE
;

133 
ívs
[
i
].
ív_runs
 = 0;

134 
ívs
[
i
].
ív_pgdú
 = 
NULL
;

136 
ív_‰ì_li°
 = 
ívs
;

138 
	`ív_öô_≥r˝u
();

139 
	}
}

143 
	$ív_öô_≥r˝u
()

145 
	`lgdt
(&
gdt_pd
);

148 
asm
 vﬁ©ûe("movw %%ax,%%gs" : : "a" (
GD_UD
|3));

149 
asm
 vﬁ©ûe("movw %%ax,%%fs" : : "a" (
GD_UD
|3));

152 
asm
 vﬁ©ûe("movw %%ax,%%es" : : "a" (
GD_KD
));

153 
asm
 vﬁ©ûe("movw %%ax,%%ds" : : "a" (
GD_KD
));

154 
asm
 vﬁ©ûe("movw %%ax,%%ss" : : "a" (
GD_KD
));

156 
asm
 vﬁ©ûe("ljm∞%0,$1f\¿1:\n" : : "i" (
GD_KT
));

159 
	`Œdt
(0);

160 
	}
}

173 
	$ív_£tup_vm
(
Env
 *
e
)

175 
i
;

176 
PageInfo
 *
p
 = 
NULL
;

179 i‡(!(
p
 = 
	`∑ge_Æloc
(
ALLOC_ZERO
)))

180  -
E_NO_MEM
;

199 
e
->
ív_pgdú
 =(
pde_t
 *)
	`∑ge2kva
(
p
);

200 
p
->
µ_ªf
++;

203 
i
 = 0; i < 
	`PDX
(
UTOP
); i++){

204 
e
->
ív_pgdú
[
i
] = 0;

206 
i
 = 
	`PDX
(
UTOP
); i<
NPDENTRIES
; i++){

207 
e
->
ív_pgdú
[
i
] = 
kîn_pgdú
[i];

211 
e
->
ív_pgdú
[
	`PDX
(
UVPT
)] = 
	`PADDR
”->ív_pgdúË| 
PTE_P
 | 
PTE_U
;

214 
	}
}

225 
	$ív_Æloc
(
Env
 **
√wív_°‹e
, 
ívid_t
 
∑ª¡_id
)

227 
öt32_t
 
gíî©i⁄
;

228 
r
;

229 
Env
 *
e
;

231 i‡(!(
e
 = 
ív_‰ì_li°
))

232  -
E_NO_FREE_ENV
;

235 i‡((
r
 = 
	`ív_£tup_vm
(
e
)) < 0)

236  
r
;

239 
gíî©i⁄
 = (
e
->
ív_id
 + (1 << 
ENVGENSHIFT
)Ë& ~(
NENV
 - 1);

240 i‡(
gíî©i⁄
 <= 0)

241 
gíî©i⁄
 = 1 << 
ENVGENSHIFT
;

242 
e
->
ív_id
 = 
gíî©i⁄
 | (ê- 
ívs
);

245 
e
->
ív_∑ª¡_id
 = 
∑ª¡_id
;

246 
e
->
ív_ty≥
 = 
ENV_TYPE_USER
;

247 
e
->
ív_°©us
 = 
ENV_RUNNABLE
;

248 
e
->
ív_runs
 = 0;

254 
	`mem£t
(&
e
->
ív_tf
, 0, (e->env_tf));

264 
e
->
ív_tf
.
tf_ds
 = 
GD_UD
 | 3;

265 
e
->
ív_tf
.
tf_es
 = 
GD_UD
 | 3;

266 
e
->
ív_tf
.
tf_ss
 = 
GD_UD
 | 3;

267 
e
->
ív_tf
.
tf_e•
 = 
USTACKTOP
;

268 
e
->
ív_tf
.
tf_cs
 = 
GD_UT
 | 3;

273 
e
->
ív_tf
.
tf_eÊags
 |
FL_IF
;

275 
e
->
ív_pgÁu…_upˇŒ
 = 0;

278 
e
->
ív_ùc_ªcvög
 = 0;

281 
ív_‰ì_li°
 = 
e
->
ív_lök
;

282 *
√wív_°‹e
 = 
e
;

286 
	}
}

296 
	$ªgi⁄_Æloc
(
Env
 *
e
, *
va
, 
size_t
 
Àn
)

305 
uöt32_t
 
°¨t
 = (uöt32_t)
	`ROUNDDOWN
(
va
, 
PGSIZE
);

306 
uöt32_t
 
íd
 = (uöt32_t)
	`ROUNDUP
(
va
 + 
Àn
, 
PGSIZE
);

307 
PageInfo
 *
p
 = 
NULL
;

308 
ª
 = -1;

309 ; 
°¨t
<
íd
; sèπ +
PGSIZE
){

310 
p
 = 
	`∑ge_Æloc
(0);

311 if(
p
 =
NULL
){

312 
	`∑nic
("theÖageállocation failed!\n");

315 
ª
 = 
	`∑ge_ö£π
(
e
->
ív_pgdú
, 
p
, (*)
°¨t
, 
PTE_U
 | 
PTE_W
);

316 if(
ª
 != 0){

317 
	`∑nic
("theÖage insert failed!\n");

320 
	}
}

344 
	$lﬂd_icode
(
Env
 *
e
, 
uöt8_t
 *
bö¨y
)

375 
Elf
 *
ñf_hód
 = (El‡*)
bö¨y
;

376 
Proghdr
 *
ph
,*
ïh
 ;

378 if(
ñf_hód
->
e_magic
 !
ELF_MAGIC
){

379 
	`∑nic
("load_icode:the file isÇotÉlf!\n");

382 if(
ñf_hód
->
e_íåy
 == 0){

383 
	`∑nic
("load_icode:theÉntry isÇull\n");

385 
e
->
ív_tf
.
tf_eù
 = 
ñf_hód
->
e_íåy
;

387 
ph
 = (
Proghdr
 *)((
uöt8_t
 *)
ñf_hód
 +Élf_hód->
e_phoff
);

388 
ïh
 = 
ph
 + 
ñf_hód
->
e_phnum
;

390 
	`l¸3
(
	`PADDR
(
e
->
ív_pgdú
));

391 ; 
ph
 < 
ïh
;Öh++){

392 if(
ph
->
p_ty≥
 =
ELF_PROG_LOAD
){

393 if(
ph
->
p_fûesz
 >Öh->
p_memsz
){

394 
	`∑nic
("load_icode:the filesz > memsz!\n");

397 
	`ªgi⁄_Æloc
(
e
, (*)
ph
->
p_va
,Öh->
p_memsz
);

398 
	`memmove
((*)
ph
->
p_va
, 
bö¨y
+ph->
p_off£t
,Öh->
p_fûesz
);

399 
	`mem£t
((*)(
ph
->
p_va
 +Öh->
p_fûesz
), 0,Öh->
p_memsz
-Öh->p_filesz);

408 
	`ªgi⁄_Æloc
(
e
, (*)(
USTACKTOP
-
PGSIZE
), PGSIZE);

410 
	}
}

420 
	$ív_¸óã
(
uöt8_t
 *
bö¨y
, 
EnvTy≥
 
ty≥
)

424 
Env
 *
e
;

426 if(
	`ív_Æloc
(&
e
, 0) != 0){

427 
	`∑nic
("env_create faild!\n");

432 
e
->
ív_ty≥
 = 
ty≥
;

433 
	`lﬂd_icode
(
e
, 
bö¨y
);

434 
	}
}

440 
	$ív_‰ì
(
Env
 *
e
)

442 
±e_t
 *
±
;

443 
uöt32_t
 
pdío
, 
±ío
;

444 
phyßddr_t
 
∑
;

449 i‡(
e
 =
cuªnv
)

450 
	`l¸3
(
	`PADDR
(
kîn_pgdú
));

456 
	`°©ic_as£π
(
UTOP
 % 
PTSIZE
 == 0);

457 
pdío
 = 0;Ödíÿ< 
	`PDX
(
UTOP
);Ödeno++) {

460 i‡(!(
e
->
ív_pgdú
[
pdío
] & 
PTE_P
))

464 
∑
 = 
	`PTE_ADDR
(
e
->
ív_pgdú
[
pdío
]);

465 
±
 = (
±e_t
*Ë
	`KADDR
(
∑
);

468 
±ío
 = 0;Öãnÿ<
	`PTX
(~0);Öteno++) {

469 i‡(
±
[
±ío
] & 
PTE_P
)

470 
	`∑ge_ªmove
(
e
->
ív_pgdú
, 
	`PGADDR
(
pdío
, 
±ío
, 0));

474 
e
->
ív_pgdú
[
pdío
] = 0;

475 
	`∑ge_de¸ef
(
	`∑2∑ge
(
∑
));

479 
∑
 = 
	`PADDR
(
e
->
ív_pgdú
);

480 
e
->
ív_pgdú
 = 0;

481 
	`∑ge_de¸ef
(
	`∑2∑ge
(
∑
));

484 
e
->
ív_°©us
 = 
ENV_FREE
;

485 
e
->
ív_lök
 = 
ív_‰ì_li°
;

486 
ív_‰ì_li°
 = 
e
;

487 
	}
}

495 
	$ív_de°roy
(
Env
 *
e
)

500 i‡(
e
->
ív_°©us
 =
ENV_RUNNING
 && 
cuªnv
 !=É) {

501 
e
->
ív_°©us
 = 
ENV_DYING
;

505 
	`ív_‰ì
(
e
);

507 i‡(
cuªnv
 =
e
) {

508 
cuªnv
 = 
NULL
;

509 
	`sched_yõld
();

511 
	}
}

521 
	$ív_p›_tf
(
Tøp‰ame
 *
tf
)

524 
cuªnv
->
ív_˝unum
 = 
	`˝unum
();

526 
asm
 volatile(

533 : : "g" (
tf
) : "memory");

534 
	`∑nic
("iret failed");

535 
	}
}

544 
	$ív_run
(
Env
 *
e
)

564 if(
cuªnv
 !
NULL
 && cuªnv->
ív_°©us
 =
ENV_RUNNING
){

565 
cuªnv
->
ív_°©us
 = 
ENV_RUNNABLE
;

568 
cuªnv
 = 
e
;

569 
cuªnv
->
ív_°©us
 = 
ENV_RUNNING
;

570 
cuªnv
->
ív_runs
 ++;

571 
	`l¸3
(
	`PADDR
(
cuªnv
->
ív_pgdú
));

573 
	`u∆ock_kî√l
();

574 
	`ív_p›_tf
(&(
cuªnv
->
ív_tf
));

575 
	`∑nic
("env_runÇot yet implemented");

576 
	}
}

	@kern/env.h

3 #i‚de‡
JOS_KERN_ENV_H


4 
	#JOS_KERN_ENV_H


	)

6 
	~<öc/ív.h
>

7 
	~<kîn/˝u.h
>

9 
Env
 *
ívs
;

10 
	#cuªnv
 (
this˝u
->
˝u_ív
)

11 
Segdesc
 
gdt
[];

	)

13 
ív_öô
();

14 
ív_öô_≥r˝u
();

15 
ív_Æloc
(
Env
 **
e
, 
ívid_t
 
∑ª¡_id
);

16 
ív_‰ì
(
Env
 *
e
);

17 
ív_¸óã
(
uöt8_t
 *
bö¨y
, 
EnvTy≥
 
ty≥
);

18 
ív_de°roy
(
Env
 *
e
);

20 
ívid2ív
(
ívid_t
 
ívid
, 
Env
 **
ív_°‹e
, 
boﬁ
 
check≥rm
);

22 
	$ív_run
(
Env
 *
e
Ë
	`__©åibuã__
((
n‹ëu∫
));

23 
	$ív_p›_tf
(
Tøp‰ame
 *
tf
Ë
	`__©åibuã__
((
n‹ëu∫
));

27 
	#ENV_PASTE3
(
x
, 
y
, 
z
Ëx ## y ## 
	)
z

29 
	#ENV_CREATE
(
x
, 
ty≥
) \

31 
uöt8_t
 
	`ENV_PASTE3
(
_bö¨y_obj_
, 
x
, 
_°¨t
)[]; \

32 
	`ív_¸óã
(
	`ENV_PASTE3
(
_bö¨y_obj_
, 
x
, 
_°¨t
), \

33 
ty≥
); \

34 
	}
} 0)

	)

	@kern/init.c

3 
	~<öc/°dio.h
>

4 
	~<öc/°rög.h
>

5 
	~<öc/as£π.h
>

7 
	~<kîn/m⁄ô‹.h
>

8 
	~<kîn/c⁄sﬁe.h
>

9 
	~<kîn/pm≠.h
>

10 
	~<kîn/k˛ock.h
>

11 
	~<kîn/ív.h
>

12 
	~<kîn/å≠.h
>

13 
	~<kîn/sched.h
>

14 
	~<kîn/picúq.h
>

15 
	~<kîn/˝u.h
>

16 
	~<kîn/•ölock.h
>

18 
boŸ_≠s
();

22 
	$i386_öô
()

26 
	`c⁄s_öô
();

28 
	`˝rötf
("6828 decimal is %o octal!\n", 6828);

31 
	`mem_öô
();

34 
	`ív_öô
();

35 
	`å≠_öô
();

38 
	`mp_öô
();

39 
	`œpic_öô
();

42 
	`pic_öô
();

46 
	`lock_kî√l
();

48 
	`boŸ_≠s
();

53 #i‡
	`deföed
(
TEST
)

55 
	`ENV_CREATE
(
TEST
, 
ENV_TYPE_USER
);

59 
	`ENV_CREATE
(
u£r_icode
, 
ENV_TYPE_USER
);

67 
	`kbd_öå
();

71 
	`sched_yõld
();

72 
	}
}

77 *
	gm≥¡ry_k°ack
;

81 
	$boŸ_≠s
()

83 
m≥¡ry_°¨t
[], 
m≥¡ry_íd
[];

84 *
code
;

85 
CpuInfo
 *
c
;

88 
code
 = 
	`KADDR
(
MPENTRY_PADDR
);

89 
	`memmove
(
code
, 
m≥¡ry_°¨t
, 
m≥¡ry_íd
 - mpentry_start);

92 
c
 = 
˝us
; c < cpu†+ 
n˝u
; c++) {

93 i‡(
c
 =
˝us
 + 
	`˝unum
())

97 
m≥¡ry_k°ack
 = 
≥r˝u_k°acks
[
c
 - 
˝us
] + 
KSTKSIZE
;

99 
	`œpic_°¨èp
(
c
->
˝u_id
, 
	`PADDR
(
code
));

101 
c
->
˝u_°©us
 !
CPU_STARTED
)

104 
	}
}

108 
	$mp_maö
()

111 
	`l¸3
(
	`PADDR
(
kîn_pgdú
));

112 
	`˝rötf
("SMP: CPU %d sèπög\n", 
	`˝unum
());

114 
	`œpic_öô
();

115 
	`ív_öô_≥r˝u
();

116 
	`å≠_öô_≥r˝u
();

117 
	`xchg
(&
this˝u
->
˝u_°©us
, 
CPU_STARTED
);

124 
	`lock_kî√l
();

125 
	`sched_yõld
();

128 
	}
}

134 c⁄° *
	g∑nic°r
;

141 
	$_∑nic
(c⁄° *
fûe
, 
löe
, c⁄° *
fmt
,...)

143 
va_li°
 
≠
;

145 i‡(
∑nic°r
)

146 
dód
;

147 
∑nic°r
 = 
fmt
;

150 
asm
 volatile("cli; cld");

152 
	`va_°¨t
(
≠
, 
fmt
);

153 
	`˝rötf
("kî√»∑ni¯⁄ CPU %dáà%s:%d: ", 
	`˝unum
(), 
fûe
, 
löe
);

154 
	`v˝rötf
(
fmt
, 
≠
);

155 
	`˝rötf
("\n");

156 
	`va_íd
(
≠
);

158 
dód
:

161 
	`m⁄ô‹
(
NULL
);

162 
	}
}

166 
	$_w¨n
(c⁄° *
fûe
, 
löe
, c⁄° *
fmt
,...)

168 
va_li°
 
≠
;

170 
	`va_°¨t
(
≠
, 
fmt
);

171 
	`˝rötf
("kî√»w¨nögáà%s:%d: ", 
fûe
, 
löe
);

172 
	`v˝rötf
(
fmt
, 
≠
);

173 
	`˝rötf
("\n");

174 
	`va_íd
(
≠
);

175 
	}
}

	@kern/kclock.c

5 
	~<öc/x86.h
>

7 
	~<kîn/k˛ock.h
>

11 
	$mc146818_ªad
(
ªg
)

13 
	`outb
(
IO_RTC
, 
ªg
);

14  
	`öb
(
IO_RTC
+1);

15 
	}
}

18 
	$mc146818_wrôe
(
ªg
, 
d©um
)

20 
	`outb
(
IO_RTC
, 
ªg
);

21 
	`outb
(
IO_RTC
+1, 
d©um
);

22 
	}
}

	@kern/kclock.h

3 #i‚de‡
JOS_KERN_KCLOCK_H


4 
	#JOS_KERN_KCLOCK_H


	)

5 #i‚de‡
JOS_KERNEL


9 
	#IO_RTC
 0x070

	)

11 
	#MC_NVRAM_START
 0xê

	)

12 
	#MC_NVRAM_SIZE
 50

	)

15 
	#NVRAM_BASELO
 (
MC_NVRAM_START
 + 7Ë

	)

16 
	#NVRAM_BASEHI
 (
MC_NVRAM_START
 + 8Ë

	)

19 
	#NVRAM_EXTLO
 (
MC_NVRAM_START
 + 9Ë

	)

20 
	#NVRAM_EXTHI
 (
MC_NVRAM_START
 + 10Ë

	)

23 
	#NVRAM_EXT16LO
 (
MC_NVRAM_START
 + 38Ë

	)

24 
	#NVRAM_EXT16HI
 (
MC_NVRAM_START
 + 39Ë

	)

26 
mc146818_ªad
(
ªg
);

27 
mc146818_wrôe
(
ªg
, 
d©um
);

	@kern/kdebug.c

1 
	~<öc/°ab.h
>

2 
	~<öc/°rög.h
>

3 
	~<öc/memœyout.h
>

4 
	~<öc/as£π.h
>

6 
	~<kîn/kdebug.h
>

7 
	~<kîn/pm≠.h
>

8 
	~<kîn/ív.h
>

10 c⁄° 
Sèb
 
__STAB_BEGIN__
[];

11 c⁄° 
Sèb
 
__STAB_END__
[];

12 c⁄° 
__STABSTR_BEGIN__
[];

13 c⁄° 
__STABSTR_END__
[];

15 
	sU£rSèbD©a
 {

16 c⁄° 
Sèb
 *
	m°abs
;

17 c⁄° 
Sèb
 *
	m°ab_íd
;

18 c⁄° *
	m°ab°r
;

19 c⁄° *
	m°ab°r_íd
;

60 
	$°ab_bö£¨ch
(c⁄° 
Sèb
 *
°abs
, *
ªgi⁄_À·
, *
ªgi⁄_right
,

61 
ty≥
, 
uöçå_t
 
addr
)

63 
l
 = *
ªgi⁄_À·
, 
r
 = *
ªgi⁄_right
, 
™y_m©ches
 = 0;

65 
l
 <
r
) {

66 
åue_m
 = (
l
 + 
r
Ë/ 2, 
m
 =Årue_m;

69 
m
 >
l
 && 
°abs
[m].
n_ty≥
 !
ty≥
)

70 
m
--;

71 i‡(
m
 < 
l
) {

72 
l
 = 
åue_m
 + 1;

77 
™y_m©ches
 = 1;

78 i‡(
°abs
[
m
].
n_vÆue
 < 
addr
) {

79 *
ªgi⁄_À·
 = 
m
;

80 
l
 = 
åue_m
 + 1;

81 } i‡(
°abs
[
m
].
n_vÆue
 > 
addr
) {

82 *
ªgi⁄_right
 = 
m
 - 1;

83 
r
 = 
m
 - 1;

87 *
ªgi⁄_À·
 = 
m
;

88 
l
 = 
m
;

89 
addr
++;

93 i‡(!
™y_m©ches
)

94 *
ªgi⁄_right
 = *
ªgi⁄_À·
 - 1;

97 
l
 = *
ªgi⁄_right
;

98 
l
 > *
ªgi⁄_À·
 && 
°abs
[l].
n_ty≥
 !
ty≥
;

99 
l
--)

101 *
ªgi⁄_À·
 = 
l
;

103 
	}
}

114 
	$debugöfo_eù
(
uöçå_t
 
addr
, 
Eùdebugöfo
 *
öfo
)

116 c⁄° 
Sèb
 *
°abs
, *
°ab_íd
;

117 c⁄° *
°ab°r
, *
°ab°r_íd
;

118 
lfûe
, 
rfûe
, 
lfun
, 
rfun
, 
Œöe
, 
æöe
;

121 
öfo
->
eù_fûe
 = "<unknown>";

122 
öfo
->
eù_löe
 = 0;

123 
öfo
->
eù_‚_«me
 = "<unknown>";

124 
öfo
->
eù_‚_«mñí
 = 9;

125 
öfo
->
eù_‚_addr
 = 
addr
;

126 
öfo
->
eù_‚_«rg
 = 0;

129 i‡(
addr
 >
ULIM
) {

130 
°abs
 = 
__STAB_BEGIN__
;

131 
°ab_íd
 = 
__STAB_END__
;

132 
°ab°r
 = 
__STABSTR_BEGIN__
;

133 
°ab°r_íd
 = 
__STABSTR_END__
;

140 c⁄° 
U£rSèbD©a
 *
usd
 = (c⁄° U£rSèbD©®*Ë
USTABDATA
;

145 if(
	`u£r_mem_check
(
cuªnv
, 
usd
, (
U£rSèbD©a
), 
PTE_U
) != 0){

148 
°abs
 = 
usd
->stabs;

149 
°ab_íd
 = 
usd
->stab_end;

150 
°ab°r
 = 
usd
->stabstr;

151 
°ab°r_íd
 = 
usd
->stabstr_end;

155 if(
	`u£r_mem_check
(
cuªnv
, 
°abs
, 
°ab_íd
-°abs, 
PTE_U
) != 0){

158 if(
	`u£r_mem_check
(
cuªnv
, 
°abs
, 
°ab°r_íd
-
°ab°r
, 
PTE_U
) != 0){

164 i‡(
°ab°r_íd
 <
°ab°r
 || stabstr_end[-1] != 0)

173 
lfûe
 = 0;

174 
rfûe
 = (
°ab_íd
 - 
°abs
) - 1;

175 
	`°ab_bö£¨ch
(
°abs
, &
lfûe
, &
rfûe
, 
N_SO
, 
addr
);

176 i‡(
lfûe
 == 0)

181 
lfun
 = 
lfûe
;

182 
rfun
 = 
rfûe
;

183 
	`°ab_bö£¨ch
(
°abs
, &
lfun
, &
rfun
, 
N_FUN
, 
addr
);

185 i‡(
lfun
 <
rfun
) {

188 i‡(
°abs
[
lfun
].
n_°rx
 < 
°ab°r_íd
 - 
°ab°r
)

189 
öfo
->
eù_‚_«me
 = 
°ab°r
 + 
°abs
[
lfun
].
n_°rx
;

190 
öfo
->
eù_‚_addr
 = 
°abs
[
lfun
].
n_vÆue
;

191 
addr
 -
öfo
->
eù_‚_addr
;

193 
Œöe
 = 
lfun
;

194 
æöe
 = 
rfun
;

198 
öfo
->
eù_‚_addr
 = 
addr
;

199 
Œöe
 = 
lfûe
;

200 
æöe
 = 
rfûe
;

203 
öfo
->
eù_‚_«mñí
 = 
	`°rföd
(öfo->
eù_‚_«me
, ':') - info->eip_fn_name;

215 
	`°ab_bö£¨ch
(
°abs
, &
Œöe
, &
æöe
, 
N_SLINE
, 
addr
);

216 if(
Œöe
 <
æöe
){

217 
öfo
->
eù_löe
 = 
°abs
[
æöe
].
n_desc
;

227 
Œöe
 >
lfûe


228 && 
°abs
[
Œöe
].
n_ty≥
 !
N_SOL


229 && (
°abs
[
Œöe
].
n_ty≥
 !
N_SO
 || !°abs[Œöe].
n_vÆue
))

230 
Œöe
--;

231 i‡(
Œöe
 >
lfûe
 && 
°abs
[Œöe].
n_°rx
 < 
°ab°r_íd
 - 
°ab°r
)

232 
öfo
->
eù_fûe
 = 
°ab°r
 + 
°abs
[
Œöe
].
n_°rx
;

237 i‡(
lfun
 < 
rfun
)

238 
Œöe
 = 
lfun
 + 1;

239 
Œöe
 < 
rfun
 && 
°abs
[Œöe].
n_ty≥
 =
N_PSYM
;

240 
Œöe
++)

241 
öfo
->
eù_‚_«rg
++;

244 
	}
}

	@kern/kdebug.h

1 #i‚de‡
JOS_KERN_KDEBUG_H


2 
	#JOS_KERN_KDEBUG_H


	)

4 
	~<öc/ty≥s.h
>

7 
	sEùdebugöfo
 {

8 c⁄° *
	meù_fûe
;

9 
	meù_löe
;

11 c⁄° *
	meù_‚_«me
;

13 
	meù_‚_«mñí
;

14 
uöçå_t
 
	meù_‚_addr
;

15 
	meù_‚_«rg
;

18 
debugöfo_eù
(
uöçå_t
 
eù
, 
Eùdebugöfo
 *
öfo
);

	@kern/lapic.c

4 
	~<öc/ty≥s.h
>

5 
	~<öc/memœyout.h
>

6 
	~<öc/å≠.h
>

7 
	~<öc/mmu.h
>

8 
	~<öc/°dio.h
>

9 
	~<öc/x86.h
>

10 
	~<kîn/pm≠.h
>

11 
	~<kîn/˝u.h
>

14 
	#ID
 (0x0020/4)

15 
	#VER
 (0x0030/4)

16 
	#TPR
 (0x0080/4)

17 
	#EOI
 (0x00B0/4)

18 
	#SVR
 (0x00F0/4)

19 
	#ENABLE
 0x00000100

20 
	#ESR
 (0x0280/4)

21 
	#ICRLO
 (0x0300/4)

22 
	#INIT
 0x00000500

23 
	#STARTUP
 0x00000600

24 
	#DELIVS
 0x00001000

25 
	#ASSERT
 0x00004000

26 
	#DEASSERT
 0x00000000

	)

27 
	#LEVEL
 0x00008000

28 
	#BCAST
 0x00080000

29 
	#OTHERS
 0x000C0000

30 
	#BUSY
 0x00001000

	)

31 
	#FIXED
 0x00000000

	)

32 
	#ICRHI
 (0x0310/4)

33 
	#TIMER
 (0x0320/4)

34 
	#X1
 0x0000000B

35 
	#PERIODIC
 0x00020000

36 
	#PCINT
 (0x0340/4)

37 
	#LINT0
 (0x0350/4)

38 
	#LINT1
 (0x0360/4)

39 
	#ERROR
 (0x0370/4)

40 
	#MASKED
 0x00010000

41 
	#TICR
 (0x0380/4)

42 
	#TCCR
 (0x0390/4)

43 
	#TDCR
 (0x03E0/4)

44 

	)

45 
phyßddr_t
 
	gœpiˇddr
;

46 vﬁ©ûê
uöt32_t
 *
	gœpic
;

49 
	$œpicw
(
ödex
, 
vÆue
)

51 
œpic
[
ödex
] = 
vÆue
;

52 
œpic
[
ID
];

53 
	}
}

56 
	$œpic_öô
()

58 i‡(!
œpiˇddr
)

63 
œpic
 = 
	`mmio_m≠_ªgi⁄
(
œpiˇddr
, 4096);

66 
	`œpicw
(
SVR
, 
ENABLE
 | (
IRQ_OFFSET
 + 
IRQ_SPURIOUS
));

72 
	`œpicw
(
TDCR
, 
X1
);

73 
	`œpicw
(
TIMER
, 
PERIODIC
 | (
IRQ_OFFSET
 + 
IRQ_TIMER
));

74 
	`œpicw
(
TICR
, 10000000);

83 i‡(
this˝u
 !
boŸ˝u
)

84 
	`œpicw
(
LINT0
, 
MASKED
);

87 
	`œpicw
(
LINT1
, 
MASKED
);

91 i‡(((
œpic
[
VER
]>>16) & 0xFF) >= 4)

92 
	`œpicw
(
PCINT
, 
MASKED
);

95 
	`œpicw
(
ERROR
, 
IRQ_OFFSET
 + 
IRQ_ERROR
);

98 
	`œpicw
(
ESR
, 0);

99 
	`œpicw
(
ESR
, 0);

102 
	`œpicw
(
EOI
, 0);

105 
	`œpicw
(
ICRHI
, 0);

106 
	`œpicw
(
ICRLO
, 
BCAST
 | 
INIT
 | 
LEVEL
);

107 
œpic
[
ICRLO
] & 
DELIVS
)

111 
	`œpicw
(
TPR
, 0);

112 
	}
}

115 
	$˝unum
()

117 i‡(
œpic
)

118  
œpic
[
ID
] >> 24;

120 
	}
}

124 
	$œpic_eoi
()

126 i‡(
œpic
)

127 
	`œpicw
(
EOI
, 0);

128 
	}
}

133 
	$mi¸odñay
(
us
)

135 
	}
}

137 
	#IO_RTC
 0x70

	)

142 
	$œpic_°¨èp
(
uöt8_t
 
≠icid
, 
uöt32_t
 
addr
)

144 
i
;

145 
uöt16_t
 *
wrv
;

150 
	`outb
(
IO_RTC
, 0xF);

151 
	`outb
(
IO_RTC
+1, 0x0A);

152 
wrv
 = (
uöt16_t
 *)
	`KADDR
((0x40 << 4 | 0x67));

153 
wrv
[0] = 0;

154 
wrv
[1] = 
addr
 >> 4;

158 
	`œpicw
(
ICRHI
, 
≠icid
 << 24);

159 
	`œpicw
(
ICRLO
, 
INIT
 | 
LEVEL
 | 
ASSERT
);

160 
	`mi¸odñay
(200);

161 
	`œpicw
(
ICRLO
, 
INIT
 | 
LEVEL
);

162 
	`mi¸odñay
(100);

169 
i
 = 0; i < 2; i++) {

170 
	`œpicw
(
ICRHI
, 
≠icid
 << 24);

171 
	`œpicw
(
ICRLO
, 
STARTUP
 | (
addr
 >> 12));

172 
	`mi¸odñay
(200);

174 
	}
}

177 
	$œpic_ùi
(
ve˘‹
)

179 
	`œpicw
(
ICRLO
, 
OTHERS
 | 
FIXED
 | 
ve˘‹
);

180 
œpic
[
ICRLO
] & 
DELIVS
)

182 
	}
}

	@kern/monitor.c

4 
	~<öc/°dio.h
>

5 
	~<öc/°rög.h
>

6 
	~<öc/memœyout.h
>

7 
	~<öc/as£π.h
>

8 
	~<öc/x86.h
>

10 
	~<kîn/c⁄sﬁe.h
>

11 
	~<kîn/m⁄ô‹.h
>

12 
	~<kîn/kdebug.h
>

13 
	~<kîn/å≠.h
>

15 
	#CMDBUF_SIZE
 80

16 

	)

18 
	sComm™d
 {

19 c⁄° *
	m«me
;

20 c⁄° *
	mdesc
;

22 (*
	mfunc
)(
	m¨gc
, ** 
	m¨gv
, 
Tøp‰ame
* 
	mtf
);

25 
Comm™d
 
	gcomm™ds
[] = {

26 { "hñp", "Di•œyÅhi†li° o‡comm™ds", 
m⁄_hñp
 },

27 { "kînöfo", "Di•œy inf‹m©i⁄ábouàthêkî√l", 
m⁄_kînöfo
 },

28 { "backåa˚", "Di•œy backåa˚ inf‹m©i⁄", 
m⁄_backåa˚
},

34 
	$m⁄_hñp
(
¨gc
, **
¨gv
, 
Tøp‰ame
 *
tf
)

36 
i
;

38 
i
 = 0; i < 
	`ARRAY_SIZE
(
comm™ds
); i++)

39 
	`˝rötf
("%†- %s\n", 
comm™ds
[
i
].
«me
, comm™ds[i].
desc
);

41 
	}
}

44 
	$m⁄_kînöfo
(
¨gc
, **
¨gv
, 
Tøp‰ame
 *
tf
)

46 
_°¨t
[], 
íåy
[], 
ëext
[], 
ed©a
[], 
íd
[];

48 
	`˝rötf
("Special kernel symbols:\n");

49 
	`˝rötf
(" _°¨à %08x (phys)\n", 
_°¨t
);

50 
	`˝rötf
("É¡ry %08x (vútË %08x (phys)\n", 
íåy
,É¡ry - 
KERNBASE
);

51 
	`˝rötf
("Éãxà %08x (vútË %08x (phys)\n", 
ëext
,Éãxà- 
KERNBASE
);

52 
	`˝rötf
("Éd©® %08x (vútË %08x (phys)\n", 
ed©a
,Éd©®- 
KERNBASE
);

53 
	`˝rötf
("Énd %08x (vútË %08x (phys)\n", 
íd
,Énd - 
KERNBASE
);

54 
	`˝rötf
("KernelÉxecutable memory footprint: %dKB\n",

55 
	`ROUNDUP
(
íd
 - 
íåy
, 1024) / 1024);

57 
	}
}

60 
	$m⁄_backåa˚
(
¨gc
, **
¨gv
, 
Tøp‰ame
 *
tf
)

63 
i
;

64 
uöt32_t
 
eù
;

65 
uöt32_t
 *
ebp
 = (uöt32_à*)
	`ªad_ebp
();

66 
Eùdebugöfo
 
debug_öfo
;

68 
ebp
){

69 
eù
 = *(
ebp
 + 1);

70 
	`˝rötf
("eb∞ %xÉù %xárgs", 
ebp
, 
eù
);

71 
i
=0; i<5; i++){

72 
	`˝rötf
(" %08x", *(
ebp
+
i
+2));

74 
	`debugöfo_eù
(
eù
, &
debug_öfo
);

75 
	`˝rötf
("\t%s:%d: %.*s+%d", 
debug_öfo
.
eù_fûe
, debug_öfo.
eù_löe
, debug_öfo.
eù_‚_«mñí
,

76 
debug_öfo
.
eù_‚_«me
, 
eù
 - debug_öfo.
eù_‚_addr
);

77 
	`˝rötf
("\n");

78 
ebp
 = (
uöt32_t
 *)(*Ébp);

81 
	}
}

87 
	#WHITESPACE
 "\t\r\¿"

	)

88 
	#MAXARGS
 16

	)

91 
	$runcmd
(*
buf
, 
Tøp‰ame
 *
tf
)

93 
¨gc
;

94 *
¨gv
[
MAXARGS
];

95 
i
;

98 
¨gc
 = 0;

99 
¨gv
[
¨gc
] = 0;

102 *
buf
 && 
	`°rchr
(
WHITESPACE
, *buf))

103 *
buf
++ = 0;

104 i‡(*
buf
 == 0)

108 i‡(
¨gc
 =
MAXARGS
-1) {

109 
	`˝rötf
("Toÿm™yárgumít†(max %d)\n", 
MAXARGS
);

112 
¨gv
[
¨gc
++] = 
buf
;

113 *
buf
 && !
	`°rchr
(
WHITESPACE
, *buf))

114 
buf
++;

116 
¨gv
[
¨gc
] = 0;

119 i‡(
¨gc
 == 0)

121 
i
 = 0; i < 
	`ARRAY_SIZE
(
comm™ds
); i++) {

122 i‡(
	`°rcmp
(
¨gv
[0], 
comm™ds
[
i
].
«me
) == 0)

123  
comm™ds
[
i
].
	`func
(
¨gc
, 
¨gv
, 
tf
);

125 
	`˝rötf
("Unknow¿comm™d '%s'\n", 
¨gv
[0]);

127 
	}
}

130 
	$m⁄ô‹
(
Tøp‰ame
 *
tf
)

132 *
buf
;

134 
	`˝rötf
("WelcomeÅoÅhe JOS kernel monitor!\n");

135 
	`˝rötf
("Type 'help' foráÜist of commands.\n");

138 i‡(
tf
 !
NULL
)

139 
	`¥öt_å≠‰ame
(
tf
);

145 
buf
 = 
	`ªadlöe
("K> ");

146 i‡(
buf
 !
NULL
)

147 i‡(
	`runcmd
(
buf
, 
tf
) < 0)

150 
	}
}

	@kern/monitor.h

1 #i‚de‡
JOS_KERN_MONITOR_H


2 
	#JOS_KERN_MONITOR_H


	)

3 #i‚de‡
JOS_KERNEL


7 
	gTøp‰ame
;

12 
m⁄ô‹
(
Tøp‰ame
 *
tf
);

15 
m⁄_hñp
(
¨gc
, **
¨gv
, 
Tøp‰ame
 *
tf
);

16 
m⁄_kînöfo
(
¨gc
, **
¨gv
, 
Tøp‰ame
 *
tf
);

17 
m⁄_backåa˚
(
¨gc
, **
¨gv
, 
Tøp‰ame
 *
tf
);

	@kern/mpconfig.c

4 
	~<öc/ty≥s.h
>

5 
	~<öc/°rög.h
>

6 
	~<öc/memœyout.h
>

7 
	~<öc/x86.h
>

8 
	~<öc/mmu.h
>

9 
	~<öc/ív.h
>

10 
	~<kîn/˝u.h
>

11 
	~<kîn/pm≠.h
>

13 
CpuInfo
 
	g˝us
[
NCPU
];

14 
CpuInfo
 *
	gboŸ˝u
;

15 
	gismp
;

16 
	gn˝u
;

19 
	g≥r˝u_k°acks
[
NCPU
][
KSTKSIZE
]

20 
__©åibuã__
 ((
Æig√d
(
PGSIZE
)));

25 
	smp
 {

26 
uöt8_t
 
	msig«tuª
[4];

27 
phyßddr_t
 
	mphyßddr
;

28 
uöt8_t
 
	mÀngth
;

29 
uöt8_t
 
	m•e¸ev
;

30 
uöt8_t
 
	mchecksum
;

31 
uöt8_t
 
	mty≥
;

32 
uöt8_t
 
	mim¸p
;

33 
uöt8_t
 
	mª£rved
[3];

34 } 
__©åibuã__
((
__∑cked__
));

36 
	smpc⁄f
 {

37 
uöt8_t
 
	msig«tuª
[4];

38 
uöt16_t
 
	mÀngth
;

39 
uöt8_t
 
	mvîsi⁄
;

40 
uöt8_t
 
	mchecksum
;

41 
uöt8_t
 
	m¥odu˘
[20];

42 
phyßddr_t
 
	m€mèbÀ
;

43 
uöt16_t
 
	m€mÀngth
;

44 
uöt16_t
 
	míåy
;

45 
phyßddr_t
 
	mœpiˇddr
;

46 
uöt16_t
 
	mxÀngth
;

47 
uöt8_t
 
	mxchecksum
;

48 
uöt8_t
 
	mª£rved
;

49 
uöt8_t
 
	míåõs
[0];

50 } 
__©åibuã__
((
__∑cked__
));

52 
	smµroc
 {

53 
uöt8_t
 
	mty≥
;

54 
uöt8_t
 
	m≠icid
;

55 
uöt8_t
 
	mvîsi⁄
;

56 
uöt8_t
 
	mÊags
;

57 
uöt8_t
 
	msig«tuª
[4];

58 
uöt32_t
 
	m„©uª
;

59 
uöt8_t
 
	mª£rved
[8];

60 } 
__©åibuã__
((
__∑cked__
));

63 
	#MPPROC_BOOT
 0x02

64 

	)

66 
	#MPPROC
 0x00

67 
	#MPBUS
 0x01

68 
	#MPIOAPIC
 0x02

69 
	#MPIOINTR
 0x03

70 
	#MPLINTR
 0x04

71 

	)

72 
uöt8_t


73 
	$sum
(*
addr
, 
Àn
)

75 
i
, 
sum
;

77 
sum
 = 0;

78 
i
 = 0; i < 
Àn
; i++)

79 
sum
 +((
uöt8_t
 *)
addr
)[
i
];

80  
sum
;

81 
	}
}

84 
mp
 *

85 
	$mp£¨ch1
(
phyßddr_t
 
a
, 
Àn
)

87 
mp
 *m∞
	`KADDR
(
a
), *
íd
 = KADDR◊ + 
Àn
);

89 ; 
mp
 < 
íd
; mp++)

90 i‡(
	`memcmp
(
mp
->
sig«tuª
, "_MP_", 4) == 0 &&

91 
	`sum
(
mp
, (*mp)) == 0)

92  
mp
;

93  
NULL
;

94 
	}
}

101 
mp
 *

102 
	$mp£¨ch
()

104 
uöt8_t
 *
bda
;

105 
uöt32_t
 
p
;

106 
mp
 *mp;

108 
	`°©ic_as£π
((*
mp
) == 16);

111 
bda
 = (
uöt8_t
 *Ë
	`KADDR
(0x40 << 4);

115 i‡((
p
 = *(
uöt16_t
 *Ë(
bda
 + 0x0E))) {

116 
p
 <<= 4;

117 i‡((
mp
 = 
	`mp£¨ch1
(
p
, 1024)))

118  
mp
;

122 
p
 = *(
uöt16_t
 *Ë(
bda
 + 0x13) * 1024;

123 i‡((
mp
 = 
	`mp£¨ch1
(
p
 - 1024, 1024)))

124  
mp
;

126  
	`mp£¨ch1
(0xF0000, 0x10000);

127 
	}
}

132 
mpc⁄f
 *

133 
	$mpc⁄fig
(
mp
 **
pmp
)

135 
mpc⁄f
 *
c⁄f
;

136 
mp
 *mp;

138 i‡((
mp
 = 
	`mp£¨ch
()) == 0)

139  
NULL
;

140 i‡(
mp
->
phyßddr
 =0 || mp->
ty≥
 != 0) {

141 
	`˝rötf
("SMP: Default configurationsÇot implemented\n");

142  
NULL
;

144 
c⁄f
 = (
mpc⁄f
 *Ë
	`KADDR
(
mp
->
phyßddr
);

145 i‡(
	`memcmp
(
c⁄f
, "PCMP", 4) != 0) {

146 
	`˝rötf
("SMP: Incorrect MP configurationÅable signature\n");

147  
NULL
;

149 i‡(
	`sum
(
c⁄f
, c⁄f->
Àngth
) != 0) {

150 
	`˝rötf
("SMP: Bad MP configuration checksum\n");

151  
NULL
;

153 i‡(
c⁄f
->
vîsi⁄
 != 1 && conf->version != 4) {

154 
	`˝rötf
("SMP: Unsuµ‹ãd MP vîsi⁄ %d\n", 
c⁄f
->
vîsi⁄
);

155  
NULL
;

157 i‡((
	`sum
((
uöt8_t
 *)
c⁄f
 + c⁄f->
Àngth
, c⁄f->
xÀngth
Ë+ c⁄f->
xchecksum
) & 0xff) {

158 
	`˝rötf
("SMP: Bad MP configurationÉxtended checksum\n");

159  
NULL
;

161 *
pmp
 = 
mp
;

162  
c⁄f
;

163 
	}
}

166 
	$mp_öô
()

168 
mp
 *mp;

169 
mpc⁄f
 *
c⁄f
;

170 
mµroc
 *
¥oc
;

171 
uöt8_t
 *
p
;

172 
i
;

174 
boŸ˝u
 = &
˝us
[0];

175 i‡((
c⁄f
 = 
	`mpc⁄fig
(&
mp
)) == 0)

177 
ismp
 = 1;

178 
œpiˇddr
 = 
c⁄f
->lapicaddr;

180 
p
 = 
c⁄f
->
íåõs
, 
i
 = 0; i < c⁄f->
íåy
; i++) {

181 *
p
) {

182 
MPPROC
:

183 
¥oc
 = (
mµroc
 *)
p
;

184 i‡(
¥oc
->
Êags
 & 
MPPROC_BOOT
)

185 
boŸ˝u
 = &
˝us
[
n˝u
];

186 i‡(
n˝u
 < 
NCPU
) {

187 
˝us
[
n˝u
].
˝u_id
 =Çcpu;

188 
n˝u
++;

190 
	`˝rötf
("SMP:Åoo many CPUs, CPU %d disabled\n",

191 
¥oc
->
≠icid
);

193 
p
 +(
mµroc
);

195 
MPBUS
:

196 
MPIOAPIC
:

197 
MPIOINTR
:

198 
MPLINTR
:

199 
p
 += 8;

202 
	`˝rötf
("mpöô: unknow¿c⁄figÅy≥ %x\n", *
p
);

203 
ismp
 = 0;

204 
i
 = 
c⁄f
->
íåy
;

208 
boŸ˝u
->
˝u_°©us
 = 
CPU_STARTED
;

209 i‡(!
ismp
) {

211 
n˝u
 = 1;

212 
œpiˇddr
 = 0;

213 
	`˝rötf
("SMP: configurationÇot found, SMP disabled\n");

216 
	`˝rötf
("SMP: CPU %d found %d CPU(s)\n", 
boŸ˝u
->
˝u_id
, 
n˝u
);

218 i‡(
mp
->
im¸p
) {

221 
	`˝rötf
("SMP: Setting IMCRÅo switch from PIC modeÅo symmetric I/O mode\n");

222 
	`outb
(0x22, 0x70);

223 
	`outb
(0x23, 
	`öb
(0x23) | 1);

225 
	}
}

	@kern/picirq.c

3 
	~<öc/as£π.h
>

4 
	~<öc/å≠.h
>

6 
	~<kîn/picúq.h
>

11 
uöt16_t
 
	gúq_mask_8259A
 = 0xFFFF & ~(1<<
IRQ_SLAVE
);

12 
boﬁ
 
	gdidöô
;

16 
	$pic_öô
()

18 
didöô
 = 1;

21 
	`outb
(
IO_PIC1
+1, 0xFF);

22 
	`outb
(
IO_PIC2
+1, 0xFF);

30 
	`outb
(
IO_PIC1
, 0x11);

33 
	`outb
(
IO_PIC1
+1, 
IRQ_OFFSET
);

37 
	`outb
(
IO_PIC1
+1, 1<<
IRQ_SLAVE
);

47 
	`outb
(
IO_PIC1
+1, 0x3);

50 
	`outb
(
IO_PIC2
, 0x11);

51 
	`outb
(
IO_PIC2
+1, 
IRQ_OFFSET
 + 8);

52 
	`outb
(
IO_PIC2
+1, 
IRQ_SLAVE
);

55 
	`outb
(
IO_PIC2
+1, 0x01);

61 
	`outb
(
IO_PIC1
, 0x68);

62 
	`outb
(
IO_PIC1
, 0x0a);

64 
	`outb
(
IO_PIC2
, 0x68);

65 
	`outb
(
IO_PIC2
, 0x0a);

67 i‡(
úq_mask_8259A
 != 0xFFFF)

68 
	`úq_£tmask_8259A
(
úq_mask_8259A
);

69 
	}
}

72 
	$úq_£tmask_8259A
(
uöt16_t
 
mask
)

74 
i
;

75 
úq_mask_8259A
 = 
mask
;

76 i‡(!
didöô
)

78 
	`outb
(
IO_PIC1
+1, ()
mask
);

79 
	`outb
(
IO_PIC2
+1, ()(
mask
 >> 8));

80 
	`˝rötf
("enabled interrupts:");

81 
i
 = 0; i < 16; i++)

82 i‡(~
mask
 & (1<<
i
))

83 
	`˝rötf
(" %d", 
i
);

84 
	`˝rötf
("\n");

85 
	}
}

	@kern/picirq.h

3 #i‚de‡
JOS_KERN_PICIRQ_H


4 
	#JOS_KERN_PICIRQ_H


	)

5 #i‚de‡
JOS_KERNEL


9 
	#MAX_IRQS
 16

10 

	)

12 
	#IO_PIC1
 0x20

13 
	#IO_PIC2
 0xA0

14 

	)

15 
	#IRQ_SLAVE
 2

16 

	)

18 #i‚de‡
__ASSEMBLER__


20 
	~<öc/ty≥s.h
>

21 
	~<öc/x86.h
>

23 
uöt16_t
 
úq_mask_8259A
;

24 
pic_öô
();

25 
úq_£tmask_8259A
(
uöt16_t
 
mask
);

	@kern/pmap.c

3 
	~<öc/x86.h
>

4 
	~<öc/mmu.h
>

5 
	~<öc/îr‹.h
>

6 
	~<öc/°rög.h
>

7 
	~<öc/as£π.h
>

9 
	~<kîn/pm≠.h
>

10 
	~<kîn/k˛ock.h
>

11 
	~<kîn/ív.h
>

12 
	~<kîn/˝u.h
>

15 
size_t
 
	g≈ages
;

16 
size_t
 
	g≈ages_ba£mem
;

19 
pde_t
 *
	gkîn_pgdú
;

20 
PageInfo
 *
	g∑ges
;

21 
PageInfo
 *
	g∑ge_‰ì_li°
;

29 
	$nvøm_ªad
(
r
)

31  
	`mc146818_ªad
(
r
) | (mc146818_read(r + 1) << 8);

32 
	}
}

35 
	$i386_dëe˘_mem‹y
()

37 
size_t
 
ba£mem
, 
extmem
, 
ext16mem
, 
tŸÆmem
;

41 
ba£mem
 = 
	`nvøm_ªad
(
NVRAM_BASELO
);

42 
extmem
 = 
	`nvøm_ªad
(
NVRAM_EXTLO
);

43 
ext16mem
 = 
	`nvøm_ªad
(
NVRAM_EXT16LO
) * 64;

47 i‡(
ext16mem
)

48 
tŸÆmem
 = 16 * 1024 + 
ext16mem
;

49 i‡(
extmem
)

50 
tŸÆmem
 = 1 * 1024 + 
extmem
;

52 
tŸÆmem
 = 
ba£mem
;

54 
≈ages
 = 
tŸÆmem
 / (
PGSIZE
 / 1024);

55 
≈ages_ba£mem
 = 
ba£mem
 / (
PGSIZE
 / 1024);

57 
	`˝rötf
("Physical memory: %uKávailable, base = %uK,Éxtended = %uK\n",

58 
tŸÆmem
, 
ba£mem
,Åotalmem - basemem);

59 
	}
}

66 
mem_öô_mp
();

67 
boŸ_m≠_ªgi⁄
(
pde_t
 *
pgdú
, 
uöçå_t
 
va
, 
size_t
 
size
, 
phyßddr_t
 
∑
, 
≥rm
);

68 
check_∑ge_‰ì_li°
(
boﬁ
 
⁄ly_low_mem‹y
);

69 
check_∑ge_Æloc
();

70 
check_kîn_pgdú
();

71 
phyßddr_t
 
check_va2∑
(
pde_t
 *
pgdú
, 
uöçå_t
 
va
);

72 
check_∑ge
();

73 
check_∑ge_ö°ÆÀd_pgdú
();

90 
	$boŸ_Æloc
(
uöt32_t
 
n
)

92 *
√xt‰ì
;

93 *
ªsu…
;

103 i‡(!
√xt‰ì
) {

104 
íd
[];

105 
√xt‰ì
 = 
	`ROUNDUP
((*Ë
íd
, 
PGSIZE
);

113 
	`˝rötf
("√ed boŸ_Æloc:0x%x byãs\à√xt‰ì:0x%x\n", 
n
, 
√xt‰ì
);

114 
ªsu…
 = 
√xt‰ì
;

115 if(
n
){

116 
√xt‰ì
 = 
	`ROUNDUP
“ext‰ì + 
n
, 
PGSIZE
);

119  
ªsu…
;

120 
	}
}

132 
	$mem_öô
()

134 
uöt32_t
 
¸0
;

135 
size_t
 
n
;

139 
	`i386_dëe˘_mem‹y
();

147 
kîn_pgdú
 = (
pde_t
 *Ë
	`boŸ_Æloc
(
PGSIZE
);

148 
	`mem£t
(
kîn_pgdú
, 0, 
PGSIZE
);

149 
	`˝rötf
("kîn_pddú 0x%x\n", 
kîn_pgdú
);

158 
kîn_pgdú
[
	`PDX
(
UVPT
)] = 
	`PADDR
(kîn_pgdúË| 
PTE_U
 | 
PTE_P
;

169 
∑ges
 =(
PageInfo
 *Ë
	`boŸ_Æloc
(
≈ages
 * (PageInfo));

170 
	`mem£t
(
∑ges
, 0, 
≈ages
 * (
PageInfo
));

176 
ívs
 = (
Env
 *)
	`boŸ_Æloc
(
NENV
 * (Env));

177 
	`mem£t
(
ívs
, 0, 
NENV
 * (
Env
));

186 
	`∑ge_öô
();

189 
	`check_∑ge_‰ì_li°
(1);

192 
	`check_∑ge_Æloc
();

195 
	`check_∑ge
();

208 
	`boŸ_m≠_ªgi⁄
(
kîn_pgdú
, 
UPAGES
, 
PTSIZE
, 
	`PADDR
(
∑ges
), 
PTE_U
);

209 
	`˝rötf
("boot_map_region UPAGES SUCCESS\n");

218 
	`boŸ_m≠_ªgi⁄
(
kîn_pgdú
, 
UENVS
, 
PTSIZE
, 
	`PADDR
(
ívs
), 
PTE_U
);

232 
	`boŸ_m≠_ªgi⁄
(
kîn_pgdú
, 
KSTACKTOP
-
KSTKSIZE
, KSTKSIZE, 
	`PADDR
(
boŸ°ack
), 
PTE_W
);

233 
	`˝rötf
("boot_map_region bootstack SUCCESS\n");

242 
	`boŸ_m≠_ªgi⁄
(
kîn_pgdú
, 
KERNBASE
, 0xffffffff-KERNBASE, 0, 
PTE_W
);

243 
	`˝rötf
("boot_map_region KERNBASE SUCCESS\n");

246 
	`mem_öô_mp
();

249 
	`check_kîn_pgdú
();

258 
	`l¸3
(
	`PADDR
(
kîn_pgdú
));

260 
	`check_∑ge_‰ì_li°
(0);

264 
¸0
 = 
	`r¸0
();

265 
¸0
 |
CR0_PE
|
CR0_PG
|
CR0_AM
|
CR0_WP
|
CR0_NE
|
CR0_MP
;

266 
¸0
 &~(
CR0_TS
|
CR0_EM
);

267 
	`l¸0
(
¸0
);

270 
	`check_∑ge_ö°ÆÀd_pgdú
();

271 
	}
}

277 
	$mem_öô_mp
()

295 
öt8_t
 
i
;

296 
uöçå_t
 
k°ackt›_i
;

297 
i
 = 0; i < 
NCPU
; i++){

298 
k°ackt›_i
 = 
KSTACKTOP
 - 
i
 * (
KSTKSIZE
 + 
KSTKGAP
);

299 
	`boŸ_m≠_ªgi⁄
(
kîn_pgdú
, 
k°ackt›_i
 - 
KSTKSIZE
, KSTKSIZE, 
	`PADDR
(&
≥r˝u_k°acks
[
i
]), 
PTE_W
 | 
PTE_P
);

301 
	}
}

316 
	$∑ge_öô
()

340 
size_t
 
∑ge_i
;

341 
∑ge_‰ì_li°
 = 
NULL
;

343 
num_Æloc
 = ((
uöt32_t
)
	`boŸ_Æloc
(0Ë- (
KERNBASE
+0x100000))/
PGSIZE
;

345 
num_iohﬁe
 = 96;

346 
m≥¡ry_i
 = 
MPENTRY_PADDR
/
PGSIZE
;

347 
∑ge_i
 = 0;Öage_ò< 
≈ages
;Öage_i++){

348 if(
∑ge_i
 =0 ||Öage_ò=
m≥¡ry_i
){

349 
∑ges
[
∑ge_i
].
µ_ªf
 = 1;

350 }if(
∑ge_i
 >=
≈ages_ba£mem
 &&Öage_ò<Ç∑ges_ba£mem + 
num_Æloc
 + 
num_iohﬁe
){

351 
∑ges
[
∑ge_i
].
µ_ªf
 = 1;

353 
∑ges
[
∑ge_i
].
µ_ªf
 = 0;

354 
∑ges
[
∑ge_i
].
µ_lök
 = 
∑ge_‰ì_li°
;

355 
∑ge_‰ì_li°
 = &
∑ges
[
∑ge_i
];

364 
	}
}

378 
PageInfo
 *

379 
	$∑ge_Æloc
(
Æloc_Êags
)

382 
PageInfo
 *
ªsu…
;

383 
ªsu…
 = 
∑ge_‰ì_li°
;

384 if(
ªsu…
 =
NULL
){

385  
NULL
;

387 
∑ge_‰ì_li°
 = 
ªsu…
->
µ_lök
;

388 
ªsu…
->
µ_lök
 = 
NULL
;

390 if(
Æloc_Êags
 & 
ALLOC_ZERO
){

391 
	`mem£t
(
	`∑ge2kva
(
ªsu…
), 0, 
PGSIZE
);

394  
ªsu…
;

395 
	}
}

402 
	$∑ge_‰ì
(
PageInfo
 *
µ
)

407 
	`as£π
(
µ
->
µ_ªf
 == 0);

408 
	`as£π
(
µ
->
µ_lök
 =
NULL
);

410 
µ
->
µ_lök
 = 
∑ge_‰ì_li°
;

411 
∑ge_‰ì_li°
 = 
µ
;

412 
	}
}

419 
	$∑ge_de¸ef
(
PageInfo
* 
µ
)

421 i‡(--
µ
->
µ_ªf
 == 0)

422 
	`∑ge_‰ì
(
µ
);

423 
	}
}

447 
±e_t
 *

448 
	$pgdú_wÆk
(
pde_t
 *
pgdú
, c⁄° *
va
, 
¸óã
)

451 
pde_ödex
 = 
	`PDX
(
va
);

452 
±e_ödex
 = 
	`PTX
(
va
);

454 
pde_t
 *
pde
 = 
pgdú
 + 
pde_ödex
;

455 if(!(*
pde
 & 
PTE_P
)){

456 if(
¸óã
 =
Ál£
){

457  
NULL
;

459 
PageInfo
 *
√w_∑ge
 = 
	`∑ge_Æloc
(
ALLOC_ZERO
);

460 if(!
√w_∑ge
){

461  
NULL
;

463 
√w_∑ge
->
µ_ªf
++;

464 *
pde
 = 
	`∑ge2∑
(
√w_∑ge
)|
PTE_P
|
PTE_U
|
PTE_W
;

469 
±e_t
 *
±a
 = (±e_à*)
	`KADDR
(
	`PTE_ADDR
(*
pde
));

471  
±a
+
±e_ödex
;

472 
	}
}

486 
	$boŸ_m≠_ªgi⁄
(
pde_t
 *
pgdú
, 
uöçå_t
 
va
, 
size_t
 
size
, 
phyßddr_t
 
∑
, 
≥rm
)

489 
sizeAdd
 = 0;

490 
±e_t
 *
√w_íåy
 = 
NULL
;

491 
sizeAdd
 = 0; sizeAdd < 
size
; sizeAdd +
PGSIZE
){

492 
√w_íåy
 = 
	`pgdú_wÆk
(
pgdú
, (*)
va
, 1);

493 *
√w_íåy
 = (
∑
 | 
≥rm
 | 
PTE_P
);

495 
∑
 +
PGSIZE
;

496 
va
 +
PGSIZE
;

498 
	}
}

526 
	$∑ge_ö£π
(
pde_t
 *
pgdú
, 
PageInfo
 *
µ
, *
va
, 
≥rm
)

529 
±e_t
 *
íåy
 = 
NULL
;

530 
íåy
 = 
	`pgdú_wÆk
(
pgdú
, 
va
, 1);

531 if(
íåy
 =
NULL
){

532  -
E_NO_MEM
;

535 
µ
->
µ_ªf
++;

536 if(*
íåy
 & 
PTE_P
){

537 
	`∑ge_ªmove
(
pgdú
, 
va
);

540 *
íåy
 = 
	`∑ge2∑
(
µ
Ë| 
≥rm
 |
PTE_P
;

543 
	}
}

556 
PageInfo
 *

557 
	$∑ge_lookup
(
pde_t
 *
pgdú
, *
va
, 
±e_t
 **
±e_°‹e
)

560 
±e_t
 *
íåy
 = 
NULL
;

561 
PageInfo
 *
ª_∑ge
 = 
NULL
;

563 
íåy
 = 
	`pgdú_wÆk
(
pgdú
, 
va
, 0);

564 if(
íåy
 =
NULL
 || !(*íåy & 
PTE_P
)){

565  
NULL
;

568 
ª_∑ge
 = 
	`∑2∑ge
(
	`PTE_ADDR
(*
íåy
));

569 if(
±e_°‹e
 !
NULL
){

570 *
±e_°‹e
 = 
íåy
 ;

572  
ª_∑ge
;

573 
	}
}

591 
	$∑ge_ªmove
(
pde_t
 *
pgdú
, *
va
)

594 
±e_t
 *
íåy
 = 
NULL
;

595 
PageInfo
 *
ª_∑ge
 = 
NULL
;

597 
ª_∑ge
 = 
	`∑ge_lookup
(
pgdú
, 
va
, &
íåy
);

598 if(
ª_∑ge
 =
NULL
){

602 
	`∑ge_de¸ef
(
ª_∑ge
);

603 
	`éb_övÆid©e
(
pgdú
, 
va
);

604 *
íåy
 = 0;

605 
	}
}

612 
	$éb_övÆid©e
(
pde_t
 *
pgdú
, *
va
)

615 i‡(!
cuªnv
 || cuªnv->
ív_pgdú
 =
pgdú
)

616 
	`övÕg
(
va
);

617 
	}
}

625 
	$mmio_m≠_ªgi⁄
(
phyßddr_t
 
∑
, 
size_t
 
size
)

631 
uöçå_t
 
ba£
 = 
MMIOBASE
;

632 *
ªt
 = (*)
ba£
;

651 
size
 = 
	`ROUNDUP
(size, 
PGSIZE
);

653 if(
MMIOBASE
 + 
size
 > 
MMIOLIM
){

654 
	`∑nic
("theÑeservation overflow MMIOLIM\n");

657 
	`boŸ_m≠_ªgi⁄
(
kîn_pgdú
, 
ba£
, 
size
, 
∑
, 
PTE_PCD
|
PTE_PWT
|
PTE_W
);

661 
ba£
 +
size
;

663  
ªt
;

665 
	}
}

667 
uöçå_t
 
	gu£r_mem_check_addr
;

688 
	$u£r_mem_check
(
Env
 *
ív
, c⁄° *
va
, 
size_t
 
Àn
, 
≥rm
)

691 
uöt32_t
 
°¨t
 = 
	`ROUNDDOWN
((uöt32_t)
va
, 
PGSIZE
);

692 
uöt32_t
 
íd
 = 
	`ROUNDUP
((uöt32_t)
va
+
Àn
, 
PGSIZE
);

693 
±e_t
 *
±e
 = 
NULL
;

696 ; 
°¨t
 < 
íd
; sèπ +
PGSIZE
 ){

697 
±e
 = 
	`pgdú_wÆk
(
ív
->
ív_pgdú
,(*)
°¨t
, 0);

699 if((
uöt32_t
)
ULIM
 < (uöt32_t)
°¨t
 || 
±e
 =
NULL
 || ((*±ê& 
≥rm
) !=Öerm) ){

701 
u£r_mem_check_addr
 = 
°¨t
 < (
uöt32_t
)
va
 ? (uint32_t)va : start;

702  -
E_FAULT
;

707 
	}
}

717 
	$u£r_mem_as£π
(
Env
 *
ív
, c⁄° *
va
, 
size_t
 
Àn
, 
≥rm
)

719 i‡(
	`u£r_mem_check
(
ív
, 
va
, 
Àn
, 
≥rm
 | 
PTE_U
) < 0) {

720 
	`˝rötf
("[%08x] user_mem_checkássertion failure for "

721 "v®%08x\n", 
ív
->
ív_id
, 
u£r_mem_check_addr
);

722 
	`ív_de°roy
(
ív
);

724 
	}
}

735 
	$check_∑ge_‰ì_li°
(
boﬁ
 
⁄ly_low_mem‹y
)

737 
PageInfo
 *
µ
;

738 
pdx_limô
 = 
⁄ly_low_mem‹y
 ? 1 : 
NPDENTRIES
;

739 
n‰ì_ba£mem
 = 0, 
n‰ì_extmem
 = 0;

740 *
fú°_‰ì_∑ge
;

742 i‡(!
∑ge_‰ì_li°
)

743 
	`∑nic
("'page_free_list' isáÇullÖointer!");

745 i‡(
⁄ly_low_mem‹y
) {

748 
PageInfo
 *
µ1
, *
µ2
;

749 
PageInfo
 **
ç
[2] = { &
µ1
, &
µ2
 };

750 
µ
 = 
∑ge_‰ì_li°
;Öp;Ö∞µ->
µ_lök
) {

751 
∑gëy≥
 = 
	`PDX
(
	`∑ge2∑
(
µ
)Ë>
pdx_limô
;

752 *
ç
[
∑gëy≥
] = 
µ
;

753 
ç
[
∑gëy≥
] = &
µ
->
µ_lök
;

755 *
ç
[1] = 0;

756 *
ç
[0] = 
µ2
;

757 
∑ge_‰ì_li°
 = 
µ1
;

762 
µ
 = 
∑ge_‰ì_li°
;Öp;Ö∞µ->
µ_lök
)

763 i‡(
	`PDX
(
	`∑ge2∑
(
µ
)Ë< 
pdx_limô
)

764 
	`mem£t
(
	`∑ge2kva
(
µ
), 0x97, 128);

766 
fú°_‰ì_∑ge
 = (*Ë
	`boŸ_Æloc
(0);

767 
µ
 = 
∑ge_‰ì_li°
;Öp;Ö∞µ->
µ_lök
) {

769 
	`as£π
(
µ
 >
∑ges
);

770 
	`as£π
(
µ
 < 
∑ges
 + 
≈ages
);

771 
	`as£π
(((*Ë
µ
 - (*Ë
∑ges
) % (*pp) == 0);

774 
	`as£π
(
	`∑ge2∑
(
µ
) != 0);

775 
	`as£π
(
	`∑ge2∑
(
µ
Ë!
IOPHYSMEM
);

776 
	`as£π
(
	`∑ge2∑
(
µ
Ë!
EXTPHYSMEM
 - 
PGSIZE
);

777 
	`as£π
(
	`∑ge2∑
(
µ
Ë!
EXTPHYSMEM
);

778 
	`as£π
(
	`∑ge2∑
(
µ
Ë< 
EXTPHYSMEM
 || (*Ë
	`∑ge2kva
’pË>
fú°_‰ì_∑ge
);

780 
	`as£π
(
	`∑ge2∑
(
µ
Ë!
MPENTRY_PADDR
);

782 i‡(
	`∑ge2∑
(
µ
Ë< 
EXTPHYSMEM
)

783 ++
n‰ì_ba£mem
;

785 ++
n‰ì_extmem
;

788 
	`as£π
(
n‰ì_ba£mem
 > 0);

789 
	`as£π
(
n‰ì_extmem
 > 0);

791 
	`˝rötf
("check_page_free_list() succeeded!\n");

792 
	}
}

799 
	$check_∑ge_Æloc
()

801 
PageInfo
 *
µ
, *
µ0
, *
µ1
, *
µ2
;

802 
n‰ì
;

803 
PageInfo
 *
Ê
;

804 *
c
;

805 
i
;

807 i‡(!
∑ges
)

808 
	`∑nic
("'pages' isáÇullÖointer!");

811 
µ
 = 
∑ge_‰ì_li°
, 
n‰ì
 = 0;Öp;Ö∞µ->
µ_lök
)

812 ++
n‰ì
;

815 
µ0
 = 
µ1
 = 
µ2
 = 0;

816 
	`as£π
((
µ0
 = 
	`∑ge_Æloc
(0)));

817 
	`as£π
((
µ1
 = 
	`∑ge_Æloc
(0)));

818 
	`as£π
((
µ2
 = 
	`∑ge_Æloc
(0)));

820 
	`as£π
(
µ0
);

821 
	`as£π
(
µ1
 &&Öp1 !
µ0
);

822 
	`as£π
(
µ2
 &&Öp2 !
µ1
 &&Öp2 !
µ0
);

823 
	`as£π
(
	`∑ge2∑
(
µ0
Ë< 
≈ages
*
PGSIZE
);

824 
	`as£π
(
	`∑ge2∑
(
µ1
Ë< 
≈ages
*
PGSIZE
);

825 
	`as£π
(
	`∑ge2∑
(
µ2
Ë< 
≈ages
*
PGSIZE
);

828 
Ê
 = 
∑ge_‰ì_li°
;

829 
∑ge_‰ì_li°
 = 0;

832 
	`as£π
(!
	`∑ge_Æloc
(0));

835 
	`∑ge_‰ì
(
µ0
);

836 
	`∑ge_‰ì
(
µ1
);

837 
	`∑ge_‰ì
(
µ2
);

838 
µ0
 = 
µ1
 = 
µ2
 = 0;

839 
	`as£π
((
µ0
 = 
	`∑ge_Æloc
(0)));

840 
	`as£π
((
µ1
 = 
	`∑ge_Æloc
(0)));

841 
	`as£π
((
µ2
 = 
	`∑ge_Æloc
(0)));

842 
	`as£π
(
µ0
);

843 
	`as£π
(
µ1
 &&Öp1 !
µ0
);

844 
	`as£π
(
µ2
 &&Öp2 !
µ1
 &&Öp2 !
µ0
);

845 
	`as£π
(!
	`∑ge_Æloc
(0));

848 
	`mem£t
(
	`∑ge2kva
(
µ0
), 1, 
PGSIZE
);

849 
	`∑ge_‰ì
(
µ0
);

850 
	`as£π
((
µ
 = 
	`∑ge_Æloc
(
ALLOC_ZERO
)));

851 
	`as£π
(
µ
 && 
µ0
 ==Öp);

852 
c
 = 
	`∑ge2kva
(
µ
);

853 
i
 = 0; i < 
PGSIZE
; i++)

854 
	`as£π
(
c
[
i
] == 0);

857 
∑ge_‰ì_li°
 = 
Ê
;

860 
	`∑ge_‰ì
(
µ0
);

861 
	`∑ge_‰ì
(
µ1
);

862 
	`∑ge_‰ì
(
µ2
);

865 
µ
 = 
∑ge_‰ì_li°
;Öp;Ö∞µ->
µ_lök
)

866 --
n‰ì
;

867 
	`as£π
(
n‰ì
 == 0);

869 
	`˝rötf
("check_page_alloc() succeeded!\n");

870 
	}
}

881 
	$check_kîn_pgdú
()

883 
uöt32_t
 
i
, 
n
;

884 
pde_t
 *
pgdú
;

886 
pgdú
 = 
kîn_pgdú
;

889 
n
 = 
	`ROUNDUP
(
≈ages
*(
PageInfo
), 
PGSIZE
);

890 
i
 = 0; i < 
n
; i +
PGSIZE
)

891 
	`as£π
(
	`check_va2∑
(
pgdú
, 
UPAGES
 + 
i
Ë=
	`PADDR
(
∑ges
) + i);

894 
n
 = 
	`ROUNDUP
(
NENV
*(
Env
), 
PGSIZE
);

895 
i
 = 0; i < 
n
; i +
PGSIZE
)

896 
	`as£π
(
	`check_va2∑
(
pgdú
, 
UENVS
 + 
i
Ë=
	`PADDR
(
ívs
) + i);

899 
i
 = 0; i < 
≈ages
 * 
PGSIZE
; i += PGSIZE)

900 
	`as£π
(
	`check_va2∑
(
pgdú
, 
KERNBASE
 + 
i
) == i);

904 
n
 = 0;Ç < 
NCPU
;Ç++) {

905 
uöt32_t
 
ba£
 = 
KSTACKTOP
 - (
KSTKSIZE
 + 
KSTKGAP
Ë* (
n
 + 1);

906 
i
 = 0; i < 
KSTKSIZE
; i +
PGSIZE
)

907 
	`as£π
(
	`check_va2∑
(
pgdú
, 
ba£
 + 
KSTKGAP
 + 
i
)

908 =
	`PADDR
(
≥r˝u_k°acks
[
n
]Ë+ 
i
);

909 
i
 = 0; i < 
KSTKGAP
; i +
PGSIZE
)

910 
	`as£π
(
	`check_va2∑
(
pgdú
, 
ba£
 + 
i
) == ~0);

914 
i
 = 0; i < 
NPDENTRIES
; i++) {

915 
i
) {

916 
	`PDX
(
UVPT
):

917 
	`PDX
(
KSTACKTOP
-1):

918 
	`PDX
(
UPAGES
):

919 
	`PDX
(
UENVS
):

920 
	`PDX
(
MMIOBASE
):

921 
	`as£π
(
pgdú
[
i
] & 
PTE_P
);

924 i‡(
i
 >
	`PDX
(
KERNBASE
)) {

925 
	`as£π
(
pgdú
[
i
] & 
PTE_P
);

926 
	`as£π
(
pgdú
[
i
] & 
PTE_W
);

928 
	`as£π
(
pgdú
[
i
] == 0);

932 
	`˝rötf
("check_kern_pgdir() succeeded!\n");

933 
	}
}

940 
phyßddr_t


941 
	$check_va2∑
(
pde_t
 *
pgdú
, 
uöçå_t
 
va
)

943 
±e_t
 *
p
;

945 
pgdú
 = &pgdú[
	`PDX
(
va
)];

946 i‡(!(*
pgdú
 & 
PTE_P
))

948 
p
 = (
±e_t
*Ë
	`KADDR
(
	`PTE_ADDR
(*
pgdú
));

949 i‡(!(
p
[
	`PTX
(
va
)] & 
PTE_P
))

951  
	`PTE_ADDR
(
p
[
	`PTX
(
va
)]);

952 
	}
}

957 
	$check_∑ge
()

959 
PageInfo
 *
µ
, *
µ0
, *
µ1
, *
µ2
;

960 
PageInfo
 *
Ê
;

961 
±e_t
 *
±ï
, *
±ï1
;

962 *
va
;

963 
uöçå_t
 
mm1
, 
mm2
;

964 
i
;

965 
pde_t
 
íåy_pgdú
[];

968 
µ0
 = 
µ1
 = 
µ2
 = 0;

969 
	`as£π
((
µ0
 = 
	`∑ge_Æloc
(0)));

970 
	`as£π
((
µ1
 = 
	`∑ge_Æloc
(0)));

971 
	`as£π
((
µ2
 = 
	`∑ge_Æloc
(0)));

973 
	`as£π
(
µ0
);

974 
	`as£π
(
µ1
 &&Öp1 !
µ0
);

975 
	`as£π
(
µ2
 &&Öp2 !
µ1
 &&Öp2 !
µ0
);

978 
Ê
 = 
∑ge_‰ì_li°
;

979 
∑ge_‰ì_li°
 = 0;

982 
	`as£π
(!
	`∑ge_Æloc
(0));

985 
	`as£π
(
	`∑ge_lookup
(
kîn_pgdú
, (*Ë0x0, &
±ï
Ë=
NULL
);

988 
	`as£π
(
	`∑ge_ö£π
(
kîn_pgdú
, 
µ1
, 0x0, 
PTE_W
) < 0);

991 
	`∑ge_‰ì
(
µ0
);

992 
	`as£π
(
	`∑ge_ö£π
(
kîn_pgdú
, 
µ1
, 0x0, 
PTE_W
) == 0);

993 
	`as£π
(
	`PTE_ADDR
(
kîn_pgdú
[0]Ë=
	`∑ge2∑
(
µ0
));

994 
	`as£π
(
	`check_va2∑
(
kîn_pgdú
, 0x0Ë=
	`∑ge2∑
(
µ1
));

995 
	`as£π
(
µ1
->
µ_ªf
 == 1);

996 
	`as£π
(
µ0
->
µ_ªf
 == 1);

999 
	`as£π
(
	`∑ge_ö£π
(
kîn_pgdú
, 
µ2
, (*Ë
PGSIZE
, 
PTE_W
) == 0);

1000 
	`as£π
(
	`check_va2∑
(
kîn_pgdú
, 
PGSIZE
Ë=
	`∑ge2∑
(
µ2
));

1001 
	`as£π
(
µ2
->
µ_ªf
 == 1);

1004 
	`as£π
(!
	`∑ge_Æloc
(0));

1007 
	`as£π
(
	`∑ge_ö£π
(
kîn_pgdú
, 
µ2
, (*Ë
PGSIZE
, 
PTE_W
) == 0);

1008 
	`as£π
(
	`check_va2∑
(
kîn_pgdú
, 
PGSIZE
Ë=
	`∑ge2∑
(
µ2
));

1009 
	`as£π
(
µ2
->
µ_ªf
 == 1);

1013 
	`as£π
(!
	`∑ge_Æloc
(0));

1016 
±ï
 = (
±e_t
 *Ë
	`KADDR
(
	`PTE_ADDR
(
kîn_pgdú
[
	`PDX
(
PGSIZE
)]));

1017 
	`as£π
(
	`pgdú_wÆk
(
kîn_pgdú
, (*)
PGSIZE
, 0Ë=
±ï
+
	`PTX
(PGSIZE));

1020 
	`as£π
(
	`∑ge_ö£π
(
kîn_pgdú
, 
µ2
, (*Ë
PGSIZE
, 
PTE_W
|
PTE_U
) == 0);

1021 
	`as£π
(
	`check_va2∑
(
kîn_pgdú
, 
PGSIZE
Ë=
	`∑ge2∑
(
µ2
));

1022 
	`as£π
(
µ2
->
µ_ªf
 == 1);

1023 
	`as£π
(*
	`pgdú_wÆk
(
kîn_pgdú
, (*Ë
PGSIZE
, 0Ë& 
PTE_U
);

1024 
	`as£π
(
kîn_pgdú
[0] & 
PTE_U
);

1027 
	`as£π
(
	`∑ge_ö£π
(
kîn_pgdú
, 
µ2
, (*Ë
PGSIZE
, 
PTE_W
) == 0);

1028 
	`as£π
(*
	`pgdú_wÆk
(
kîn_pgdú
, (*Ë
PGSIZE
, 0Ë& 
PTE_W
);

1029 
	`as£π
(!(*
	`pgdú_wÆk
(
kîn_pgdú
, (*Ë
PGSIZE
, 0Ë& 
PTE_U
));

1032 
	`as£π
(
	`∑ge_ö£π
(
kîn_pgdú
, 
µ0
, (*Ë
PTSIZE
, 
PTE_W
) < 0);

1035 
	`as£π
(
	`∑ge_ö£π
(
kîn_pgdú
, 
µ1
, (*Ë
PGSIZE
, 
PTE_W
) == 0);

1036 
	`as£π
(!(*
	`pgdú_wÆk
(
kîn_pgdú
, (*Ë
PGSIZE
, 0Ë& 
PTE_U
));

1039 
	`as£π
(
	`check_va2∑
(
kîn_pgdú
, 0Ë=
	`∑ge2∑
(
µ1
));

1040 
	`as£π
(
	`check_va2∑
(
kîn_pgdú
, 
PGSIZE
Ë=
	`∑ge2∑
(
µ1
));

1042 
	`as£π
(
µ1
->
µ_ªf
 == 2);

1043 
	`as£π
(
µ2
->
µ_ªf
 == 0);

1046 
	`as£π
((
µ
 = 
	`∑ge_Æloc
(0)Ë&&Ö∞=
µ2
);

1049 
	`∑ge_ªmove
(
kîn_pgdú
, 0x0);

1050 
	`as£π
(
	`check_va2∑
(
kîn_pgdú
, 0x0) == ~0);

1051 
	`as£π
(
	`check_va2∑
(
kîn_pgdú
, 
PGSIZE
Ë=
	`∑ge2∑
(
µ1
));

1052 
	`as£π
(
µ1
->
µ_ªf
 == 1);

1053 
	`as£π
(
µ2
->
µ_ªf
 == 0);

1056 
	`as£π
(
	`∑ge_ö£π
(
kîn_pgdú
, 
µ1
, (*Ë
PGSIZE
, 0) == 0);

1057 
	`as£π
(
µ1
->
µ_ªf
);

1058 
	`as£π
(
µ1
->
µ_lök
 =
NULL
);

1061 
	`∑ge_ªmove
(
kîn_pgdú
, (*Ë
PGSIZE
);

1062 
	`as£π
(
	`check_va2∑
(
kîn_pgdú
, 0x0) == ~0);

1063 
	`as£π
(
	`check_va2∑
(
kîn_pgdú
, 
PGSIZE
) == ~0);

1064 
	`as£π
(
µ1
->
µ_ªf
 == 0);

1065 
	`as£π
(
µ2
->
µ_ªf
 == 0);

1068 
	`as£π
((
µ
 = 
	`∑ge_Æloc
(0)Ë&&Ö∞=
µ1
);

1071 
	`as£π
(!
	`∑ge_Æloc
(0));

1074 
	`as£π
(
	`PTE_ADDR
(
kîn_pgdú
[0]Ë=
	`∑ge2∑
(
µ0
));

1075 
kîn_pgdú
[0] = 0;

1076 
	`as£π
(
µ0
->
µ_ªf
 == 1);

1077 
µ0
->
µ_ªf
 = 0;

1080 
	`∑ge_‰ì
(
µ0
);

1081 
va
 = (*)(
PGSIZE
 * 
NPDENTRIES
 + PGSIZE);

1082 
±ï
 = 
	`pgdú_wÆk
(
kîn_pgdú
, 
va
, 1);

1083 
±ï1
 = (
±e_t
 *Ë
	`KADDR
(
	`PTE_ADDR
(
kîn_pgdú
[
	`PDX
(
va
)]));

1084 
	`as£π
(
±ï
 =
±ï1
 + 
	`PTX
(
va
));

1085 
kîn_pgdú
[
	`PDX
(
va
)] = 0;

1086 
µ0
->
µ_ªf
 = 0;

1089 
	`mem£t
(
	`∑ge2kva
(
µ0
), 0xFF, 
PGSIZE
);

1090 
	`∑ge_‰ì
(
µ0
);

1091 
	`pgdú_wÆk
(
kîn_pgdú
, 0x0, 1);

1092 
±ï
 = (
±e_t
 *Ë
	`∑ge2kva
(
µ0
);

1093 
i
=0; i<
NPTENTRIES
; i++)

1094 
	`as£π
((
±ï
[
i
] & 
PTE_P
) == 0);

1095 
kîn_pgdú
[0] = 0;

1096 
µ0
->
µ_ªf
 = 0;

1099 
∑ge_‰ì_li°
 = 
Ê
;

1102 
	`∑ge_‰ì
(
µ0
);

1103 
	`∑ge_‰ì
(
µ1
);

1104 
	`∑ge_‰ì
(
µ2
);

1107 
mm1
 = (
uöçå_t
Ë
	`mmio_m≠_ªgi⁄
(0, 4097);

1108 
mm2
 = (
uöçå_t
Ë
	`mmio_m≠_ªgi⁄
(0, 4096);

1110 
	`as£π
(
mm1
 >
MMIOBASE
 && mm1 + 8192 < 
MMIOLIM
);

1111 
	`as£π
(
mm2
 >
MMIOBASE
 && mm2 + 8192 < 
MMIOLIM
);

1113 
	`as£π
(
mm1
 % 
PGSIZE
 =0 && 
mm2
 % PGSIZE == 0);

1115 
	`as£π
(
mm1
 + 8192 <
mm2
);

1117 
	`as£π
(
	`check_va2∑
(
kîn_pgdú
, 
mm1
) == 0);

1118 
	`as£π
(
	`check_va2∑
(
kîn_pgdú
, 
mm1
+
PGSIZE
) == PGSIZE);

1119 
	`as£π
(
	`check_va2∑
(
kîn_pgdú
, 
mm2
) == 0);

1120 
	`as£π
(
	`check_va2∑
(
kîn_pgdú
, 
mm2
+
PGSIZE
) == ~0);

1122 
	`as£π
(*
	`pgdú_wÆk
(
kîn_pgdú
, (*Ë
mm1
, 0Ë& (
PTE_W
|
PTE_PWT
|
PTE_PCD
));

1123 
	`as£π
(!(*
	`pgdú_wÆk
(
kîn_pgdú
, (*Ë
mm1
, 0Ë& 
PTE_U
));

1125 *
	`pgdú_wÆk
(
kîn_pgdú
, (*Ë
mm1
, 0) = 0;

1126 *
	`pgdú_wÆk
(
kîn_pgdú
, (*Ë
mm1
 + 
PGSIZE
, 0) = 0;

1127 *
	`pgdú_wÆk
(
kîn_pgdú
, (*Ë
mm2
, 0) = 0;

1129 
	`˝rötf
("check_page() succeeded!\n");

1130 
	}
}

1134 
	$check_∑ge_ö°ÆÀd_pgdú
()

1136 
PageInfo
 *
µ
, *
µ0
, *
µ1
, *
µ2
;

1137 
PageInfo
 *
Ê
;

1138 
±e_t
 *
±ï
, *
±ï1
;

1139 
uöçå_t
 
va
;

1140 
i
;

1143 
µ1
 = 
µ2
 = 0;

1144 
	`as£π
((
µ0
 = 
	`∑ge_Æloc
(0)));

1145 
	`as£π
((
µ1
 = 
	`∑ge_Æloc
(0)));

1146 
	`as£π
((
µ2
 = 
	`∑ge_Æloc
(0)));

1147 
	`∑ge_‰ì
(
µ0
);

1148 
	`mem£t
(
	`∑ge2kva
(
µ1
), 1, 
PGSIZE
);

1149 
	`mem£t
(
	`∑ge2kva
(
µ2
), 2, 
PGSIZE
);

1150 
	`∑ge_ö£π
(
kîn_pgdú
, 
µ1
, (*Ë
PGSIZE
, 
PTE_W
);

1151 
	`as£π
(
µ1
->
µ_ªf
 == 1);

1152 
	`as£π
(*(
uöt32_t
 *)
PGSIZE
 == 0x01010101U);

1153 
	`∑ge_ö£π
(
kîn_pgdú
, 
µ2
, (*Ë
PGSIZE
, 
PTE_W
);

1154 
	`as£π
(*(
uöt32_t
 *)
PGSIZE
 == 0x02020202U);

1155 
	`as£π
(
µ2
->
µ_ªf
 == 1);

1156 
	`as£π
(
µ1
->
µ_ªf
 == 0);

1157 *(
uöt32_t
 *)
PGSIZE
 = 0x03030303U;

1158 
	`as£π
(*(
uöt32_t
 *)
	`∑ge2kva
(
µ2
) == 0x03030303U);

1159 
	`∑ge_ªmove
(
kîn_pgdú
, (*Ë
PGSIZE
);

1160 
	`as£π
(
µ2
->
µ_ªf
 == 0);

1163 
	`as£π
(
	`PTE_ADDR
(
kîn_pgdú
[0]Ë=
	`∑ge2∑
(
µ0
));

1164 
kîn_pgdú
[0] = 0;

1165 
	`as£π
(
µ0
->
µ_ªf
 == 1);

1166 
µ0
->
µ_ªf
 = 0;

1169 
	`∑ge_‰ì
(
µ0
);

1171 
	`˝rötf
("check_page_installed_pgdir() succeeded!\n");

1172 
	}
}

	@kern/pmap.h

3 #i‚de‡
JOS_KERN_PMAP_H


4 
	#JOS_KERN_PMAP_H


	)

5 #i‚de‡
JOS_KERNEL


9 
	~<öc/memœyout.h
>

10 
	~<öc/as£π.h
>

11 
	gEnv
;

13 
boŸ°ackt›
[], 
boŸ°ack
[];

15 
PageInfo
 *
∑ges
;

16 
size_t
 
≈ages
;

18 
pde_t
 *
kîn_pgdú
;

26 
	#PADDR
(
kva
Ë
	`_∑ddr
(
__FILE__
, 
__LINE__
, kva)

	)

28 
ölöe
 
phyßddr_t


29 
	$_∑ddr
(c⁄° *
fûe
, 
löe
, *
kva
)

31 i‡((
uöt32_t
)
kva
 < 
KERNBASE
)

32 
	`_∑nic
(
fûe
, 
löe
, "PADDR cÆÀd wôh invÆid kv®%08lx", 
kva
);

33  (
phyßddr_t
)
kva
 - 
KERNBASE
;

34 
	}
}

38 
	#KADDR
(
∑
Ë
	`_kaddr
(
__FILE__
, 
__LINE__
,Öa)

	)

40 
ölöe
 *

41 
	$_kaddr
(c⁄° *
fûe
, 
löe
, 
phyßddr_t
 
∑
)

43 i‡(
	`PGNUM
(
∑
Ë>
≈ages
)

44 
	`_∑nic
(
fûe
, 
löe
, "KADDR cÆÀd wôh invÆidÖ®%08lx", 
∑
);

45  (*)(
∑
 + 
KERNBASE
);

46 
	}
}

51 
	mALLOC_ZERO
 = 1<<0,

54 
mem_öô
();

56 
∑ge_öô
();

57 
PageInfo
 *
∑ge_Æloc
(
Æloc_Êags
);

58 
∑ge_‰ì
(
PageInfo
 *
µ
);

59 
∑ge_ö£π
(
pde_t
 *
pgdú
, 
PageInfo
 *
µ
, *
va
, 
≥rm
);

60 
∑ge_ªmove
(
pde_t
 *
pgdú
, *
va
);

61 
PageInfo
 *
∑ge_lookup
(
pde_t
 *
pgdú
, *
va
, 
±e_t
 **
±e_°‹e
);

62 
∑ge_de¸ef
(
PageInfo
 *
µ
);

64 
éb_övÆid©e
(
pde_t
 *
pgdú
, *
va
);

66 * 
mmio_m≠_ªgi⁄
(
phyßddr_t
 
∑
, 
size_t
 
size
);

68 
u£r_mem_check
(
Env
 *
ív
, c⁄° *
va
, 
size_t
 
Àn
, 
≥rm
);

69 
u£r_mem_as£π
(
Env
 *
ív
, c⁄° *
va
, 
size_t
 
Àn
, 
≥rm
);

71 
ölöe
 
phyßddr_t


72 
	$∑ge2∑
(
PageInfo
 *
µ
)

74  (
µ
 - 
∑ges
Ë<< 
PGSHIFT
;

75 
	}
}

77 
ölöe
 
PageInfo
*

78 
	$∑2∑ge
(
phyßddr_t
 
∑
)

80 i‡(
	`PGNUM
(
∑
Ë>
≈ages
)

81 
	`∑nic
("pa2page called with invalidÖa");

82  &
∑ges
[
	`PGNUM
(
∑
)];

83 
	}
}

85 
ölöe
 *

86 
	$∑ge2kva
(
PageInfo
 *
µ
)

88  
	`KADDR
(
	`∑ge2∑
(
µ
));

89 
	}
}

91 
±e_t
 *
pgdú_wÆk
(
pde_t
 *
pgdú
, c⁄° *
va
, 
¸óã
);

	@kern/printf.c

4 
	~<öc/ty≥s.h
>

5 
	~<öc/°dio.h
>

6 
	~<öc/°d¨g.h
>

10 
	$putch
(
ch
, *
˙t
)

12 
	`˝utch¨
(
ch
);

13 *
˙t
++;

14 
	}
}

17 
	$v˝rötf
(c⁄° *
fmt
, 
va_li°
 
≠
)

19 
˙t
 = 0;

21 
	`v¥ötfmt
((*)
putch
, &
˙t
, 
fmt
, 
≠
);

22  
˙t
;

23 
	}
}

26 
	$˝rötf
(c⁄° *
fmt
, ...)

28 
va_li°
 
≠
;

29 
˙t
;

31 
	`va_°¨t
(
≠
, 
fmt
);

32 
˙t
 = 
	`v˝rötf
(
fmt
, 
≠
);

33 
	`va_íd
(
≠
);

35  
˙t
;

36 
	}
}

	@kern/sched.c

1 
	~<öc/as£π.h
>

2 
	~<öc/x86.h
>

3 
	~<kîn/•ölock.h
>

4 
	~<kîn/ív.h
>

5 
	~<kîn/pm≠.h
>

6 
	~<kîn/m⁄ô‹.h
>

8 
sched_hÆt
();

12 
	$sched_yõld
()

14 
Env
 *
idÀ
;

33 
ív_ödex
;

34 
°¨t_ívi
;

35 
i
;

37 
idÀ
 = 
this˝u
->
˝u_ív
;

38 
°¨t_ívi
 = 
idÀ
? 
	`ENVX
(idÀ->
ív_id
) + 1 : 0;

40 
i
 = 0; i< 
NENV
; i++){

41 
ív_ödex
 = (
°¨t_ívi
 + 
i
)%
NENV
;

42 if(
ívs
[
ív_ödex
].
ív_°©us
 =
ENV_RUNNABLE
){

43 
	`ív_run
(&
ívs
[
ív_ödex
]);

48 if(
idÀ
 && idÀ->
ív_°©us
 =
ENV_RUNNING
){

49 
	`ív_run
(
idÀ
);

53 
	`sched_hÆt
();

54 
	}
}

60 
	$sched_hÆt
()

62 
i
;

66 
i
 = 0; i < 
NENV
; i++) {

67 i‡((
ívs
[
i
].
ív_°©us
 =
ENV_RUNNABLE
 ||

68 
ívs
[
i
].
ív_°©us
 =
ENV_RUNNING
 ||

69 
ívs
[
i
].
ív_°©us
 =
ENV_DYING
))

72 i‡(
i
 =
NENV
) {

73 
	`˝rötf
("NoÑunnableÉnvironments inÅhe system!\n");

75 
	`m⁄ô‹
(
NULL
);

79 
cuªnv
 = 
NULL
;

80 
	`l¸3
(
	`PADDR
(
kîn_pgdú
));

85 
	`xchg
(&
this˝u
->
˝u_°©us
, 
CPU_HALTED
);

88 
	`u∆ock_kî√l
();

91 
asm
 volatile (

101 : : "a" (
this˝u
->
˝u_ts
.
ts_e•0
));

102 
	}
}

	@kern/sched.h

3 #i‚de‡
JOS_KERN_SCHED_H


4 
	#JOS_KERN_SCHED_H


	)

5 #i‚de‡
JOS_KERNEL


10 
	$sched_yõld
(Ë
	`__©åibuã__
((
n‹ëu∫
));

	@kern/spinlock.c

3 
	~<öc/ty≥s.h
>

4 
	~<öc/as£π.h
>

5 
	~<öc/x86.h
>

6 
	~<öc/memœyout.h
>

7 
	~<öc/°rög.h
>

8 
	~<kîn/˝u.h
>

9 
	~<kîn/•ölock.h
>

10 
	~<kîn/kdebug.h
>

13 
•ölock
 
	gkî√l_lock
 = {

14 #ifde‡
DEBUG_SPINLOCK


15 .
«me
 = "kernel_lock"

19 #ifde‡
DEBUG_SPINLOCK


22 
	$gë_ˇŒî_pcs
(
uöt32_t
 
pcs
[])

24 
uöt32_t
 *
ebp
;

25 
i
;

27 
ebp
 = (
uöt32_t
 *)
	`ªad_ebp
();

28 
i
 = 0; i < 10; i++){

29 i‡(
ebp
 =0 ||Éb∞< (
uöt32_t
 *)
ULIM
)

31 
pcs
[
i
] = 
ebp
[1];

32 
ebp
 = (
uöt32_t
 *)ebp[0];

34 ; 
i
 < 10; i++)

35 
pcs
[
i
] = 0;

36 
	}
}

40 
	$hﬁdög
(
•ölock
 *
lock
)

42  
lock
->
locked
 &&Üock->
˝u
 =
this˝u
;

43 
	}
}

47 
	$__•ö_öôlock
(
•ölock
 *
lk
, *
«me
)

49 
lk
->
locked
 = 0;

50 #ifde‡
DEBUG_SPINLOCK


51 
lk
->
«me
 =Çame;

52 
lk
->
˝u
 = 0;

54 
	}
}

61 
	$•ö_lock
(
•ölock
 *
lk
)

63 #ifde‡
DEBUG_SPINLOCK


64 i‡(
	`hﬁdög
(
lk
))

65 
	`∑nic
("CPU %d c™nŸácquúê%s:áÃódy hﬁdög", 
	`˝unum
(), 
lk
->
«me
);

71 
	`xchg
(&
lk
->
locked
, 1) != 0)

72 
asm
 volatile ("pause");

75 #ifde‡
DEBUG_SPINLOCK


76 
lk
->
˝u
 = 
this˝u
;

77 
	`gë_ˇŒî_pcs
(
lk
->
pcs
);

79 
	}
}

83 
	$•ö_u∆ock
(
•ölock
 *
lk
)

85 #ifde‡
DEBUG_SPINLOCK


86 i‡(!
	`hﬁdög
(
lk
)) {

87 
i
;

88 
uöt32_t
 
pcs
[10];

90 
	`memmove
(
pcs
, 
lk
->pcs, Öcs);

91 
	`˝rötf
("CPU %d cannotÑelease %s: held by CPU %d\nAcquiredát:",

92 
	`˝unum
(), 
lk
->
«me
,Ük->
˝u
->
˝u_id
);

93 
i
 = 0; i < 10 && 
pcs
[i]; i++) {

94 
Eùdebugöfo
 
öfo
;

95 i‡(
	`debugöfo_eù
(
pcs
[
i
], &
öfo
) >= 0)

96 
	`˝rötf
(" %08x %s:%d: %.*s+%x\n", 
pcs
[
i
],

97 
öfo
.
eù_fûe
, info.
eù_löe
,

98 
öfo
.
eù_‚_«mñí
, info.
eù_‚_«me
,

99 
pcs
[
i
] - 
öfo
.
eù_‚_addr
);

101 
	`˝rötf
(" %08x\n", 
pcs
[
i
]);

103 
	`∑nic
("spin_unlock");

106 
lk
->
pcs
[0] = 0;

107 
lk
->
˝u
 = 0;

115 
	`xchg
(&
lk
->
locked
, 0);

116 
	}
}

	@kern/spinlock.h

1 #i‚de‡
JOS_INC_SPINLOCK_H


2 
	#JOS_INC_SPINLOCK_H


	)

4 
	~<öc/ty≥s.h
>

7 
	#DEBUG_SPINLOCK


	)

10 
	s•ölock
 {

11 
	mlocked
;

13 #ifde‡
DEBUG_SPINLOCK


15 *
	m«me
;

16 
CpuInfo
 *
	m˝u
;

17 
uöçå_t
 
	mpcs
[10];

22 
__•ö_öôlock
(
•ölock
 *
lk
, *
«me
);

23 
•ö_lock
(
•ölock
 *
lk
);

24 
•ö_u∆ock
(
•ölock
 *
lk
);

26 
	#•ö_öôlock
(
lock
Ë
	`__•ö_öôlock
÷ock, #lock)

	)

28 
•ölock
 
kî√l_lock
;

30 
ölöe
 

31 
	$lock_kî√l
()

33 
	`•ö_lock
(&
kî√l_lock
);

34 
	}
}

36 
ölöe
 

37 
	$u∆ock_kî√l
()

39 
	`•ö_u∆ock
(&
kî√l_lock
);

45 
asm
 volatile("pause");

46 
	}
}

	@kern/syscall.c

3 
	~<öc/x86.h
>

4 
	~<öc/îr‹.h
>

5 
	~<öc/°rög.h
>

6 
	~<öc/as£π.h
>

8 
	~<kîn/ív.h
>

9 
	~<kîn/pm≠.h
>

10 
	~<kîn/å≠.h
>

11 
	~<kîn/sysˇŒ.h
>

12 
	~<kîn/c⁄sﬁe.h
>

13 
	~<kîn/sched.h
>

19 
	$sys_˝uts
(c⁄° *
s
, 
size_t
 
Àn
)

25 
	`u£r_mem_as£π
(
cuªnv
, 
s
, 
Àn
, 0);

27 
	`˝rötf
("%.*s", 
Àn
, 
s
);

28 
	}
}

33 
	$sys_cgëc
()

35  
	`c⁄s_gëc
();

36 
	}
}

39 
ívid_t


40 
	$sys_gëívid
()

42  
cuªnv
->
ív_id
;

43 
	}
}

51 
	$sys_ív_de°roy
(
ívid_t
 
ívid
)

53 
r
;

54 
Env
 *
e
;

56 i‡((
r
 = 
	`ívid2ív
(
ívid
, &
e
, 1)) < 0)

57  
r
;

58 
	`ív_de°roy
(
e
);

60 
	}
}

64 
	$sys_yõld
()

66 
	`sched_yõld
();

67 
	}
}

73 
ívid_t


74 
	$sys_exof‹k
()

83 
Env
 *
e
 ;

84 
ª
 ;

87 if((
ª
 = 
	`ív_Æloc
(&
e
, 
	`sys_gëívid
()))){

88  
ª
;

91 
e
->
ív_°©us
 = 
ENV_NOT_RUNNABLE
;

92 
e
->
ív_tf
 = 
cuªnv
->env_tf;

93 
e
->
ív_tf
.
tf_ªgs
.
ªg_óx
 = 0;

95  
e
->
ív_id
;

97 
	}
}

107 
	$sys_ív_£t_°©us
(
ívid_t
 
ívid
, 
°©us
)

116 
Env
 *
e
;

117 
ª
;

120 if(
°©us
 !
ENV_RUNNABLE
 && sètu†!
ENV_NOT_RUNNABLE
){

121  -
E_INVAL
;

125 if((
ª
 = 
	`ívid2ív
(
ívid
, &
e
, 1))){

126  
ª
;

129 
e
->
ív_°©us
 = 
°©us
;

133 
	}
}

143 
	$sys_ív_£t_å≠‰ame
(
ívid_t
 
ívid
, 
Tøp‰ame
 *
tf
)

148 
	`∑nic
("sys_env_set_trapframeÇot implemented");

149 
	}
}

160 
	$sys_ív_£t_pgÁu…_upˇŒ
(
ívid_t
 
ívid
, *
func
)

163 
ª
;

164 
Env
 *
e
;

166 if((
ª
 = 
	`ívid2ív
(
ívid
, &
e
, 1))){

167  
ª
;

170 
e
->
ív_pgÁu…_upˇŒ
 = 
func
;

173 
	}
}

192 
	$sys_∑ge_Æloc
(
ívid_t
 
ívid
, *
va
, 
≥rm
)

202 
ª
 ;

203 
Env
 *
e
;

204 
PageInfo
 *
√w∑ge
;

207 if(
va
 >(*)
UTOP
 || 
	`PGOFF
(va)){

208  -
E_INVAL
;

212 if(((
≥rm
 & (
PTE_U
 | 
PTE_P
)Ë!(PTE_U|PTE_P)Ë|| (≥rm & ~
PTE_SYSCALL
)){

213  -
E_INVAL
;

217 if((
ª
 = 
	`ívid2ív
(
ívid
, &
e
, 1))){

218  
ª
;

222 if((
√w∑ge
 = 
	`∑ge_Æloc
(
ALLOC_ZERO
)Ë=
NULL
){

223  -
E_NO_MEM
;

227 if((
ª
 = 
	`∑ge_ö£π
(
e
->
ív_pgdú
, 
√w∑ge
, 
va
, 
≥rm
))){

228 
	`∑ge_‰ì
(
√w∑ge
);

229  
ª
;

234 
	}
}

253 
	$sys_∑ge_m≠
(
ívid_t
 
§˚nvid
, *
§cva
,

254 
ívid_t
 
d°ívid
, *
d°va
, 
≥rm
)

264 
Env
 *
§˚nv
, *
d°ív
;

265 
PageInfo
 *
∑ge
;

266 
§¸e
, 
d°ª
, 
ª
;

267 
±e_t
 *
ã
;

270 if((
§¸e
 = 
	`ívid2ív
(
§˚nvid
, &
§˚nv
, 1))){

271  
§¸e
;

273 if((
d°ª
 = 
	`ívid2ív
(
d°ívid
, &
d°ív
, 1))){

274  
d°ª
;

278 if(
§cva
 >(*)
UTOP
 || 
	`PGOFF
(§cvaË|| 
d°va
 >= (*)UTOP || PGOFF(dstva)){

279  -
E_INVAL
;

283 if(((
≥rm
 & (
PTE_U
|
PTE_P
)Ë!(PTE_U|PTE_P)Ë|| (≥rm & ~
PTE_SYSCALL
)){

284  -
E_INVAL
;

288 if((
∑ge
 = 
	`∑ge_lookup
(
§˚nv
->
ív_pgdú
, 
§cva
, &
ã
)Ë=
NULL
){

289  -
E_INVAL
;

293 if((
≥rm
 & 
PTE_W
Ë&& !(*
ã
 & PTE_W)){

294  -
E_INVAL
;

298 if((
ª
 = 
	`∑ge_ö£π
(
d°ív
->
ív_pgdú
, 
∑ge
, 
d°va
, 
≥rm
))){

299  
ª
;

304 
	}
}

314 
	$sys_∑ge_unm≠
(
ívid_t
 
ívid
, *
va
)

319 
Env
 *
e
;

320 
ª
;

323 if((
ª
 = 
	`ívid2ív
(
ívid
, &
e
, 1))){

324  
ª
;

328 if(
va
 >(*)
UTOP
 || 
	`PGOFF
(va)){

329  -
E_INVAL
;

332 
	`∑ge_ªmove
(
e
->
ív_pgdú
, 
va
);

335 
	}
}

376 
	$sys_ùc_åy_£nd
(
ívid_t
 
ívid
, 
uöt32_t
 
vÆue
, *
§cva
, 
≥rm
)

379 
Env
 *
ív
;

380 
PageInfo
 *
µ
;

381 
ª
;

382 
±e_t
 *
íåy
;

385 if((
ª
 = 
	`ívid2ív
(
ívid
, &
ív
, 0)) < 0){

386  
ª
;

389 if(!
ív
->
ív_ùc_ªcvög
 ||Énv->
ív_ùc_‰om
){

390  -
E_IPC_NOT_RECV
;

393 if(
§cva
 < (*)
UTOP
){

394 if(
	`PGOFF
(
§cva
)){

395  -
E_INVAL
;

398 if(((
≥rm
 & (
PTE_U
 | 
PTE_P
)Ë!(PTE_U|PTE_P)Ë|| (≥rm & ~
PTE_SYSCALL
)){

399  -
E_INVAL
;

402 if(!(
µ
 = 
	`∑ge_lookup
(
cuªnv
->
ív_pgdú
, 
§cva
, &
íåy
))){

403  -
E_INVAL
;

406 if((
≥rm
 & 
PTE_W
Ë&& !(*
íåy
 & PTE_W)){

407  -
E_INVAL
;

409 if(
ív
->
ív_ùc_d°va
){

410 if((
ª
 = 
	`∑ge_ö£π
(
ív
->
ív_pgdú
, 
µ
,Énv->
ív_ùc_d°va
, 
≥rm
)) < 0){

411  
ª
;

413 
ív
->
ív_ùc_≥rm
 = 
≥rm
;

418 
ív
->
ív_ùc_ªcvög
 = 0;

419 
ív
->
ív_ùc_‰om
 = 
	`sys_gëívid
();

420 
ív
->
ív_ùc_vÆue
 = 
vÆue
;

421 
ív
->
ív_°©us
 = 
ENV_RUNNABLE
;

422 
ív
->
ív_tf
.
tf_ªgs
.
ªg_óx
 = 0;

425 
	}
}

439 
	$sys_ùc_ªcv
(*
d°va
)

442 
Env
 *
ív
 = 
cuªnv
;

444 if(
d°va
 < (*)
UTOP
 && 
	`PGOFF
(dstva)){

445  -
E_INVAL
;

448 
ív
->
ív_°©us
 = 
ENV_NOT_RUNNABLE
;

449 
ív
->
ív_ùc_ªcvög
 = 
åue
;

450 
ív
->
ív_ùc_d°va
 = 
d°va
;

451 
ív
->
ív_ùc_‰om
 = 0;

452 
	`sys_yõld
();

455 
	}
}

458 
öt32_t


459 
	$sysˇŒ
(
uöt32_t
 
sysˇŒno
, uöt32_à
a1
, uöt32_à
a2
, uöt32_à
a3
, uöt32_à
a4
, uöt32_à
a5
)

465 
ª
 ;

468 
sysˇŒno
) {

469 
SYS_˝uts
:

470 
	`sys_˝uts
((c⁄° *)
a1
, (
size_t
)
a2
);

473 
SYS_cgëc
:

474 
ª
 = 
	`sys_cgëc
();

475  (
öt32_t
)
ª
;

477 
SYS_gëívid
:

478 
ª
 = 
	`sys_gëívid
();

479  (
öt32_t
)
ª
;

481 
SYS_ív_de°roy
:

482 
ª
 = 
	`sys_ív_de°roy
((
uöt32_t
)
a1
);

483  (
öt32_t
)
ª
;

485 
SYS_∑ge_Æloc
:

486  (
öt32_t
)
	`sys_∑ge_Æloc
(
a1
, (*)
a2
, 
a3
);

488 
SYS_∑ge_m≠
:

489  (
öt32_t
)
	`sys_∑ge_m≠
(
a1
, (*)
a2
, 
a3
, (*)
a4
 ,
a5
);

491 
SYS_∑ge_unm≠
:

492  (
öt32_t
)
	`sys_∑ge_unm≠
(
a1
, (*)
a2
);

494 
SYS_exof‹k
:

495  (
öt32_t
)
	`sys_exof‹k
();

497 
SYS_ív_£t_°©us
:

498  (
öt32_t
)
	`sys_ív_£t_°©us
(
a1
, 
a2
);

500 
SYS_ív_£t_pgÁu…_upˇŒ
:

501  (
öt32_t
)
	`sys_ív_£t_pgÁu…_upˇŒ
(
a1
, (*)
a2
);

503 
SYS_yõld
:

504 
	`sys_yõld
();

507 
SYS_ùc_åy_£nd
:

508  (
öt32_t
)
	`sys_ùc_åy_£nd
(
a1
, 
a2
, (*)
a3
, 
a4
);

510 
SYS_ùc_ªcv
:

511  (
öt32_t
)
	`sys_ùc_ªcv
((*)
a1
);

514  -
E_INVAL
;

516 
	}
}

	@kern/syscall.h

1 #i‚de‡
JOS_KERN_SYSCALL_H


2 
	#JOS_KERN_SYSCALL_H


	)

3 #i‚de‡
JOS_KERNEL


7 
	~<öc/sysˇŒ.h
>

9 
öt32_t
 
sysˇŒ
(
uöt32_t
 
num
, uöt32_à
a1
, uöt32_à
a2
, uöt32_à
a3
, uöt32_à
a4
, uöt32_à
a5
);

	@kern/trap.c

1 
	~<öc/mmu.h
>

2 
	~<öc/x86.h
>

3 
	~<öc/as£π.h
>

5 
	~<kîn/pm≠.h
>

6 
	~<kîn/å≠.h
>

7 
	~<kîn/c⁄sﬁe.h
>

8 
	~<kîn/m⁄ô‹.h
>

9 
	~<kîn/ív.h
>

10 
	~<kîn/sysˇŒ.h
>

11 
	~<kîn/sched.h
>

12 
	~<kîn/k˛ock.h
>

13 
	~<kîn/picúq.h
>

14 
	~<kîn/˝u.h
>

15 
	~<kîn/•ölock.h
>

17 
Task°©e
 
	gts
;

23 
Tøp‰ame
 *
	gœ°_tf
;

28 
G©edesc
 
	gidt
[256] = { { 0 } };

29 
P£udodesc
 
	gidt_pd
 = {

30 (
idt
Ë- 1, (
uöt32_t
) idt

34 c⁄° *
	$å≠«me
(
å≠no
)

36 c⁄° * c⁄° 
ex˙ames
[] = {

59 i‡(
å≠no
 < 
	`ARRAY_SIZE
(
ex˙ames
))

60  
ex˙ames
[
å≠no
];

61 i‡(
å≠no
 =
T_SYSCALL
)

63 i‡(
å≠no
 >
IRQ_OFFSET
 &&Årapno < IRQ_OFFSET + 16)

66 
	}
}

70 
	$å≠_öô
()

72 
Segdesc
 
gdt
[];

75 
	`divide_h™dÀr
();

76 
	`debug_h™dÀr
();

77 
	`nmi_h™dÀr
();

78 
	`brk±_h™dÀr
();

79 
	`oÊow_h™dÀr
();

80 
	`bound_h™dÀr
();

81 
	`ûl›_h™dÀr
();

82 
	`devi˚_h™dÀr
();

83 
	`dblÊt_h™dÀr
();

84 
	`tss_h™dÀr
();

85 
	`£g≈_h™dÀr
();

86 
	`°ack_h™dÀr
();

87 
	`gpÊt_h™dÀr
();

88 
	`pgÊt_h™dÀr
();

89 
	`Âîr_h™dÀr
();

90 
	`Æign_h™dÀr
();

91 
	`mchk_h™dÀr
();

92 
	`simdîr_h™dÀr
();

93 
	`sysˇŒ_h™dÀr
();

96 
	`úq_timî_h™dÀr
();

97 
	`úq_kbd_h™dÀr
();

98 
	`úq_£rül_h™dÀr
();

99 
	`úq_•urious_h™dÀr
();

100 
	`úq_ide_h™dÀr
();

101 
	`úq_îr‹_h™dÀr
();

104 
	`SETGATE
(
idt
[
T_DIVIDE
], 0, 
GD_KT
, 
divide_h™dÀr
, 0);

105 
	`SETGATE
(
idt
[
T_DEBUG
], 0, 
GD_KT
, 
debug_h™dÀr
, 0);

106 
	`SETGATE
(
idt
[
T_NMI
], 0, 
GD_KT
, 
nmi_h™dÀr
, 0);

107 
	`SETGATE
(
idt
[
T_BRKPT
], 0, 
GD_KT
, 
brk±_h™dÀr
, 3);

108 
	`SETGATE
(
idt
[
T_OFLOW
], 0, 
GD_KT
, 
oÊow_h™dÀr
, 0);

109 
	`SETGATE
(
idt
[
T_BOUND
], 0, 
GD_KT
, 
bound_h™dÀr
, 0);

110 
	`SETGATE
(
idt
[
T_ILLOP
], 0, 
GD_KT
, 
ûl›_h™dÀr
, 0);

111 
	`SETGATE
(
idt
[
T_DEVICE
], 0, 
GD_KT
, 
devi˚_h™dÀr
, 0);

112 
	`SETGATE
(
idt
[
T_DBLFLT
], 0, 
GD_KT
, 
dblÊt_h™dÀr
, 0);

113 
	`SETGATE
(
idt
[
T_TSS
], 0, 
GD_KT
, 
tss_h™dÀr
, 0);

114 
	`SETGATE
(
idt
[
T_SEGNP
], 0, 
GD_KT
, 
£g≈_h™dÀr
, 0);

115 
	`SETGATE
(
idt
[
T_STACK
], 0, 
GD_KT
, 
°ack_h™dÀr
, 0);

116 
	`SETGATE
(
idt
[
T_GPFLT
], 0, 
GD_KT
, 
gpÊt_h™dÀr
, 0);

117 
	`SETGATE
(
idt
[
T_PGFLT
], 0, 
GD_KT
, 
pgÊt_h™dÀr
, 0);

118 
	`SETGATE
(
idt
[
T_FPERR
], 0, 
GD_KT
, 
Âîr_h™dÀr
, 0);

119 
	`SETGATE
(
idt
[
T_ALIGN
], 0, 
GD_KT
, 
Æign_h™dÀr
, 0);

120 
	`SETGATE
(
idt
[
T_MCHK
], 0, 
GD_KT
, 
mchk_h™dÀr
, 0);

121 
	`SETGATE
(
idt
[
T_SIMDERR
], 0, 
GD_KT
, 
simdîr_h™dÀr
, 0);

122 
	`SETGATE
(
idt
[
T_SYSCALL
], 0, 
GD_KT
, 
sysˇŒ_h™dÀr
, 3);

125 
	`SETGATE
(
idt
[
IRQ_OFFSET
 + 
IRQ_TIMER
], 0, 
GD_KT
, 
úq_timî_h™dÀr
, 3);

126 
	`SETGATE
(
idt
[
IRQ_OFFSET
 + 
IRQ_KBD
], 0, 
GD_KT
, 
úq_kbd_h™dÀr
, 3);

127 
	`SETGATE
(
idt
[
IRQ_OFFSET
 + 
IRQ_SERIAL
], 0, 
GD_KT
, 
úq_£rül_h™dÀr
, 3);

128 
	`SETGATE
(
idt
[
IRQ_OFFSET
 + 
IRQ_SPURIOUS
], 0, 
GD_KT
, 
úq_•urious_h™dÀr
, 3);

129 
	`SETGATE
(
idt
[
IRQ_OFFSET
 + 
IRQ_IDE
], 0, 
GD_KT
, 
úq_ide_h™dÀr
, 3);

130 
	`SETGATE
(
idt
[
IRQ_OFFSET
 + 
IRQ_ERROR
], 0, 
GD_KT
, 
úq_îr‹_h™dÀr
, 3);

134 
	`å≠_öô_≥r˝u
();

135 
	}
}

139 
	$å≠_öô_≥r˝u
()

165 
öt8_t
 
˝u_i
 = 
	`˝unum
();

168 
this˝u
->
˝u_ts
.
ts_e•0
 = 
KSTACKTOP
 - 
˝u_i
 * (
KSTKSIZE
 + 
KSTKGAP
);

169 
this˝u
->
˝u_ts
.
ts_ss0
 = 
GD_KD
;

170 
this˝u
->
˝u_ts
.
ts_iomb
 = (
Task°©e
);

173 
gdt
[(
GD_TSS0
 >> 3Ë+ 
˝u_i
] = 
	`SEG16
(
STS_T32A
, (
uöt32_t
Ë(&(
this˝u
->
˝u_ts
)),

174 (
Task°©e
) - 1, 0);

175 
gdt
[(
GD_TSS0
 >> 3Ë+ 
˝u_i
].
sd_s
 = 0;

179 
	`…r
(
GD_TSS0
 + (
Segdesc
Ë* 
˝u_i
);

182 
	`lidt
(&
idt_pd
);

183 
	}
}

186 
	$¥öt_å≠‰ame
(
Tøp‰ame
 *
tf
)

188 
	`˝rötf
("TRAP fømê© %∞‰om CPU %d\n", 
tf
, 
	`˝unum
());

189 
	`¥öt_ªgs
(&
tf
->
tf_ªgs
);

190 
	`˝rötf
("É† 0x----%04x\n", 
tf
->
tf_es
);

191 
	`˝rötf
(" d† 0x----%04x\n", 
tf
->
tf_ds
);

192 
	`˝rötf
("Åø∞0x%08x %s\n", 
tf
->
tf_å≠no
, 
	`å≠«me
(tf->tf_trapno));

195 i‡(
tf
 =
œ°_tf
 &&Åf->
tf_å≠no
 =
T_PGFLT
)

196 
	`˝rötf
(" cr2 0x%08x\n", 
	`r¸2
());

197 
	`˝rötf
("Éº 0x%08x", 
tf
->
tf_îr
);

202 i‡(
tf
->
tf_å≠no
 =
T_PGFLT
)

203 
	`˝rötf
(" [%s, %s, %s]\n",

204 
tf
->
tf_îr
 & 4 ? "user" : "kernel",

205 
tf
->
tf_îr
 & 2 ? "write" : "read",

206 
tf
->
tf_îr
 & 1 ? "protection" : "not-present");

208 
	`˝rötf
("\n");

209 
	`˝rötf
("Éù 0x%08x\n", 
tf
->
tf_eù
);

210 
	`˝rötf
(" c† 0x----%04x\n", 
tf
->
tf_cs
);

211 
	`˝rötf
(" fœg 0x%08x\n", 
tf
->
tf_eÊags
);

212 i‡((
tf
->
tf_cs
 & 3) != 0) {

213 
	`˝rötf
("É• 0x%08x\n", 
tf
->
tf_e•
);

214 
	`˝rötf
(" s† 0x----%04x\n", 
tf
->
tf_ss
);

216 
	}
}

219 
	$¥öt_ªgs
(
PushRegs
 *
ªgs
)

221 
	`˝rötf
("Édò 0x%08x\n", 
ªgs
->
ªg_edi
);

222 
	`˝rötf
("Ésò 0x%08x\n", 
ªgs
->
ªg_esi
);

223 
	`˝rötf
("Éb∞ 0x%08x\n", 
ªgs
->
ªg_ebp
);

224 
	`˝rötf
(" oe• 0x%08x\n", 
ªgs
->
ªg_€•
);

225 
	`˝rötf
("Ébx 0x%08x\n", 
ªgs
->
ªg_ebx
);

226 
	`˝rötf
("Édx 0x%08x\n", 
ªgs
->
ªg_edx
);

227 
	`˝rötf
("Écx 0x%08x\n", 
ªgs
->
ªg_ecx
);

228 
	`˝rötf
("Éax 0x%08x\n", 
ªgs
->
ªg_óx
);

229 
	}
}

232 
	$å≠_di•©ch
(
Tøp‰ame
 *
tf
)

237 
PushRegs
 *
ªgs
 = &(
tf
->
tf_ªgs
);

238 
öt32_t
 
ª
 ;

240 if(
tf
->
tf_å≠no
 =
T_BRKPT
){

241 
	`m⁄ô‹
(
tf
);

245 if(
tf
->
tf_å≠no
 =
T_SYSCALL
){

246 
ª
 = 
	`sysˇŒ
(
ªgs
->
ªg_óx
,Ñegs->
ªg_edx
,Ñegs->
ªg_ecx
,Ñegs->
ªg_ebx
,Ñegs->
ªg_edi
,Ñegs->
ªg_esi
);

247 
ªgs
->
ªg_óx
 = 
ª
;

251 if(
tf
->
tf_å≠no
 =
T_PGFLT
){

252 
	`∑ge_Áu…_h™dÀr
(
tf
);

259 i‡(
tf
->
tf_å≠no
 =
IRQ_OFFSET
 + 
IRQ_SPURIOUS
) {

260 
	`˝rötf
("Spurious interrupt on irq 7\n");

261 
	`¥öt_å≠‰ame
(
tf
);

269 if(
tf
->
tf_å≠no
 =
IRQ_OFFSET
 + 
IRQ_TIMER
){

270 
	`œpic_eoi
();

271 
	`sched_yõld
();

278 
	`¥öt_å≠‰ame
(
tf
);

279 i‡(
tf
->
tf_cs
 =
GD_KT
)

280 
	`∑nic
("unhandledÅrap in kernel");

282 
	`ív_de°roy
(
cuªnv
);

285 
	}
}

288 
	$å≠
(
Tøp‰ame
 *
tf
)

292 
asm
 volatile("cld" ::: "cc");

295 *
∑nic°r
;

296 i‡(
∑nic°r
)

297 
asm
 volatile("hlt");

301 i‡(
	`xchg
(&
this˝u
->
˝u_°©us
, 
CPU_STARTED
Ë=
CPU_HALTED
)

302 
	`lock_kî√l
();

306 
	`as£π
(!(
	`ªad_eÊags
(Ë& 
FL_IF
));

308 i‡((
tf
->
tf_cs
 & 3) == 3) {

313 
	`lock_kî√l
();

314 
	`as£π
(
cuªnv
);

317 i‡(
cuªnv
->
ív_°©us
 =
ENV_DYING
) {

318 
	`ív_‰ì
(
cuªnv
);

319 
cuªnv
 = 
NULL
;

320 
	`sched_yõld
();

326 
cuªnv
->
ív_tf
 = *
tf
;

328 
tf
 = &
cuªnv
->
ív_tf
;

333 
œ°_tf
 = 
tf
;

336 
	`å≠_di•©ch
(
tf
);

341 i‡(
cuªnv
 && cuªnv->
ív_°©us
 =
ENV_RUNNING
)

342 
	`ív_run
(
cuªnv
);

344 
	`sched_yõld
();

345 
	}
}

349 
	$∑ge_Áu…_h™dÀr
(
Tøp‰ame
 *
tf
)

351 
uöt32_t
 
Áu…_va
;

352 
UTøp‰ame
 *
utf
;

354 
Áu…_va
 = 
	`r¸2
();

360 if(!(
tf
->
tf_cs
 & 0x03)){

361 
	`∑nic
("page fault in kernel mode\n");

396 if(
cuªnv
->
ív_pgÁu…_upˇŒ
){

397 if(
tf
->
tf_e•
 >
UXSTACKTOP
 - 
PGSIZE
 &&Åf->tf_esp < UXSTACKTOP){

398 
utf
 = (
UTøp‰ame
 *)(
tf
->
tf_e•
-4-(UTrapframe));

400 
utf
 = (
UTøp‰ame
 *)(
UXSTACKTOP
 - (UTrapframe));

402 
	`u£r_mem_as£π
(
cuªnv
, (c⁄° *)
utf
, (
UTøp‰ame
), 
PTE_U
|
PTE_W
);

404 
utf
->
utf_e•
 = 
tf
->
tf_e•
;

405 
utf
->
utf_eÊags
 = 
tf
->
tf_eÊags
;

406 
utf
->
utf_eù
 = 
tf
->
tf_eù
;

407 
utf
->
utf_ªgs
 = 
tf
->
tf_ªgs
;

408 
utf
->
utf_îr
 = 
tf
->
tf_å≠no
;

409 
utf
->
utf_Áu…_va
 = 
Áu…_va
;

410 
tf
->
tf_eù
 = (
uöçå_t
)
cuªnv
->
ív_pgÁu…_upˇŒ
;

411 
tf
->
tf_e•
 = (
uöçå_t
)
utf
;

413 
	`ív_run
(
cuªnv
);

417 
	`˝rötf
("[%08x] user fault va %08x ip %08x\n",

418 
cuªnv
->
ív_id
, 
Áu…_va
, 
tf
->
tf_eù
);

419 
	`¥öt_å≠‰ame
(
tf
);

420 
	`ív_de°roy
(
cuªnv
);

422 
	}
}

	@kern/trap.h

3 #i‚de‡
JOS_KERN_TRAP_H


4 
	#JOS_KERN_TRAP_H


	)

5 #i‚de‡
JOS_KERNEL


9 
	~<öc/å≠.h
>

10 
	~<öc/mmu.h
>

13 
G©edesc
 
idt
[];

14 
P£udodesc
 
idt_pd
;

16 
å≠_öô
();

17 
å≠_öô_≥r˝u
();

18 
¥öt_ªgs
(
PushRegs
 *
ªgs
);

19 
¥öt_å≠‰ame
(
Tøp‰ame
 *
tf
);

20 
∑ge_Áu…_h™dÀr
(
Tøp‰ame
 *);

21 
backåa˚
(
Tøp‰ame
 *);

	@lib/args.c

1 
	~<öc/¨gs.h
>

2 
	~<öc/°rög.h
>

5 
	$¨g°¨t
(*
¨gc
, **
¨gv
, 
Arg°©e
 *
¨gs
)

7 
¨gs
->
¨gc
 =árgc;

8 
¨gs
->
¨gv
 = (const **)árgv;

9 
¨gs
->
cuørg
 = (*
¨gc
 > 1 && 
¨gv
 ? "" : 0);

10 
¨gs
->
¨gvÆue
 = 0;

11 
	}
}

14 
	$¨g√xt
(
Arg°©e
 *
¨gs
)

16 
¨g
;

18 
¨gs
->
¨gvÆue
 = 0;

21 i‡(
¨gs
->
cuørg
 == 0)

24 i‡(!*
¨gs
->
cuørg
) {

27 i‡(*
¨gs
->
¨gc
 == 1

28 || 
¨gs
->
¨gv
[1][0] != '-'

29 || 
¨gs
->
¨gv
[1][1] == '\0')

30 
ídoÁrgs
;

32 
¨gs
->
cuørg
 =árgs->
¨gv
[1] + 1;

33 
	`memmove
(
¨gs
->
¨gv
 + 1,árgs->¨gv + 2, (c⁄° *Ë* (*¨gs->
¨gc
 - 1));

34 (*
¨gs
->
¨gc
)--;

36 i‡(
¨gs
->
cuørg
[0] == '-' &&árgs->curarg[1] == '\0')

37 
ídoÁrgs
;

40 
¨g
 = (Ë*
¨gs
->
cuørg
;

41 
¨gs
->
cuørg
++;

42  
¨g
;

44 
ídoÁrgs
:

45 
¨gs
->
cuørg
 = 0;

47 
	}
}

50 
	$¨gvÆue
(
Arg°©e
 *
¨gs
)

52  (*Ë(
¨gs
->
¨gvÆue
 ?árgs->¨gvÆuê: 
	`¨g√xtvÆue
(args));

53 
	}
}

56 
	$¨g√xtvÆue
(
Arg°©e
 *
¨gs
)

58 i‡(!
¨gs
->
cuørg
)

60 i‡(*
¨gs
->
cuørg
) {

61 
¨gs
->
¨gvÆue
 =árgs->
cuørg
;

62 
¨gs
->
cuørg
 = "";

63 } i‡(*
¨gs
->
¨gc
 > 1) {

64 
¨gs
->
¨gvÆue
 =árgs->
¨gv
[1];

65 
	`memmove
(
¨gs
->
¨gv
 + 1,árgs->¨gv + 2, (c⁄° *Ë* (*¨gs->
¨gc
 - 1));

66 (*
¨gs
->
¨gc
)--;

68 
¨gs
->
¨gvÆue
 = 0;

69 
¨gs
->
cuørg
 = 0;

71  (*Ë
¨gs
->
¨gvÆue
;

72 
	}
}

	@lib/console.c

2 
	~<öc/°rög.h
>

3 
	~<öc/lib.h
>

6 
	$˝utch¨
(
ch
)

8 
c
 = 
ch
;

12 
	`sys_˝uts
(&
c
, 1);

13 
	}
}

16 
	$gëch¨
()

18 
c
;

19 
r
;

24 
r
 = 
	`ªad
(0, &
c
, 1);

25 i‡(
r
 < 0)

26  
r
;

27 i‡(
r
 < 1)

28  -
E_EOF
;

29  
c
;

30 
	}
}

37 
ssize_t
 
devc⁄s_ªad
(
Fd
*, *, 
size_t
);

38 
ssize_t
 
devc⁄s_wrôe
(
Fd
*, c⁄° *, 
size_t
);

39 
devc⁄s_˛o£
(
Fd
*);

40 
devc⁄s_°©
(
Fd
*, 
Sèt
*);

42 
Dev
 
	gdevc⁄s
 =

44 .
dev_id
 = 'c',

45 .
	gdev_«me
 = "cons",

46 .
	gdev_ªad
 = 
devc⁄s_ªad
,

47 .
	gdev_wrôe
 = 
devc⁄s_wrôe
,

48 .
	gdev_˛o£
 = 
devc⁄s_˛o£
,

49 .
	gdev_°©
 = 
devc⁄s_°©


53 
	$isc⁄s
(
fdnum
)

55 
r
;

56 
Fd
 *
fd
;

58 i‡((
r
 = 
	`fd_lookup
(
fdnum
, &
fd
)) < 0)

59  
r
;

60  
fd
->
fd_dev_id
 =
devc⁄s
.
dev_id
;

61 
	}
}

64 
	$›íc⁄s
()

66 
r
;

67 
Fd
* 
fd
;

69 i‡((
r
 = 
	`fd_Æloc
(&
fd
)) < 0)

70  
r
;

71 i‡((
r
 = 
	`sys_∑ge_Æloc
(0, 
fd
, 
PTE_P
|
PTE_U
|
PTE_W
|
PTE_SHARE
)) < 0)

72  
r
;

73 
fd
->
fd_dev_id
 = 
devc⁄s
.
dev_id
;

74 
fd
->
fd_omode
 = 
O_RDWR
;

75  
	`fd2num
(
fd
);

76 
	}
}

78 
ssize_t


79 
	$devc⁄s_ªad
(
Fd
 *
fd
, *
vbuf
, 
size_t
 
n
)

81 
c
;

83 i‡(
n
 == 0)

86 (
c
 = 
	`sys_cgëc
()) == 0)

87 
	`sys_yõld
();

88 i‡(
c
 < 0)

89  
c
;

90 i‡(
c
 == 0x04)

92 *(*)
vbuf
 = 
c
;

94 
	}
}

96 
ssize_t


97 
	$devc⁄s_wrôe
(
Fd
 *
fd
, c⁄° *
vbuf
, 
size_t
 
n
)

99 
tŸ
, 
m
;

100 
buf
[128];

104 
tŸ
 = 0;ÅŸ < 
n
;ÅŸ +
m
) {

105 
m
 = 
n
 - 
tŸ
;

106 i‡(
m
 > (
buf
) - 1)

107 
m
 = (
buf
) - 1;

108 
	`memmove
(
buf
, (*)
vbuf
 + 
tŸ
, 
m
);

109 
	`sys_˝uts
(
buf
, 
m
);

111  
tŸ
;

112 
	}
}

115 
	$devc⁄s_˛o£
(
Fd
 *
fd
)

117 
	`USED
(
fd
);

120 
	}
}

123 
	$devc⁄s_°©
(
Fd
 *
fd
, 
Sèt
 *
°©
)

125 
	`°r˝y
(
°©
->
°_«me
, "<cons>");

127 
	}
}

	@lib/exit.c

2 
	~<öc/lib.h
>

5 
	$exô
()

8 
	`sys_ív_de°roy
(0);

9 
	}
}

	@lib/fd.c

1 
	~<öc/lib.h
>

3 
	#debug
 0

	)

6 
	#MAXFD
 32

	)

8 
	#FDTABLE
 0xD0000000

	)

11 
	#FILEDATA
 (
FDTABLE
 + 
MAXFD
*
PGSIZE
)

	)

14 
	#INDEX2FD
(
i
Ë((
Fd
*Ë(
FDTABLE
 + (i)*
PGSIZE
))

	)

16 
	#INDEX2DATA
(
i
Ë((*Ë(
FILEDATA
 + (i)*
PGSIZE
))

	)

24 
	$fd2num
(
Fd
 *
fd
)

26  ((
uöçå_t
Ë
fd
 - 
FDTABLE
Ë/ 
PGSIZE
;

27 
	}
}

30 
	$fd2d©a
(
Fd
 *
fd
)

32  
	`INDEX2DATA
(
	`fd2num
(
fd
));

33 
	}
}

51 
	$fd_Æloc
(
Fd
 **
fd_°‹e
)

53 
i
;

54 
Fd
 *
fd
;

56 
i
 = 0; i < 
MAXFD
; i++) {

57 
fd
 = 
	`INDEX2FD
(
i
);

58 i‡((
uvpd
[
	`PDX
(
fd
)] & 
PTE_P
Ë=0 || (
uv±
[
	`PGNUM
(fd)] & PTE_P) == 0) {

59 *
fd_°‹e
 = 
fd
;

63 *
fd_°‹e
 = 0;

64  -
E_MAX_OPEN
;

65 
	}
}

74 
	$fd_lookup
(
fdnum
, 
Fd
 **
fd_°‹e
)

76 
Fd
 *
fd
;

78 i‡(
fdnum
 < 0 || fdnum >
MAXFD
) {

79 i‡(
debug
)

80 
	`˝rötf
("[%08x] bad fd %d\n", 
thi£nv
->
ív_id
, 
fdnum
);

81  -
E_INVAL
;

83 
fd
 = 
	`INDEX2FD
(
fdnum
);

84 i‡(!(
uvpd
[
	`PDX
(
fd
)] & 
PTE_P
Ë|| !(
uv±
[
	`PGNUM
(fd)] & PTE_P)) {

85 i‡(
debug
)

86 
	`˝rötf
("[%08x] clo£d fd %d\n", 
thi£nv
->
ív_id
, 
fdnum
);

87  -
E_INVAL
;

89 *
fd_°‹e
 = 
fd
;

91 
	}
}

101 
	$fd_˛o£
(
Fd
 *
fd
, 
boﬁ
 
mu°_exi°
)

103 
Fd
 *
fd2
;

104 
Dev
 *
dev
;

105 
r
;

106 i‡((
r
 = 
	`fd_lookup
(
	`fd2num
(
fd
), &
fd2
)) < 0

107 || 
fd
 !
fd2
)

108  (
mu°_exi°
 ? 
r
 : 0);

109 i‡((
r
 = 
	`dev_lookup
(
fd
->
fd_dev_id
, &
dev
)) >= 0) {

110 i‡(
dev
->
dev_˛o£
)

111 
r
 = (*
dev
->
dev_˛o£
)(
fd
);

113 
r
 = 0;

117 (Ë
	`sys_∑ge_unm≠
(0, 
fd
);

118  
r
;

119 
	}
}

126 
Dev
 *
	gdevèb
[] =

128 &
devfûe
,

129 &
devpùe
,

130 &
devc⁄s
,

135 
	$dev_lookup
(
dev_id
, 
Dev
 **
dev
)

137 
i
;

138 
i
 = 0; 
devèb
[i]; i++)

139 i‡(
devèb
[
i
]->
dev_id
 == dev_id) {

140 *
dev
 = 
devèb
[
i
];

143 
	`˝rötf
("[%08x] unknow¿devi˚Åy≥ %d\n", 
thi£nv
->
ív_id
, 
dev_id
);

144 *
dev
 = 0;

145  -
E_INVAL
;

146 
	}
}

149 
	$˛o£
(
fdnum
)

151 
Fd
 *
fd
;

152 
r
;

154 i‡((
r
 = 
	`fd_lookup
(
fdnum
, &
fd
)) < 0)

155  
r
;

157  
	`fd_˛o£
(
fd
, 1);

158 
	}
}

161 
	$˛o£_Æl
()

163 
i
;

164 
i
 = 0; i < 
MAXFD
; i++)

165 
	`˛o£
(
i
);

166 
	}
}

174 
	$dup
(
ﬁdfdnum
, 
√wfdnum
)

176 
r
;

177 *
ova
, *
nva
;

178 
±e_t
 
±e
;

179 
Fd
 *
ﬁdfd
, *
√wfd
;

181 i‡((
r
 = 
	`fd_lookup
(
ﬁdfdnum
, &
ﬁdfd
)) < 0)

182  
r
;

183 
	`˛o£
(
√wfdnum
);

185 
√wfd
 = 
	`INDEX2FD
(
√wfdnum
);

186 
ova
 = 
	`fd2d©a
(
ﬁdfd
);

187 
nva
 = 
	`fd2d©a
(
√wfd
);

189 i‡((
uvpd
[
	`PDX
(
ova
)] & 
PTE_P
Ë&& (
uv±
[
	`PGNUM
(ova)] & PTE_P))

190 i‡((
r
 = 
	`sys_∑ge_m≠
(0, 
ova
, 0, 
nva
, 
uv±
[
	`PGNUM
(ova)] & 
PTE_SYSCALL
)) < 0)

191 
îr
;

192 i‡((
r
 = 
	`sys_∑ge_m≠
(0, 
ﬁdfd
, 0, 
√wfd
, 
uv±
[
	`PGNUM
(ﬁdfd)] & 
PTE_SYSCALL
)) < 0)

193 
îr
;

195  
√wfdnum
;

197 
îr
:

198 
	`sys_∑ge_unm≠
(0, 
√wfd
);

199 
	`sys_∑ge_unm≠
(0, 
nva
);

200  
r
;

201 
	}
}

203 
ssize_t


204 
	$ªad
(
fdnum
, *
buf
, 
size_t
 
n
)

206 
r
;

207 
Dev
 *
dev
;

208 
Fd
 *
fd
;

210 i‡((
r
 = 
	`fd_lookup
(
fdnum
, &
fd
)) < 0

211 || (
r
 = 
	`dev_lookup
(
fd
->
fd_dev_id
, &
dev
)) < 0)

212  
r
;

213 i‡((
fd
->
fd_omode
 & 
O_ACCMODE
Ë=
O_WRONLY
) {

214 
	`˝rötf
("[%08x]Ñód %d -- bad mode\n", 
thi£nv
->
ív_id
, 
fdnum
);

215  -
E_INVAL
;

217 i‡(!
dev
->
dev_ªad
)

218  -
E_NOT_SUPP
;

219  (*
dev
->
dev_ªad
)(
fd
, 
buf
, 
n
);

220 
	}
}

222 
ssize_t


223 
	$ªadn
(
fdnum
, *
buf
, 
size_t
 
n
)

225 
m
, 
tŸ
;

227 
tŸ
 = 0;ÅŸ < 
n
;ÅŸ +
m
) {

228 
m
 = 
	`ªad
(
fdnum
, (*)
buf
 + 
tŸ
, 
n
 -Åot);

229 i‡(
m
 < 0)

230  
m
;

231 i‡(
m
 == 0)

234  
tŸ
;

235 
	}
}

237 
ssize_t


238 
	$wrôe
(
fdnum
, c⁄° *
buf
, 
size_t
 
n
)

240 
r
;

241 
Dev
 *
dev
;

242 
Fd
 *
fd
;

244 i‡((
r
 = 
	`fd_lookup
(
fdnum
, &
fd
)) < 0

245 || (
r
 = 
	`dev_lookup
(
fd
->
fd_dev_id
, &
dev
)) < 0)

246  
r
;

247 i‡((
fd
->
fd_omode
 & 
O_ACCMODE
Ë=
O_RDONLY
) {

248 
	`˝rötf
("[%08x] wrôê%d -- bad mode\n", 
thi£nv
->
ív_id
, 
fdnum
);

249  -
E_INVAL
;

251 i‡(
debug
)

252 
	`˝rötf
("write %d %p %d via dev %s\n",

253 
fdnum
, 
buf
, 
n
, 
dev
->
dev_«me
);

254 i‡(!
dev
->
dev_wrôe
)

255  -
E_NOT_SUPP
;

256  (*
dev
->
dev_wrôe
)(
fd
, 
buf
, 
n
);

257 
	}
}

260 
	$£ek
(
fdnum
, 
off_t
 
off£t
)

262 
r
;

263 
Fd
 *
fd
;

265 i‡((
r
 = 
	`fd_lookup
(
fdnum
, &
fd
)) < 0)

266  
r
;

267 
fd
->
fd_off£t
 = 
off£t
;

269 
	}
}

272 
	$·runˇã
(
fdnum
, 
off_t
 
√wsize
)

274 
r
;

275 
Dev
 *
dev
;

276 
Fd
 *
fd
;

277 i‡((
r
 = 
	`fd_lookup
(
fdnum
, &
fd
)) < 0

278 || (
r
 = 
	`dev_lookup
(
fd
->
fd_dev_id
, &
dev
)) < 0)

279  
r
;

280 i‡((
fd
->
fd_omode
 & 
O_ACCMODE
Ë=
O_RDONLY
) {

281 
	`˝rötf
("[%08x] ftruncate %d -- bad mode\n",

282 
thi£nv
->
ív_id
, 
fdnum
);

283  -
E_INVAL
;

285 i‡(!
dev
->
dev_åunc
)

286  -
E_NOT_SUPP
;

287  (*
dev
->
dev_åunc
)(
fd
, 
√wsize
);

288 
	}
}

291 
	$f°©
(
fdnum
, 
Sèt
 *
°©
)

293 
r
;

294 
Dev
 *
dev
;

295 
Fd
 *
fd
;

297 i‡((
r
 = 
	`fd_lookup
(
fdnum
, &
fd
)) < 0

298 || (
r
 = 
	`dev_lookup
(
fd
->
fd_dev_id
, &
dev
)) < 0)

299  
r
;

300 i‡(!
dev
->
dev_°©
)

301  -
E_NOT_SUPP
;

302 
°©
->
°_«me
[0] = 0;

303 
°©
->
°_size
 = 0;

304 
°©
->
°_isdú
 = 0;

305 
°©
->
°_dev
 = 
dev
;

306  (*
dev
->
dev_°©
)(
fd
, 
°©
);

307 
	}
}

310 
	$°©
(c⁄° *
∑th
, 
Sèt
 *
°©
)

312 
fd
, 
r
;

314 i‡((
fd
 = 
	`›í
(
∑th
, 
O_RDONLY
)) < 0)

315  
fd
;

316 
r
 = 
	`f°©
(
fd
, 
°©
);

317 
	`˛o£
(
fd
);

318  
r
;

319 
	}
}

	@lib/file.c

1 
	~<öc/fs.h
>

2 
	~<öc/°rög.h
>

3 
	~<öc/lib.h
>

5 
	#debug
 0

	)

7 
Fsùc
 
fsùcbuf
 
__©åibuã__
((
Æig√d
(
PGSIZE
)));

16 
	$fsùc
(
ty≥
, *
d°va
)

18 
ívid_t
 
f£nv
;

19 i‡(
f£nv
 == 0)

20 
f£nv
 = 
	`ùc_föd_ív
(
ENV_TYPE_FS
);

22 
	`°©ic_as£π
((
fsùcbuf
Ë=
PGSIZE
);

24 i‡(
debug
)

25 
	`˝rötf
("[%08x] fsù¯%d %08x\n", 
thi£nv
->
ív_id
, 
ty≥
, *(
uöt32_t
 *)&
fsùcbuf
);

27 
	`ùc_£nd
(
f£nv
, 
ty≥
, &
fsùcbuf
, 
PTE_P
 | 
PTE_W
 | 
PTE_U
);

28  
	`ùc_ªcv
(
NULL
, 
d°va
, NULL);

29 
	}
}

31 
devfûe_Êush
(
Fd
 *
fd
);

32 
ssize_t
 
devfûe_ªad
(
Fd
 *
fd
, *
buf
, 
size_t
 
n
);

33 
ssize_t
 
devfûe_wrôe
(
Fd
 *
fd
, c⁄° *
buf
, 
size_t
 
n
);

34 
devfûe_°©
(
Fd
 *
fd
, 
Sèt
 *
°©
);

35 
devfûe_åunc
(
Fd
 *
fd
, 
off_t
 
√wsize
);

37 
Dev
 
	gdevfûe
 =

39 .
dev_id
 = 'f',

40 .
	gdev_«me
 = "file",

41 .
	gdev_ªad
 = 
devfûe_ªad
,

42 .
	gdev_˛o£
 = 
devfûe_Êush
,

43 .
	gdev_°©
 = 
devfûe_°©
,

44 .
	gdev_wrôe
 = 
devfûe_wrôe
,

45 .
	gdev_åunc
 = 
devfûe_åunc


55 
	$›í
(c⁄° *
∑th
, 
mode
)

71 
r
;

72 
Fd
 *
fd
;

74 i‡(
	`°æí
(
∑th
Ë>
MAXPATHLEN
)

75  -
E_BAD_PATH
;

77 i‡((
r
 = 
	`fd_Æloc
(&
fd
)) < 0)

78  
r
;

80 
	`°r˝y
(
fsùcbuf
.
›í
.
ªq_∑th
, 
∑th
);

81 
fsùcbuf
.
›í
.
ªq_omode
 = 
mode
;

83 i‡((
r
 = 
	`fsùc
(
FSREQ_OPEN
, 
fd
)) < 0) {

84 
	`fd_˛o£
(
fd
, 0);

85  
r
;

88  
	`fd2num
(
fd
);

89 
	}
}

100 
	$devfûe_Êush
(
Fd
 *
fd
)

102 
fsùcbuf
.
Êush
.
ªq_fûeid
 = 
fd
->
fd_fûe
.
id
;

103  
	`fsùc
(
FSREQ_FLUSH
, 
NULL
);

104 
	}
}

111 
ssize_t


112 
	$devfûe_ªad
(
Fd
 *
fd
, *
buf
, 
size_t
 
n
)

118 
r
;

120 
fsùcbuf
.
ªad
.
ªq_fûeid
 = 
fd
->
fd_fûe
.
id
;

121 
fsùcbuf
.
ªad
.
ªq_n
 = 
n
;

122 i‡((
r
 = 
	`fsùc
(
FSREQ_READ
, 
NULL
)) < 0)

123  
r
;

124 
	`as£π
(
r
 <
n
);

125 
	`as£π
(
r
 <
PGSIZE
);

126 
	`memmove
(
buf
, 
fsùcbuf
.
ªadRë
.
ªt_buf
, 
r
);

127  
r
;

128 
	}
}

136 
ssize_t


137 
	$devfûe_wrôe
(
Fd
 *
fd
, c⁄° *
buf
, 
size_t
 
n
)

144 
	`∑nic
("devfile_writeÇot implemented");

145 
	}
}

148 
	$devfûe_°©
(
Fd
 *
fd
, 
Sèt
 *
°
)

150 
r
;

152 
fsùcbuf
.
°©
.
ªq_fûeid
 = 
fd
->
fd_fûe
.
id
;

153 i‡((
r
 = 
	`fsùc
(
FSREQ_STAT
, 
NULL
)) < 0)

154  
r
;

155 
	`°r˝y
(
°
->
°_«me
, 
fsùcbuf
.
°©Rë
.
ªt_«me
);

156 
°
->
°_size
 = 
fsùcbuf
.
°©Rë
.
ªt_size
;

157 
°
->
°_isdú
 = 
fsùcbuf
.
°©Rë
.
ªt_isdú
;

159 
	}
}

163 
	$devfûe_åunc
(
Fd
 *
fd
, 
off_t
 
√wsize
)

165 
fsùcbuf
.
£t_size
.
ªq_fûeid
 = 
fd
->
fd_fûe
.
id
;

166 
fsùcbuf
.
£t_size
.
ªq_size
 = 
√wsize
;

167  
	`fsùc
(
FSREQ_SET_SIZE
, 
NULL
);

168 
	}
}

173 
	$sync
()

178  
	`fsùc
(
FSREQ_SYNC
, 
NULL
);

179 
	}
}

	@lib/fork.c

3 
	~<öc/°rög.h
>

4 
	~<öc/lib.h
>

8 
	#PTE_COW
 0x800

	)

15 
	$pgÁu…
(
UTøp‰ame
 *
utf
)

17 *
addr
 = (*Ë
utf
->
utf_Áu…_va
;

18 
uöt32_t
 
îr
 = 
utf
->
utf_îr
;

19 
r
;

20 
ívid_t
 
ívid
;

29 if(!((
îr
 & 
FEC_WR
Ë&& (
uv±
[
	`PGNUM
(
addr
)] & 
PTE_COW
Ë&& (uv±[PGNUM◊ddr)] & 
PTE_P
Ë&& (
uvpd
[
	`PDX
(addr)] & PTE_P))){

30 
	`∑nic
("pgfault:not writtable orÇot cowÖages\n");

40 
ívid
 = 
	`sys_gëívid
();

42 if((
r
 = 
	`sys_∑ge_Æloc
(
ívid
, 
PFTEMP
, 
PTE_U
|
PTE_W
|
PTE_P
)) < 0){

43 
	`∑nic
("pgÁu…:sys_∑ge_Æloc: %ê\n", 
r
);

46 
addr
 = 
	`ROUNDDOWN
◊ddr, 
PGSIZE
);

47 
	`memmove
(
PFTEMP
, 
addr
, 
PGSIZE
);

49 if((
r
 = 
	`sys_∑ge_unm≠
(
ívid
, 
addr
)) < 0){

50 
	`∑nic
("pgÁu…:sys_∑ge_unm≠: %ê\n", 
r
);

52 if((
r
 = 
	`sys_∑ge_m≠
(
ívid
, 
PFTEMP
,Énvid, 
addr
, 
PTE_U
|
PTE_W
|
PTE_P
)) < 0){

53 
	`∑nic
("pgÁu…:sys_∑ga_m≠: %ê\n", 
r
);

55 if((
r
 = 
	`sys_∑ge_unm≠
(
ívid
, 
PFTEMP
)) < 0){

56 
	`∑nic
("pgÁu…:sys_∑ge_unm≠: %ê\n", 
r
);

59 
	}
}

73 
	$duµage
(
ívid_t
 
ívid
, 
≤
)

75 
r
;

78 *
addr
;

79 
≥rm
;

81 
addr
 = (*)((
uöt32_t
)
≤
 * 
PGSIZE
);

82 
≥rm
 = 
PTE_P
|
PTE_U
;

84 if((
uv±
[
≤
] & 
PTE_W
Ë|| (uv±[≤] & 
PTE_COW
)){

85 
≥rm
 |
PTE_COW
;

89 if((
r
 = 
	`sys_∑ge_m≠
(0, 
addr
, 
ívid
,áddr, 
≥rm
)) < 0){

90 
	`∑nic
("sys_∑ge_m≠: %ê\n", 
r
);

94 if(
≥rm
 & 
PTE_COW
){

95 if((
r
 = 
	`sys_∑ge_m≠
(0, 
addr
, 0,áddr, 
≥rm
)) < 0){

96 
	`∑nic
("sys_∑ge_m≠ : %ê\n", 
r
);

102 
	}
}

120 
ívid_t


121 
	$f‹k
()

124 
ívid_t
 
ívid
;

125 
ª
;

126 
uöt8_t
 *
addr
;

127 
	`_pgÁu…_upˇŒ
();

129 
	`£t_pgÁu…_h™dÀr
(
pgÁu…
);

130 
ívid
 = 
	`sys_exof‹k
();

132 if(
ívid
 < 0){

133 
	`∑nic
("sys_exof‹k: %e", 
ívid
);

136 if(
ívid
 == 0){

138 
thi£nv
 = &
ívs
[
	`ENVX
(
	`sys_gëívid
())];

145 
addr
 = (
uöt8_t
 *)
UTEXT
;ádd∏< (uöt8_à*)(
UXSTACKTOP
 - 
PGSIZE
);áddr += PGSIZE){

146 if((
uvpd
[
	`PDX
(
addr
)]&
PTE_P
Ë&& (
uv±
[
	`PGNUM
(addr)]&PTE_P)){

147 
	`duµage
(
ívid
, 
	`PGNUM
(
addr
));

152 if((
ª
 = 
	`sys_∑ge_Æloc
(
ívid
, (*)(
UXSTACKTOP
 - 
PGSIZE
), 
PTE_P
|
PTE_U
|
PTE_W
)) < 0){

153 
	`∑nic
("sys_∑ge_Æloc: %ê\n", 
ª
);

155 if((
ª
 = 
	`sys_∑ge_m≠
(
ívid
, (*)(
UXSTACKTOP
 - 
PGSIZE
), 0, 
UTEMP
, 
PTE_P
|
PTE_U
|
PTE_W
)) < 0){

156 
	`∑nic
("sys_∑ge_m≠: %ê\n", 
ª
);

158 
	`memmove
(
UTEMP
, (*)(
UXSTACKTOP
 -
PGSIZE
), PGSIZE);

159 if((
ª
 = 
	`sys_∑ge_unm≠
(0, 
UTEMP
)) < 0){

160 
	`∑nic
("sys_∑ge_unm≠: %ê\n", 
ª
);

165 
	`sys_ív_£t_pgÁu…_upˇŒ
(
ívid
, 
_pgÁu…_upˇŒ
);

168 if((
ª
 = 
	`sys_ív_£t_°©us
(
ívid
, 
ENV_RUNNABLE
))){

169 
	`∑nic
("sys_ív_£t_°©us: %e", 
ª
);

171  
ívid
;

173 
	}
}

177 
	$sf‹k
()

179 
	`∑nic
("sforkÇot implemented");

180  -
E_INVAL
;

181 
	}
}

	@lib/fprintf.c

1 
	~<öc/lib.h
>

8 
	s¥ötbuf
 {

9 
	mfd
;

10 
	midx
;

11 
ssize_t
 
	mªsu…
;

12 
	mîr‹
;

13 
	mbuf
[256];

18 
	$wrôebuf
(
¥ötbuf
 *
b
)

20 i‡(
b
->
îr‹
 > 0) {

21 
ssize_t
 
ªsu…
 = 
	`wrôe
(
b
->
fd
, b->
buf
, b->
idx
);

22 i‡(
ªsu…
 > 0)

23 
b
->
ªsu…
 +=Ñesult;

24 i‡(
ªsu…
 !
b
->
idx
)

25 
b
->
îr‹
 = (
ªsu…
 < 0 ?Ñesult : 0);

27 
	}
}

30 
	$putch
(
ch
, *
thunk
)

32 
¥ötbuf
 *
b
 = (¥ötbu‡*Ë
thunk
;

33 
b
->
buf
[b->
idx
++] = 
ch
;

34 i‡(
b
->
idx
 == 256) {

35 
	`wrôebuf
(
b
);

36 
b
->
idx
 = 0;

38 
	}
}

41 
	$vÂrötf
(
fd
, c⁄° *
fmt
, 
va_li°
 
≠
)

43 
¥ötbuf
 
b
;

45 
b
.
fd
 = fd;

46 
b
.
idx
 = 0;

47 
b
.
ªsu…
 = 0;

48 
b
.
îr‹
 = 1;

49 
	`v¥ötfmt
(
putch
, &
b
, 
fmt
, 
≠
);

50 i‡(
b
.
idx
 > 0)

51 
	`wrôebuf
(&
b
);

53  (
b
.
ªsu…
 ? b.ªsu… : b.
îr‹
);

54 
	}
}

57 
	$Ârötf
(
fd
, c⁄° *
fmt
, ...)

59 
va_li°
 
≠
;

60 
˙t
;

62 
	`va_°¨t
(
≠
, 
fmt
);

63 
˙t
 = 
	`vÂrötf
(
fd
, 
fmt
, 
≠
);

64 
	`va_íd
(
≠
);

66  
˙t
;

67 
	}
}

70 
	$¥ötf
(c⁄° *
fmt
, ...)

72 
va_li°
 
≠
;

73 
˙t
;

75 
	`va_°¨t
(
≠
, 
fmt
);

76 
˙t
 = 
	`vÂrötf
(1, 
fmt
, 
≠
);

77 
	`va_íd
(
≠
);

79  
˙t
;

80 
	}
}

	@lib/ipc.c

3 
	~<öc/lib.h
>

22 
öt32_t


23 
	$ùc_ªcv
(
ívid_t
 *
‰om_ív_°‹e
, *
pg
, *
≥rm_°‹e
)

26 
ª
;

27 
ív_‰om
;

28 
ív_≥rm
;

30 if(
pg
 =
NULL
){

31 
pg
 = (*)
UTOP
;

34 if(!(
ª
 = 
	`sys_ùc_ªcv
(
pg
))){

35 
ív_‰om
 = 
thi£nv
->
ív_ùc_‰om
;

36 
ív_≥rm
 = 
thi£nv
->
ív_ùc_≥rm
;

37 
ª
 = 
thi£nv
->
ív_ùc_vÆue
;

39 
ív_‰om
 = 0;

40 
ív_≥rm
 = 0;

43 if(
‰om_ív_°‹e
){

44 *
‰om_ív_°‹e
 = 
ív_‰om
;

46 if(
≥rm_°‹e
){

47 *
≥rm_°‹e
 = 
ív_≥rm
;

50  
ª
;

53 
	}
}

64 
	$ùc_£nd
(
ívid_t
 
to_ív
, 
uöt32_t
 
vÆ
, *
pg
, 
≥rm
)

67 
ª
;

69 if(
pg
 =
NULL
){

70 
pg
 = (*)
UTOP
;

73 
ª
 = 
	`sys_ùc_åy_£nd
(
to_ív
, 
vÆ
, 
pg
, 
≥rm
);

74 if(
ª
 =-
E_IPC_NOT_RECV
){

75 
	`sys_yõld
();

76 }if(
ª
 == 0){

79 
	`∑nic
("ùc_£nd: %e", 
ª
);

84 
	}
}

89 
ívid_t


90 
	$ùc_föd_ív
(
EnvTy≥
 
ty≥
)

92 
i
;

93 
i
 = 0; i < 
NENV
; i++)

94 i‡(
ívs
[
i
].
ív_ty≥
 =
ty≥
)

95  
ívs
[
i
].
ív_id
;

97 
	}
}

	@lib/libmain.c

4 
	~<öc/lib.h
>

6 
umaö
(
¨gc
, **
¨gv
);

8 c⁄° vﬁ©ûê
Env
 *
	gthi£nv
;

9 c⁄° *
	gbö¨y«me
 = "<unknown>";

12 
	$libmaö
(
¨gc
, **
¨gv
)

16 
thi£nv
 = &
ívs
[
	`ENVX
(
	`sys_gëívid
())];

19 i‡(
¨gc
 > 0)

20 
bö¨y«me
 = 
¨gv
[0];

23 
	`umaö
(
¨gc
, 
¨gv
);

26 
	`exô
();

27 
	}
}

	@lib/pageref.c

1 
	~<öc/lib.h
>

4 
	$∑gîef
(*
v
)

6 
±e_t
 
±e
;

8 i‡(!(
uvpd
[
	`PDX
(
v
)] & 
PTE_P
))

10 
±e
 = 
uv±
[
	`PGNUM
(
v
)];

11 i‡(!(
±e
 & 
PTE_P
))

13  
∑ges
[
	`PGNUM
(
±e
)].
µ_ªf
;

14 
	}
}

	@lib/panic.c

2 
	~<öc/lib.h
>

10 
	$_∑nic
(c⁄° *
fûe
, 
löe
, c⁄° *
fmt
, ...)

12 
va_li°
 
≠
;

14 
	`va_°¨t
(
≠
, 
fmt
);

17 
	`˝rötf
("[%08x] userÖanic in %sát %s:%d: ",

18 
	`sys_gëívid
(), 
bö¨y«me
, 
fûe
, 
löe
);

19 
	`v˝rötf
(
fmt
, 
≠
);

20 
	`˝rötf
("\n");

24 
asm
 volatile("int3");

25 
	}
}

	@lib/pgfault.c

7 
	~<öc/lib.h
>

11 
_pgÁu…_upˇŒ
();

14 (*
_pgÁu…_h™dÀr
)(
UTøp‰ame
 *
utf
);

25 
	$£t_pgÁu…_h™dÀr
((*
h™dÀr
)(
UTøp‰ame
 *
utf
))

27 
r
;

29 i‡(
_pgÁu…_h™dÀr
 == 0) {

32 if(!(
r
 = 
	`sys_∑ge_Æloc
(
thi£nv
->
ív_id
, (*)(
UXSTACKTOP
-
PGSIZE
), 
PTE_U
 | 
PTE_W
 | 
PTE_P
))){

33 
	`sys_ív_£t_pgÁu…_upˇŒ
(
thi£nv
->
ív_id
, 
_pgÁu…_upˇŒ
);

35 
	`∑nic
("set_pgfault_handlerÇot implemented");

41 
_pgÁu…_h™dÀr
 = 
h™dÀr
;

42 
	}
}

	@lib/pipe.c

1 
	~<öc/lib.h
>

3 
	#debug
 0

	)

5 
ssize_t
 
devpùe_ªad
(
Fd
 *
fd
, *
buf
, 
size_t
 
n
);

6 
ssize_t
 
devpùe_wrôe
(
Fd
 *
fd
, c⁄° *
buf
, 
size_t
 
n
);

7 
devpùe_°©
(
Fd
 *
fd
, 
Sèt
 *
°©
);

8 
devpùe_˛o£
(
Fd
 *
fd
);

10 
Dev
 
	gdevpùe
 =

12 .
dev_id
 = 'p',

13 .
	gdev_«me
 = "pipe",

14 .
	gdev_ªad
 = 
devpùe_ªad
,

15 .
	gdev_wrôe
 = 
devpùe_wrôe
,

16 .
	gdev_˛o£
 = 
devpùe_˛o£
,

17 .
	gdev_°©
 = 
devpùe_°©
,

20 
	#PIPEBUFSIZ
 32

21 

	)

22 
	sPùe
 {

23 
off_t
 
	mp_Ωos
;

24 
off_t
 
	mp_wpos
;

25 
uöt8_t
 
	mp_buf
[
PIPEBUFSIZ
];

29 
	$pùe
(
pfd
[2])

31 
r
;

32 
Fd
 *
fd0
, *
fd1
;

33 *
va
;

36 i‡((
r
 = 
	`fd_Æloc
(&
fd0
)) < 0

37 || (
r
 = 
	`sys_∑ge_Æloc
(0, 
fd0
, 
PTE_P
|
PTE_W
|
PTE_U
|
PTE_SHARE
)) < 0)

38 
îr
;

40 i‡((
r
 = 
	`fd_Æloc
(&
fd1
)) < 0

41 || (
r
 = 
	`sys_∑ge_Æloc
(0, 
fd1
, 
PTE_P
|
PTE_W
|
PTE_U
|
PTE_SHARE
)) < 0)

42 
îr1
;

45 
va
 = 
	`fd2d©a
(
fd0
);

46 i‡((
r
 = 
	`sys_∑ge_Æloc
(0, 
va
, 
PTE_P
|
PTE_W
|
PTE_U
|
PTE_SHARE
)) < 0)

47 
îr2
;

48 i‡((
r
 = 
	`sys_∑ge_m≠
(0, 
va
, 0, 
	`fd2d©a
(
fd1
), 
PTE_P
|
PTE_W
|
PTE_U
|
PTE_SHARE
)) < 0)

49 
îr3
;

52 
fd0
->
fd_dev_id
 = 
devpùe
.
dev_id
;

53 
fd0
->
fd_omode
 = 
O_RDONLY
;

55 
fd1
->
fd_dev_id
 = 
devpùe
.
dev_id
;

56 
fd1
->
fd_omode
 = 
O_WRONLY
;

58 i‡(
debug
)

59 
	`˝rötf
("[%08x]Öùe¸óã %08x\n", 
thi£nv
->
ív_id
, 
uv±
[
	`PGNUM
(
va
)]);

61 
pfd
[0] = 
	`fd2num
(
fd0
);

62 
pfd
[1] = 
	`fd2num
(
fd1
);

65 
îr3
:

66 
	`sys_∑ge_unm≠
(0, 
va
);

67 
îr2
:

68 
	`sys_∑ge_unm≠
(0, 
fd1
);

69 
îr1
:

70 
	`sys_∑ge_unm≠
(0, 
fd0
);

71 
îr
:

72  
r
;

73 
	}
}

76 
	$_pùeis˛o£d
(
Fd
 *
fd
, 
Pùe
 *
p
)

78 
n
, 
¬
, 
ªt
;

81 
n
 = 
thi£nv
->
ív_runs
;

82 
ªt
 = 
	`∑gîef
(
fd
Ë=∑gîef(
p
);

83 
¬
 = 
thi£nv
->
ív_runs
;

84 i‡(
n
 =
¬
)

85  
ªt
;

86 i‡(
n
 !
¬
 && 
ªt
 == 1)

87 
	`˝rötf
("pùêø˚ávoided\n", 
n
, 
thi£nv
->
ív_runs
, 
ªt
);

89 
	}
}

92 
	$pùeis˛o£d
(
fdnum
)

94 
Fd
 *
fd
;

95 
Pùe
 *
p
;

96 
r
;

98 i‡((
r
 = 
	`fd_lookup
(
fdnum
, &
fd
)) < 0)

99  
r
;

100 
p
 = (
Pùe
*Ë
	`fd2d©a
(
fd
);

101  
	`_pùeis˛o£d
(
fd
, 
p
);

102 
	}
}

104 
ssize_t


105 
	$devpùe_ªad
(
Fd
 *
fd
, *
vbuf
, 
size_t
 
n
)

107 
uöt8_t
 *
buf
;

108 
size_t
 
i
;

109 
Pùe
 *
p
;

111 
p
 = (
Pùe
*)
	`fd2d©a
(
fd
);

112 i‡(
debug
)

113 
	`˝rötf
("[%08x] devpipe_read %08x %dÑpos %d wpos %d\n",

114 
thi£nv
->
ív_id
, 
uv±
[
	`PGNUM
(
p
)], 
n
,Ö->
p_Ωos
,Ö->
p_wpos
);

116 
buf
 = 
vbuf
;

117 
i
 = 0; i < 
n
; i++) {

118 
p
->
p_Ωos
 =p->
p_wpos
) {

121 i‡(
i
 > 0)

122  
i
;

124 i‡(
	`_pùeis˛o£d
(
fd
, 
p
))

127 i‡(
debug
)

128 
	`˝rötf
("devpipe_read yield\n");

129 
	`sys_yõld
();

133 
buf
[
i
] = 
p
->
p_buf
[p->
p_Ωos
 % 
PIPEBUFSIZ
];

134 
p
->
p_Ωos
++;

136  
i
;

137 
	}
}

139 
ssize_t


140 
	$devpùe_wrôe
(
Fd
 *
fd
, c⁄° *
vbuf
, 
size_t
 
n
)

142 c⁄° 
uöt8_t
 *
buf
;

143 
size_t
 
i
;

144 
Pùe
 *
p
;

146 
p
 = (
Pùe
*Ë
	`fd2d©a
(
fd
);

147 i‡(
debug
)

148 
	`˝rötf
("[%08x] devpipe_write %08x %dÑpos %d wpos %d\n",

149 
thi£nv
->
ív_id
, 
uv±
[
	`PGNUM
(
p
)], 
n
,Ö->
p_Ωos
,Ö->
p_wpos
);

151 
buf
 = 
vbuf
;

152 
i
 = 0; i < 
n
; i++) {

153 
p
->
p_wpos
 >p->
p_Ωos
 + ’->
p_buf
)) {

158 i‡(
	`_pùeis˛o£d
(
fd
, 
p
))

161 i‡(
debug
)

162 
	`˝rötf
("devpipe_write yield\n");

163 
	`sys_yõld
();

167 
p
->
p_buf
[p->
p_wpos
 % 
PIPEBUFSIZ
] = 
buf
[
i
];

168 
p
->
p_wpos
++;

171  
i
;

172 
	}
}

175 
	$devpùe_°©
(
Fd
 *
fd
, 
Sèt
 *
°©
)

177 
Pùe
 *
p
 = (Pùe*Ë
	`fd2d©a
(
fd
);

178 
	`°r˝y
(
°©
->
°_«me
, "<pipe>");

179 
°©
->
°_size
 = 
p
->
p_wpos
 -Ö->
p_Ωos
;

180 
°©
->
°_isdú
 = 0;

181 
°©
->
°_dev
 = &
devpùe
;

183 
	}
}

186 
	$devpùe_˛o£
(
Fd
 *
fd
)

188 (Ë
	`sys_∑ge_unm≠
(0, 
fd
);

189  
	`sys_∑ge_unm≠
(0, 
	`fd2d©a
(
fd
));

190 
	}
}

	@lib/printf.c

8 
	~<öc/ty≥s.h
>

9 
	~<öc/°dio.h
>

10 
	~<öc/°d¨g.h
>

11 
	~<öc/lib.h
>

19 
	s¥ötbuf
 {

20 
	midx
;

21 
	m˙t
;

22 
	mbuf
[256];

27 
	$putch
(
ch
, 
¥ötbuf
 *
b
)

29 
b
->
buf
[b->
idx
++] = 
ch
;

30 i‡(
b
->
idx
 == 256-1) {

31 
	`sys_˝uts
(
b
->
buf
, b->
idx
);

32 
b
->
idx
 = 0;

34 
b
->
˙t
++;

35 
	}
}

38 
	$v˝rötf
(c⁄° *
fmt
, 
va_li°
 
≠
)

40 
¥ötbuf
 
b
;

42 
b
.
idx
 = 0;

43 
b
.
˙t
 = 0;

44 
	`v¥ötfmt
((*)
putch
, &
b
, 
fmt
, 
≠
);

45 
	`sys_˝uts
(
b
.
buf
, b.
idx
);

47  
b
.
˙t
;

48 
	}
}

51 
	$˝rötf
(c⁄° *
fmt
, ...)

53 
va_li°
 
≠
;

54 
˙t
;

56 
	`va_°¨t
(
≠
, 
fmt
);

57 
˙t
 = 
	`v˝rötf
(
fmt
, 
≠
);

58 
	`va_íd
(
≠
);

60  
˙t
;

61 
	}
}

	@lib/printfmt.c

5 
	~<öc/ty≥s.h
>

6 
	~<öc/°dio.h
>

7 
	~<öc/°rög.h
>

8 
	~<öc/°d¨g.h
>

9 
	~<öc/îr‹.h
>

21 c⁄° * c⁄° 
	gîr‹_°rög
[
MAXERROR
] =

23 [
E_UNSPECIFIED
] = "unspecifiedÉrror",

24 [
E_BAD_ENV
] = "badÉnvironment",

25 [
E_INVAL
] = "invalidÖarameter",

26 [
E_NO_MEM
] = "out of memory",

27 [
E_NO_FREE_ENV
] = "out ofÉnvironments",

28 [
E_FAULT
] = "segmentation fault",

29 [
E_IPC_NOT_RECV
]= "env isÇotÑecving",

30 [
E_EOF
] = "unexpectedÉnd of file",

31 [
E_NO_DISK
] = "no free space on disk",

32 [
E_MAX_OPEN
] = "too many filesáre open",

33 [
E_NOT_FOUND
] = "file or blockÇot found",

34 [
E_BAD_PATH
] = "invalidÖath",

35 [
E_FILE_EXISTS
] = "fileálreadyÉxists",

36 [
E_NOT_EXEC
] = "file isÇotá validÉxecutable",

37 [
E_NOT_SUPP
] = "operationÇot supported",

45 
	$¥öäum
((*
putch
)(, *), *
putd©
,

46 
num
, 
ba£
, 
width
, 
∑dc
)

49 i‡(
num
 >
ba£
) {

50 
	`¥öäum
(
putch
, 
putd©
, 
num
 / 
ba£
, ba£, 
width
 - 1, 
∑dc
);

53 --
width
 > 0)

54 
	`putch
(
∑dc
, 
putd©
);

58 
	`putch
("0123456789abcdef"[
num
 % 
ba£
], 
putd©
);

59 
	}
}

64 
	$gëuöt
(
va_li°
 *
≠
, 
lÊag
)

66 i‡(
lÊag
 >= 2)

67  
	`va_¨g
(*
≠
, );

68 i‡(
lÊag
)

69  
	`va_¨g
(*
≠
, );

71  
	`va_¨g
(*
≠
, );

72 
	}
}

77 
	$gëöt
(
va_li°
 *
≠
, 
lÊag
)

79 i‡(
lÊag
 >= 2)

80  
	`va_¨g
(*
≠
, );

81 i‡(
lÊag
)

82  
	`va_¨g
(*
≠
, );

84  
	`va_¨g
(*
≠
, );

85 
	}
}

89 
¥ötfmt
((*
putch
)(, *), *
putd©
, c⁄° *
fmt
, ...);

92 
	$v¥ötfmt
((*
putch
)(, *), *
putd©
, c⁄° *
fmt
, 
va_li°
 
≠
)

94 c⁄° *
p
;

95 
ch
, 
îr
;

96 
num
;

97 
ba£
, 
lÊag
, 
width
, 
¥ecisi⁄
, 
ÆtÊag
;

98 
∑dc
;

101 (
ch
 = *(*Ë
fmt
++) != '%') {

102 i‡(
ch
 == '\0')

104 
	`putch
(
ch
, 
putd©
);

108 
∑dc
 = ' ';

109 
width
 = -1;

110 
¥ecisi⁄
 = -1;

111 
lÊag
 = 0;

112 
ÆtÊag
 = 0;

113 
ªswôch
:

114 
ch
 = *(*Ë
fmt
++) {

118 
∑dc
 = '-';

119 
ªswôch
;

123 
∑dc
 = '0';

124 
ªswôch
;

136 
¥ecisi⁄
 = 0; ; ++
fmt
) {

137 
¥ecisi⁄
 =Öªcisi⁄ * 10 + 
ch
 - '0';

138 
ch
 = *
fmt
;

139 i‡(
ch
 < '0' || ch > '9')

142 
¥o˚ss_¥ecisi⁄
;

145 
¥ecisi⁄
 = 
	`va_¨g
(
≠
, );

146 
¥o˚ss_¥ecisi⁄
;

149 i‡(
width
 < 0)

150 
width
 = 0;

151 
ªswôch
;

154 
ÆtÊag
 = 1;

155 
ªswôch
;

157 
¥o˚ss_¥ecisi⁄
:

158 i‡(
width
 < 0)

159 
width
 = 
¥ecisi⁄
,Örecision = -1;

160 
ªswôch
;

164 
lÊag
++;

165 
ªswôch
;

169 
	`putch
(
	`va_¨g
(
≠
, ), 
putd©
);

174 
îr
 = 
	`va_¨g
(
≠
, );

175 i‡(
îr
 < 0)

176 
îr
 = -err;

177 i‡(
îr
 >
MAXERROR
 || (
p
 = 
îr‹_°rög
[îr]Ë=
NULL
)

178 
	`¥ötfmt
(
putch
, 
putd©
, "îr‹ %d", 
îr
);

180 
	`¥ötfmt
(
putch
, 
putd©
, "%s", 
p
);

185 i‡((
p
 = 
	`va_¨g
(
≠
, *)Ë=
NULL
)

186 
p
 = "(null)";

187 i‡(
width
 > 0 && 
∑dc
 != '-')

188 
width
 -
	`°∫Àn
(
p
, 
¥ecisi⁄
); width > 0; width--)

189 
	`putch
(
∑dc
, 
putd©
);

190 ; (
ch
 = *
p
++Ë!'\0' && (
¥ecisi⁄
 < 0 || --¥ecisi⁄ >0); 
width
--)

191 i‡(
ÆtÊag
 && (
ch
 < ' ' || ch > '~'))

192 
	`putch
('?', 
putd©
);

194 
	`putch
(
ch
, 
putd©
);

195 ; 
width
 > 0; width--)

196 
	`putch
(' ', 
putd©
);

201 
num
 = 
	`gëöt
(&
≠
, 
lÊag
);

202 i‡((Ë
num
 < 0) {

203 
	`putch
('-', 
putd©
);

204 
num
 = -()Çum;

206 
ba£
 = 10;

207 
numbî
;

211 
num
 = 
	`gëuöt
(&
≠
, 
lÊag
);

212 
ba£
 = 10;

213 
numbî
;

223 
	`putch
('0', 
putd©
);

224 
num
 = 
	`gëuöt
(&
≠
, 
lÊag
);

225 
ba£
 = 8;

226 
numbî
;

231 
	`putch
('0', 
putd©
);

232 
	`putch
('x', 
putd©
);

233 
num
 = ()

234 (
uöçå_t
Ë
	`va_¨g
(
≠
, *);

235 
ba£
 = 16;

236 
numbî
;

240 
num
 = 
	`gëuöt
(&
≠
, 
lÊag
);

241 
ba£
 = 16;

242 
numbî
:

243 
	`¥öäum
(
putch
, 
putd©
, 
num
, 
ba£
, 
width
, 
∑dc
);

248 
	`putch
(
ch
, 
putd©
);

253 
	`putch
('%', 
putd©
);

254 
fmt
--; fmt[-1] != '%'; fmt--)

259 
	}
}

262 
	$¥ötfmt
((*
putch
)(, *), *
putd©
, c⁄° *
fmt
, ...)

264 
va_li°
 
≠
;

266 
	`va_°¨t
(
≠
, 
fmt
);

267 
	`v¥ötfmt
(
putch
, 
putd©
, 
fmt
, 
≠
);

268 
	`va_íd
(
≠
);

269 
	}
}

271 
	s•rötbuf
 {

272 *
	mbuf
;

273 *
	mebuf
;

274 
	m˙t
;

278 
	$•röçutch
(
ch
, 
•rötbuf
 *
b
)

280 
b
->
˙t
++;

281 i‡(
b
->
buf
 < b->
ebuf
)

282 *
b
->
buf
++ = 
ch
;

283 
	}
}

286 
	$v¢¥ötf
(*
buf
, 
n
, c⁄° *
fmt
, 
va_li°
 
≠
)

288 
•rötbuf
 
b
 = {
buf
, buf+
n
-1, 0};

290 i‡(
buf
 =
NULL
 || 
n
 < 1)

291  -
E_INVAL
;

294 
	`v¥ötfmt
((*)
•röçutch
, &
b
, 
fmt
, 
≠
);

297 *
b
.
buf
 = '\0';

299  
b
.
˙t
;

300 
	}
}

303 
	$¢¥ötf
(*
buf
, 
n
, c⁄° *
fmt
, ...)

305 
va_li°
 
≠
;

306 
rc
;

308 
	`va_°¨t
(
≠
, 
fmt
);

309 
rc
 = 
	`v¢¥ötf
(
buf
, 
n
, 
fmt
, 
≠
);

310 
	`va_íd
(
≠
);

312  
rc
;

313 
	}
}

	@lib/readline.c

1 
	~<öc/°dio.h
>

2 
	~<öc/îr‹.h
>

4 
	#BUFLEN
 1024

	)

5 
	gbuf
[
BUFLEN
];

8 
	$ªadlöe
(c⁄° *
¥om±
)

10 
i
, 
c
, 
echoög
;

12 #i‡
JOS_KERNEL


13 i‡(
¥om±
 !
NULL
)

14 
	`˝rötf
("%s", 
¥om±
);

16 i‡(
¥om±
 !
NULL
)

17 
	`Ârötf
(1, "%s", 
¥om±
);

20 
i
 = 0;

21 
echoög
 = 
	`isc⁄s
(0);

23 
c
 = 
	`gëch¨
();

24 i‡(
c
 < 0) {

25 i‡(
c
 !-
E_EOF
)

26 
	`˝rötf
("ªadÉº‹: %e\n", 
c
);

27  
NULL
;

28 } i‡((
c
 ='\b' || c ='\x7f'Ë&& 
i
 > 0) {

29 i‡(
echoög
)

30 
	`˝utch¨
('\b');

31 
i
--;

32 } i‡(
c
 >' ' && 
i
 < 
BUFLEN
-1) {

33 i‡(
echoög
)

34 
	`˝utch¨
(
c
);

35 
buf
[
i
++] = 
c
;

36 } i‡(
c
 == '\n' || c == '\r') {

37 i‡(
echoög
)

38 
	`˝utch¨
('\n');

39 
buf
[
i
] = 0;

40  
buf
;

43 
	}
}

	@lib/spawn.c

1 
	~<öc/lib.h
>

2 
	~<öc/ñf.h
>

4 
	#UTEMP2USTACK
(
addr
Ë((*Ë◊ddrË+ (
USTACKTOP
 - 
PGSIZE
Ë- 
UTEMP
)

	)

5 
	#UTEMP2
 (
UTEMP
 + 
PGSIZE
)

	)

6 
	#UTEMP3
 (
UTEMP2
 + 
PGSIZE
)

	)

9 
öô_°ack
(
ívid_t
 
chûd
, c⁄° **
¨gv
, 
uöçå_t
 *
öô_e•
);

10 
m≠_£gmít
(
ívid_t
 
chûd
, 
uöçå_t
 
va
, 
size_t
 
memsz
,

11 
fd
, 
size_t
 
fûesz
, 
off_t
 
fûeoff£t
, 
≥rm
);

12 
c›y_sh¨ed_∑ges
(
ívid_t
 
chûd
);

20 
	$•awn
(c⁄° *
¥og
, c⁄° **
¨gv
)

22 
ñf_buf
[512];

23 
Tøp‰ame
 
chûd_tf
;

24 
ívid_t
 
chûd
;

26 
fd
, 
i
, 
r
;

27 
Elf
 *
ñf
;

28 
Proghdr
 *
ph
;

29 
≥rm
;

88 i‡((
r
 = 
	`›í
(
¥og
, 
O_RDONLY
)) < 0)

89  
r
;

90 
fd
 = 
r
;

93 
ñf
 = (
Elf
*Ë
ñf_buf
;

94 i‡(
	`ªadn
(
fd
, 
ñf_buf
, (elf_buf)) != (elf_buf)

95 || 
ñf
->
e_magic
 !
ELF_MAGIC
) {

96 
	`˛o£
(
fd
);

97 
	`˝rötf
("ñ‡magi¯%08x w™à%08x\n", 
ñf
->
e_magic
, 
ELF_MAGIC
);

98  -
E_NOT_EXEC
;

102 i‡((
r
 = 
	`sys_exof‹k
()) < 0)

103  
r
;

104 
chûd
 = 
r
;

107 
chûd_tf
 = 
ívs
[
	`ENVX
(
chûd
)].
ív_tf
;

108 
chûd_tf
.
tf_eù
 = 
ñf
->
e_íåy
;

110 i‡((
r
 = 
	`öô_°ack
(
chûd
, 
¨gv
, &
chûd_tf
.
tf_e•
)) < 0)

111  
r
;

114 
ph
 = (
Proghdr
*Ë(
ñf_buf
 + 
ñf
->
e_phoff
);

115 
i
 = 0; i < 
ñf
->
e_phnum
; i++, 
ph
++) {

116 i‡(
ph
->
p_ty≥
 !
ELF_PROG_LOAD
)

118 
≥rm
 = 
PTE_P
 | 
PTE_U
;

119 i‡(
ph
->
p_Êags
 & 
ELF_PROG_FLAG_WRITE
)

120 
≥rm
 |
PTE_W
;

121 i‡((
r
 = 
	`m≠_£gmít
(
chûd
, 
ph
->
p_va
,Öh->
p_memsz
,

122 
fd
, 
ph
->
p_fûesz
,Öh->
p_off£t
, 
≥rm
)) < 0)

123 
îr‹
;

125 
	`˛o£
(
fd
);

126 
fd
 = -1;

129 i‡((
r
 = 
	`c›y_sh¨ed_∑ges
(
chûd
)) < 0)

130 
	`∑nic
("c›y_sh¨ed_∑ges: %e", 
r
);

132 
chûd_tf
.
tf_eÊags
 |
FL_IOPL_3
;

133 i‡((
r
 = 
	`sys_ív_£t_å≠‰ame
(
chûd
, &
chûd_tf
)) < 0)

134 
	`∑nic
("sys_ív_£t_å≠‰ame: %e", 
r
);

136 i‡((
r
 = 
	`sys_ív_£t_°©us
(
chûd
, 
ENV_RUNNABLE
)) < 0)

137 
	`∑nic
("sys_ív_£t_°©us: %e", 
r
);

139  
chûd
;

141 
îr‹
:

142 
	`sys_ív_de°roy
(
chûd
);

143 
	`˛o£
(
fd
);

144  
r
;

145 
	}
}

151 
	$•aw∆
(c⁄° *
¥og
, c⁄° *
¨g0
, ...)

157 
¨gc
=0;

158 
va_li°
 
vl
;

159 
	`va_°¨t
(
vl
, 
¨g0
);

160 
	`va_¨g
(
vl
, *Ë!
NULL
)

161 
¨gc
++;

162 
	`va_íd
(
vl
);

166 c⁄° *
¨gv
[
¨gc
+2];

167 
¨gv
[0] = 
¨g0
;

168 
¨gv
[
¨gc
+1] = 
NULL
;

170 
	`va_°¨t
(
vl
, 
¨g0
);

171 
i
;

172 
i
=0;i<
¨gc
;i++)

173 
¨gv
[
i
+1] = 
	`va_¨g
(
vl
, const *);

174 
	`va_íd
(
vl
);

175  
	`•awn
(
¥og
, 
¨gv
);

176 
	}
}

187 
	$öô_°ack
(
ívid_t
 
chûd
, c⁄° **
¨gv
, 
uöçå_t
 *
öô_e•
)

189 
size_t
 
°rög_size
;

190 
¨gc
, 
i
, 
r
;

191 *
°rög_°‹e
;

192 
uöçå_t
 *
¨gv_°‹e
;

196 
°rög_size
 = 0;

197 
¨gc
 = 0; 
¨gv
[argc] != 0;árgc++)

198 
°rög_size
 +
	`°æí
(
¨gv
[
¨gc
]) + 1;

205 
°rög_°‹e
 = (*Ë
UTEMP
 + 
PGSIZE
 - 
°rög_size
;

208 
¨gv_°‹e
 = (
uöçå_t
*Ë(
	`ROUNDDOWN
(
°rög_°‹e
, 4Ë- 4 * (
¨gc
 + 1));

212 i‡((*Ë(
¨gv_°‹e
 - 2Ë< (*Ë
UTEMP
)

213  -
E_NO_MEM
;

216 i‡((
r
 = 
	`sys_∑ge_Æloc
(0, (*Ë
UTEMP
, 
PTE_P
|
PTE_U
|
PTE_W
)) < 0)

217  
r
;

236 
i
 = 0; i < 
¨gc
; i++) {

237 
¨gv_°‹e
[
i
] = 
	`UTEMP2USTACK
(
°rög_°‹e
);

238 
	`°r˝y
(
°rög_°‹e
, 
¨gv
[
i
]);

239 
°rög_°‹e
 +
	`°æí
(
¨gv
[
i
]) + 1;

241 
¨gv_°‹e
[
¨gc
] = 0;

242 
	`as£π
(
°rög_°‹e
 =(*)
UTEMP
 + 
PGSIZE
);

244 
¨gv_°‹e
[-1] = 
	`UTEMP2USTACK
(argv_store);

245 
¨gv_°‹e
[-2] = 
¨gc
;

247 *
öô_e•
 = 
	`UTEMP2USTACK
(&
¨gv_°‹e
[-2]);

251 i‡((
r
 = 
	`sys_∑ge_m≠
(0, 
UTEMP
, 
chûd
, (*Ë(
USTACKTOP
 - 
PGSIZE
), 
PTE_P
 | 
PTE_U
 | 
PTE_W
)) < 0)

252 
îr‹
;

253 i‡((
r
 = 
	`sys_∑ge_unm≠
(0, 
UTEMP
)) < 0)

254 
îr‹
;

258 
îr‹
:

259 
	`sys_∑ge_unm≠
(0, 
UTEMP
);

260  
r
;

261 
	}
}

264 
	$m≠_£gmít
(
ívid_t
 
chûd
, 
uöçå_t
 
va
, 
size_t
 
memsz
,

265 
fd
, 
size_t
 
fûesz
, 
off_t
 
fûeoff£t
, 
≥rm
)

267 
i
, 
r
;

268 *
blk
;

272 i‡((
i
 = 
	`PGOFF
(
va
))) {

273 
va
 -
i
;

274 
memsz
 +
i
;

275 
fûesz
 +
i
;

276 
fûeoff£t
 -
i
;

279 
i
 = 0; i < 
memsz
; i +
PGSIZE
) {

280 i‡(
i
 >
fûesz
) {

282 i‡((
r
 = 
	`sys_∑ge_Æloc
(
chûd
, (*Ë(
va
 + 
i
), 
≥rm
)) < 0)

283  
r
;

286 i‡((
r
 = 
	`sys_∑ge_Æloc
(0, 
UTEMP
, 
PTE_P
|
PTE_U
|
PTE_W
)) < 0)

287  
r
;

288 i‡((
r
 = 
	`£ek
(
fd
, 
fûeoff£t
 + 
i
)) < 0)

289  
r
;

290 i‡((
r
 = 
	`ªadn
(
fd
, 
UTEMP
, 
	`MIN
(
PGSIZE
, 
fûesz
-
i
))) < 0)

291  
r
;

292 i‡((
r
 = 
	`sys_∑ge_m≠
(0, 
UTEMP
, 
chûd
, (*Ë(
va
 + 
i
), 
≥rm
)) < 0)

293 
	`∑nic
("•awn: sys_∑ge_m≠ d©a: %e", 
r
);

294 
	`sys_∑ge_unm≠
(0, 
UTEMP
);

298 
	}
}

302 
	$c›y_sh¨ed_∑ges
(
ívid_t
 
chûd
)

306 
	}
}

	@lib/string.c

3 
	~<öc/°rög.h
>

9 
	#ASM
 1

	)

12 
	$°æí
(c⁄° *
s
)

14 
n
;

16 
n
 = 0; *
s
 != '\0'; s++)

17 
n
++;

18  
n
;

19 
	}
}

22 
	$°∫Àn
(c⁄° *
s
, 
size_t
 
size
)

24 
n
;

26 
n
 = 0; 
size
 > 0 && *
s
 != '\0'; s++, size--)

27 
n
++;

28  
n
;

29 
	}
}

32 
	$°r˝y
(*
d°
, c⁄° *
§c
)

34 *
ªt
;

36 
ªt
 = 
d°
;

37 (*
d°
++ = *
§c
++) != '\0')

39  
ªt
;

40 
	}
}

43 
	$°rˇt
(*
d°
, c⁄° *
§c
)

45 
Àn
 = 
	`°æí
(
d°
);

46 
	`°r˝y
(
d°
 + 
Àn
, 
§c
);

47  
d°
;

48 
	}
}

51 
	$°∫˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
size
) {

52 
size_t
 
i
;

53 *
ªt
;

55 
ªt
 = 
d°
;

56 
i
 = 0; i < 
size
; i++) {

57 *
d°
++ = *
§c
;

59 i‡(*
§c
 != '\0')

60 
§c
++;

62  
ªt
;

63 
	}
}

65 
size_t


66 
	$°æ˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
size
)

68 *
d°_ö
;

70 
d°_ö
 = 
d°
;

71 i‡(
size
 > 0) {

72 --
size
 > 0 && *
§c
 != '\0')

73 *
d°
++ = *
§c
++;

74 *
d°
 = '\0';

76  
d°
 - 
d°_ö
;

77 
	}
}

80 
	$°rcmp
(c⁄° *
p
, c⁄° *
q
)

82 *
p
 && *∞=*
q
)

83 
p
++, 
q
++;

84  (Ë((Ë*
p
 - (Ë*
q
);

85 
	}
}

88 
	$°∫cmp
(c⁄° *
p
, c⁄° *
q
, 
size_t
 
n
)

90 
n
 > 0 && *
p
 && *∞=*
q
)

91 
n
--, 
p
++, 
q
++;

92 i‡(
n
 == 0)

95  (Ë((Ë*
p
 - (Ë*
q
);

96 
	}
}

101 
	$°rchr
(c⁄° *
s
, 
c
)

103 ; *
s
; s++)

104 i‡(*
s
 =
c
)

105  (*Ë
s
;

107 
	}
}

112 
	$°rföd
(c⁄° *
s
, 
c
)

114 ; *
s
; s++)

115 i‡(*
s
 =
c
)

117  (*Ë
s
;

118 
	}
}

120 #i‡
ASM


122 
	$mem£t
(*
v
, 
c
, 
size_t
 
n
)

124 *
p
;

126 i‡(
n
 == 0)

127  
v
;

128 i‡(()
v
%4 =0 && 
n
%4 == 0) {

129 
c
 &= 0xFF;

130 
c
 = (c<<24)|(c<<16)|(c<<8)|c;

131 
asm
 volatile("cld;Ñep stosl\n"

132 :: "D" (
v
), "a" (
c
), "c" (
n
/4)

135 
asm
 volatile("cld;Ñep stosb\n"

136 :: "D" (
v
), "a" (
c
), "c" (
n
)

138  
v
;

139 
	}
}

142 
	$memmove
(*
d°
, c⁄° *
§c
, 
size_t
 
n
)

144 c⁄° *
s
;

145 *
d
;

147 
s
 = 
§c
;

148 
d
 = 
d°
;

149 i‡(
s
 < 
d
 && s + 
n
 > d) {

150 
s
 +
n
;

151 
d
 +
n
;

152 i‡(()
s
%4 =0 && ()
d
%4 =0 && 
n
%4 == 0)

153 
asm
 volatile("std;Ñep movsl\n"

154 :: "D" (
d
-4), "S" (
s
-4), "c" (
n
/4) : "cc", "memory");

156 
asm
 volatile("std;Ñep movsb\n"

157 :: "D" (
d
-1), "S" (
s
-1), "c" (
n
) : "cc", "memory");

159 
asm
 volatile("cld" ::: "cc");

161 i‡(()
s
%4 =0 && ()
d
%4 =0 && 
n
%4 == 0)

162 
asm
 volatile("cld;Ñep movsl\n"

163 :: "D" (
d
), "S" (
s
), "c" (
n
/4) : "cc", "memory");

165 
asm
 volatile("cld;Ñep movsb\n"

166 :: "D" (
d
), "S" (
s
), "c" (
n
) : "cc", "memory");

168  
d°
;

169 
	}
}

174 
	$mem£t
(*
v
, 
c
, 
size_t
 
n
)

176 *
p
;

177 
m
;

179 
p
 = 
v
;

180 
m
 = 
n
;

181 --
m
 >= 0)

182 *
p
++ = 
c
;

184  
v
;

185 
	}
}

188 
	$memmove
(*
d°
, c⁄° *
§c
, 
size_t
 
n
)

190 c⁄° *
s
;

191 *
d
;

193 
s
 = 
§c
;

194 
d
 = 
d°
;

195 i‡(
s
 < 
d
 && s + 
n
 > d) {

196 
s
 +
n
;

197 
d
 +
n
;

198 
n
-- > 0)

199 *--
d
 = *--
s
;

201 
n
-- > 0)

202 *
d
++ = *
s
++;

204  
d°
;

205 
	}
}

209 
	$mem˝y
(*
d°
, c⁄° *
§c
, 
size_t
 
n
)

211  
	`memmove
(
d°
, 
§c
, 
n
);

212 
	}
}

215 
	$memcmp
(c⁄° *
v1
, c⁄° *
v2
, 
size_t
 
n
)

217 c⁄° 
uöt8_t
 *
s1
 = (c⁄° uöt8_à*Ë
v1
;

218 c⁄° 
uöt8_t
 *
s2
 = (c⁄° uöt8_à*Ë
v2
;

220 
n
-- > 0) {

221 i‡(*
s1
 !*
s2
)

222  (Ë*
s1
 - (Ë*
s2
;

223 
s1
++, 
s2
++;

227 
	}
}

230 
	$memföd
(c⁄° *
s
, 
c
, 
size_t
 
n
)

232 c⁄° *
íds
 = (c⁄° *Ë
s
 + 
n
;

233 ; 
s
 < 
íds
; s++)

234 i‡(*(c⁄° *Ë
s
 =(Ë
c
)

236  (*Ë
s
;

237 
	}
}

240 
	$°πﬁ
(c⁄° *
s
, **
íd±r
, 
ba£
)

242 
√g
 = 0;

243 
vÆ
 = 0;

246 *
s
 == ' ' || *s == '\t')

247 
s
++;

250 i‡(*
s
 == '+')

251 
s
++;

252 i‡(*
s
 == '-')

253 
s
++, 
√g
 = 1;

256 i‡((
ba£
 =0 || ba£ =16Ë&& (
s
[0] == '0' && s[1] == 'x'))

257 
s
 +2, 
ba£
 = 16;

258 i‡(
ba£
 =0 && 
s
[0] == '0')

259 
s
++, 
ba£
 = 8;

260 i‡(
ba£
 == 0)

261 
ba£
 = 10;

265 
dig
;

267 i‡(*
s
 >= '0' && *s <= '9')

268 
dig
 = *
s
 - '0';

269 i‡(*
s
 >= 'a' && *s <= 'z')

270 
dig
 = *
s
 - 'a' + 10;

271 i‡(*
s
 >= 'A' && *s <= 'Z')

272 
dig
 = *
s
 - 'A' + 10;

275 i‡(
dig
 >
ba£
)

277 
s
++, 
vÆ
 = (vÆ * 
ba£
Ë+ 
dig
;

281 i‡(
íd±r
)

282 *
íd±r
 = (*Ë
s
;

283  (
√g
 ? -
vÆ
 : val);

284 
	}
}

	@lib/syscall.c

3 
	~<öc/sysˇŒ.h
>

4 
	~<öc/lib.h
>

6 
ölöe
 
öt32_t


7 
	$sysˇŒ
(
num
, 
check
, 
uöt32_t
 
a1
, uöt32_à
a2
, uöt32_à
a3
, uöt32_à
a4
, uöt32_à
a5
)

9 
öt32_t
 
ªt
;

23 
asm
 volatile("int %1\n"

24 : "˜" (
ªt
)

25 : "i" (
T_SYSCALL
),

26 "a" (
num
),

27 "d" (
a1
),

28 "c" (
a2
),

29 "b" (
a3
),

30 "D" (
a4
),

31 "S" (
a5
)

34 if(
check
 && 
ªt
 > 0)

35 
	`∑nic
("sysˇŒ %dÑëu∫ed %d (> 0)", 
num
, 
ªt
);

37  
ªt
;

38 
	}
}

41 
	$sys_˝uts
(c⁄° *
s
, 
size_t
 
Àn
)

43 
	`sysˇŒ
(
SYS_˝uts
, 0, (
uöt32_t
)
s
, 
Àn
, 0, 0, 0);

44 
	}
}

47 
	$sys_cgëc
()

49  
	`sysˇŒ
(
SYS_cgëc
, 0, 0, 0, 0, 0, 0);

50 
	}
}

53 
	$sys_ív_de°roy
(
ívid_t
 
ívid
)

55  
	`sysˇŒ
(
SYS_ív_de°roy
, 1, 
ívid
, 0, 0, 0, 0);

56 
	}
}

58 
ívid_t


59 
	$sys_gëívid
()

61  
	`sysˇŒ
(
SYS_gëívid
, 0, 0, 0, 0, 0, 0);

62 
	}
}

65 
	$sys_yõld
()

67 
	`sysˇŒ
(
SYS_yõld
, 0, 0, 0, 0, 0, 0);

68 
	}
}

71 
	$sys_∑ge_Æloc
(
ívid_t
 
ívid
, *
va
, 
≥rm
)

73  
	`sysˇŒ
(
SYS_∑ge_Æloc
, 1, 
ívid
, (
uöt32_t
Ë
va
, 
≥rm
, 0, 0);

74 
	}
}

77 
	$sys_∑ge_m≠
(
ívid_t
 
§˚nv
, *
§cva
,Énvid_à
d°ív
, *
d°va
, 
≥rm
)

79  
	`sysˇŒ
(
SYS_∑ge_m≠
, 1, 
§˚nv
, (
uöt32_t
Ë
§cva
, 
d°ív
, (uöt32_tË
d°va
, 
≥rm
);

80 
	}
}

83 
	$sys_∑ge_unm≠
(
ívid_t
 
ívid
, *
va
)

85  
	`sysˇŒ
(
SYS_∑ge_unm≠
, 1, 
ívid
, (
uöt32_t
Ë
va
, 0, 0, 0);

86 
	}
}

91 
	$sys_ív_£t_°©us
(
ívid_t
 
ívid
, 
°©us
)

93  
	`sysˇŒ
(
SYS_ív_£t_°©us
, 1, 
ívid
, 
°©us
, 0, 0, 0);

94 
	}
}

97 
	$sys_ív_£t_å≠‰ame
(
ívid_t
 
ívid
, 
Tøp‰ame
 *
tf
)

99  
	`sysˇŒ
(
SYS_ív_£t_å≠‰ame
, 1, 
ívid
, (
uöt32_t
Ë
tf
, 0, 0, 0);

100 
	}
}

103 
	$sys_ív_£t_pgÁu…_upˇŒ
(
ívid_t
 
ívid
, *
upˇŒ
)

105  
	`sysˇŒ
(
SYS_ív_£t_pgÁu…_upˇŒ
, 1, 
ívid
, (
uöt32_t
Ë
upˇŒ
, 0, 0, 0);

106 
	}
}

109 
	$sys_ùc_åy_£nd
(
ívid_t
 
ívid
, 
uöt32_t
 
vÆue
, *
§cva
, 
≥rm
)

111  
	`sysˇŒ
(
SYS_ùc_åy_£nd
, 0, 
ívid
, 
vÆue
, (
uöt32_t
Ë
§cva
, 
≥rm
, 0);

112 
	}
}

115 
	$sys_ùc_ªcv
(*
d°va
)

117  
	`sysˇŒ
(
SYS_ùc_ªcv
, 1, (
uöt32_t
)
d°va
, 0, 0, 0, 0);

118 
	}
}

	@lib/wait.c

1 
	~<öc/lib.h
>

5 
	$waô
(
ívid_t
 
ívid
)

7 c⁄° vﬁ©ûê
Env
 *
e
;

9 
	`as£π
(
ívid
 != 0);

10 
e
 = &
ívs
[
	`ENVX
(
ívid
)];

11 
e
->
ív_id
 =
ívid
 &&É->
ív_°©us
 !
ENV_FREE
)

12 
	`sys_yõld
();

13 
	}
}

	@user/badsegment.c

3 
	~<öc/lib.h
>

6 
	$umaö
(
¨gc
, **
¨gv
)

9 
asm
 volatile("movw $0x28,%ax; movw %ax,%ds");

10 
	}
}

	@user/breakpoint.c

3 
	~<öc/lib.h
>

6 
	$umaö
(
¨gc
, **
¨gv
)

8 
asm
 volatile("int $3");

9 
	}
}

	@user/buggyhello.c

4 
	~<öc/lib.h
>

7 
	$umaö
(
¨gc
, **
¨gv
)

9 
	`sys_˝uts
((*)1, 1);

10 
	}
}

	@user/buggyhello2.c

4 
	~<öc/lib.h
>

6 c⁄° *
	ghñlo
 = "hello, world\n";

9 
	$umaö
(
¨gc
, **
¨gv
)

11 
	`sys_˝uts
(
hñlo
, 1024*1024);

12 
	}
}

	@user/cat.c

1 
	~<öc/lib.h
>

3 
	gbuf
[8192];

6 
	$ˇt
(
f
, *
s
)

8 
n
;

9 
r
;

11 (
n
 = 
	`ªad
(
f
, 
buf
, ()(buf))) > 0)

12 i‡((
r
 = 
	`wrôe
(1, 
buf
, 
n
)) !=Ç)

13 
	`∑nic
("wrôêîr‹ c›yög %s: %e", 
s
, 
r
);

14 i‡(
n
 < 0)

15 
	`∑nic
("îr‹Ñódög %s: %e", 
s
, 
n
);

16 
	}
}

19 
	$umaö
(
¨gc
, **
¨gv
)

21 
f
, 
i
;

23 
bö¨y«me
 = "cat";

24 i‡(
¨gc
 == 1)

25 
	`ˇt
(0, "<stdin>");

27 
i
 = 1; i < 
¨gc
; i++) {

28 
f
 = 
	`›í
(
¨gv
[
i
], 
O_RDONLY
);

29 i‡(
f
 < 0)

30 
	`¥ötf
("ˇn'à›í %s: %e\n", 
¨gv
[
i
], 
f
);

32 
	`ˇt
(
f
, 
¨gv
[
i
]);

33 
	`˛o£
(
f
);

36 
	}
}

	@user/divzero.c

3 
	~<öc/lib.h
>

5 
	gzîo
;

8 
	$umaö
(
¨gc
, **
¨gv
)

10 
zîo
 = 0;

11 
	`˝rötf
("1/0 i†%08x!\n", 1/
zîo
);

12 
	}
}

	@user/dumbfork.c

4 
	~<öc/°rög.h
>

5 
	~<öc/lib.h
>

7 
ívid_t
 
dumbf‹k
();

10 
	$umaö
(
¨gc
, **
¨gv
)

12 
ívid_t
 
who
;

13 
i
;

16 
who
 = 
	`dumbf‹k
();

19 
i
 = 0; i < (
who
 ? 10 : 20); i++) {

20 
	`˝rötf
("%d: IámÅhê%s!\n", 
i
, 
who
 ? "parent" : "child");

21 
	`sys_yõld
();

23 
	}
}

26 
	$duµage
(
ívid_t
 
d°ív
, *
addr
)

28 
r
;

31 i‡((
r
 = 
	`sys_∑ge_Æloc
(
d°ív
, 
addr
, 
PTE_P
|
PTE_U
|
PTE_W
)) < 0)

32 
	`∑nic
("sys_∑ge_Æloc: %e", 
r
);

33 i‡((
r
 = 
	`sys_∑ge_m≠
(
d°ív
, 
addr
, 0, 
UTEMP
, 
PTE_P
|
PTE_U
|
PTE_W
)) < 0)

34 
	`∑nic
("sys_∑ge_m≠: %e", 
r
);

35 
	`memmove
(
UTEMP
, 
addr
, 
PGSIZE
);

36 i‡((
r
 = 
	`sys_∑ge_unm≠
(0, 
UTEMP
)) < 0)

37 
	`∑nic
("sys_∑ge_unm≠: %e", 
r
);

38 
	}
}

40 
ívid_t


41 
	$dumbf‹k
()

43 
ívid_t
 
ívid
;

44 
uöt8_t
 *
addr
;

45 
r
;

46 
íd
[];

53 
ívid
 = 
	`sys_exof‹k
();

54 i‡(
ívid
 < 0)

55 
	`∑nic
("sys_exof‹k: %e", 
ívid
);

56 i‡(
ívid
 == 0) {

61 
thi£nv
 = &
ívs
[
	`ENVX
(
	`sys_gëívid
())];

68 
addr
 = (
uöt8_t
*Ë
UTEXT
;ádd∏< 
íd
;ádd∏+
PGSIZE
)

69 
	`duµage
(
ívid
, 
addr
);

72 
	`duµage
(
ívid
, 
	`ROUNDDOWN
(&
addr
, 
PGSIZE
));

75 i‡((
r
 = 
	`sys_ív_£t_°©us
(
ívid
, 
ENV_RUNNABLE
)) < 0)

76 
	`∑nic
("sys_ív_£t_°©us: %e", 
r
);

78  
ívid
;

79 
	}
}

	@user/echo.c

1 
	~<öc/lib.h
>

4 
	$umaö
(
¨gc
, **
¨gv
)

6 
i
, 
nÊag
;

8 
nÊag
 = 0;

9 i‡(
¨gc
 > 1 && 
	`°rcmp
(
¨gv
[1], "-n") == 0) {

10 
nÊag
 = 1;

11 
¨gc
--;

12 
¨gv
++;

14 
i
 = 1; i < 
¨gc
; i++) {

15 i‡(
i
 > 1)

16 
	`wrôe
(1, " ", 1);

17 
	`wrôe
(1, 
¨gv
[
i
], 
	`°æí
(argv[i]));

19 i‡(!
nÊag
)

20 
	`wrôe
(1, "\n", 1);

21 
	}
}

	@user/evilhello.c

4 
	~<öc/lib.h
>

7 
	$umaö
(
¨gc
, **
¨gv
)

10 
	`sys_˝uts
((*)0xf010000c, 100);

11 
	}
}

	@user/fairness.c

5 
	~<öc/lib.h
>

8 
	$umaö
(
¨gc
, **
¨gv
)

10 
ívid_t
 
who
, 
id
;

12 
id
 = 
	`sys_gëívid
();

14 i‡(
thi£nv
 =&
ívs
[1]) {

16 
	`ùc_ªcv
(&
who
, 0, 0);

17 
	`˝rötf
("%xÑecv from %x\n", 
id
, 
who
);

20 
	`˝rötf
("%xÜo› sídögÅÿ%x\n", 
id
, 
ívs
[1].
ív_id
);

22 
	`ùc_£nd
(
ívs
[1].
ív_id
, 0, 0, 0);

24 
	}
}

	@user/faultalloc.c

3 
	~<öc/lib.h
>

6 
	$h™dÀr
(
UTøp‰ame
 *
utf
)

8 
r
;

9 *
addr
 = (*)
utf
->
utf_Áu…_va
;

11 
	`˝rötf
("Áu… %x\n", 
addr
);

12 i‡((
r
 = 
	`sys_∑ge_Æloc
(0, 
	`ROUNDDOWN
(
addr
, 
PGSIZE
),

13 
PTE_P
|
PTE_U
|
PTE_W
)) < 0)

14 
	`∑nic
("Æloˇtögáà%x i¿∑gêÁu… h™dÀr: %e", 
addr
, 
r
);

15 
	`¢¥ötf
((*Ë
addr
, 100, "this string was faulted inát %x",áddr);

16 
	}
}

19 
	$umaö
(
¨gc
, **
¨gv
)

21 
	`£t_pgÁu…_h™dÀr
(
h™dÀr
);

22 
	`˝rötf
("%s\n", (*)0xDeadBeef);

23 
	`˝rötf
("%s\n", (*)0xCafeBffe);

24 
	}
}

	@user/faultallocbad.c

4 
	~<öc/lib.h
>

7 
	$h™dÀr
(
UTøp‰ame
 *
utf
)

9 
r
;

10 *
addr
 = (*)
utf
->
utf_Áu…_va
;

12 
	`˝rötf
("Áu… %x\n", 
addr
);

13 i‡((
r
 = 
	`sys_∑ge_Æloc
(0, 
	`ROUNDDOWN
(
addr
, 
PGSIZE
),

14 
PTE_P
|
PTE_U
|
PTE_W
)) < 0)

15 
	`∑nic
("Æloˇtögáà%x i¿∑gêÁu… h™dÀr: %e", 
addr
, 
r
);

16 
	`¢¥ötf
((*Ë
addr
, 100, "this string was faulted inát %x",áddr);

17 
	}
}

20 
	$umaö
(
¨gc
, **
¨gv
)

22 
	`£t_pgÁu…_h™dÀr
(
h™dÀr
);

23 
	`sys_˝uts
((*)0xDEADBEEF, 4);

24 
	}
}

	@user/faultbadhandler.c

6 
	~<öc/lib.h
>

9 
	$umaö
(
¨gc
, **
¨gv
)

11 
	`sys_∑ge_Æloc
(0, (*Ë(
UXSTACKTOP
 - 
PGSIZE
), 
PTE_P
|
PTE_U
|
PTE_W
);

12 
	`sys_ív_£t_pgÁu…_upˇŒ
(0, (*) 0xDeadBeef);

14 
	}
}

	@user/faultdie.c

3 
	~<öc/lib.h
>

6 
	$h™dÀr
(
UTøp‰ame
 *
utf
)

8 *
addr
 = (*)
utf
->
utf_Áu…_va
;

9 
uöt32_t
 
îr
 = 
utf
->
utf_îr
;

10 
	`˝rötf
("òÁu…edáàv®%x,Éº %x\n", 
addr
, 
îr
 & 7);

11 
	`sys_ív_de°roy
(
	`sys_gëívid
());

12 
	}
}

15 
	$umaö
(
¨gc
, **
¨gv
)

17 
	`£t_pgÁu…_h™dÀr
(
h™dÀr
);

19 
	}
}

	@user/faultevilhandler.c

3 
	~<öc/lib.h
>

6 
	$umaö
(
¨gc
, **
¨gv
)

8 
	`sys_∑ge_Æloc
(0, (*Ë(
UXSTACKTOP
 - 
PGSIZE
), 
PTE_P
|
PTE_U
|
PTE_W
);

9 
	`sys_ív_£t_pgÁu…_upˇŒ
(0, (*) 0xF0100020);

11 
	}
}

	@user/faultio.c

3 
	~<öc/lib.h
>

4 
	~<öc/x86.h
>

7 
	$umaö
(
¨gc
, **
¨gv
)

9 
x
, 
r
;

10 
n£cs
 = 1;

11 
£˙o
 = 0;

12 
diskno
 = 1;

14 i‡(
	`ªad_eÊags
(Ë& 
FL_IOPL_3
)

15 
	`˝rötf
("eflags wrong\n");

19 
	`outb
(0x1F6, 0xE0 | (1<<4));

21 
	`˝rötf
("%s: made it here --- bug\n");

22 
	}
}

	@user/faultnostack.c

3 
	~<öc/lib.h
>

5 
_pgÁu…_upˇŒ
();

8 
	$umaö
(
¨gc
, **
¨gv
)

10 
	`sys_ív_£t_pgÁu…_upˇŒ
(0, (*Ë
_pgÁu…_upˇŒ
);

12 
	}
}

	@user/faultread.c

3 
	~<öc/lib.h
>

6 
	$umaö
(
¨gc
, **
¨gv
)

8 
	`˝rötf
("IÑead %08x fromÜocation 0!\n", *(*)0);

9 
	}
}

	@user/faultreadkernel.c

3 
	~<öc/lib.h
>

6 
	$umaö
(
¨gc
, **
¨gv
)

8 
	`˝rötf
("IÑead %08x fromÜocation 0xf0100000!\n", *(*)0xf0100000);

9 
	}
}

	@user/faultregs.c

3 
	~<öc/lib.h
>

5 
	sªgs


7 
PushRegs
 
	mªgs
;

8 
uöçå_t
 
	meù
;

9 
uöt32_t
 
	meÊags
;

10 
uöçå_t
 
	me•
;

13 
	#SAVE_REGS
(
ba£
) \

14 "\tmov»%%edi, "
ba£
"+0x00\n" \

15 "\tmov»%%esi, "
ba£
"+0x04\n" \

16 "\tmov»%%ebp, "
ba£
"+0x08\n" \

17 "\tmov»%%ebx, "
ba£
"+0x10\n" \

18 "\tmov»%%edx, "
ba£
"+0x14\n" \

19 "\tmov»%%ecx, "
ba£
"+0x18\n" \

20 "\tmov»%%óx, "
ba£
"+0x1c\n" \

21 "\tmov»%%e•, "
ba£
"+0x28\n"

	)

23 
	#LOAD_REGS
(
ba£
) \

24 "\tmov»"
ba£
"+0x00, %%edi\n" \

25 "\tmov»"
ba£
"+0x04, %%esi\n" \

26 "\tmov»"
ba£
"+0x08, %%ebp\n" \

27 "\tmov»"
ba£
"+0x10, %%ebx\n" \

28 "\tmov»"
ba£
"+0x14, %%edx\n" \

29 "\tmov»"
ba£
"+0x18, %%ecx\n" \

30 "\tmov»"
ba£
"+0x1c, %%eax\n" \

31 "\tmov»"
ba£
"+0x28, %%e•\n"

	)

33 
ªgs
 
	gbef‹e
, 
	gdurög
, 
	ga·î
;

36 
	$check_ªgs
(
ªgs
* 
a
, c⁄° *
™
, ªgs* 
b
, c⁄° *
bn
,

37 c⁄° *
ã°«me
)

39 
mism©ch
 = 0;

41 
	`˝rötf
("%-6†%-8†%-8s\n", "", 
™
, 
bn
);

43 
	#CHECK
(
«me
, 
fõld
) \

45 
	`˝rötf
("%-6†%08x %08x ", #«me, 
a
->
fõld
, 
b
->field); \

46 i‡(
a
->
fõld
 =
b
->field) \

47 
	`˝rötf
("OK\n"); \

49 
	`˝rötf
("MISMATCH\n"); \

50 
mism©ch
 = 1; \

52 } 0)

	)

54 
	`CHECK
(
edi
, 
ªgs
.
ªg_edi
);

55 
	`CHECK
(
esi
, 
ªgs
.
ªg_esi
);

56 
	`CHECK
(
ebp
, 
ªgs
.
ªg_ebp
);

57 
	`CHECK
(
ebx
, 
ªgs
.
ªg_ebx
);

58 
	`CHECK
(
edx
, 
ªgs
.
ªg_edx
);

59 
	`CHECK
(
ecx
, 
ªgs
.
ªg_ecx
);

60 
	`CHECK
(
óx
, 
ªgs
.
ªg_óx
);

61 
	`CHECK
(
eù
,Éip);

62 
	`CHECK
(
eÊags
,Éflags);

63 
	`CHECK
(
e•
,Ésp);

65 #unde‡
CHECK


67 
	`˝rötf
("Regi°î†%†", 
ã°«me
);

68 i‡(!
mism©ch
)

69 
	`˝rötf
("OK\n");

71 
	`˝rötf
("MISMATCH\n");

72 
	}
}

75 
	$pgÁu…
(
UTøp‰ame
 *
utf
)

77 
r
;

79 i‡(
utf
->
utf_Áu…_va
 !(
uöt32_t
)
UTEMP
)

80 
	`∑nic
("pgfaultÉxpectedát UTEMP, got 0x%08x (eip %08x)",

81 
utf
->
utf_Áu…_va
, utf->
utf_eù
);

84 
durög
.
ªgs
 = 
utf
->
utf_ªgs
;

85 
durög
.
eù
 = 
utf
->
utf_eù
;

86 
durög
.
eÊags
 = 
utf
->
utf_eÊags
 & ~
FL_RF
;

87 
durög
.
e•
 = 
utf
->
utf_e•
;

88 
	`check_ªgs
(&
bef‹e
, "bef‹e", &
durög
, "during", "in UTrapframe");

91 i‡((
r
 = 
	`sys_∑ge_Æloc
(0, 
UTEMP
, 
PTE_U
|
PTE_P
|
PTE_W
)) < 0)

92 
	`∑nic
("sys_∑ge_Æloc: %e", 
r
);

93 
	}
}

96 
	$umaö
(
¨gc
, **
¨gv
)

98 
	`£t_pgÁu…_h™dÀr
(
pgÁu…
);

100 
asm
 volatile(

117 
	`SAVE_REGS
("%0")

123 
	`SAVE_REGS
("%1")

127 
	`LOAD_REGS
("%0")

136 : : "m" (
bef‹e
), "m" (
a·î
) : "memory", "cc");

141 i‡(*(*)
UTEMP
 != 42)

142 
	`˝rötf
("EIPáfterÖage-fault MISMATCH\n");

143 
a·î
.
eù
 = 
bef‹e
.eip;

145 
	`check_ªgs
(&
bef‹e
, "bef‹e", &
a·î
, "after", "afterÖage-fault");

146 
	}
}

	@user/faultwrite.c

3 
	~<öc/lib.h
>

6 
	$umaö
(
¨gc
, **
¨gv
)

9 
	}
}

	@user/faultwritekernel.c

3 
	~<öc/lib.h
>

6 
	$umaö
(
¨gc
, **
¨gv
)

9 
	}
}

	@user/forktree.c

3 
	~<öc/lib.h
>

5 
	#DEPTH
 3

	)

7 
f‹kåì
(c⁄° *
cur
);

10 
	$f‹kchûd
(c⁄° *
cur
, 
bønch
)

12 
nxt
[
DEPTH
+1];

14 i‡(
	`°æí
(
cur
Ë>
DEPTH
)

17 
	`¢¥ötf
(
nxt
, 
DEPTH
+1, "%s%c", 
cur
, 
bønch
);

18 i‡(
	`f‹k
() == 0) {

19 
	`f‹kåì
(
nxt
);

20 
	`exô
();

22 
	}
}

25 
	$f‹kåì
(c⁄° *
cur
)

27 
	`˝rötf
("%04x: Iám '%s'\n", 
	`sys_gëívid
(), 
cur
);

29 
	`f‹kchûd
(
cur
, '0');

30 
	`f‹kchûd
(
cur
, '1');

31 
	}
}

34 
	$umaö
(
¨gc
, **
¨gv
)

36 
	`f‹kåì
("");

37 
	}
}

	@user/hello.c

2 
	~<öc/lib.h
>

5 
	$umaö
(
¨gc
, **
¨gv
)

7 
	`˝rötf
("hello, world\n");

8 
	`˝rötf
("òamÉnvú⁄míà%08x\n", 
thi£nv
->
ív_id
);

9 
	}
}

	@user/icode.c

1 
	~<öc/lib.h
>

4 
	$umaö
(
¨gc
, **
¨gv
)

6 
fd
, 
n
, 
r
;

7 
buf
[512+1];

9 
bö¨y«me
 = "icode";

11 
	`˝rötf
("icode startup\n");

13 
	`˝rötf
("icode: open /motd\n");

14 i‡((
fd
 = 
	`›í
("/mŸd", 
O_RDONLY
)) < 0)

15 
	`∑nic
("icode: o≥¿/mŸd: %e", 
fd
);

17 
	`˝rötf
("icode:Ñead /motd\n");

18 (
n
 = 
	`ªad
(
fd
, 
buf
,  buf-1)) > 0)

19 
	`sys_˝uts
(
buf
, 
n
);

21 
	`˝rötf
("icode: close /motd\n");

22 
	`˛o£
(
fd
);

24 
	`˝rötf
("icode: spawn /init\n");

25 i‡((
r
 = 
	`•aw∆
("/init", "init", "initarg1", "initarg2", (*)0)) < 0)

26 
	`∑nic
("icode: s∑w¿/öô: %e", 
r
);

28 
	`˝rötf
("icode:Éxiting\n");

29 
	}
}

	@user/idle.c

3 
	~<öc/x86.h
>

4 
	~<öc/lib.h
>

7 
	$umaö
(
¨gc
, **
¨gv
)

9 
bö¨y«me
 = "idle";

17 
	`sys_yõld
();

19 
	}
}

	@user/init.c

1 
	~<öc/lib.h
>

4 
	mmsg1
[5000];

5 
	mmsg2
[1000];

6 } 
	gd©a
 = {

11 
	gbss
[6000];

14 
	$sum
(c⁄° *
s
, 
n
)

16 
i
, 
tŸ
 = 0;

17 
i
 = 0; i < 
n
; i++)

18 
tŸ
 ^
i
 * 
s
[i];

19  
tŸ
;

20 
	}
}

23 
	$umaö
(
¨gc
, **
¨gv
)

25 
i
, 
r
, 
x
, 
w™t
;

26 
¨gs
[256];

28 
	`˝rötf
("init:Ñunning\n");

30 
w™t
 = 0xf989e;

31 i‡((
x
 = 
	`sum
((*)&
d©a
,  d©a)Ë!
w™t
)

32 
	`˝rötf
("init: data isÇot initialized: got sum %08x wanted %08x\n",

33 
x
, 
w™t
);

35 
	`˝rötf
("init: data seems okay\n");

36 i‡((
x
 = 
	`sum
(
bss
,  bss)) != 0)

37 
	`˝rötf
("bs†i†nŸ inôülized: w™ãd sum 0 gŸ %08x\n", 
x
);

39 
	`˝rötf
("init: bss seems okay\n");

42 
	`°rˇt
(
¨gs
, "init:árgs:");

43 
i
 = 0; i < 
¨gc
; i++) {

44 
	`°rˇt
(
¨gs
, " '");

45 
	`°rˇt
(
¨gs
, 
¨gv
[
i
]);

46 
	`°rˇt
(
¨gs
, "'");

48 
	`˝rötf
("%s\n", 
¨gs
);

50 
	`˝rötf
("init:Ñunning sh\n");

53 
	`˛o£
(0);

54 i‡((
r
 = 
	`›íc⁄s
()) < 0)

55 
	`∑nic
("›íc⁄s: %e", 
r
);

56 i‡(
r
 != 0)

57 
	`∑nic
("fú° o≥nc⁄†u£d fd %d", 
r
);

58 i‡((
r
 = 
	`dup
(0, 1)) < 0)

59 
	`∑nic
("dup: %e", 
r
);

61 
	`˝rötf
("init: starting sh\n");

62 
r
 = 
	`•aw∆
("/sh", "sh", (*)0);

63 i‡(
r
 < 0) {

64 
	`˝rötf
("öô: s∑w¿sh: %e\n", 
r
);

67 
	`waô
(
r
);

69 
	}
}

	@user/initsh.c

1 
	~<öc/lib.h
>

4 
	$umaö
(
¨gc
, **
¨gv
)

6 
i
, 
r
, 
x
, 
w™t
;

8 
	`˝rötf
("initsh:Ñunning sh\n");

11 
	`˛o£
(0);

12 i‡((
r
 = 
	`›íc⁄s
()) < 0)

13 
	`∑nic
("›íc⁄s: %e", 
r
);

14 i‡(
r
 != 0)

15 
	`∑nic
("fú° o≥nc⁄†u£d fd %d", 
r
);

16 i‡((
r
 = 
	`dup
(0, 1)) < 0)

17 
	`∑nic
("dup: %e", 
r
);

19 
	`˝rötf
("init: starting sh\n");

20 
r
 = 
	`•aw∆
("/sh", "sh", (*)0);

21 i‡(
r
 < 0) {

22 
	`˝rötf
("öô: s∑w¿sh: %e\n", 
r
);

25 
	`waô
(
r
);

27 
	}
}

	@user/ls.c

1 
	~<öc/lib.h
>

3 
	gÊag
[256];

5 
lsdú
(const *, const *);

6 
ls1
(c⁄° *, 
boﬁ
, 
off_t
, const *);

9 
	$ls
(c⁄° *
∑th
, c⁄° *
¥efix
)

11 
r
;

12 
Sèt
 
°
;

14 i‡((
r
 = 
	`°©
(
∑th
, &
°
)) < 0)

15 
	`∑nic
("°© %s: %e", 
∑th
, 
r
);

16 i‡(
°
.
°_isdú
 && !
Êag
['d'])

17 
	`lsdú
(
∑th
, 
¥efix
);

19 
	`ls1
(0, 
°
.
°_isdú
, st.
°_size
, 
∑th
);

20 
	}
}

23 
	$lsdú
(c⁄° *
∑th
, c⁄° *
¥efix
)

25 
fd
, 
n
;

26 
Fûe
 
f
;

28 i‡((
fd
 = 
	`›í
(
∑th
, 
O_RDONLY
)) < 0)

29 
	`∑nic
("›í %s: %e", 
∑th
, 
fd
);

30 (
n
 = 
	`ªadn
(
fd
, &
f
,  f)) ==  f)

31 i‡(
f
.
f_«me
[0])

32 
	`ls1
(
¥efix
, 
f
.
f_ty≥
==
FTYPE_DIR
, f.
f_size
, f.
f_«me
);

33 i‡(
n
 > 0)

34 
	`∑nic
("sh‹àªad i¿dúe˘‹y %s", 
∑th
);

35 i‡(
n
 < 0)

36 
	`∑nic
("îr‹Ñódög dúe˘‹y %s: %e", 
∑th
, 
n
);

37 
	}
}

40 
	$ls1
(c⁄° *
¥efix
, 
boﬁ
 
isdú
, 
off_t
 
size
, c⁄° *
«me
)

42 c⁄° *
£p
;

44 if(
Êag
['l'])

45 
	`¥ötf
("%11d %¯", 
size
, 
isdú
 ? 'd' : '-');

46 if(
¥efix
) {

47 i‡(
¥efix
[0] &&Öªfix[
	`°æí
(prefix)-1] != '/')

48 
£p
 = "/";

50 
£p
 = "";

51 
	`¥ötf
("%s%s", 
¥efix
, 
£p
);

53 
	`¥ötf
("%s", 
«me
);

54 if(
Êag
['F'] && 
isdú
)

55 
	`¥ötf
("/");

56 
	`¥ötf
("\n");

57 
	}
}

60 
	$ußge
()

62 
	`¥ötf
("usage:Üs [-dFl] [file...]\n");

63 
	`exô
();

64 
	}
}

67 
	$umaö
(
¨gc
, **
¨gv
)

69 
i
;

70 
Arg°©e
 
¨gs
;

72 
	`¨g°¨t
(&
¨gc
, 
¨gv
, &
¨gs
);

73 (
i
 = 
	`¨g√xt
(&
¨gs
)) >= 0)

74 
i
) {

78 
Êag
[
i
]++;

81 
	`ußge
();

84 i‡(
¨gc
 == 1)

85 
	`ls
("/", "");

87 
i
 = 1; i < 
¨gc
; i++)

88 
	`ls
(
¨gv
[
i
],árgv[i]);

90 
	}
}

	@user/lsfd.c

1 
	~<öc/lib.h
>

4 
	$ußge
()

6 
	`˝rötf
("usage:Üsfd [-1]\n");

7 
	`exô
();

8 
	}
}

11 
	$umaö
(
¨gc
, **
¨gv
)

13 
i
, 
u£Âröt
 = 0;

14 
Sèt
 
°
;

15 
Arg°©e
 
¨gs
;

17 
	`¨g°¨t
(&
¨gc
, 
¨gv
, &
¨gs
);

18 (
i
 = 
	`¨g√xt
(&
¨gs
)) >= 0)

19 i‡(
i
 == '1')

20 
u£Âröt
 = 1;

22 
	`ußge
();

24 
i
 = 0; i < 32; i++)

25 i‡(
	`f°©
(
i
, &
°
) >= 0) {

26 i‡(
u£Âröt
)

27 
	`Ârötf
(1, "fd %d:Çame %s isdir %d size %d dev %s\n",

28 
i
, 
°
.
°_«me
, st.
°_isdú
,

29 
°
.
°_size
, st.
°_dev
->
dev_«me
);

31 
	`˝rötf
("fd %d:Çame %s isdir %d size %d dev %s\n",

32 
i
, 
°
.
°_«me
, st.
°_isdú
,

33 
°
.
°_size
, st.
°_dev
->
dev_«me
);

35 
	}
}

	@user/num.c

1 
	~<öc/lib.h
>

3 
	gbﬁ
 = 1;

4 
	glöe
 = 0;

7 
	$num
(
f
, c⁄° *
s
)

9 
n
;

10 
r
;

11 
c
;

13 (
n
 = 
	`ªad
(
f
, &
c
, 1)) > 0) {

14 i‡(
bﬁ
) {

15 
	`¥ötf
("%5d ", ++
löe
);

16 
bﬁ
 = 0;

18 i‡((
r
 = 
	`wrôe
(1, &
c
, 1)) != 1)

19 
	`∑nic
("wrôêîr‹ c›yög %s: %e", 
s
, 
r
);

20 i‡(
c
 == '\n')

21 
bﬁ
 = 1;

23 i‡(
n
 < 0)

24 
	`∑nic
("îr‹Ñódög %s: %e", 
s
, 
n
);

25 
	}
}

28 
	$umaö
(
¨gc
, **
¨gv
)

30 
f
, 
i
;

32 
bö¨y«me
 = "num";

33 i‡(
¨gc
 == 1)

34 
	`num
(0, "<stdin>");

36 
i
 = 1; i < 
¨gc
; i++) {

37 
f
 = 
	`›í
(
¨gv
[
i
], 
O_RDONLY
);

38 i‡(
f
 < 0)

39 
	`∑nic
("ˇn'à›í %s: %e", 
¨gv
[
i
], 
f
);

41 
	`num
(
f
, 
¨gv
[
i
]);

42 
	`˛o£
(
f
);

45 
	`exô
();

46 
	}
}

	@user/pingpong.c

4 
	~<öc/lib.h
>

7 
	$umaö
(
¨gc
, **
¨gv
)

9 
ívid_t
 
who
;

11 i‡((
who
 = 
	`f‹k
()) != 0) {

13 
	`˝rötf
("£nd 0 from %xÅÿ%x\n", 
	`sys_gëívid
(), 
who
);

14 
	`ùc_£nd
(
who
, 0, 0, 0);

18 
uöt32_t
 
i
 = 
	`ùc_ªcv
(&
who
, 0, 0);

19 
	`˝rötf
("%x gŸ %d from %x\n", 
	`sys_gëívid
(), 
i
, 
who
);

20 i‡(
i
 == 10)

22 
i
++;

23 
	`ùc_£nd
(
who
, 
i
, 0, 0);

24 i‡(
i
 == 10)

28 
	}
}

	@user/pingpongs.c

4 
	~<öc/lib.h
>

6 
uöt32_t
 
	gvÆ
;

9 
	$umaö
(
¨gc
, **
¨gv
)

11 
ívid_t
 
who
;

12 
uöt32_t
 
i
;

14 
i
 = 0;

15 i‡((
who
 = 
	`sf‹k
()) != 0) {

16 
	`˝rötf
("òam %08x;Åhi£nv i†%p\n", 
	`sys_gëívid
(), 
thi£nv
);

18 
	`˝rötf
("£nd 0 from %xÅÿ%x\n", 
	`sys_gëívid
(), 
who
);

19 
	`ùc_£nd
(
who
, 0, 0, 0);

23 
	`ùc_ªcv
(&
who
, 0, 0);

24 
	`˝rötf
("%x gŸ %d from %x (thi£nv i†%∞%x)\n", 
	`sys_gëívid
(), 
vÆ
, 
who
, 
thi£nv
,Åhi£nv->
ív_id
);

25 i‡(
vÆ
 == 10)

27 ++
vÆ
;

28 
	`ùc_£nd
(
who
, 0, 0, 0);

29 i‡(
vÆ
 == 10)

33 
	}
}

	@user/primes.c

11 
	~<öc/lib.h
>

14 
	$¥imïroc
()

16 
i
, 
id
, 
p
;

17 
ívid_t
 
ívid
;

20 
t›
:

21 
p
 = 
	`ùc_ªcv
(&
ívid
, 0, 0);

22 
	`˝rötf
("CPU %d: %d ", 
thi£nv
->
ív_˝unum
, 
p
);

25 i‡((
id
 = 
	`f‹k
()) < 0)

26 
	`∑nic
("f‹k: %e", 
id
);

27 i‡(
id
 == 0)

28 
t›
;

32 
i
 = 
	`ùc_ªcv
(&
ívid
, 0, 0);

33 i‡(
i
 % 
p
)

34 
	`ùc_£nd
(
id
, 
i
, 0, 0);

36 
	}
}

39 
	$umaö
(
¨gc
, **
¨gv
)

41 
i
, 
id
;

44 i‡((
id
 = 
	`f‹k
()) < 0)

45 
	`∑nic
("f‹k: %e", 
id
);

46 i‡(
id
 == 0)

47 
	`¥imïroc
();

50 
i
 = 2; ; i++)

51 
	`ùc_£nd
(
id
, 
i
, 0, 0);

52 
	}
}

	@user/primespipe.c

11 
	~<öc/lib.h
>

14 
	$¥imïroc
(
fd
)

16 
i
, 
id
, 
p
, 
pfd
[2], 
wfd
, 
r
;

19 
t›
:

20 i‡((
r
 = 
	`ªadn
(
fd
, &
p
, 4)) != 4)

21 
	`∑nic
("¥imïro¯couldÇŸÑód inôü»¥ime: %d, %e", 
r
,Ñ >= 0 ? 0 :Ñ);

23 
	`˝rötf
("%d\n", 
p
);

26 i‡((
i
=
	`pùe
(
pfd
)) < 0)

27 
	`∑nic
("pùe: %e", 
i
);

28 i‡((
id
 = 
	`f‹k
()) < 0)

29 
	`∑nic
("f‹k: %e", 
id
);

30 i‡(
id
 == 0) {

31 
	`˛o£
(
fd
);

32 
	`˛o£
(
pfd
[1]);

33 
fd
 = 
pfd
[0];

34 
t›
;

37 
	`˛o£
(
pfd
[0]);

38 
wfd
 = 
pfd
[1];

42 i‡((
r
=
	`ªadn
(
fd
, &
i
, 4)) != 4)

43 
	`∑nic
("¥imïro¯%dÑód¿%d %d %e", 
p
, 
fd
, 
r
,Ñ >= 0 ? 0 :Ñ);

44 i‡(
i
%
p
)

45 i‡((
r
=
	`wrôe
(
wfd
, &
i
, 4)) != 4)

46 
	`∑nic
("¥imïro¯%d wrôe: %d %e", 
p
, 
r
,Ñ >= 0 ? 0 :Ñ);

48 
	}
}

51 
	$umaö
(
¨gc
, **
¨gv
)

53 
i
, 
id
, 
p
[2], 
r
;

55 
bö¨y«me
 = "primespipe";

57 i‡((
i
=
	`pùe
(
p
)) < 0)

58 
	`∑nic
("pùe: %e", 
i
);

61 i‡((
id
=
	`f‹k
()) < 0)

62 
	`∑nic
("f‹k: %e", 
id
);

64 i‡(
id
 == 0) {

65 
	`˛o£
(
p
[1]);

66 
	`¥imïroc
(
p
[0]);

69 
	`˛o£
(
p
[0]);

72 
i
=2;; i++)

73 i‡((
r
=
	`wrôe
(
p
[1], &
i
, 4)) != 4)

74 
	`∑nic
("gíî©‹ wrôe: %d, %e", 
r
,Ñ >= 0 ? 0 :Ñ);

75 
	}
}

	@user/sendpage.c

4 
	~<öc/lib.h
>

6 c⁄° *
	g°r1
 = "hello childÉnvironment! howáre you?";

7 c⁄° *
	g°r2
 = "helloÖarentÉnvironment! I'm good.";

9 
	#TEMP_ADDR
 ((*)0xa00000)

	)

10 
	#TEMP_ADDR_CHILD
 ((*)0xb00000)

	)

13 
	$umaö
(
¨gc
, **
¨gv
)

15 
ívid_t
 
who
;

17 i‡((
who
 = 
	`f‹k
()) == 0) {

19 
	`ùc_ªcv
(&
who
, 
TEMP_ADDR_CHILD
, 0);

20 
	`˝rötf
("%x gŸ mesßge: %s\n", 
who
, 
TEMP_ADDR_CHILD
);

21 i‡(
	`°∫cmp
(
TEMP_ADDR_CHILD
, 
°r1
, 
	`°æí
(str1)) == 0)

22 
	`˝rötf
("childÑeceived correct message\n");

24 
	`mem˝y
(
TEMP_ADDR_CHILD
, 
°r2
, 
	`°æí
(str2) + 1);

25 
	`ùc_£nd
(
who
, 0, 
TEMP_ADDR_CHILD
, 
PTE_P
 | 
PTE_W
 | 
PTE_U
);

30 
	`sys_∑ge_Æloc
(
thi£nv
->
ív_id
, 
TEMP_ADDR
, 
PTE_P
 | 
PTE_W
 | 
PTE_U
);

31 
	`mem˝y
(
TEMP_ADDR
, 
°r1
, 
	`°æí
(str1) + 1);

32 
	`ùc_£nd
(
who
, 0, 
TEMP_ADDR
, 
PTE_P
 | 
PTE_W
 | 
PTE_U
);

34 
	`ùc_ªcv
(&
who
, 
TEMP_ADDR
, 0);

35 
	`˝rötf
("%x gŸ mesßge: %s\n", 
who
, 
TEMP_ADDR
);

36 i‡(
	`°∫cmp
(
TEMP_ADDR
, 
°r2
, 
	`°æí
(str2)) == 0)

37 
	`˝rötf
("parentÑeceived correct message\n");

39 
	}
}

	@user/sh.c

1 
	~<öc/lib.h
>

3 
	#BUFSIZ
 1024

	)

4 
	gdebug
 = 0;

13 
gëtokí
(*
s
, **
tokí
);

20 
	#MAXARGS
 16

	)

22 
	$runcmd
(* 
s
)

24 *
¨gv
[
MAXARGS
], *
t
, 
¨gv0buf
[
BUFSIZ
];

25 
¨gc
, 
c
, 
i
, 
r
, 
p
[2], 
fd
, 
pùe_chûd
;

27 
pùe_chûd
 = 0;

28 
	`gëtokí
(
s
, 0);

30 
agaö
:

31 
¨gc
 = 0;

33 (
c
 = 
	`gëtokí
(0, &
t
))) {

36 i‡(
¨gc
 =
MAXARGS
) {

37 
	`˝rötf
("too manyárguments\n");

38 
	`exô
();

40 
¨gv
[
¨gc
++] = 
t
;

45 i‡(
	`gëtokí
(0, &
t
) != 'w') {

46 
	`˝rötf
("syntaxÉrror: <Çot followed by word\n");

47 
	`exô
();

58 
	`∑nic
("<ÑedirectionÇot implemented");

63 i‡(
	`gëtokí
(0, &
t
) != 'w') {

64 
	`˝rötf
("syntaxÉrror: >Çot followed by word\n");

65 
	`exô
();

67 i‡((
fd
 = 
	`›í
(
t
, 
O_WRONLY
|
O_CREAT
|
O_TRUNC
)) < 0) {

68 
	`˝rötf
("›í %†f‹ wrôe: %e", 
t
, 
fd
);

69 
	`exô
();

71 i‡(
fd
 != 1) {

72 
	`dup
(
fd
, 1);

73 
	`˛o£
(
fd
);

78 i‡((
r
 = 
	`pùe
(
p
)) < 0) {

79 
	`˝rötf
("pùe: %e", 
r
);

80 
	`exô
();

82 i‡(
debug
)

83 
	`˝rötf
("PIPE: %d %d\n", 
p
[0],Ö[1]);

84 i‡((
r
 = 
	`f‹k
()) < 0) {

85 
	`˝rötf
("f‹k: %e", 
r
);

86 
	`exô
();

88 i‡(
r
 == 0) {

89 i‡(
p
[0] != 0) {

90 
	`dup
(
p
[0], 0);

91 
	`˛o£
(
p
[0]);

93 
	`˛o£
(
p
[1]);

94 
agaö
;

96 
pùe_chûd
 = 
r
;

97 i‡(
p
[1] != 1) {

98 
	`dup
(
p
[1], 1);

99 
	`˛o£
(
p
[1]);

101 
	`˛o£
(
p
[0]);

102 
runô
;

104 
	`∑nic
("|Çot implemented");

109 
runô
;

112 
	`∑nic
("badÑëu∫ %d from gëtokí", 
c
);

118 
runô
:

120 if(
¨gc
 == 0) {

121 i‡(
debug
)

122 
	`˝rötf
("EMPTY COMMAND\n");

130 i‡(
¨gv
[0][0] != '/') {

131 
¨gv0buf
[0] = '/';

132 
	`°r˝y
(
¨gv0buf
 + 1, 
¨gv
[0]);

133 
¨gv
[0] = 
¨gv0buf
;

135 
¨gv
[
¨gc
] = 0;

138 i‡(
debug
) {

139 
	`˝rötf
("[%08x] SPAWN:", 
thi£nv
->
ív_id
);

140 
i
 = 0; 
¨gv
[i]; i++)

141 
	`˝rötf
(" %s", 
¨gv
[
i
]);

142 
	`˝rötf
("\n");

146 i‡((
r
 = 
	`•awn
(
¨gv
[0], (const **)árgv)) < 0)

147 
	`˝rötf
("•aw¿%s: %e\n", 
¨gv
[0], 
r
);

151 
	`˛o£_Æl
();

152 i‡(
r
 >= 0) {

153 i‡(
debug
)

154 
	`˝rötf
("[%08x] WAIT %†%08x\n", 
thi£nv
->
ív_id
, 
¨gv
[0], 
r
);

155 
	`waô
(
r
);

156 i‡(
debug
)

157 
	`˝rötf
("[%08x] waô föished\n", 
thi£nv
->
ív_id
);

162 i‡(
pùe_chûd
) {

163 i‡(
debug
)

164 
	`˝rötf
("[%08x] WAITÖùe_chûd %08x\n", 
thi£nv
->
ív_id
, 
pùe_chûd
);

165 
	`waô
(
pùe_chûd
);

166 i‡(
debug
)

167 
	`˝rötf
("[%08x] waô föished\n", 
thi£nv
->
ív_id
);

171 
	`exô
();

172 
	}
}

186 
	#WHITESPACE
 " \t\r\n"

	)

187 
	#SYMBOLS
 "<|>&;()"

	)

190 
	$_gëtokí
(*
s
, **
p1
, **
p2
)

192 
t
;

194 i‡(
s
 == 0) {

195 i‡(
debug
 > 1)

196 
	`˝rötf
("GETTOKEN NULL\n");

200 i‡(
debug
 > 1)

201 
	`˝rötf
("GETTOKEN: %s\n", 
s
);

203 *
p1
 = 0;

204 *
p2
 = 0;

206 
	`°rchr
(
WHITESPACE
, *
s
))

207 *
s
++ = 0;

208 i‡(*
s
 == 0) {

209 i‡(
debug
 > 1)

210 
	`˝rötf
("EOL\n");

213 i‡(
	`°rchr
(
SYMBOLS
, *
s
)) {

214 
t
 = *
s
;

215 *
p1
 = 
s
;

216 *
s
++ = 0;

217 *
p2
 = 
s
;

218 i‡(
debug
 > 1)

219 
	`˝rötf
("TOK %c\n", 
t
);

220  
t
;

222 *
p1
 = 
s
;

223 *
s
 && !
	`°rchr
(
WHITESPACE
 
SYMBOLS
, *s))

224 
s
++;

225 *
p2
 = 
s
;

226 i‡(
debug
 > 1) {

227 
t
 = **
p2
;

228 **
p2
 = 0;

229 
	`˝rötf
("WORD: %s\n", *
p1
);

230 **
p2
 = 
t
;

233 
	}
}

236 
	$gëtokí
(*
s
, **
p1
)

238 
c
, 
nc
;

239 * 
≈1
, *
≈2
;

241 i‡(
s
) {

242 
nc
 = 
	`_gëtokí
(
s
, &
≈1
, &
≈2
);

245 
c
 = 
nc
;

246 *
p1
 = 
≈1
;

247 
nc
 = 
	`_gëtokí
(
≈2
, &
≈1
, &np2);

248  
c
;

249 
	}
}

253 
	$ußge
()

255 
	`˝rötf
("usage: sh [-dix] [command-file]\n");

256 
	`exô
();

257 
	}
}

260 
	$umaö
(
¨gc
, **
¨gv
)

262 
r
, 
öãø˘ive
, 
echocmds
;

263 
Arg°©e
 
¨gs
;

265 
öãø˘ive
 = '?';

266 
echocmds
 = 0;

267 
	`¨g°¨t
(&
¨gc
, 
¨gv
, &
¨gs
);

268 (
r
 = 
	`¨g√xt
(&
¨gs
)) >= 0)

269 
r
) {

271 
debug
++;

274 
öãø˘ive
 = 1;

277 
echocmds
 = 1;

280 
	`ußge
();

283 i‡(
¨gc
 > 2)

284 
	`ußge
();

285 i‡(
¨gc
 == 2) {

286 
	`˛o£
(0);

287 i‡((
r
 = 
	`›í
(
¨gv
[1], 
O_RDONLY
)) < 0)

288 
	`∑nic
("›í %s: %e", 
¨gv
[1], 
r
);

289 
	`as£π
(
r
 == 0);

291 i‡(
öãø˘ive
 == '?')

292 
öãø˘ive
 = 
	`isc⁄s
(0);

295 *
buf
;

297 
buf
 = 
	`ªadlöe
(
öãø˘ive
 ? "$ " : 
NULL
);

298 i‡(
buf
 =
NULL
) {

299 i‡(
debug
)

300 
	`˝rötf
("EXITING\n");

301 
	`exô
();

303 i‡(
debug
)

304 
	`˝rötf
("LINE: %s\n", 
buf
);

305 i‡(
buf
[0] == '#')

307 i‡(
echocmds
)

308 
	`¥ötf
("# %s\n", 
buf
);

309 i‡(
debug
)

310 
	`˝rötf
("BEFORE FORK\n");

311 i‡((
r
 = 
	`f‹k
()) < 0)

312 
	`∑nic
("f‹k: %e", 
r
);

313 i‡(
debug
)

314 
	`˝rötf
("FORK: %d\n", 
r
);

315 i‡(
r
 == 0) {

316 
	`runcmd
(
buf
);

317 
	`exô
();

319 
	`waô
(
r
);

321 
	}
}

	@user/softint.c

3 
	~<öc/lib.h
>

6 
	$umaö
(
¨gc
, **
¨gv
)

8 
asm
 volatile("int $14");

9 
	}
}

	@user/spawnfaultio.c

1 
	~<öc/lib.h
>

4 
	$umaö
(
¨gc
, **
¨gv
)

6 
r
;

7 
	`˝rötf
("òamÖ¨íàívú⁄míà%08x\n", 
thi£nv
->
ív_id
);

8 i‡((
r
 = 
	`•aw∆
("faultio", "faultio", 0)) < 0)

9 
	`∑nic
("•awn(Áu…ioËÁûed: %e", 
r
);

10 
	}
}

	@user/spawnhello.c

1 
	~<öc/lib.h
>

4 
	$umaö
(
¨gc
, **
¨gv
)

6 
r
;

7 
	`˝rötf
("òamÖ¨íàívú⁄míà%08x\n", 
thi£nv
->
ív_id
);

8 i‡((
r
 = 
	`•aw∆
("hello", "hello", 0)) < 0)

9 
	`∑nic
("•awn(hñloËÁûed: %e", 
r
);

10 
	}
}

	@user/spawninit.c

1 
	~<öc/lib.h
>

4 
	$umaö
(
¨gc
, **
¨gv
)

6 
r
;

7 
	`˝rötf
("òamÖ¨íàívú⁄míà%08x\n", 
thi£nv
->
ív_id
);

8 i‡((
r
 = 
	`•aw∆
("init", "init", "one", "two", 0)) < 0)

9 
	`∑nic
("•aw∆(öôËÁûed: %e", 
r
);

10 
	}
}

	@user/spin.c

4 
	~<öc/lib.h
>

7 
	$umaö
(
¨gc
, **
¨gv
)

9 
ívid_t
 
ív
;

11 
	`˝rötf
("IámÅheÖarent. ForkingÅhe child...\n");

12 i‡((
ív
 = 
	`f‹k
()) == 0) {

13 
	`˝rötf
("IámÅhe child. Spinning...\n");

18 
	`˝rötf
("IámÅheÖarent. RunningÅhe child...\n");

19 
	`sys_yõld
();

20 
	`sys_yõld
();

21 
	`sys_yõld
();

22 
	`sys_yõld
();

23 
	`sys_yõld
();

24 
	`sys_yõld
();

25 
	`sys_yõld
();

26 
	`sys_yõld
();

28 
	`˝rötf
("IámÅheÖarent. KillingÅhe child...\n");

29 
	`sys_ív_de°roy
(
ív
);

30 
	}
}

	@user/stresssched.c

1 
	~<öc/lib.h
>

3 vﬁ©ûê
	gcou¡î
;

6 
	$umaö
(
¨gc
, **
¨gv
)

8 
i
, 
j
;

9 
£í
;

10 
ívid_t
 
∑ª¡
 = 
	`sys_gëívid
();

13 
i
 = 0; i < 20; i++)

14 i‡(
	`f‹k
() == 0)

16 i‡(
i
 == 20) {

17 
	`sys_yõld
();

22 
ívs
[
	`ENVX
(
∑ª¡
)].
ív_°©us
 !
ENV_FREE
)

23 
asm
 volatile("pause");

26 
i
 = 0; i < 10; i++) {

27 
	`sys_yõld
();

28 
j
 = 0; j < 10000; j++)

29 
cou¡î
++;

32 i‡(
cou¡î
 != 10*10000)

33 
	`∑nic
("ø¿⁄ÅwÿCPU†© on˚ (cou¡î i†%d)", 
cou¡î
);

36 
	`˝rötf
("[%08x] såesssched o¿CPU %d\n", 
thi£nv
->
ív_id
,Åhi£nv->
ív_˝unum
);

38 
	}
}

	@user/testbss.c

3 
	~<öc/lib.h
>

5 
	#ARRAYSIZE
 (1024*1024)

	)

7 
uöt32_t
 
	gbig¨øy
[
ARRAYSIZE
];

10 
	$umaö
(
¨gc
, **
¨gv
)

12 
i
;

14 
	`˝rötf
("Making sure bss worksÑight...\n");

15 
i
 = 0; i < 
ARRAYSIZE
; i++)

16 i‡(
big¨øy
[
i
] != 0)

17 
	`∑nic
("big¨øy[%d] i¢'à˛óªd!\n", 
i
);

18 
i
 = 0; i < 
ARRAYSIZE
; i++)

19 
big¨øy
[
i
] = i;

20 
i
 = 0; i < 
ARRAYSIZE
; i++)

21 i‡(
big¨øy
[
i
] != i)

22 
	`∑nic
("big¨øy[%d] didn'àhﬁd it†vÆue!\n", 
i
);

24 
	`˝rötf
("Yes, good. Now doingá wild write offÅheÉnd...\n");

25 
big¨øy
[
ARRAYSIZE
+1024] = 0;

26 
	`∑nic
("SHOULD HAVE TRAPPED!!!");

27 
	}
}

	@user/testfdsharing.c

1 
	~<öc/x86.h
>

2 
	~<öc/lib.h
>

4 
	gbuf
[512], 
	gbuf2
[512];

7 
	$umaö
(
¨gc
, **
¨gv
)

9 
fd
, 
r
, 
n
, 
n2
;

11 i‡((
fd
 = 
	`›í
("mŸd", 
O_RDONLY
)) < 0)

12 
	`∑nic
("›í mŸd: %e", 
fd
);

13 
	`£ek
(
fd
, 0);

14 i‡((
n
 = 
	`ªadn
(
fd
, 
buf
,  buf)) <= 0)

15 
	`∑nic
("ªadn: %e", 
n
);

17 i‡((
r
 = 
	`f‹k
()) < 0)

18 
	`∑nic
("f‹k: %e", 
r
);

19 i‡(
r
 == 0) {

20 
	`£ek
(
fd
, 0);

21 
	`˝rötf
("goingÅoÑead in child (mightÖage fault if your sharing is buggy)\n");

22 i‡((
n2
 = 
	`ªadn
(
fd
, 
buf2
,  buf2)Ë!
n
)

23 
	`∑nic
("ªad i¿∑ª¡ gŸ %d,Ñód i¿chûd gŸ %d", 
n
, 
n2
);

24 i‡(
	`memcmp
(
buf
, 
buf2
, 
n
) != 0)

25 
	`∑nic
("read inÖarent got different bytes fromÑead in child");

26 
	`˝rötf
("read in child succeeded\n");

27 
	`£ek
(
fd
, 0);

28 
	`˛o£
(
fd
);

29 
	`exô
();

31 
	`waô
(
r
);

32 i‡((
n2
 = 
	`ªadn
(
fd
, 
buf2
,  buf2)Ë!
n
)

33 
	`∑nic
("ªad i¿∑ª¡ gŸ %d,Åhí gŸ %d", 
n
, 
n2
);

34 
	`˝rötf
("read inÖarent succeeded\n");

35 
	`˛o£
(
fd
);

37 
	`bªakpoöt
();

38 
	}
}

	@user/testfile.c

1 
	~<öc/lib.h
>

3 c⁄° *
	gmsg
 = "This isÅhe NEW message ofÅhe day!\n\n";

5 
	#FVA
 ((
Fd
*)0xCCCCC000)

	)

8 
	$x›í
(c⁄° *
∑th
, 
mode
)

10 
Fsùc
 
fsùcbuf
;

11 
ívid_t
 
f£nv
;

13 
	`°r˝y
(
fsùcbuf
.
›í
.
ªq_∑th
, 
∑th
);

14 
fsùcbuf
.
›í
.
ªq_omode
 = 
mode
;

16 
f£nv
 = 
	`ùc_föd_ív
(
ENV_TYPE_FS
);

17 
	`ùc_£nd
(
f£nv
, 
FSREQ_OPEN
, &
fsùcbuf
, 
PTE_P
 | 
PTE_W
 | 
PTE_U
);

18  
	`ùc_ªcv
(
NULL
, 
FVA
, NULL);

19 
	}
}

22 
	$umaö
(
¨gc
, **
¨gv
)

24 
r
, 
f
, 
i
;

25 
Fd
 *
fd
;

26 
Fd
 
fdc›y
;

27 
Sèt
 
°
;

28 
buf
[512];

31 i‡((
r
 = 
	`x›í
("/nŸ-found", 
O_RDONLY
)Ë< 0 &&Ñ !-
E_NOT_FOUND
)

32 
	`∑nic
("£rve_›í /nŸ-found: %e", 
r
);

33 i‡(
r
 >= 0)

34 
	`∑nic
("serve_open /not-found succeeded!");

36 i‡((
r
 = 
	`x›í
("/√wmŸd", 
O_RDONLY
)) < 0)

37 
	`∑nic
("£rve_›í /√wmŸd: %e", 
r
);

38 i‡(
FVA
->
fd_dev_id
 !'f' || FVA->
fd_off£t
 !0 || FVA->
fd_omode
 !
O_RDONLY
)

39 
	`∑nic
("serve_open didÇot fill struct Fd correctly\n");

40 
	`˝rötf
("serve_open is good\n");

42 i‡((
r
 = 
devfûe
.
	`dev_°©
(
FVA
, &
°
)) < 0)

43 
	`∑nic
("fûe_°©: %e", 
r
);

44 i‡(
	`°æí
(
msg
Ë!
°
.
°_size
)

45 
	`∑nic
("fûe_°©Ñëu∫ed sizê%d w™ãd %d\n", 
°
.
°_size
, 
	`°æí
(
msg
));

46 
	`˝rötf
("file_stat is good\n");

48 
	`mem£t
(
buf
, 0,  buf);

49 i‡((
r
 = 
devfûe
.
	`dev_ªad
(
FVA
, 
buf
,  buf)) < 0)

50 
	`∑nic
("fûe_ªad: %e", 
r
);

51 i‡(
	`°rcmp
(
buf
, 
msg
) != 0)

52 
	`∑nic
("file_readÑeturned wrong data");

53 
	`˝rötf
("file_read is good\n");

55 i‡((
r
 = 
devfûe
.
	`dev_˛o£
(
FVA
)) < 0)

56 
	`∑nic
("fûe_˛o£: %e", 
r
);

57 
	`˝rötf
("file_close is good\n");

63 
fdc›y
 = *
FVA
;

64 
	`sys_∑ge_unm≠
(0, 
FVA
);

66 i‡((
r
 = 
devfûe
.
	`dev_ªad
(&
fdc›y
, 
buf
,  buf)Ë!-
E_INVAL
)

67 
	`∑nic
("£rve_ªad d€†nŸ h™dÀ sèÀ fûeid†c‹ª˘ly: %e", 
r
);

68 
	`˝rötf
("stale fileid is good\n");

71 i‡((
r
 = 
	`x›í
("/√w-fûe", 
O_RDWR
|
O_CREAT
)) < 0)

72 
	`∑nic
("£rve_›í /√w-fûe: %e", 
r
);

74 i‡((
r
 = 
devfûe
.
	`dev_wrôe
(
FVA
, 
msg
, 
	`°æí
(msg))) != strlen(msg))

75 
	`∑nic
("fûe_wrôe: %e", 
r
);

76 
	`˝rötf
("file_write is good\n");

78 
FVA
->
fd_off£t
 = 0;

79 
	`mem£t
(
buf
, 0,  buf);

80 i‡((
r
 = 
devfûe
.
	`dev_ªad
(
FVA
, 
buf
,  buf)) < 0)

81 
	`∑nic
("fûe_ªadá·î fûe_wrôe: %e", 
r
);

82 i‡(
r
 !
	`°æí
(
msg
))

83 
	`∑nic
("fûe_ªadá·î fûe_wrôêªtu∫ed wr⁄gÜígth: %d", 
r
);

84 i‡(
	`°rcmp
(
buf
, 
msg
) != 0)

85 
	`∑nic
("file_readáfter file_writeÑeturned wrong data");

86 
	`˝rötf
("file_readáfter file_write is good\n");

89 i‡((
r
 = 
	`›í
("/nŸ-found", 
O_RDONLY
)Ë< 0 &&Ñ !-
E_NOT_FOUND
)

90 
	`∑nic
("›í /nŸ-found: %e", 
r
);

91 i‡(
r
 >= 0)

92 
	`∑nic
("open /not-found succeeded!");

94 i‡((
r
 = 
	`›í
("/√wmŸd", 
O_RDONLY
)) < 0)

95 
	`∑nic
("›í /√wmŸd: %e", 
r
);

96 
fd
 = (
Fd
*Ë(0xD0000000 + 
r
*
PGSIZE
);

97 i‡(
fd
->
fd_dev_id
 !'f' || fd->
fd_off£t
 !0 || fd->
fd_omode
 !
O_RDONLY
)

98 
	`∑nic
("open didÇot fill struct Fd correctly\n");

99 
	`˝rötf
("open is good\n");

102 i‡((
f
 = 
	`›í
("/big", 
O_WRONLY
|
O_CREAT
)) < 0)

103 
	`∑nic
("¸óà/big: %e", 
f
);

104 
	`mem£t
(
buf
, 0, (buf));

105 
i
 = 0; i < (
NDIRECT
*3)*
BLKSIZE
; i +(
buf
)) {

106 *(*)
buf
 = 
i
;

107 i‡((
r
 = 
	`wrôe
(
f
, 
buf
, (buf))) < 0)

108 
	`∑nic
("wrôê/big@%d: %e", 
i
, 
r
);

110 
	`˛o£
(
f
);

112 i‡((
f
 = 
	`›í
("/big", 
O_RDONLY
)) < 0)

113 
	`∑nic
("›í /big: %e", 
f
);

114 
i
 = 0; i < (
NDIRECT
*3)*
BLKSIZE
; i +(
buf
)) {

115 *(*)
buf
 = 
i
;

116 i‡((
r
 = 
	`ªadn
(
f
, 
buf
, (buf))) < 0)

117 
	`∑nic
("ªad /big@%d: %e", 
i
, 
r
);

118 i‡(
r
 !(
buf
))

119 
	`∑nic
("read /big from %dÑeturned %d < %d bytes",

120 
i
, 
r
, (
buf
));

121 i‡(*(*)
buf
 !
i
)

122 
	`∑nic
("read /big from %dÑeturned bad data %d",

123 
i
, *(*)
buf
);

125 
	`˛o£
(
f
);

126 
	`˝rötf
("large file is good\n");

127 
	}
}

	@user/testkbd.c

2 
	~<öc/lib.h
>

5 
	$umaö
(
¨gc
, **
¨gv
)

7 
i
, 
r
;

10 
i
 = 0; i < 10; ++i)

11 
	`sys_yõld
();

13 
	`˛o£
(0);

14 i‡((
r
 = 
	`›íc⁄s
()) < 0)

15 
	`∑nic
("›íc⁄s: %e", 
r
);

16 i‡(
r
 != 0)

17 
	`∑nic
("fú° o≥nc⁄†u£d fd %d", 
r
);

18 i‡((
r
 = 
	`dup
(0, 1)) < 0)

19 
	`∑nic
("dup: %e", 
r
);

22 *
buf
;

24 
buf
 = 
	`ªadlöe
("TypeáÜine: ");

25 i‡(
buf
 !
NULL
)

26 
	`Ârötf
(1, "%s\n", 
buf
);

28 
	`Ârötf
(1, "(end of fileÑeceived)\n");

30 
	}
}

	@user/testmalloc.c

1 
	~<öc/lib.h
>

4 
	$umaö
(
¨gc
, **
¨gv
)

6 *
buf
;

7 
n
;

8 *
v
;

11 
buf
 = 
	`ªadlöe
("> ");

12 i‡(
buf
 == 0)

13 
	`exô
();

14 i‡(
	`memcmp
(
buf
, "free ", 5) == 0) {

15 
v
 = (*Ë
	`°πﬁ
(
buf
 + 5, 0, 0);

16 
	`‰ì
(
v
);

17 } i‡(
	`memcmp
(
buf
, "malloc ", 7) == 0) {

18 
n
 = 
	`°πﬁ
(
buf
 + 7, 0, 0);

19 
v
 = 
	`mÆloc
(
n
);

20 
	`¥ötf
("\t0x%x\n", (
uöçå_t
Ë
v
);

22 
	`¥ötf
("?unknown command\n");

24 
	}
}

	@user/testpipe.c

1 
	~<öc/lib.h
>

3 *
	gmsg
 = "Now isÅheÅime foráll good menÅo comeÅoÅheáid ofÅheirÖarty.";

6 
	$umaö
(
¨gc
, **
¨gv
)

8 
buf
[100];

9 
i
, 
pid
, 
p
[2];

11 
bö¨y«me
 = "pipereadeof";

13 i‡((
i
 = 
	`pùe
(
p
)) < 0)

14 
	`∑nic
("pùe: %e", 
i
);

16 i‡((
pid
 = 
	`f‹k
()) < 0)

17 
	`∑nic
("f‹k: %e", 
i
);

19 i‡(
pid
 == 0) {

20 
	`˝rötf
("[%08x]Öùîódeo‡˛o£ %d\n", 
thi£nv
->
ív_id
, 
p
[1]);

21 
	`˛o£
(
p
[1]);

22 
	`˝rötf
("[%08x]Öùîódeo‡ªad¿%d\n", 
thi£nv
->
ív_id
, 
p
[0]);

23 
i
 = 
	`ªadn
(
p
[0], 
buf
,  buf-1);

24 i‡(
i
 < 0)

25 
	`∑nic
("ªad: %e", 
i
);

26 
buf
[
i
] = 0;

27 i‡(
	`°rcmp
(
buf
, 
msg
) == 0)

28 
	`˝rötf
("\npipeÑead closedÖroperly\n");

30 
	`˝rötf
("\ngŸ %d byãs: %s\n", 
i
, 
buf
);

31 
	`exô
();

33 
	`˝rötf
("[%08x]Öùîódeo‡˛o£ %d\n", 
thi£nv
->
ív_id
, 
p
[0]);

34 
	`˛o£
(
p
[0]);

35 
	`˝rötf
("[%08x]Öùîódeo‡wrôê%d\n", 
thi£nv
->
ív_id
, 
p
[1]);

36 i‡((
i
 = 
	`wrôe
(
p
[1], 
msg
, 
	`°æí
(msg))) != strlen(msg))

37 
	`∑nic
("wrôe: %e", 
i
);

38 
	`˛o£
(
p
[1]);

40 
	`waô
(
pid
);

42 
bö¨y«me
 = "pipewriteeof";

43 i‡((
i
 = 
	`pùe
(
p
)) < 0)

44 
	`∑nic
("pùe: %e", 
i
);

46 i‡((
pid
 = 
	`f‹k
()) < 0)

47 
	`∑nic
("f‹k: %e", 
i
);

49 i‡(
pid
 == 0) {

50 
	`˛o£
(
p
[0]);

52 
	`˝rötf
(".");

53 i‡(
	`wrôe
(
p
[1], "x", 1) != 1)

56 
	`˝rötf
("\npipe write closedÖroperly\n");

57 
	`exô
();

59 
	`˛o£
(
p
[0]);

60 
	`˛o£
(
p
[1]);

61 
	`waô
(
pid
);

63 
	`˝rötf
("pipeÅestsÖassed\n");

64 
	}
}

	@user/testpiperace.c

1 
	~<öc/lib.h
>

4 
	$umaö
(
¨gc
, **
¨gv
)

6 
p
[2], 
r
, 
pid
, 
i
, 
max
;

7 *
va
;

8 
Fd
 *
fd
;

9 c⁄° vﬁ©ûê
Env
 *
kid
;

11 
	`˝rötf
("testing for dupÑace...\n");

12 i‡((
r
 = 
	`pùe
(
p
)) < 0)

13 
	`∑nic
("pùe: %e", 
r
);

14 
max
 = 200;

15 i‡((
r
 = 
	`f‹k
()) < 0)

16 
	`∑nic
("f‹k: %e", 
r
);

17 i‡(
r
 == 0) {

18 
	`˛o£
(
p
[1]);

37 
i
=0; i<
max
; i++) {

38 if(
	`pùeis˛o£d
(
p
[0])){

39 
	`˝rötf
("RACE:Öipeáppears closed\n");

40 
	`exô
();

42 
	`sys_yõld
();

45 
	`ùc_ªcv
(0,0,0);

47 
pid
 = 
r
;

48 
	`˝rötf
("pid i†%d\n", 
pid
);

49 
va
 = 0;

50 
kid
 = &
ívs
[
	`ENVX
(
pid
)];

51 
	`˝rötf
("kid i†%d\n", 
kid
-
ívs
);

52 
	`dup
(
p
[0], 10);

53 
kid
->
ív_°©us
 =
ENV_RUNNABLE
)

54 
	`dup
(
p
[0], 10);

56 
	`˝rötf
("child done withÜoop\n");

57 i‡(
	`pùeis˛o£d
(
p
[0]))

58 
	`∑nic
("somehowÅhe otherÉnd ofÖ[0] got closed!");

59 i‡((
r
 = 
	`fd_lookup
(
p
[0], &
fd
)) < 0)

60 
	`∑nic
("ˇ¬ŸÜook u∞p[0]: %e", 
r
);

61 
va
 = 
	`fd2d©a
(
fd
);

62 i‡(
	`∑gîef
(
va
) != 3+1)

63 
	`˝rötf
("\nchild detectedÑace\n");

65 
	`˝rötf
("\ƒa˚ didn'àh≠≥n\n", 
max
);

66 
	}
}

	@user/testpiperace2.c

2 
	~<öc/lib.h
>

5 
	$umaö
(
¨gc
, **
¨gv
)

7 
p
[2], 
r
, 
i
;

8 
Fd
 *
fd
;

9 c⁄° vﬁ©ûê
Env
 *
kid
;

11 
	`˝rötf
("testing forÖipeisclosedÑace...\n");

12 i‡((
r
 = 
	`pùe
(
p
)) < 0)

13 
	`∑nic
("pùe: %e", 
r
);

14 i‡((
r
 = 
	`f‹k
()) < 0)

15 
	`∑nic
("f‹k: %e", 
r
);

16 i‡(
r
 == 0) {

20 
	`˛o£
(
p
[1]);

21 
i
 = 0; i < 200; i++) {

22 i‡(
i
 % 10 == 0)

23 
	`˝rötf
("%d.", 
i
);

26 
	`dup
(
p
[0], 10);

27 
	`sys_yõld
();

28 
	`˛o£
(10);

29 
	`sys_yõld
();

31 
	`exô
();

55 
kid
 = &
ívs
[
	`ENVX
(
r
)];

56 
kid
->
ív_°©us
 =
ENV_RUNNABLE
)

57 i‡(
	`pùeis˛o£d
(
p
[0]) != 0) {

58 
	`˝rötf
("\nRACE:Öipeáppears closed\n");

59 
	`sys_ív_de°roy
(
r
);

60 
	`exô
();

62 
	`˝rötf
("child done withÜoop\n");

63 i‡(
	`pùeis˛o£d
(
p
[0]))

64 
	`∑nic
("somehowÅhe otherÉnd ofÖ[0] got closed!");

65 i‡((
r
 = 
	`fd_lookup
(
p
[0], &
fd
)) < 0)

66 
	`∑nic
("ˇ¬ŸÜook u∞p[0]: %e", 
r
);

67 (Ë
	`fd2d©a
(
fd
);

68 
	`˝rötf
("race didn't happen\n");

69 
	}
}

	@user/testptelibrary.c

1 
	~<öc/lib.h
>

3 
	#VA
 ((*Ë0xA0000000)

	)

4 c⁄° *
	gmsg
 = "hello, world\n";

5 c⁄° *
	gmsg2
 = "goodbye, world\n";

7 
chûdof•awn
();

10 
	$umaö
(
¨gc
, **
¨gv
)

12 
r
;

14 i‡(
¨gc
 != 0)

15 
	`chûdof•awn
();

17 i‡((
r
 = 
	`sys_∑ge_Æloc
(0, 
VA
, 
PTE_P
|
PTE_W
|
PTE_U
|
PTE_SHARE
)) < 0)

18 
	`∑nic
("sys_∑ge_Æloc: %e", 
r
);

21 i‡((
r
 = 
	`f‹k
()) < 0)

22 
	`∑nic
("f‹k: %e", 
r
);

23 i‡(
r
 == 0) {

24 
	`°r˝y
(
VA
, 
msg
);

25 
	`exô
();

27 
	`waô
(
r
);

28 
	`˝rötf
("f‹k h™dÀ†PTE_SHARE %s\n", 
	`°rcmp
(
VA
, 
msg
) == 0 ? "right" : "wrong");

31 i‡((
r
 = 
	`•aw∆
("/testptelibrary", "testptelibrary", "arg", 0)) < 0)

32 
	`∑nic
("•awn: %e", 
r
);

33 
	`waô
(
r
);

34 
	`˝rötf
("•aw¿h™dÀ†PTE_SHARE %s\n", 
	`°rcmp
(
VA
, 
msg2
) == 0 ? "right" : "wrong");

35 
	}
}

38 
	$chûdof•awn
()

40 
	`°r˝y
(
VA
, 
msg2
);

41 
	`exô
();

42 
	}
}

	@user/testpteshare.c

1 
	~<öc/x86.h
>

2 
	~<öc/lib.h
>

4 
	#VA
 ((*Ë0xA0000000)

	)

5 c⁄° *
	gmsg
 = "hello, world\n";

6 c⁄° *
	gmsg2
 = "goodbye, world\n";

8 
chûdof•awn
();

11 
	$umaö
(
¨gc
, **
¨gv
)

13 
r
;

15 i‡(
¨gc
 != 0)

16 
	`chûdof•awn
();

18 i‡((
r
 = 
	`sys_∑ge_Æloc
(0, 
VA
, 
PTE_P
|
PTE_W
|
PTE_U
|
PTE_SHARE
)) < 0)

19 
	`∑nic
("sys_∑ge_Æloc: %e", 
r
);

22 i‡((
r
 = 
	`f‹k
()) < 0)

23 
	`∑nic
("f‹k: %e", 
r
);

24 i‡(
r
 == 0) {

25 
	`°r˝y
(
VA
, 
msg
);

26 
	`exô
();

28 
	`waô
(
r
);

29 
	`˝rötf
("f‹k h™dÀ†PTE_SHARE %s\n", 
	`°rcmp
(
VA
, 
msg
) == 0 ? "right" : "wrong");

32 i‡((
r
 = 
	`•aw∆
("/testpteshare", "testpteshare", "arg", 0)) < 0)

33 
	`∑nic
("•awn: %e", 
r
);

34 
	`waô
(
r
);

35 
	`˝rötf
("•aw¿h™dÀ†PTE_SHARE %s\n", 
	`°rcmp
(
VA
, 
msg2
) == 0 ? "right" : "wrong");

37 
	`bªakpoöt
();

38 
	}
}

41 
	$chûdof•awn
()

43 
	`°r˝y
(
VA
, 
msg2
);

44 
	`exô
();

45 
	}
}

	@user/testshell.c

1 
	~<öc/x86.h
>

2 
	~<öc/lib.h
>

4 
wr⁄g
(, , );

7 
	$umaö
(
¨gc
, **
¨gv
)

9 
c1
, 
c2
;

10 
r
, 
rfd
, 
wfd
, 
kfd
, 
n1
, 
n2
, 
off
, 
∆off
;

11 
pfds
[2];

13 
	`˛o£
(0);

14 
	`˛o£
(1);

15 
	`›íc⁄s
();

16 
	`›íc⁄s
();

18 i‡((
rfd
 = 
	`›í
("ã°shñl.sh", 
O_RDONLY
)) < 0)

19 
	`∑nic
("›íÅe°shñl.sh: %e", 
rfd
);

20 i‡((
wfd
 = 
	`pùe
(
pfds
)) < 0)

21 
	`∑nic
("pùe: %e", 
wfd
);

22 
wfd
 = 
pfds
[1];

24 
	`˝rötf
("running sh -x <Åestshell.sh | cat\n");

25 i‡((
r
 = 
	`f‹k
()) < 0)

26 
	`∑nic
("f‹k: %e", 
r
);

27 i‡(
r
 == 0) {

28 
	`dup
(
rfd
, 0);

29 
	`dup
(
wfd
, 1);

30 
	`˛o£
(
rfd
);

31 
	`˛o£
(
wfd
);

32 i‡((
r
 = 
	`•aw∆
("/sh", "sh", "-x", 0)) < 0)

33 
	`∑nic
("•awn: %e", 
r
);

34 
	`˛o£
(0);

35 
	`˛o£
(1);

36 
	`waô
(
r
);

37 
	`exô
();

39 
	`˛o£
(
rfd
);

40 
	`˛o£
(
wfd
);

42 
rfd
 = 
pfds
[0];

43 i‡((
kfd
 = 
	`›í
("ã°shñl.key", 
O_RDONLY
)) < 0)

44 
	`∑nic
("›íÅe°shñl.key f‹Ñódög: %e", 
kfd
);

46 
∆off
 = 0;

47 
off
=0;; off++) {

48 
n1
 = 
	`ªad
(
rfd
, &
c1
, 1);

49 
n2
 = 
	`ªad
(
kfd
, &
c2
, 1);

50 i‡(
n1
 < 0)

51 
	`∑nic
("ªadögÅe°shñl.out: %e", 
n1
);

52 i‡(
n2
 < 0)

53 
	`∑nic
("ªadögÅe°shñl.key: %e", 
n2
);

54 i‡(
n1
 =0 && 
n2
 == 0)

56 i‡(
n1
 !1 || 
n2
 !1 || 
c1
 !
c2
)

57 
	`wr⁄g
(
rfd
, 
kfd
, 
∆off
);

58 i‡(
c1
 == '\n')

59 
∆off
 = 
off
+1;

61 
	`˝rötf
("shellÑan correctly\n");

63 
	`bªakpoöt
();

64 
	}
}

67 
	$wr⁄g
(
rfd
, 
kfd
, 
off
)

69 
buf
[100];

70 
n
;

72 
	`£ek
(
rfd
, 
off
);

73 
	`£ek
(
kfd
, 
off
);

75 
	`˝rötf
("shellÖroduced incorrect output.\n");

76 
	`˝rötf
("expected:\n===\n");

77 (
n
 = 
	`ªad
(
kfd
, 
buf
,  buf-1)) > 0)

78 
	`sys_˝uts
(
buf
, 
n
);

79 
	`˝rötf
("===\ngot:\n===\n");

80 (
n
 = 
	`ªad
(
rfd
, 
buf
,  buf-1)) > 0)

81 
	`sys_˝uts
(
buf
, 
n
);

82 
	`˝rötf
("===\n");

83 
	`exô
();

84 
	}
}

	@user/writemotd.c

1 
	~<öc/lib.h
>

4 
	$umaö
(
¨gc
, **
¨gv
)

6 
rfd
, 
wfd
;

7 
buf
[512];

8 
n
, 
r
;

10 i‡((
rfd
 = 
	`›í
("/√wmŸd", 
O_RDONLY
)) < 0)

11 
	`∑nic
("›í /√wmŸd: %e", 
rfd
);

12 i‡((
wfd
 = 
	`›í
("/mŸd", 
O_RDWR
)) < 0)

13 
	`∑nic
("›í /mŸd: %e", 
wfd
);

14 
	`˝rötf
("fûêdes¸ùt‹†%d %d\n", 
rfd
, 
wfd
);

15 i‡(
rfd
 =
wfd
)

16 
	`∑nic
("open /newmotdánd /motd give same file descriptor");

18 
	`˝rötf
("OLD MOTD\n===\n");

19 (
n
 = 
	`ªad
(
wfd
, 
buf
,  buf-1)) > 0)

20 
	`sys_˝uts
(
buf
, 
n
);

21 
	`˝rötf
("===\n");

22 
	`£ek
(
wfd
, 0);

24 i‡((
r
 = 
	`·runˇã
(
wfd
, 0)) < 0)

25 
	`∑nic
("åunˇã /mŸd: %e", 
r
);

27 
	`˝rötf
("NEW MOTD\n===\n");

28 (
n
 = 
	`ªad
(
rfd
, 
buf
,  buf-1)) > 0) {

29 
	`sys_˝uts
(
buf
, 
n
);

30 i‡((
r
 = 
	`wrôe
(
wfd
, 
buf
, 
n
)) !=Ç)

31 
	`∑nic
("wrôê/mŸd: %e", 
r
);

33 
	`˝rötf
("===\n");

35 i‡(
n
 < 0)

36 
	`∑nic
("ªad /√wmŸd: %e", 
n
);

38 
	`˛o£
(
rfd
);

39 
	`˛o£
(
wfd
);

40 
	}
}

	@user/yield.c

3 
	~<öc/lib.h
>

6 
	$umaö
(
¨gc
, **
¨gv
)

8 
i
;

10 
	`˝rötf
("Hñlo, IámÉnvú⁄míà%08x.\n", 
thi£nv
->
ív_id
);

11 
i
 = 0; i < 5; i++) {

12 
	`sys_yõld
();

13 
	`˝rötf
("Back inÉnvironment %08x, iteration %d.\n",

14 
thi£nv
->
ív_id
, 
i
);

16 
	`˝rötf
("AŒ d⁄êöÉnvú⁄míà%08x.\n", 
thi£nv
->
ív_id
);

17 
	}
}

	@
1
.
0
132
1881
boot/main.c
fs/bc.c
fs/fs.c
fs/fs.h
fs/fsformat.c
fs/ide.c
fs/serv.c
fs/test.c
inc/args.h
inc/assert.h
inc/elf.h
inc/env.h
inc/error.h
inc/fd.h
inc/fs.h
inc/kbdreg.h
inc/lib.h
inc/memlayout.h
inc/mmu.h
inc/partition.h
inc/stab.h
inc/stdarg.h
inc/stdio.h
inc/string.h
inc/syscall.h
inc/trap.h
inc/types.h
inc/x86.h
kern/console.c
kern/console.h
kern/cpu.h
kern/entrypgdir.c
kern/env.c
kern/env.h
kern/init.c
kern/kclock.c
kern/kclock.h
kern/kdebug.c
kern/kdebug.h
kern/lapic.c
kern/monitor.c
kern/monitor.h
kern/mpconfig.c
kern/picirq.c
kern/picirq.h
kern/pmap.c
kern/pmap.h
kern/printf.c
kern/sched.c
kern/sched.h
kern/spinlock.c
kern/spinlock.h
kern/syscall.c
kern/syscall.h
kern/trap.c
kern/trap.h
lib/args.c
lib/console.c
lib/exit.c
lib/fd.c
lib/file.c
lib/fork.c
lib/fprintf.c
lib/ipc.c
lib/libmain.c
lib/pageref.c
lib/panic.c
lib/pgfault.c
lib/pipe.c
lib/printf.c
lib/printfmt.c
lib/readline.c
lib/spawn.c
lib/string.c
lib/syscall.c
lib/wait.c
user/badsegment.c
user/breakpoint.c
user/buggyhello.c
user/buggyhello2.c
user/cat.c
user/divzero.c
user/dumbfork.c
user/echo.c
user/evilhello.c
user/fairness.c
user/faultalloc.c
user/faultallocbad.c
user/faultbadhandler.c
user/faultdie.c
user/faultevilhandler.c
user/faultio.c
user/faultnostack.c
user/faultread.c
user/faultreadkernel.c
user/faultregs.c
user/faultwrite.c
user/faultwritekernel.c
user/forktree.c
user/hello.c
user/icode.c
user/idle.c
user/init.c
user/initsh.c
user/ls.c
user/lsfd.c
user/num.c
user/pingpong.c
user/pingpongs.c
user/primes.c
user/primespipe.c
user/sendpage.c
user/sh.c
user/softint.c
user/spawnfaultio.c
user/spawnhello.c
user/spawninit.c
user/spin.c
user/stresssched.c
user/testbss.c
user/testfdsharing.c
user/testfile.c
user/testkbd.c
user/testmalloc.c
user/testpipe.c
user/testpiperace.c
user/testpiperace2.c
user/testptelibrary.c
user/testpteshare.c
user/testshell.c
user/writemotd.c
user/yield.c
